/*******************************************************************************
 * Copyright (c) 2008 itemis AG (http://www.itemis.eu) and others.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/legal/epl-v10.html
 *******************************************************************************/
import org::eclipse::xtext;

import org::eclipse::jface::text::contentassist;
import org::eclipse::xtext::scoping;
import org::eclipse::xtext::ui::core::editor::contentassist;
import org::eclipse::xtext::ui::common::editor::contentassist;
import org::eclipse::xtext::ui::common::xtend::contentassist;

extension org::eclipse::xtext::Extensions reexport;
extension org::eclipse::xtext::xtend::Services reexport;

ICompletionProposal newProposal(AbstractElement element, String text, ContentAssistContext contentAssistContext) :
	JAVA org.eclipse.xtext.xtend.contentassist.ContentAssistHelper.newProposal(org.eclipse.xtext.AbstractElement, java.lang.String, org.eclipse.xtext.ui.core.editor.contentassist.ContentAssistContext); 

List[ICompletionProposal] lookupCrossReference(CrossReference crossRef, ContentAssistContext contentAssistContext) :
	scopeProvider() != null 
		? (
			!crossRef.containingParserRule().isDatatypeRule()
				? lookupCandidates(crossRef, contentAssistContext)
					.filterMatches(contentAssistContext)
						.newProposal(crossRef, contentAssistContext)
				: {}
		)
		: {};	


// Helper extensions	
List[IScopedElement] lookupCandidates(CrossReference crossRef, ContentAssistContext contentAssistContext) :
	let scope = scopeProvider().getScope(contentAssistContext.currentModel, crossRef.eReference()) :
		(scope != null) ? scope.allContents.toList() : {};

List[IScopedElement]  filterMatches(List[IScopedElement] this, ContentAssistContext contentAssistContext) : 
	select(e|e.name() != null && e.name().toLowerCase().startsWith(contentAssistContext.prefix.toLowerCase()));		

ICompletionProposal newProposal(IScopedElement this, CrossReference crossRef, ContentAssistContext contentAssistContext): 		
		newProposal(crossRef, name(), contentAssistContext);
				
IScopeProvider scopeProvider():
	GLOBALVAR scopeProvider;
