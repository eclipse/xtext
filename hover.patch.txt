From 199ce122d6cf1b70cfc93c6381c50689e94059bd Mon Sep 17 00:00:00 2001
From: Jan Koehnlein <jan.koehnlein@itemis.de>
Date: Tue, 28 Sep 2010 17:31:58 +0200
Subject: [PATCH 01/28] Patch adapted to HEAD

---
 .../common/types/xtext/ui/JavadocHoverWrapper.java |   34 +
 .../xtext/common/types/xtext/ui/JdtHover.java      |   77 ++
 .../generator/types/TypesGeneratorFragment.java    |    5 +
 plugins/org.eclipse.xtext.ui/META-INF/MANIFEST.MF  |    1 +
 .../org.eclipse.xtext.ui/XtextHoverStyleSheet.css  |   34 +
 plugins/org.eclipse.xtext.ui/build.properties      |    3 +-
 .../icons/dlcl16/goto_input.gif                    |  Bin 0 -> 235 bytes
 .../icons/elcl16/goto_input.gif                    |  Bin 0 -> 372 bytes
 .../src/org/eclipse/xtext/ui/DefaultUiModule.java  |   23 +
 .../org/eclipse/xtext/ui/DefaultUiModule.java.rej  |   19 +
 .../src/org/eclipse/xtext/ui/XtextUIMessages.java  |   14 +-
 .../ui/editor/XtextSourceViewerConfiguration.java  |   18 +-
 .../xtext/ui/editor/hover/AbstractHover.java       |   14 +-
 .../ui/editor/hover/AbstractXtextEditorHover.java  |  114 +++
 .../hover/AnnotationWithQuickFixesHover.java       |  750 ++++++++++++++++++++
 .../xtext/ui/editor/hover/DelegatingHover.java     |  142 ++++
 .../hover/IEObjectDocumentationProvider.java       |   23 +
 .../hover/MutiLineDocumentationProvider.java       |   85 +++
 .../xtext/ui/editor/hover/ProblemHover.java        |   56 ++-
 .../html/AbstractHtmlHoverContentProvider.java     |   44 ++
 .../html/DeclarativeHtmlHoverConentProvider.java   |   45 ++
 .../html/DefaultHtmlHoverContentProvider.java      |   67 ++
 .../hover/html/IHtmlHoverContentProvider.java      |   19 +
 .../ui/editor/hover/html/OpenBrowserUtil.java      |   37 +
 .../html/XtextBrowserInformationControlInput.java  |   78 ++
 .../ui/editor/hover/html/XtextElementLinks.java    |  185 +++++
 .../xtext/ui/editor/hover/html/XtextHtmlHover.java |  472 ++++++++++++
 .../xtext/ui/internal/XtextPluginImages.java       |    3 +
 .../src/org/eclipse/xtext/ui/messages.properties   |   10 +
 29 files changed, 2354 insertions(+), 18 deletions(-)
 create mode 100644 plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JavadocHoverWrapper.java
 create mode 100644 plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JdtHover.java
 create mode 100644 plugins/org.eclipse.xtext.ui/XtextHoverStyleSheet.css
 create mode 100644 plugins/org.eclipse.xtext.ui/icons/dlcl16/goto_input.gif
 create mode 100644 plugins/org.eclipse.xtext.ui/icons/elcl16/goto_input.gif
 create mode 100644 plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java.rej
 create mode 100644 plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractXtextEditorHover.java
 create mode 100644 plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AnnotationWithQuickFixesHover.java
 create mode 100644 plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DelegatingHover.java
 create mode 100644 plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/IEObjectDocumentationProvider.java
 create mode 100644 plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/MutiLineDocumentationProvider.java
 create mode 100644 plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/AbstractHtmlHoverContentProvider.java
 create mode 100644 plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/DeclarativeHtmlHoverConentProvider.java
 create mode 100644 plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/DefaultHtmlHoverContentProvider.java
 create mode 100644 plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/IHtmlHoverContentProvider.java
 create mode 100644 plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/OpenBrowserUtil.java
 create mode 100644 plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextBrowserInformationControlInput.java
 create mode 100644 plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextElementLinks.java
 create mode 100644 plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextHtmlHover.java

diff --git a/plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JavadocHoverWrapper.java b/plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JavadocHoverWrapper.java
new file mode 100644
index 0000000..43d5414
--- /dev/null
+++ b/plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JavadocHoverWrapper.java
@@ -0,0 +1,34 @@
+/*******************************************************************************
+ * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ *******************************************************************************/
+package org.eclipse.xtext.common.types.xtext.ui;
+
+import org.eclipse.jdt.core.IJavaElement;
+import org.eclipse.jdt.internal.ui.text.java.hover.JavadocHover;
+import org.eclipse.jface.text.IRegion;
+import org.eclipse.jface.text.ITextViewer;
+
+/**
+ * @author Christoph Kulla - Initial contribution and API
+ */
+@SuppressWarnings("restriction")
+public class JavadocHoverWrapper extends JavadocHover {
+
+	IJavaElement currentElement;
+	
+	void setJavaElement (IJavaElement element) {
+		currentElement = element;
+	}
+	
+	@Override
+	protected IJavaElement[] getJavaElementsAt(ITextViewer textViewer, IRegion hoverRegion) {
+		// hack: return previously registered element
+		// required as JavadocHover.getHoverInfo(IJavaElement[] elements,...) is private
+		return new IJavaElement[] { currentElement };
+	}	
+	
+}
diff --git a/plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JdtHover.java b/plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JdtHover.java
new file mode 100644
index 0000000..9e87844
--- /dev/null
+++ b/plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JdtHover.java
@@ -0,0 +1,77 @@
+/*******************************************************************************
+ * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ *******************************************************************************/
+package org.eclipse.xtext.common.types.xtext.ui;
+
+import org.eclipse.emf.ecore.EObject;
+import org.eclipse.jdt.core.IJavaElement;
+import org.eclipse.jface.text.IInformationControlCreator;
+import org.eclipse.jface.text.IRegion;
+import org.eclipse.jface.text.ITextViewer;
+import org.eclipse.xtext.common.types.JvmIdentifyableElement;
+import org.eclipse.xtext.common.types.util.jdt.IJavaElementFinder;
+import org.eclipse.xtext.parsetree.AbstractNode;
+import org.eclipse.xtext.resource.XtextResource;
+import org.eclipse.xtext.ui.editor.hover.AbstractXtextEditorHover;
+import org.eclipse.xtext.ui.editor.model.IXtextDocument;
+import org.eclipse.xtext.ui.editor.model.XtextDocumentUtil;
+import org.eclipse.xtext.util.Pair;
+import org.eclipse.xtext.util.concurrent.IUnitOfWork;
+
+import com.google.inject.Inject;
+
+/**
+ * @author Christoph Kulla - Initial contribution and API
+ */
+@SuppressWarnings("restriction")
+public class JdtHover extends AbstractXtextEditorHover {
+
+	@Inject
+	private IJavaElementFinder javaElementFinder;
+	
+	private JavadocHoverWrapper javadocHover = new JavadocHoverWrapper ();
+	
+	@Deprecated
+	public String getHoverInfo(ITextViewer textViewer, IRegion hoverRegion) {
+		Object o = getHoverInfo2(textViewer, hoverRegion);
+		if (o!=null) {
+			return o.toString();
+		}
+		return null;
+	}
+
+	public Object getHoverInfo2(final ITextViewer textViewer, final IRegion hoverRegion) {		
+		IXtextDocument xtextDocument = XtextDocumentUtil.get(textViewer);
+
+		JvmIdentifyableElement element = xtextDocument.readOnly(new IUnitOfWork<JvmIdentifyableElement, XtextResource>() {
+			public JvmIdentifyableElement exec(XtextResource state) throws Exception {
+				Pair<AbstractNode,EObject> element = getXtextElementAt(textViewer, hoverRegion);
+				if (element!=null && element.getSecond() instanceof JvmIdentifyableElement) {
+					return (JvmIdentifyableElement) element.getSecond();
+
+				} 
+				return null;
+			}		
+		});
+		 
+		if (element!=null) {	
+			IJavaElement javaElement = javaElementFinder.findElementFor(element);
+			if (javaElement!=null) {
+				javadocHover.setJavaElement(javaElement);
+				return javadocHover.getHoverInfo2(textViewer, hoverRegion);
+			}
+		}
+		return null;
+	}
+
+	@Override
+	public IInformationControlCreator getHoverControlCreator() {
+		return javadocHover.getHoverControlCreator();
+	}
+
+	
+}
diff --git a/plugins/org.eclipse.xtext.generator/src/org/eclipse/xtext/generator/types/TypesGeneratorFragment.java b/plugins/org.eclipse.xtext.generator/src/org/eclipse/xtext/generator/types/TypesGeneratorFragment.java
index 6369c1e..8cfd88b 100644
--- a/plugins/org.eclipse.xtext.generator/src/org/eclipse/xtext/generator/types/TypesGeneratorFragment.java
+++ b/plugins/org.eclipse.xtext.generator/src/org/eclipse/xtext/generator/types/TypesGeneratorFragment.java
@@ -19,6 +19,7 @@ import org.eclipse.xtext.common.types.xtext.TypesAwareDefaultGlobalScopeProvider
 import org.eclipse.xtext.generator.BindFactory;
 import org.eclipse.xtext.generator.Binding;
 import org.eclipse.xtext.generator.DefaultGeneratorFragment;
+import org.eclipse.xtext.parser.antlr.Lexer;
 import org.eclipse.xtext.scoping.IGlobalScopeProvider;
 
 /**
@@ -54,6 +55,10 @@ public class TypesGeneratorFragment extends DefaultGeneratorFragment {
 					 	"org.eclipse.xtext.common.types.xtext.ui.TypeAwareHyperlinkHelper")
 			 .addTypeToType("org.eclipse.xtext.ui.editor.contentassist.PrefixMatcher", 
 					 	"org.eclipse.xtext.ui.editor.contentassist.FQNPrefixMatcher")
+			 .addConfiguredBinding("AdditionalHover", 
+					"binder.bind(org.eclipse.jface.text.ITextHover.class)"+
+					".annotatedWith(com.google.inject.name.Names.named(org.eclipse.xtext.ui.editor.hover.DelegatingHover.ADDITIONAL_HOVER" +
+					")).to(org.eclipse.xtext.common.types.xtext.ui.JDTHover.class);")
 			 .addTypeToType("org.eclipse.xtext.ui.editor.contentassist.AbstractJavaBasedContentProposalProvider$ReferenceProposalCreator", 
 					 	"org.eclipse.xtext.common.types.xtext.ui.TypeAwareReferenceProposalCreator")
 			 .getBindings();
diff --git a/plugins/org.eclipse.xtext.ui/META-INF/MANIFEST.MF b/plugins/org.eclipse.xtext.ui/META-INF/MANIFEST.MF
index b15d5ac..5fbb9bc 100644
--- a/plugins/org.eclipse.xtext.ui/META-INF/MANIFEST.MF
+++ b/plugins/org.eclipse.xtext.ui/META-INF/MANIFEST.MF
@@ -36,6 +36,7 @@ Export-Package: org.eclipse.xtext.common.ui.contentassist,
  org.eclipse.xtext.ui.editor.formatting,
  org.eclipse.xtext.ui.editor.handler,
  org.eclipse.xtext.ui.editor.hover,
+ org.eclipse.xtext.ui.editor.hover.html,
  org.eclipse.xtext.ui.editor.hyperlinking,
  org.eclipse.xtext.ui.editor.info,
  org.eclipse.xtext.ui.editor.model,
diff --git a/plugins/org.eclipse.xtext.ui/XtextHoverStyleSheet.css b/plugins/org.eclipse.xtext.ui/XtextHoverStyleSheet.css
new file mode 100644
index 0000000..9cea29c
--- /dev/null
+++ b/plugins/org.eclipse.xtext.ui/XtextHoverStyleSheet.css
@@ -0,0 +1,34 @@
+/* Font definitions */
+html         { font-family: sans-serif; font-size: 9pt; font-style: normal; font-weight: normal; }
+body, h1, h2, h3, h4, h5, h6, p, table, td, caption, th, ul, ol, dl, li, dd, dt { font-size: 1em; }
+pre          { font-family: monospace; }
+
+/* Margins */
+body	     { overflow: auto; margin-top: 0px; margin-bottom: 0.5em; margin-left: 0.3em; margin-right: 0px; }
+h1           { margin-top: 0.3em; margin-bottom: 0.04em; }	
+h2           { margin-top: 2em; margin-bottom: 0.25em; }
+h3           { margin-top: 1.7em; margin-bottom: 0.25em; }
+h4           { margin-top: 2em; margin-bottom: 0.3em; }
+h5           { margin-top: 0px; margin-bottom: 0px; }
+p            { margin-top: 1em; margin-bottom: 1em; }
+pre          { margin-left: 0.6em; }
+ul	         { margin-top: 0px; margin-bottom: 1em; margin-left: 1em; padding-left: 1em;}
+li	         { margin-top: 0px; margin-bottom: 0px; } 
+li p	     { margin-top: 0px; margin-bottom: 0px; } 
+ol	         { margin-top: 0px; margin-bottom: 1em; margin-left: 1em; padding-left: 1em; }
+dl	         { margin-top: 0px; margin-bottom: 1em; }
+dt	         { margin-top: 0px; margin-bottom: 0px; font-weight: bold; }
+dd	         { margin-top: 0px; margin-bottom: 0px; }
+
+/* Styles and colors */
+a:link	     { color: #0000FF; }
+a:hover	     { color: #000080; }
+a:visited    { text-decoration: underline; }
+a.header:link    { text-decoration: none; color: InfoText }
+a.header:visited { text-decoration: none; color: InfoText }
+a.header:hover   { text-decoration: underline; color: #000080; }
+h4           { font-style: italic; }
+strong	     { font-weight: bold; }
+em	         { font-style: italic; }
+var	         { font-style: italic; }
+th	         { font-weight: bold; }
diff --git a/plugins/org.eclipse.xtext.ui/build.properties b/plugins/org.eclipse.xtext.ui/build.properties
index ea59b90..04659a5 100644
--- a/plugins/org.eclipse.xtext.ui/build.properties
+++ b/plugins/org.eclipse.xtext.ui/build.properties
@@ -5,4 +5,5 @@ bin.includes = META-INF/,\
                plugin.properties,\
                icons/,\
                about.html,\
-               schema/
+               schema/,\
+               XtextHoverStyleSheet.css
diff --git a/plugins/org.eclipse.xtext.ui/icons/dlcl16/goto_input.gif b/plugins/org.eclipse.xtext.ui/icons/dlcl16/goto_input.gif
new file mode 100644
index 0000000000000000000000000000000000000000..459ee003ba8f731dae0c12a8bfb93d27f35b9e86
GIT binary patch
literal 235
zcmZ?wbhEHb6krfwIKsg2|Ns9VKYo1v{Q33k*Uz6nzkU1m!Gi}695}Fl|NedZ_U+!i
zd)KaAJ9qBfv17;f?b|nR-n@GC>SfE8_4W1j^z?LgcDA*(wYIi4H#avmH8nIe)YjGl
z4P-z9ia%Kx85pD)bU<PtI~iCr9;o%DWJ+bMl2U!J&%k?^b1r{_jh7IQ{L;AfYzj=3
z9^vQ9XZ(os>lJBOz_RYf>V{7ZE)1O9i9T}S3_)BK%?D%jW_)})QzMl_(qZ9(=h|;7
e{Tb?wYpdHCxOJQKcvSiLxVR=xn#8BbU=0A>|7P6)

literal 0
HcmV?d00001

diff --git a/plugins/org.eclipse.xtext.ui/icons/elcl16/goto_input.gif b/plugins/org.eclipse.xtext.ui/icons/elcl16/goto_input.gif
new file mode 100644
index 0000000000000000000000000000000000000000..8ae589bc199b6fefcd00d66aad9ddf04c6e56da5
GIT binary patch
literal 372
zcmV-)0gL`eNk%w1VGsZi0M!5h!N%G6`TS>nsj0Wp^7Z@n`26+v`}z9(ZG)|MjI`nD
z_v`Ta>F@dS_4?uJ_~7aH;_LY2?D**K`Rnoe@bvok`TX|y`{3&M;Oh70?)l{G_w@Js
z<n8$5?DyvG_~`HW^7i}f^ZD}j`Y2+S_WApmn34SY+nk$?{{8QonUDMOxuc(npq-5S
z?y$SAdAO{6v#EZkp@+w{amBQ9!?JYy<(I#(cd({`tfPdzgci1Z6t;a8t#T5ra}uU&
z5dZ)GA^8LW002J#EC2ui01yBW000J&z@KnPEE;9Vq*7KqIG<1^F%SS)uYk&|n9Es6
zmO>$1pm9+-gLSjE{km`znjj*8KnhpR#P9QS6eEHZFFGoRh=(mZ2?zoqFg-Psl#@IQ
zf+G_*KR%wGlRgq35)7j_MLsn?9s>id0~s-?J`o%d9T5>45i3Oy5U#?m5G+Lx4;Km;
S4j2y@7$-#~)YaB0K>$0%*~$6<

literal 0
HcmV?d00001

diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java
index 7b76e2c..dca5548 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java
@@ -13,11 +13,13 @@ import org.eclipse.emf.edit.ui.provider.AdapterFactoryLabelProvider;
 import org.eclipse.jface.dialogs.IDialogSettings;
 import org.eclipse.jface.preference.IPreferenceStore;
 import org.eclipse.jface.text.IDocumentPartitioner;
+import org.eclipse.jface.text.ITextHover;
 import org.eclipse.jface.text.contentassist.IContentAssistProcessor;
 import org.eclipse.jface.text.hyperlink.IHyperlinkDetector;
 import org.eclipse.jface.text.presentation.IPresentationDamager;
 import org.eclipse.jface.text.presentation.IPresentationRepairer;
 import org.eclipse.jface.text.reconciler.IReconciler;
+import org.eclipse.jface.text.source.IAnnotationHover;
 import org.eclipse.jface.text.rules.IPartitionTokenScanner;
 import org.eclipse.jface.text.rules.ITokenScanner;
 import org.eclipse.jface.text.source.DefaultCharacterPairMatcher;
@@ -54,7 +56,15 @@ import org.eclipse.xtext.ui.editor.contentassist.XtextContentAssistProcessor;
 import org.eclipse.xtext.ui.editor.formatting.ContentFormatterFactory;
 import org.eclipse.xtext.ui.editor.formatting.IContentFormatterFactory;
 import org.eclipse.xtext.ui.editor.formatting.PreferenceStoreIndentationInformation;
+import org.eclipse.xtext.ui.editor.hover.ProblemHover;
+import org.eclipse.xtext.ui.editor.hover.DelegatingHover;
+import org.eclipse.xtext.ui.editor.hover.AnnotationWithQuickFixesHover;
+import org.eclipse.xtext.ui.editor.hover.html.DefaultHtmlHoverContentProvider;
+import org.eclipse.xtext.ui.editor.hover.html.IHtmlHoverContentProvider;
+import org.eclipse.xtext.ui.editor.hover.html.XtextHtmlHover;
 import org.eclipse.xtext.ui.editor.hyperlinking.DefaultHyperlinkDetector;
+import org.eclipse.xtext.ui.editor.model.IResourceForEditorInputFactory;
+import org.eclipse.xtext.ui.editor.model.JavaClassPathResourceForIEditorInputFactory;
 import org.eclipse.xtext.ui.editor.model.DocumentPartitioner;
 import org.eclipse.xtext.ui.editor.model.IResourceForEditorInputFactory;
 import org.eclipse.xtext.ui.editor.model.JavaClassPathResourceForIEditorInputFactory;
@@ -292,4 +302,17 @@ public class DefaultUiModule extends AbstractGenericModule {
 		return XtextResourceSetProvider.class;
 	}
 
+	public Class<? extends IAnnotationHover> bindAnnotationHover () {
+		return ProblemHover.class;		
+	}
+		 	
+	public void configureTextHover(com.google.inject.Binder binder) {
+		binder.bind(ITextHover.class).to(DelegatingHover.class);
+		binder.bind(ITextHover.class).annotatedWith(com.google.inject.name.Names.named(DelegatingHover.PRIORITY_HOVER)).to(AnnotationWithQuickFixesHover.class);
+		binder.bind(ITextHover.class).annotatedWith(com.google.inject.name.Names.named(DelegatingHover.DEFAULT_HOVER)).to(XtextHtmlHover.class);
+	}
+			
+	public Class<? extends IHtmlHoverContentProvider> bindHtmlHoverContentProvider () {
+		return DefaultHtmlHoverContentProvider.class;
+	}
 }
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java.rej b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java.rej
new file mode 100644
index 0000000..4536f78
--- /dev/null
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java.rej
@@ -0,0 +1,19 @@
+diff a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java	(rejected hunks)
+@@ -287,5 +297,17 @@ public class DefaultUiModule extends AbstractGenericModule {
+ 		return XtextResourceSetProvider.class;
+ 	}
+ 
++	public Class<? extends IAnnotationHover> bindAnnotationHover () {
++		return ProblemHover.class;		
++	}
+ 	
++	public void configureTextHover(com.google.inject.Binder binder) {
++		binder.bind(ITextHover.class).to(DelegatingHover.class);
++		binder.bind(ITextHover.class).annotatedWith(com.google.inject.name.Names.named(DelegatingHover.PRIORITY_HOVER)).to(AnnotationWithQuickFixesHover.class);
++		binder.bind(ITextHover.class).annotatedWith(com.google.inject.name.Names.named(DelegatingHover.DEFAULT_HOVER)).to(XtextHtmlHover.class);
++	}
++	
++	public Class<? extends IHtmlHoverContentProvider> bindHtmlHoverContentProvider () {
++		return DefaultHtmlHoverContentProvider.class;
++	}
+ }
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/XtextUIMessages.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/XtextUIMessages.java
index a285194..7ceb639 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/XtextUIMessages.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/XtextUIMessages.java
@@ -20,7 +20,7 @@ import com.ibm.icu.text.MessageFormat;
  * Singleton for all message bundle classes used from within
  * <i>org.eclipse.xtext.ui</i>.
  * 
- * @author Dennis Hübner - Initial contribution and API
+ * @author Dennis H¸bner - Initial contribution and API
  * @author Michael Clay
  * @see org.eclipse.osgi.util.NLS
  * 
@@ -87,4 +87,16 @@ public class XtextUIMessages extends NLS {
 	public static String ToggleLinkWithEditorAction_description;
 	public static String ToggleLinkWithEditorAction_label;
 	public static String ToggleLinkWithEditorAction_toolTip;
+	
+	/**
+	 * messages for hover
+	 */
+	public static String XtextBrowserInformationControlInput_Back;
+	public static String XtextBrowserInformationControlInput_BackTo;
+	public static String XtextBrowserInformationControlInput_Forward;
+	public static String XtextBrowserInformationControlInput_ForwardTo;
+	public static String XtextBrowserInformationControlInput_OpenDeclaration;
+	public static String AnnotationWithQuickFixesHover_message_singleQuickFix;
+	public static String AnnotationWithQuickFixesHover_message_multipleQuickFix;
+
 }
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/XtextSourceViewerConfiguration.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/XtextSourceViewerConfiguration.java
index d57a040..208a6ba 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/XtextSourceViewerConfiguration.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/XtextSourceViewerConfiguration.java
@@ -72,14 +72,28 @@ public class XtextSourceViewerConfiguration extends TextSourceViewerConfiguratio
 	@Inject
 	private ITokenTypeToPartitionTypeMapper partitionTypesMapper;
 	
+	@Inject
+	private Provider<IAnnotationHover> annotationHoverProvider;
+
+	@Inject
+	private Provider<ITextHover> textHoverProvider;
+	
 	@Override
 	public IAnnotationHover getAnnotationHover(ISourceViewer sourceViewer) {
-		return new ProblemHover(sourceViewer);
+		IAnnotationHover hover = annotationHoverProvider.get();
+		if (hover instanceof ISourceViewerAware) {
+			((ISourceViewerAware) hover).setSourceViewer(sourceViewer);
+		}
+		return hover;
 	}
 	
 	@Override
 	public ITextHover getTextHover(ISourceViewer sourceViewer, String contentType) {
-		return new ProblemHover(sourceViewer);
+		ITextHover hover = textHoverProvider.get();
+		if (hover instanceof ISourceViewerAware) {
+			((ISourceViewerAware) hover).setSourceViewer(sourceViewer);
+		}
+		return hover;
 	}
 
 	@Inject(optional = true)
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractHover.java
index d73aad7..b10bc9b 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractHover.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractHover.java
@@ -22,19 +22,17 @@ import org.eclipse.jface.text.source.IAnnotationHover;
 import org.eclipse.jface.text.source.ISourceViewer;
 import org.eclipse.swt.graphics.Point;
 import org.eclipse.xtext.ui.XtextUIMessages;
+import org.eclipse.xtext.ui.editor.ISourceViewerAware;
 
 /**
  * @author Patrick Schoenbach - Initial API and implementation
  */
-public abstract class AbstractHover implements IAnnotationHover, ITextHover, ITextHoverExtension2 {
+public abstract class AbstractHover implements IAnnotationHover, ITextHover, ITextHoverExtension2, ISourceViewerAware {
 
-	protected final ISourceViewer sourceViewer;
+	protected ISourceViewer sourceViewer;
 
-	public AbstractHover(final ISourceViewer sourceViewer) {
-		if (sourceViewer == null)
-			throw new IllegalArgumentException();
-
-		this.sourceViewer = sourceViewer;
+	public void setSourceViewer(ISourceViewer sourceViewer) {
+		this.sourceViewer = sourceViewer;		
 	}
 
 	public IDocument getDocument() {
@@ -54,7 +52,7 @@ public abstract class AbstractHover implements IAnnotationHover, ITextHover, ITe
 	public String getHoverInfo2(final ITextViewer textViewer, final IRegion hoverRegion) {
 		int lineNumber;
 		try {
-			lineNumber = getDocument().getLineOfOffset(hoverRegion.getOffset());
+			lineNumber = textViewer.getDocument().getLineOfOffset(hoverRegion.getOffset());
 		}
 		catch (final BadLocationException e) {
 			return null;
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractXtextEditorHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractXtextEditorHover.java
new file mode 100644
index 0000000..66842d7
--- /dev/null
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractXtextEditorHover.java
@@ -0,0 +1,114 @@
+/*******************************************************************************
+ * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ *******************************************************************************/
+package org.eclipse.xtext.ui.editor.hover;
+
+import java.util.List;
+
+import org.eclipse.emf.ecore.EObject;
+import org.eclipse.emf.ecore.EStructuralFeature;
+import org.eclipse.jface.text.DefaultInformationControl;
+import org.eclipse.jface.text.IInformationControl;
+import org.eclipse.jface.text.IInformationControlCreator;
+import org.eclipse.jface.text.IRegion;
+import org.eclipse.jface.text.ITextHover;
+import org.eclipse.jface.text.ITextHoverExtension;
+import org.eclipse.jface.text.ITextHoverExtension2;
+import org.eclipse.jface.text.ITextViewer;
+import org.eclipse.jface.text.Region;
+import org.eclipse.swt.widgets.Shell;
+import org.eclipse.ui.editors.text.EditorsUI;
+import org.eclipse.xtext.parsetree.AbstractNode;
+import org.eclipse.xtext.parsetree.CompositeNode;
+import org.eclipse.xtext.parsetree.NodeUtil;
+import org.eclipse.xtext.parsetree.ParseTreeUtil;
+import org.eclipse.xtext.resource.EObjectAtOffsetHelper;
+import org.eclipse.xtext.resource.XtextResource;
+import org.eclipse.xtext.ui.editor.model.IXtextDocument;
+import org.eclipse.xtext.ui.editor.model.XtextDocumentUtil;
+import org.eclipse.xtext.util.Pair;
+import org.eclipse.xtext.util.Tuples;
+import org.eclipse.xtext.util.concurrent.IUnitOfWork;
+
+import com.google.inject.Inject;
+
+/**
+ * @author Christoph Kulla - Initial contribution and API
+ */
+public abstract class AbstractXtextEditorHover implements ITextHover, ITextHoverExtension, ITextHoverExtension2 {
+
+	@Inject
+	private EObjectAtOffsetHelper eObjectAtOffsetHelper;
+	
+	public IRegion getHoverRegion(ITextViewer textViewer, int offset) {
+		Pair<AbstractNode, EObject> element = getXtextElementAt(textViewer, offset);
+		if (element != null) {
+			return new Region(element.getFirst().getOffset(), element.getFirst().getLength());
+		} else {
+			return null;
+		}
+	}
+
+	/*
+	 * @see ITextHoverExtension#getHoverControlCreator()
+	 * @since 3.0
+	 */
+	public IInformationControlCreator getHoverControlCreator() {
+		return new IInformationControlCreator() {
+			public IInformationControl createInformationControl(Shell parent) {
+				return new DefaultInformationControl(parent, EditorsUI.getTooltipAffordanceString());
+			}
+		};
+	}
+
+	protected Pair<AbstractNode, EObject> getXtextElementAt(ITextViewer textViewer, final IRegion hoverRegion) {
+		return getXtextElementAt(textViewer, hoverRegion.getOffset());
+	}
+
+	protected Pair<AbstractNode, EObject> getXtextElementAt(ITextViewer textViewer, final int offset) {
+		IXtextDocument xtextDocument = XtextDocumentUtil.get(textViewer);
+		return xtextDocument.readOnly(new IUnitOfWork<Pair<AbstractNode, EObject>, XtextResource>() {
+
+			public Pair<AbstractNode, EObject> exec(XtextResource state) throws Exception {
+				AbstractNode an = ParseTreeUtil.getCurrentOrFollowingNodeByOffset(state.getParseResult().getRootNode(), offset);
+				
+				{
+					// check assignment to name
+					EObject o = NodeUtil.findASTElement(an);
+					if (o!=null) {
+						EStructuralFeature nameFeature = o.eClass().getEStructuralFeature("name");
+						if (nameFeature!=null) {
+							List<AbstractNode> nodes = NodeUtil.findNodesForFeature (o, nameFeature);
+							if (contains(nodes, an))
+								return Tuples.create(an, o);
+						}
+					}
+				}
+				
+				// check cross reference
+				EObject crossLinkedEObject = eObjectAtOffsetHelper.resolveCrossReferencedElementAt(state, offset);
+				if (crossLinkedEObject != null && !crossLinkedEObject.eIsProxy()) {
+					return Tuples.create(an, crossLinkedEObject);
+				}
+				return null;
+			}
+
+			private boolean contains(List<AbstractNode> nodes, AbstractNode an) {
+				for (AbstractNode n: nodes) {
+					if (n==an) 
+						return true;
+					if (n instanceof CompositeNode) {
+						if (contains (((CompositeNode) n).getChildren(), an))
+							return true;
+					}
+				}
+				return false;
+			}
+		});
+	}
+	
+}
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AnnotationWithQuickFixesHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AnnotationWithQuickFixesHover.java
new file mode 100644
index 0000000..b358cd1
--- /dev/null
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AnnotationWithQuickFixesHover.java
@@ -0,0 +1,750 @@
+/*******************************************************************************
+ * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ *******************************************************************************/
+
+package org.eclipse.xtext.ui.editor.hover;
+
+import java.text.MessageFormat;
+import java.util.ArrayList;
+import java.util.Iterator;
+import java.util.List;
+
+import org.eclipse.core.runtime.Assert;
+import org.eclipse.jface.action.ToolBarManager;
+import org.eclipse.jface.resource.JFaceResources;
+import org.eclipse.jface.text.AbstractInformationControl;
+import org.eclipse.jface.text.AbstractReusableInformationControlCreator;
+import org.eclipse.jface.text.BadLocationException;
+import org.eclipse.jface.text.IDocument;
+import org.eclipse.jface.text.IInformationControl;
+import org.eclipse.jface.text.IInformationControlCreator;
+import org.eclipse.jface.text.IInformationControlExtension2;
+import org.eclipse.jface.text.IInformationControlExtension4;
+import org.eclipse.jface.text.IRegion;
+import org.eclipse.jface.text.IRewriteTarget;
+import org.eclipse.jface.text.ITextHover;
+import org.eclipse.jface.text.ITextHoverExtension;
+import org.eclipse.jface.text.ITextHoverExtension2;
+import org.eclipse.jface.text.ITextViewer;
+import org.eclipse.jface.text.ITextViewerExtension;
+import org.eclipse.jface.text.Position;
+import org.eclipse.jface.text.Region;
+import org.eclipse.jface.text.contentassist.ICompletionProposal;
+import org.eclipse.jface.text.contentassist.ICompletionProposalExtension;
+import org.eclipse.jface.text.contentassist.ICompletionProposalExtension2;
+import org.eclipse.jface.text.quickassist.IQuickAssistInvocationContext;
+import org.eclipse.jface.text.source.Annotation;
+import org.eclipse.jface.text.source.IAnnotationModel;
+import org.eclipse.jface.text.source.ILineDiffInfo;
+import org.eclipse.jface.text.source.ISourceViewer;
+import org.eclipse.jface.text.source.TextInvocationContext;
+import org.eclipse.swt.SWT;
+import org.eclipse.swt.custom.ScrolledComposite;
+import org.eclipse.swt.custom.StyledText;
+import org.eclipse.swt.events.FocusEvent;
+import org.eclipse.swt.events.FocusListener;
+import org.eclipse.swt.events.KeyEvent;
+import org.eclipse.swt.events.KeyListener;
+import org.eclipse.swt.events.MouseEvent;
+import org.eclipse.swt.events.MouseListener;
+import org.eclipse.swt.events.PaintEvent;
+import org.eclipse.swt.events.PaintListener;
+import org.eclipse.swt.events.SelectionAdapter;
+import org.eclipse.swt.events.SelectionEvent;
+import org.eclipse.swt.graphics.Color;
+import org.eclipse.swt.graphics.Font;
+import org.eclipse.swt.graphics.Image;
+import org.eclipse.swt.graphics.Point;
+import org.eclipse.swt.graphics.Rectangle;
+import org.eclipse.swt.layout.GridData;
+import org.eclipse.swt.layout.GridLayout;
+import org.eclipse.swt.widgets.Canvas;
+import org.eclipse.swt.widgets.Composite;
+import org.eclipse.swt.widgets.Control;
+import org.eclipse.swt.widgets.Display;
+import org.eclipse.swt.widgets.Label;
+import org.eclipse.swt.widgets.Link;
+import org.eclipse.swt.widgets.ScrollBar;
+import org.eclipse.swt.widgets.Shell;
+import org.eclipse.ui.editors.text.EditorsUI;
+import org.eclipse.ui.texteditor.DefaultMarkerAnnotationAccess;
+import org.eclipse.xtext.ui.XtextUIMessages;
+import org.eclipse.xtext.ui.editor.ISourceViewerAware;
+import org.eclipse.xtext.ui.editor.quickfix.XtextQuickAssistProcessor;
+
+import com.google.inject.Inject;
+
+/**
+ * Hover which shows annotation and quick fixes. 
+ * 
+ * Clone from JDTs {@link org.eclipse.jdt.internal.ui.text.java.hover.AbstractAnnotationHover}
+ *
+ * @author Christoph Kulla
+ */
+public class AnnotationWithQuickFixesHover implements ITextHover, ITextHoverExtension, ITextHoverExtension2, ISourceViewerAware {
+	
+	@Inject
+	private XtextQuickAssistProcessor quickAssistProcessor;
+
+	protected static class AnnotationInfo {
+		public final Annotation annotation;
+		public final Position position;
+		public final ITextViewer viewer;
+		public final ICompletionProposal[] proposals;
+		
+		public AnnotationInfo(Annotation annotation, Position position, ITextViewer textViewer, ICompletionProposal[] proposals) {
+			this.annotation= annotation;
+			this.position= position;
+			this.viewer= textViewer;
+			this.proposals = proposals;
+		}
+
+		/**
+		 * Create completion proposals which can resolve the given annotation at
+		 * the given position. Returns an empty array if no such proposals exist.
+		 *
+		 * @return the proposals or an empty array
+		 */
+		public ICompletionProposal[] getCompletionProposals() {
+			return proposals;
+		}
+
+		/**
+		 * Adds actions to the given toolbar.
+		 *
+		 * @param manager the toolbar manager to add actions to
+		 * @param infoControl the information control
+		 */
+		public void fillToolBar(ToolBarManager manager, IInformationControl infoControl) {
+//			ConfigureAnnotationsAction configureAnnotationsAction= new ConfigureAnnotationsAction(annotation, infoControl);
+//			manager.add(configureAnnotationsAction);
+		}
+	}
+
+	private static class AnnotationInformationControl extends AbstractInformationControl implements IInformationControlExtension2 {
+
+		private final DefaultMarkerAnnotationAccess fMarkerAnnotationAccess;
+		private Control fFocusControl;
+		private AnnotationInfo fInput;
+		private Composite fParent;
+
+		public AnnotationInformationControl(Shell parentShell, String statusFieldText) {
+			super(parentShell, statusFieldText);
+			fMarkerAnnotationAccess= new DefaultMarkerAnnotationAccess();
+			create();
+		}
+
+		public AnnotationInformationControl(Shell parentShell, ToolBarManager toolBarManager) {
+			super(parentShell, toolBarManager);
+			fMarkerAnnotationAccess= new DefaultMarkerAnnotationAccess();
+			create();
+		}
+		
+		public AnnotationInformationControl(Shell parentShell, boolean resizeable) {
+			super(parentShell, resizeable);
+			fMarkerAnnotationAccess= new DefaultMarkerAnnotationAccess();
+			create();
+		}		
+
+		public void setInput(Object input) {
+			Assert.isLegal(input instanceof AnnotationInfo);
+			fInput= (AnnotationInfo)input;
+			disposeDeferredCreatedContent();
+			deferredCreateContent();
+		}
+
+		public boolean hasContents() {
+			return fInput != null;
+		}
+
+		private AnnotationInfo getAnnotationInfo() {
+			return fInput;
+		}
+
+		@Override
+		public void setFocus() {
+			super.setFocus();
+			if (fFocusControl != null)
+				fFocusControl.setFocus();
+		}
+
+		@Override
+		public final void setVisible(boolean visible) {
+			if (!visible)
+				disposeDeferredCreatedContent();
+			super.setVisible(visible);
+		}
+
+		protected void disposeDeferredCreatedContent() {
+			Control[] children= fParent.getChildren();
+			for (int i= 0; i < children.length; i++) {
+				children[i].dispose();
+			}
+			ToolBarManager toolBarManager= getToolBarManager();
+			if (toolBarManager != null)
+				toolBarManager.removeAll();
+		}
+
+		/*
+		 * @see org.eclipse.jface.text.AbstractInformationControl#createContent(org.eclipse.swt.widgets.Composite)
+		 */
+		@Override
+		protected void createContent(Composite parent) {
+			fParent= parent;
+			GridLayout layout= new GridLayout(1, false);
+			layout.verticalSpacing= 0;
+			layout.marginWidth= 0;
+			layout.marginHeight= 0;
+			fParent.setLayout(layout);
+		}
+
+		@Override
+		public Point computeSizeHint() {
+			Point preferedSize= getShell().computeSize(SWT.DEFAULT, SWT.DEFAULT, true);
+
+			Point constrains= getSizeConstraints();
+			if (constrains == null)
+				return preferedSize;
+
+			Point constrainedSize= getShell().computeSize(constrains.x, SWT.DEFAULT, true);
+
+			int width= Math.min(preferedSize.x, constrainedSize.x);
+			int height= Math.max(preferedSize.y, constrainedSize.y);
+
+			return new Point(width, height);
+		}
+
+		/**
+		 * Fills the toolbar actions, if a toolbar is available. This
+		 * is called after the input has been set.
+		 */
+		protected void fillToolbar() {
+			ToolBarManager toolBarManager= getToolBarManager();
+			if (toolBarManager == null)
+				return;
+			fInput.fillToolBar(toolBarManager, this);
+			toolBarManager.update(true);
+		}
+
+		/**
+		 * Create content of the hover. This is called after
+		 * the input has been set.
+		 */
+		protected void deferredCreateContent() {
+			fillToolbar();
+
+			createAnnotationInformation(fParent, getAnnotationInfo().annotation);
+			setColorAndFont(fParent, fParent.getForeground(), fParent.getBackground(), JFaceResources.getDialogFont());
+
+			ICompletionProposal[] proposals= getAnnotationInfo().getCompletionProposals();
+			if (proposals.length > 0)
+				createCompletionProposalsControl(fParent, proposals);
+
+			fParent.layout(true);
+		}
+
+		private void setColorAndFont(Control control, Color foreground, Color background, Font font) {
+			control.setForeground(foreground);
+			control.setBackground(background);
+			control.setFont(font);
+
+			if (control instanceof Composite) {
+				Control[] children= ((Composite) control).getChildren();
+				for (int i= 0; i < children.length; i++) {
+					setColorAndFont(children[i], foreground, background, font);
+				}
+			}
+		}
+
+		private void createAnnotationInformation(Composite parent, final Annotation annotation) {
+			Composite composite= new Composite(parent, SWT.NONE);
+			composite.setLayoutData(new GridData(SWT.FILL, SWT.TOP, true, false));
+			GridLayout layout= new GridLayout(2, false);
+			layout.marginHeight= 2;
+			layout.marginWidth= 2;
+			layout.horizontalSpacing= 0;
+			composite.setLayout(layout);
+
+			final Canvas canvas= new Canvas(composite, SWT.NO_FOCUS);
+			GridData gridData= new GridData(SWT.BEGINNING, SWT.BEGINNING, false, false);
+			gridData.widthHint= 17;
+			gridData.heightHint= 16;
+			canvas.setLayoutData(gridData);
+			canvas.addPaintListener(new PaintListener() {
+				public void paintControl(PaintEvent e) {
+					e.gc.setFont(null);
+					fMarkerAnnotationAccess.paint(annotation, e.gc, canvas, new Rectangle(0, 0, 16, 16));
+				}
+			});
+
+			StyledText text= new StyledText(composite, SWT.MULTI | SWT.WRAP | SWT.READ_ONLY);
+			GridData data= new GridData(SWT.FILL, SWT.FILL, true, true);
+			text.setLayoutData(data);
+			String annotationText= annotation.getText();
+			if (annotationText != null)
+				text.setText(annotationText);
+		}
+
+		private void createCompletionProposalsControl(Composite parent, ICompletionProposal[] proposals) {
+			Composite composite= new Composite(parent, SWT.NONE);
+			composite.setLayoutData(new GridData(SWT.FILL, SWT.FILL, true, true));
+			GridLayout layout2= new GridLayout(1, false);
+			layout2.marginHeight= 0;
+			layout2.marginWidth= 0;
+			layout2.verticalSpacing= 2;
+			composite.setLayout(layout2);
+
+			Label separator= new Label(composite, SWT.SEPARATOR | SWT.HORIZONTAL);
+			GridData gridData= new GridData(SWT.FILL, SWT.CENTER, true, false);
+			separator.setLayoutData(gridData);
+
+			Label quickFixLabel= new Label(composite, SWT.NONE);
+			GridData layoutData= new GridData(SWT.BEGINNING, SWT.CENTER, false, false);
+			layoutData.horizontalIndent= 4;
+			quickFixLabel.setLayoutData(layoutData);
+			String text;
+			if (proposals.length == 1) {
+				text= XtextUIMessages.AnnotationWithQuickFixesHover_message_singleQuickFix;
+			} else {
+				text= MessageFormat.format(XtextUIMessages.AnnotationWithQuickFixesHover_message_multipleQuickFix, new Object[] { String.valueOf(proposals.length) });
+			}
+			quickFixLabel.setText(text);
+
+			setColorAndFont(composite, parent.getForeground(), parent.getBackground(), JFaceResources.getDialogFont());
+			createCompletionProposalsList(composite, proposals);
+		}
+
+		private void createCompletionProposalsList(Composite parent, ICompletionProposal[] proposals) {
+			final ScrolledComposite scrolledComposite= new ScrolledComposite(parent, SWT.V_SCROLL | SWT.H_SCROLL);
+			GridData gridData= new GridData(SWT.FILL, SWT.FILL, true, true);
+			scrolledComposite.setLayoutData(gridData);
+			scrolledComposite.setExpandVertical(false);
+			scrolledComposite.setExpandHorizontal(false);
+
+			Composite composite= new Composite(scrolledComposite, SWT.NONE);
+			composite.setLayoutData(new GridData(SWT.FILL, SWT.FILL, true, true));
+			GridLayout layout= new GridLayout(2, false);
+			layout.marginLeft= 5;
+			layout.verticalSpacing= 2;
+			composite.setLayout(layout);
+			
+			List<Link> list= new ArrayList<Link>();
+			for (int i= 0; i < proposals.length; i++) {
+				list.add(createCompletionProposalLink(composite, proposals[i], 1));// Original link for single fix, hence pass 1 for count
+
+//				if (proposals[i] instanceof FixCorrectionProposal) {
+//					FixCorrectionProposal proposal= (FixCorrectionProposal)proposals[i];
+//					int count= proposal.computeNumberOfFixesForCleanUp(proposal.getCleanUp());
+//					if (count > 1) {
+//						list.add(createCompletionProposalLink(composite, proposals[i], count));
+//					}
+//				}
+			}
+			final Link[] links= list.toArray(new Link[list.size()]);
+
+			scrolledComposite.setContent(composite);
+			setColorAndFont(scrolledComposite, parent.getForeground(), parent.getBackground(), JFaceResources.getDialogFont());
+
+			Point contentSize= composite.computeSize(SWT.DEFAULT, SWT.DEFAULT);
+			composite.setSize(contentSize);
+
+			Point constraints= getSizeConstraints();
+			if (constraints != null && contentSize.x < constraints.x) {
+				ScrollBar horizontalBar= scrolledComposite.getHorizontalBar();
+
+				int scrollBarHeight;
+				if (horizontalBar == null) {
+					Point scrollSize= scrolledComposite.computeSize(SWT.DEFAULT, SWT.DEFAULT);
+					scrollBarHeight= scrollSize.y - contentSize.y;
+				} else {
+					scrollBarHeight= horizontalBar.getSize().y;
+				}
+				gridData.heightHint= contentSize.y - scrollBarHeight;
+			}
+
+			fFocusControl= links[0];
+			for (int i= 0; i < links.length; i++) {
+				final int index= i;
+				final Link link= links[index];
+				link.addKeyListener(new KeyListener() {
+					public void keyPressed(KeyEvent e) {
+						switch (e.keyCode) {
+							case SWT.ARROW_DOWN:
+								if (index + 1 < links.length) {
+									links[index + 1].setFocus();
+								}
+								break;
+							case SWT.ARROW_UP:
+								if (index > 0) {
+									links[index - 1].setFocus();
+								}
+								break;
+							default:
+								break;
+						}
+					}
+
+					public void keyReleased(KeyEvent e) {
+					}
+				});
+
+				link.addFocusListener(new FocusListener() {
+					public void focusGained(FocusEvent e) {
+						int currentPosition= scrolledComposite.getOrigin().y;
+						int hight= scrolledComposite.getSize().y;
+						int linkPosition= link.getLocation().y;
+
+						if (linkPosition < currentPosition) {
+							if (linkPosition < 10)
+								linkPosition= 0;
+
+							scrolledComposite.setOrigin(0, linkPosition);
+						} else if (linkPosition + 20 > currentPosition + hight) {
+							scrolledComposite.setOrigin(0, linkPosition - hight + link.getSize().y);
+						}
+					}
+
+					public void focusLost(FocusEvent e) {
+					}
+				});
+			}
+		}
+
+		private Link createCompletionProposalLink(Composite parent, final ICompletionProposal proposal, int count) {
+			final boolean isMultiFix= count > 1;
+			if (isMultiFix) {
+				new Label(parent, SWT.NONE); // spacer to fill image cell
+				parent= new Composite(parent, SWT.NONE); // indented composite for multi-fix
+				GridLayout layout= new GridLayout(2, false);
+				layout.marginWidth= 0;
+				layout.marginHeight= 0;
+				parent.setLayout(layout);
+			}
+			
+			Label proposalImage= new Label(parent, SWT.NONE);
+			proposalImage.setLayoutData(new GridData(SWT.BEGINNING, SWT.CENTER, false, false));
+			Image image= /*isMultiFix ? JavaPluginImages.get(JavaPluginImages.IMG_CORRECTION_MULTI_FIX) : */proposal.getImage();
+			if (image != null) {
+				proposalImage.setImage(image);
+
+				proposalImage.addMouseListener(new MouseListener() {
+
+					public void mouseDoubleClick(MouseEvent e) {
+					}
+
+					public void mouseDown(MouseEvent e) {
+					}
+
+					public void mouseUp(MouseEvent e) {
+						if (e.button == 1) {
+							apply(proposal, fInput.viewer, fInput.position.offset, isMultiFix);
+						}
+					}
+
+				});
+			}
+
+			Link proposalLink= new Link(parent, SWT.WRAP);
+			GridData layoutData= new GridData(SWT.BEGINNING, SWT.CENTER, false, false);
+			String linkText;
+			if (isMultiFix) {
+				linkText= MessageFormat.format(XtextUIMessages.AnnotationWithQuickFixesHover_message_multipleQuickFix, new Object[] { String.valueOf(count) });
+			} else {
+				linkText= proposal.getDisplayString();
+			}
+			proposalLink.setText("<a>" + linkText + "</a>"); //$NON-NLS-1$ //$NON-NLS-2$
+			proposalLink.setLayoutData(layoutData);
+			proposalLink.addSelectionListener(new SelectionAdapter() {
+
+				@Override
+				public void widgetSelected(SelectionEvent e) {
+					apply(proposal, fInput.viewer, fInput.position.offset, isMultiFix);
+				}
+			});
+			return proposalLink;
+		}
+
+		private void apply(ICompletionProposal p, ITextViewer viewer, int offset, boolean isMultiFix) {
+			//Focus needs to be in the text viewer, otherwise linked mode does not work
+			dispose();
+
+			IRewriteTarget target= null;
+			try {
+				IDocument document= viewer.getDocument();
+
+				if (viewer instanceof ITextViewerExtension) {
+					ITextViewerExtension extension= (ITextViewerExtension) viewer;
+					target= extension.getRewriteTarget();
+				}
+
+				if (target != null)
+					target.beginCompoundChange();
+
+				if (p instanceof ICompletionProposalExtension2) {
+					ICompletionProposalExtension2 e= (ICompletionProposalExtension2) p;
+					e.apply(viewer, (char) 0, isMultiFix ? SWT.CONTROL : SWT.NONE, offset);
+				} else if (p instanceof ICompletionProposalExtension) {
+					ICompletionProposalExtension e= (ICompletionProposalExtension) p;
+					e.apply(document, (char) 0, offset);
+				} else {
+					p.apply(document);
+				}
+
+				Point selection= p.getSelection(document);
+				if (selection != null) {
+					viewer.setSelectedRange(selection.x, selection.y);
+					viewer.revealRange(selection.x, selection.y);
+				}
+			} finally {
+				if (target != null)
+					target.endCompoundChange();
+			}
+		}
+	}
+
+	private static final class PresenterControlCreator extends AbstractReusableInformationControlCreator {
+
+		@Override
+		public IInformationControl doCreateInformationControl(Shell parent) {
+			return new AnnotationInformationControl(parent, true);
+		}
+	}
+
+	private static final class HoverControlCreator extends AbstractReusableInformationControlCreator {
+		private final IInformationControlCreator fPresenterControlCreator;
+
+		public HoverControlCreator(IInformationControlCreator presenterControlCreator) {
+			fPresenterControlCreator= presenterControlCreator;
+		}
+
+		@Override
+		public IInformationControl doCreateInformationControl(Shell parent) {
+			return new AnnotationInformationControl(parent, EditorsUI.getTooltipAffordanceString()) {
+
+				@Override
+				public IInformationControlCreator getInformationPresenterControlCreator() {
+					return fPresenterControlCreator;
+				}
+			};
+		}
+
+		@Override
+		public boolean canReuse(IInformationControl control) {
+			if (!super.canReuse(control))
+				return false;
+
+			if (control instanceof IInformationControlExtension4)
+				((IInformationControlExtension4) control).setStatusText(EditorsUI.getTooltipAffordanceString());
+
+			return true;
+		}
+	}
+
+	private final class CompletionProposalRunnable implements Runnable {
+		
+		public ICompletionProposal[] proposals = null;
+		IQuickAssistInvocationContext invocationContext;
+		
+		public CompletionProposalRunnable(IQuickAssistInvocationContext invocationContext) {
+			this.invocationContext = invocationContext;
+		}
+
+		public void run() {
+			proposals = quickAssistProcessor.computeQuickAssistProposals(invocationContext);
+		}
+	}
+	
+//	/**
+//	 * Action to configure the annotation preferences.
+//	 *
+//	 * @since 3.4
+//	 */
+//	private static final class ConfigureAnnotationsAction extends Action {
+//
+//		private final Annotation fAnnotation;
+//		private final IInformationControl fInfoControl;
+//
+//		public ConfigureAnnotationsAction(Annotation annotation, IInformationControl infoControl) {
+//			super();
+//			fAnnotation= annotation;
+//			fInfoControl= infoControl;
+//			setImageDescriptor(JavaPluginImages.DESC_ELCL_CONFIGURE_ANNOTATIONS);
+//			setDisabledImageDescriptor(JavaPluginImages.DESC_DLCL_CONFIGURE_ANNOTATIONS);
+//			setToolTipText(JavaHoverMessages.AbstractAnnotationHover_action_configureAnnotationPreferences);
+//		}
+//
+//		/*
+//		 * @see org.eclipse.jface.action.Action#run()
+//		 */
+//		@Override
+//		public void run() {
+//			Shell shell= PlatformUI.getWorkbench().getActiveWorkbenchWindow().getShell();
+//
+//			Object data= null;
+//			AnnotationPreference preference= getAnnotationPreference(fAnnotation);
+//			if (preference != null)
+//				data= preference.getPreferenceLabel();
+//
+//			fInfoControl.dispose(); //FIXME: should have protocol to hide, rather than dispose
+//			PreferencesUtil.createPreferenceDialogOn(shell, "org.eclipse.ui.editors.preferencePages.Annotations", null, data).open(); //$NON-NLS-1$
+//		}
+//	}
+
+//	private final IPreferenceStore fStore= JavaPlugin.getDefault().getCombinedPreferenceStore();
+
+	private IInformationControlCreator fHoverControlCreator;
+
+	private IInformationControlCreator fPresenterControlCreator;
+
+	private ISourceViewer sourceViewer;
+
+
+	public AnnotationWithQuickFixesHover() {
+	}
+
+	public IRegion getHoverRegion(final ITextViewer textViewer, final int offset) {
+		int lineNumber;
+		try {
+			lineNumber = textViewer.getDocument().getLineOfOffset(offset);
+			return getHoverRegionInternal(lineNumber, offset);
+		} catch (BadLocationException e) {
+			return null;
+		}
+	}
+	
+	protected Region getHoverRegionInternal(final int lineNumber,
+			final int offset) {
+		final IAnnotationModel model = getAnnotationModel();
+		if(model == null) {
+			return null;
+		}
+		final Iterator<?> iterator = model.getAnnotationIterator();
+		while (iterator.hasNext()) {
+			final Annotation annotation = (Annotation) iterator.next();
+			if (!annotation.isMarkedDeleted()) {
+				Position position = model.getPosition(annotation);
+				if (position != null) {
+					final int start = position.getOffset();
+					final int end = start + position.getLength();
+		
+					if (offset > 0 && !(start <= offset && offset <= end)) {
+						continue;
+					}
+					try {
+						if (lineNumber != sourceViewer.getDocument().getLineOfOffset(
+								start)) {
+							continue;
+						}
+					} catch (final Exception x) {
+						continue;
+					}
+					if (!isLineDiffInfo(annotation)) {
+						return new Region (start, position.getLength());
+					}
+				}
+			}
+		}
+		return null;
+	}
+	
+	@Deprecated
+	public String getHoverInfo(ITextViewer textViewer, IRegion hoverRegion) {
+		Object o = getHoverInfo2(textViewer, hoverRegion);
+		if (o!=null)
+			return o.toString();
+		return null;
+	}
+
+	public Object getHoverInfo2(final ITextViewer textViewer, final IRegion hoverRegion) {
+		int lineNumber;
+		try {
+			lineNumber = textViewer.getDocument().getLineOfOffset(hoverRegion.getOffset());
+		}
+		catch (final BadLocationException e) {
+			return null;
+		}
+		return getHoverInfoInternal(lineNumber, hoverRegion.getOffset());
+	}
+
+	protected Object getHoverInfoInternal(final int lineNumber, final int offset) {
+		final IAnnotationModel model = getAnnotationModel();
+		if(model == null) {
+			return null;
+		}
+		final Iterator<?> iterator = model.getAnnotationIterator();
+		while (iterator.hasNext()) {
+			final Annotation annotation = (Annotation) iterator.next();
+			if (!annotation.isMarkedDeleted()) {
+				Position position = model.getPosition(annotation);
+				if (position != null) {
+					final int start = position.getOffset();
+					final int end = start + position.getLength();
+		
+					if (offset > 0 && !(start <= offset && offset <= end)) {
+						continue;
+					}
+					try {
+						if (lineNumber != sourceViewer.getDocument().getLineOfOffset(
+								start)) {
+							continue;
+						}
+					} catch (final Exception x) {
+						continue;
+					}
+					if (!isLineDiffInfo(annotation)) {
+						final IQuickAssistInvocationContext invocationContext = new TextInvocationContext(sourceViewer, position.getOffset(), position.getLength());
+						CompletionProposalRunnable runnable = new CompletionProposalRunnable(invocationContext);	
+						// Note: the resolutions have to be retrieved from the UI thread, otherwise
+						// workbench.getActiveWorkbenchWindow() will return null in LanguageSpecificURIEditorOpener and
+						// cause an exception
+						Display.getDefault().syncExec(runnable);
+						return new AnnotationInfo (annotation, position, sourceViewer, runnable.proposals);
+					} 
+				}
+			}
+		}
+		return null;
+	}
+
+	public IInformationControlCreator getHoverControlCreator() {
+		if (fHoverControlCreator == null)
+			fHoverControlCreator= new HoverControlCreator(getInformationPresenterControlCreator());
+		return fHoverControlCreator;
+	}
+
+	public IInformationControlCreator getInformationPresenterControlCreator() {
+		if (fPresenterControlCreator == null)
+			fPresenterControlCreator= new PresenterControlCreator();
+		return fPresenterControlCreator;
+	}
+
+	private IAnnotationModel getAnnotationModel() {
+		return sourceViewer.getAnnotationModel();
+	}
+
+	public void setSourceViewer(ISourceViewer sourceViewer) {
+		this.sourceViewer = sourceViewer;
+	}
+	
+	public boolean isLineDiffInfo(Annotation annotation) {
+		return annotation instanceof ILineDiffInfo;
+	}
+	
+
+//	/**
+//	 * Returns the annotation preference for the given annotation.
+//	 *
+//	 * @param annotation the annotation
+//	 * @return the annotation preference or <code>null</code> if none
+//	 */
+//	private static AnnotationPreference getAnnotationPreference(Annotation annotation) {
+//
+//		if (annotation.isMarkedDeleted())
+//			return null;
+//		return EditorsUI.getAnnotationPreferenceLookup().getAnnotationPreference(annotation);
+//	}
+}
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DelegatingHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DelegatingHover.java
new file mode 100644
index 0000000..6999042
--- /dev/null
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DelegatingHover.java
@@ -0,0 +1,142 @@
+/*******************************************************************************
+ * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ *******************************************************************************/
+package org.eclipse.xtext.ui.editor.hover;
+
+import java.util.ArrayList;
+import java.util.HashSet;
+import java.util.List;
+import java.util.Set;
+
+import org.eclipse.jface.text.IInformationControlCreator;
+import org.eclipse.jface.text.IRegion;
+import org.eclipse.jface.text.ITextHover;
+import org.eclipse.jface.text.ITextHoverExtension;
+import org.eclipse.jface.text.ITextHoverExtension2;
+import org.eclipse.jface.text.ITextViewer;
+import org.eclipse.jface.text.source.ISourceViewer;
+import org.eclipse.xtext.ui.editor.ISourceViewerAware;
+
+import com.google.inject.Inject;
+import com.google.inject.name.Named;
+
+/**
+ * This hover delegates calls to a list of hovers. By default the list consist of two hovers: the priority hover 
+ * (usually the problem/annotation hover) and a default hover. The active hover is determined by iterating over 
+ * the list of hovers. The first one which returns a valid region in getHoverRegion is selected.
+ * 
+ * <p>Additional hovers can be configured with a guice multi binder (those hovers will be inserted between the 
+ * the priority and default hovers. Please note that the multi binder does not support any ordering of the hovers.
+ * 
+ * @author Christoph Kulla - Initial contribution and API
+ */
+public class DelegatingHover implements ITextHover, ITextHoverExtension, ITextHoverExtension2, ISourceViewerAware {
+
+	public final static String PRIORITY_HOVER = "org.eclipse.xtext.ui.editor.hover.DelegatingHover.PriorityHover";
+	public final static String DEFAULT_HOVER = "org.eclipse.xtext.ui.editor.hover.DelegatingHover.DefaultHover";
+	
+	// FIXME: remove as soon as guice multibinder works
+	public final static String ADDITIONAL_HOVER = "org.eclipse.xtext.ui.editor.hover.DelegatingHover.AdditionalHover";
+	
+	private List<ITextHover> hovers;
+
+	private ITextHover currentHover;
+
+	@Inject
+	public DelegatingHover(@Named(PRIORITY_HOVER) ITextHover priorityHover, @Named(DEFAULT_HOVER) ITextHover defaultHover) {
+		hovers = new ArrayList<ITextHover>(2);
+		hovers.add(priorityHover);
+		hovers.add(defaultHover);
+	}
+
+	@Inject(optional=true)
+	public void setAdditionalHovers (Set<ITextHover> additionalHovers) {
+		int i=0;
+		for (ITextHover hover: additionalHovers) {
+			hovers.add(1+i, hover);
+			i++;
+		}
+	}
+	
+	@Inject(optional=true)
+	public void setAdditionalHover (@Named(ADDITIONAL_HOVER) ITextHover additionalHover) {
+		Set<ITextHover> set = new HashSet<ITextHover>();
+		set.add(additionalHover);
+		setAdditionalHovers(set);
+	}	
+	
+	public void setSourceViewer(ISourceViewer sourceViewer) {
+		for (ITextHover hover : hovers) {
+			if (hover instanceof ISourceViewerAware)
+				((ISourceViewerAware) hover).setSourceViewer(sourceViewer);
+		}
+	}
+
+	/*
+	 * @see ITextHover#getHoverRegion(ITextViewer, int)
+	 */
+	@SuppressWarnings("deprecation")
+	public IRegion getHoverRegion(ITextViewer textViewer, int offset) {
+		for (ITextHover hover : hovers) {
+			IRegion region = hover.getHoverRegion(textViewer, offset);
+			if (region != null) {
+
+				Object hoverInfo = null;
+				if (hover instanceof ITextHoverExtension2)
+					hoverInfo = ((ITextHoverExtension2) hover).getHoverInfo2(textViewer, region);
+				else {
+					hoverInfo = hover.getHoverInfo(textViewer, region);
+				}
+				if (hoverInfo != null && !(hoverInfo instanceof String && ((String) hoverInfo).length() == 0)) {
+					currentHover = hover;
+					return region;
+				}
+			}
+		}
+		currentHover = null;
+		return null;
+	}
+
+	/*
+	 * @see ITextHover#getHoverInfo(ITextViewer, IRegion)
+	 */
+	@Deprecated
+	public String getHoverInfo(ITextViewer textViewer, IRegion hoverRegion) {
+		// should never be called
+		if (currentHover != null) {
+			return currentHover.getHoverInfo(textViewer, hoverRegion);
+		}
+		return null;
+	}
+
+	/*
+	 * @see org.eclipse.jface.text.ITextHoverExtension2#getHoverInfo2(org.eclipse.jface.text.ITextViewer, org.eclipse.jface.text.IRegion)
+	 * @since 3.4
+	 */
+	@SuppressWarnings("deprecation")
+	public Object getHoverInfo2(ITextViewer textViewer, IRegion hoverRegion) {
+		if (currentHover != null) {
+			if (currentHover instanceof ITextHoverExtension2)
+				return ((ITextHoverExtension2) currentHover).getHoverInfo2(textViewer, hoverRegion);
+			else {
+				return currentHover.getHoverInfo(textViewer, hoverRegion);
+			}
+		}
+		return null;
+	}
+
+	/*
+	 * @see org.eclipse.jface.text.ITextHoverExtension#getHoverControlCreator()
+	 * @since 3.4
+	 */
+	public IInformationControlCreator getHoverControlCreator() {
+		if (currentHover instanceof ITextHoverExtension)
+			return ((ITextHoverExtension) currentHover).getHoverControlCreator();
+		return null;
+	}
+
+}
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/IEObjectDocumentationProvider.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/IEObjectDocumentationProvider.java
new file mode 100644
index 0000000..4135b00
--- /dev/null
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/IEObjectDocumentationProvider.java
@@ -0,0 +1,23 @@
+/*******************************************************************************
+ * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ *******************************************************************************/
+package org.eclipse.xtext.ui.editor.hover;
+
+import org.eclipse.emf.ecore.EObject;
+
+import com.google.inject.ImplementedBy;
+
+/**
+ * @author Christoph Kulla - Initial contribution and API
+ */
+// FIXME: not ui related, move to org.eclipse.xtext?
+@ImplementedBy(MutiLineDocumentationProvider.class)
+public interface IEObjectDocumentationProvider {
+
+	public String getDocumentation (EObject o);
+
+}
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/MutiLineDocumentationProvider.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/MutiLineDocumentationProvider.java
new file mode 100644
index 0000000..53096dc
--- /dev/null
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/MutiLineDocumentationProvider.java
@@ -0,0 +1,85 @@
+/*******************************************************************************
+ * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ *******************************************************************************/
+package org.eclipse.xtext.ui.editor.hover;
+
+import org.eclipse.emf.ecore.EObject;
+import org.eclipse.xtext.TerminalRule;
+import org.eclipse.xtext.parsetree.AbstractNode;
+import org.eclipse.xtext.parsetree.CompositeNode;
+import org.eclipse.xtext.parsetree.LeafNode;
+import org.eclipse.xtext.parsetree.NodeUtil;
+
+import com.google.inject.Inject;
+import com.google.inject.name.Named;
+
+/**
+ * @author Christoph Kulla - Initial contribution and API
+ */
+//FIXME: not ui related, move to org.eclipse.xtext?
+public class MutiLineDocumentationProvider implements IEObjectDocumentationProvider {
+
+	public final static String RULE = "org.eclipse.xtext.ui.editor.hover.MultiLineDocumentationProvider.ruleName";
+	public final static String START_TAG = "org.eclipse.xtext.ui.editor.hover.MultiLineDocumentationProvider.xtartTag";
+	public final static String END_TAG = "org.eclipse.xtext.ui.editor.hover.MultiLineDocumentationProvider.endTag";
+	public final static String LINE_PREFIX = "org.eclipse.xtext.ui.editor.hover.MultiLineDocumentationProvider.linePrefix";
+	public final static String LINE_POSTFIX = "org.eclipse.xtext.ui.editor.hover.MultiLineDocumentationProvider.linePostfix";
+
+	@Inject(optional = true)
+	@Named(RULE)
+	String ruleName = "ML_COMMENT";
+
+	@Inject(optional = true)
+	@Named(START_TAG)
+	String startTag = "/\\*\\*"; // regular expression
+
+	@Inject(optional = true)
+	@Named(END_TAG)
+	String endTag = "\\*/"; // regular expression
+
+	@Inject(optional = true)
+	@Named(LINE_PREFIX)
+	String linePrefix = "\\*+"; // regular expression
+
+	@Inject(optional = true)
+	@Named(LINE_POSTFIX)
+	String linePostfix = "\\*+"; // regular expression
+
+	protected String findComment(EObject o) {
+		String returnValue = null;
+		CompositeNode node = NodeUtil.getNode(o);
+		if (node != null) {
+			Iterable<AbstractNode> contents = NodeUtil.getAllContents(node);
+
+			// get the last multi line comment before a non hidden leaf node
+			for (AbstractNode abstractNode : contents) {
+				if (abstractNode instanceof LeafNode && !((LeafNode) abstractNode).isHidden())
+					break;
+				if (abstractNode instanceof LeafNode && abstractNode.getGrammarElement() instanceof TerminalRule
+						&& ruleName.equalsIgnoreCase(((TerminalRule) abstractNode.getGrammarElement()).getName())) {
+					String comment = ((LeafNode) abstractNode).getText();
+					if (comment.matches("(?s)" + startTag + ".*")) {
+						returnValue = comment;
+					}
+				}
+			}
+		}
+		return returnValue;
+	}
+
+	public String getDocumentation(EObject o) {
+		String returnValue = findComment(o);
+		if (returnValue != null) {
+			returnValue = returnValue.replaceAll("\\A" + startTag, "");
+			returnValue = returnValue.replaceAll(endTag + "\\z", "");
+			returnValue = returnValue.replaceAll("(?m)^( |\\t)*" + linePrefix, "");
+			returnValue = returnValue.replaceAll("(?m)" + linePostfix + "( |\\t)*$", "");
+			return returnValue;
+		} else
+			return "";
+	}
+}
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/ProblemHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/ProblemHover.java
index a61976c..a7aa8f9 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/ProblemHover.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/ProblemHover.java
@@ -13,23 +13,67 @@ package org.eclipse.xtext.ui.editor.hover;
 import java.util.Iterator;
 import java.util.Set;
 
+import org.eclipse.jface.text.BadLocationException;
+import org.eclipse.jface.text.IRegion;
+import org.eclipse.jface.text.ITextViewer;
 import org.eclipse.jface.text.Position;
+import org.eclipse.jface.text.Region;
 import org.eclipse.jface.text.source.Annotation;
 import org.eclipse.jface.text.source.IAnnotationModel;
 import org.eclipse.jface.text.source.ILineDiffInfo;
-import org.eclipse.jface.text.source.ISourceViewer;
-
 import com.google.common.collect.Sets;
 
 /**
  * @author Sven Efftinge - Initial contribution and API
  */
 public class ProblemHover extends AbstractHover {
-
-	public ProblemHover(final ISourceViewer sourceViewer) {
-		super(sourceViewer);
+	
+	@Override
+	public IRegion getHoverRegion(final ITextViewer textViewer, final int offset) {
+		int lineNumber;
+		try {
+			lineNumber = textViewer.getDocument().getLineOfOffset(offset);
+			return getHoverRegionInternal(lineNumber, offset);
+		} catch (BadLocationException e) {
+		}
+		return null;
 	}
-
+	
+	protected Region getHoverRegionInternal(final int lineNumber,
+			final int offset) {
+		final IAnnotationModel model = sourceViewer.getAnnotationModel();
+		if(model == null) {
+			return null;
+		}
+		final Iterator<?> iterator = model.getAnnotationIterator();
+		while (iterator.hasNext()) {
+			final Annotation annotation = (Annotation) iterator.next();
+			if (!annotation.isMarkedDeleted()) {
+				Position position = model.getPosition(annotation);
+				if (position != null) {
+					final int start = position.getOffset();
+					final int end = start + position.getLength();
+		
+					if (offset > 0 && !(start <= offset && offset <= end)) {
+						continue;
+					}
+					try {
+						if (lineNumber != sourceViewer.getDocument().getLineOfOffset(
+								start)) {
+							continue;
+						}
+					} catch (final Exception x) {
+						continue;
+					}
+					if (!isLineDiffInfo(annotation)) {
+						return new Region (start, position.getLength());
+					}
+				}
+			}
+		}
+		return null;
+	}
+	
 	@Override
 	protected String getHoverInfoInternal(final int lineNumber,
 			final int offset) {
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/AbstractHtmlHoverContentProvider.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/AbstractHtmlHoverContentProvider.java
new file mode 100644
index 0000000..23fcc0b
--- /dev/null
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/AbstractHtmlHoverContentProvider.java
@@ -0,0 +1,44 @@
+/*******************************************************************************
+ * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ *******************************************************************************/
+package org.eclipse.xtext.ui.editor.hover.html;
+
+/**
+ * @author Christoph Kulla - Initial contribution and API
+ */
+public abstract class AbstractHtmlHoverContentProvider implements IHtmlHoverContentProvider {
+
+	private IHtmlHoverContentProvider delegate;
+
+	protected AbstractHtmlHoverContentProvider() {
+	}
+
+	protected AbstractHtmlHoverContentProvider(IHtmlHoverContentProvider delegate) {
+		this.delegate = delegate;
+	}
+
+	public String getHtml(Object o) {
+		String html = doGetHtml(o);
+		if (o == null && html != null)
+			html = delegate.getHtml(o);
+		if (html == null)
+			html = getDefaultHtml();
+		return html;
+	}
+
+	/**
+	 * Expected to be overridden by clients.
+	 * 
+	 * @return a {@link String} containing html content.
+	 */
+	protected abstract String doGetHtml(Object o);
+
+	protected String getDefaultHtml() {
+		return null;
+	}
+
+}
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/DeclarativeHtmlHoverConentProvider.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/DeclarativeHtmlHoverConentProvider.java
new file mode 100644
index 0000000..2dcfaa5
--- /dev/null
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/DeclarativeHtmlHoverConentProvider.java
@@ -0,0 +1,45 @@
+package org.eclipse.xtext.ui.editor.hover.html;
+
+import java.util.Collections;
+
+import org.eclipse.xtext.util.Exceptions;
+import org.eclipse.xtext.util.PolymorphicDispatcher;
+import org.eclipse.xtext.util.PolymorphicDispatcher.ErrorHandler;
+
+/**
+ * @author Christoph Kulla - Initial contribution and API
+ */
+public class DeclarativeHtmlHoverConentProvider extends AbstractHtmlHoverContentProvider {
+
+	public DeclarativeHtmlHoverConentProvider() {
+	}
+
+	public DeclarativeHtmlHoverConentProvider(IHtmlHoverContentProvider delegate) {
+		super(delegate);
+	}
+
+	private final PolymorphicDispatcher<String> dispatcher = 
+		new PolymorphicDispatcher<String>("html", 1, 1, Collections.singletonList(this), new ErrorHandler<String>() {
+			public String handle(Object[] params, Throwable e) {
+				return handleError(params, e);
+			}
+		});
+
+	@Override
+	protected String doGetHtml(Object element) {
+		return dispatcher.invoke(element);
+	}
+
+	public String html(Object element) {
+		return null;
+	}
+	
+	protected String handleError(Object[] params, Throwable e) {
+		if (e instanceof NullPointerException) {
+			return getDefaultHtml();
+		}
+		return Exceptions.throwUncheckedException(e);
+
+	}
+
+}
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/DefaultHtmlHoverContentProvider.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/DefaultHtmlHoverContentProvider.java
new file mode 100644
index 0000000..fdd0c8d
--- /dev/null
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/DefaultHtmlHoverContentProvider.java
@@ -0,0 +1,67 @@
+/*******************************************************************************
+ * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ *******************************************************************************/
+package org.eclipse.xtext.ui.editor.hover.html;
+
+import org.eclipse.emf.ecore.EObject;
+import org.eclipse.jface.viewers.ILabelProvider;
+import org.eclipse.xtext.ui.editor.hover.IEObjectDocumentationProvider;
+
+import com.google.inject.Inject;
+
+/**
+ * @author Christoph Kulla - Initial contribution and API
+ */
+public class DefaultHtmlHoverContentProvider extends DeclarativeHtmlHoverConentProvider {
+
+	@Inject
+	private ILabelProvider labelProvider;
+
+	@Inject
+	private IEObjectDocumentationProvider documentationProvider;
+
+	@Override
+	protected String doGetHtml(Object element) {
+		String text = super.doGetHtml(element);
+		if (text != null) {
+			return text;
+		}
+		if (element instanceof EObject) {
+			return getDefaultHtml((EObject) element);
+		}
+		return null;
+	}
+
+	protected String getDefaultHtml (EObject o) {
+		StringBuffer buffer = new StringBuffer();
+		buffer.append (o.eClass().getName()+ " <b>"+getLabel(o)+"</b>");
+		String documentation = getDocumentation(o);
+		if (documentation!=null && documentation.length()>0) {
+			buffer.append ("<p>");
+			buffer.append (documentation);
+		}
+		return buffer.toString();
+	}
+	
+	protected String getDocumentation (EObject o) {
+		return getDocumentationProvider().getDocumentation(o);
+	}
+	
+	protected IEObjectDocumentationProvider getDocumentationProvider () {
+		return documentationProvider;
+	}
+		
+	protected String getLabel (EObject o) {
+		return getLabelProvider().getText(o);
+	}
+	
+	protected ILabelProvider getLabelProvider () {
+		return labelProvider;
+	}
+	
+}
+
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/IHtmlHoverContentProvider.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/IHtmlHoverContentProvider.java
new file mode 100644
index 0000000..7c8570f
--- /dev/null
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/IHtmlHoverContentProvider.java
@@ -0,0 +1,19 @@
+/*******************************************************************************
+ * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ *******************************************************************************/
+package org.eclipse.xtext.ui.editor.hover.html;
+
+/**
+ * @author Christoph Kulla - Initial contribution and API
+ */
+public interface IHtmlHoverContentProvider {
+
+	/**
+	 * Returns a html string for the given object
+	 */
+	String getHtml (Object o);  
+}
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/OpenBrowserUtil.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/OpenBrowserUtil.java
new file mode 100644
index 0000000..5c64ce8
--- /dev/null
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/OpenBrowserUtil.java
@@ -0,0 +1,37 @@
+/*******************************************************************************
+ * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ *******************************************************************************/
+
+package org.eclipse.xtext.ui.editor.hover.html;
+
+import java.net.URL;
+
+import org.eclipse.swt.custom.BusyIndicator;
+import org.eclipse.swt.widgets.Display;
+
+import org.eclipse.ui.PlatformUI;
+
+// coppied from JDT
+
+public class OpenBrowserUtil {
+
+	public static void open(final URL url, Display display, final String dialogTitle) {
+		display.syncExec(new Runnable() {
+			public void run() {
+				internalOpen(url, dialogTitle);
+			}
+		});
+	}
+
+	private static void internalOpen(final URL url, String title) {
+		BusyIndicator.showWhile(null, new Runnable() {
+			public void run() {
+				PlatformUI.getWorkbench().getHelpSystem().displayHelpResource(url.toExternalForm() + "?noframes=true"); //$NON-NLS-1$
+			}
+		});
+	}
+}
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextBrowserInformationControlInput.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextBrowserInformationControlInput.java
new file mode 100644
index 0000000..2e20858
--- /dev/null
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextBrowserInformationControlInput.java
@@ -0,0 +1,78 @@
+/*******************************************************************************
+ * Copyright (c) 2008 IBM Corporation and others.
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ *
+ * Contributors:
+ *     IBM Corporation - initial API and implementation
+ *******************************************************************************/
+package org.eclipse.xtext.ui.editor.hover.html;
+
+import org.eclipse.core.runtime.Assert;
+import org.eclipse.emf.ecore.EObject;
+
+import org.eclipse.jface.internal.text.html.BrowserInformationControlInput;
+import org.eclipse.jface.viewers.ILabelProvider;
+
+/**
+ * Browser input for XtextEditorHover.
+ *
+ * @since 3.4
+ */
+@SuppressWarnings("restriction")
+public class XtextBrowserInformationControlInput extends BrowserInformationControlInput {
+
+	private final EObject fElement;
+	private final String fHtml;
+	private final ILabelProvider fLabelProvider;
+	
+	//private final int fLeadingImageWidth;
+	/**
+	 * Creates a new browser information control input.
+	 *
+	 * @param previous previous input, or <code>null</code> if none available
+	 * @param element the element, or <code>null</code> if none available
+	 * @param html HTML contents, must not be null
+	 * @param leadingImageWidth the indent required for the element image
+	 */
+	public XtextBrowserInformationControlInput(XtextBrowserInformationControlInput previous, EObject element, String html, ILabelProvider labelProvider) {
+		super(previous);
+		Assert.isNotNull(html);
+		fElement= element;
+		fHtml= html;
+		fLabelProvider = labelProvider;
+		// fLeadingImageWidth= leadingImageWidth;
+	}
+
+	// FIXME
+//	/*
+//	 * @see org.eclipse.jface.internal.text.html.BrowserInformationControlInput#getLeadingImageWidth()
+//	 * @since 3.4
+//	 */
+//	@Override
+//	public int getLeadingImageWidth() {
+//		return fLeadingImageWidth;
+//	}
+
+	public EObject getElement() {
+		return fElement;
+	}
+
+	@Override
+	public String getHtml() {
+		return fHtml;
+	}
+
+	@Override
+	public Object getInputElement() {
+		return fElement == null ? fHtml : fElement;
+	}
+
+	@Override
+	public String getInputName() {
+		return fLabelProvider.getText(fElement);
+	}
+
+}
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextElementLinks.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextElementLinks.java
new file mode 100644
index 0000000..8760173
--- /dev/null
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextElementLinks.java
@@ -0,0 +1,185 @@
+/*******************************************************************************
+ * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ *******************************************************************************/
+package org.eclipse.xtext.ui.editor.hover.html;
+
+import java.io.File;
+import java.net.MalformedURLException;
+import java.net.URI;
+import java.net.URISyntaxException;
+import java.net.URL;
+
+import org.apache.log4j.Logger;
+import org.eclipse.emf.ecore.EObject;
+import org.eclipse.jface.viewers.ILabelProvider;
+import org.eclipse.swt.browser.LocationAdapter;
+import org.eclipse.swt.browser.LocationEvent;
+import org.eclipse.swt.browser.LocationListener;
+import org.eclipse.swt.widgets.Display;
+
+import com.google.inject.Inject;
+
+/**
+ * @author Christoph Kulla - Initial contribution and API
+ */
+public class XtextElementLinks {
+	
+	@Inject
+	ILabelProvider labelProvider;
+	
+	private static final Logger log = Logger.getLogger(XtextElementLinks.class);
+	
+	// should be all lower case (IE issue)
+	public static final String OPEN_LINK_SCHEME= "xtext-open"; //$NON-NLS-1$
+	public static final String XTEXTDOC_SCHEME= "xtext-doc"; //$NON-NLS-1$
+	public static final String XTEXTDOC_VIEW_SCHEME= "xtext-doc-view"; //$NON-NLS-1$
+	
+	public interface ILinkHandler {
+
+		/**
+		 * Handle normal kind of link to given target.
+		 *
+		 * @param target the target to show
+		 */
+		void handleInlineXtextdocLink(org.eclipse.emf.common.util.URI  uri);
+
+		/**
+		 * Handle link to given target to open in Xtextdoc view.
+		 *
+		 * @param target the target to show
+		 */
+		void handleXtextdocViewLink(org.eclipse.emf.common.util.URI  uri);
+
+		/**
+		 * Handle link to given target to open its declaration
+		 *
+		 * @param target the target to show
+		 */
+		void handleDeclarationLink(org.eclipse.emf.common.util.URI  uri);
+
+		/**
+		 * Handle link to given link to open in external browser
+		 *
+		 * @param url the url to show
+		 * @param display the current display
+		 * @return <code>true</code> if the handler could open the link
+		 *         <code>false</code> if the browser should follow the link
+		 */
+		boolean handleExternalLink(URL url, Display display);
+
+		/**
+		 * Informs the handler that the text of the browser was set.
+		 */
+		void handleTextSet();
+	}	
+	
+	public LocationListener createLocationListener(final ILinkHandler handler) {
+		return new LocationAdapter() {
+			@Override
+			public void changing(LocationEvent event) {
+				String loc= event.location;
+
+				if ("about:blank".equals(loc)) { //$NON-NLS-1$
+					/*
+					 * Using the Browser.setText API triggers a location change to "about:blank".
+					 * remove this code once https://bugs.eclipse.org/bugs/show_bug.cgi?id=130314 is fixed
+					 */
+					//input set with setText
+					handler.handleTextSet();
+					return;
+				}
+
+				event.doit= false;
+
+				if (loc.startsWith("about:")) { //$NON-NLS-1$
+					// Relative links should be handled via head > base tag.
+					// If no base is available, links just won't work.
+					return;
+				}
+
+				URI uri;
+				try {
+					uri= new URI(loc);
+				} catch (URISyntaxException e) {
+					// try it with a file (workaround for https://bugs.eclipse.org/bugs/show_bug.cgi?id=237903 ):
+					File file= new File(loc);
+					if (! file.exists()) {
+						log.warn("Could not handle location"+loc.toString(), e);
+						return;
+					}
+					uri= file.toURI();
+					loc= uri.toASCIIString();
+				}
+
+				String scheme= uri.getScheme();
+				if (XtextElementLinks.XTEXTDOC_VIEW_SCHEME.equals(scheme)) {
+					org.eclipse.emf.common.util.URI linkTarget= parseURI(uri);
+					if (linkTarget == null)
+						return;
+
+					handler.handleXtextdocViewLink(linkTarget);
+				} else if (XtextElementLinks.XTEXTDOC_SCHEME.equals(scheme)) {
+					org.eclipse.emf.common.util.URI linkTarget= parseURI(uri);
+					if (linkTarget == null)
+						return;
+
+					handler.handleInlineXtextdocLink(linkTarget);
+				} else if (XtextElementLinks.OPEN_LINK_SCHEME.equals(scheme)) {
+					org.eclipse.emf.common.util.URI linkTarget= parseURI(uri);
+					if (linkTarget == null)
+						return;
+
+					handler.handleDeclarationLink(linkTarget);
+				} else {
+					try {
+						if (handler.handleExternalLink(new URL(loc), event.display))
+							return;
+
+						event.doit= true;
+					} catch (MalformedURLException e) {
+						log.warn("Could not handle location"+loc.toString(), e);
+					}
+				}
+			}
+		};
+	}
+
+	public String createLink (EObject o) {
+		return createLink (XTEXTDOC_SCHEME, o);
+	}
+
+	public String createLink (String scheme, EObject o) {
+		return createLink (scheme, o, labelProvider.getText (o));
+	}
+	
+	public String createLink (String scheme, EObject o, String elementName) {
+		try {
+			return createLink (createURI (scheme, o), elementName);
+		} catch (URISyntaxException e) {
+			log.warn("Could not create Link for "+elementName, e);
+		} 
+		return elementName;
+	}	
+	
+	public String createLink (String uri, String elementName) {
+		return "<a class='header' href='" + uri + ("'>" + elementName + "</a>"); //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$
+	}
+	
+	private org.eclipse.emf.common.util.URI createURI(EObject o) {
+		return o.eResource().getURI().appendFragment(o.eResource().getURIFragment(o));
+	}
+	
+	public String createURI(String scheme, EObject o) throws URISyntaxException {
+		return new URI (scheme, createURI(o).toString(), null).toASCIIString();
+	}
+	
+	public org.eclipse.emf.common.util.URI parseURI(URI uri) {
+		return org.eclipse.emf.common.util.URI.createURI(uri.getSchemeSpecificPart());
+	}
+
+	
+}
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextHtmlHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextHtmlHover.java
new file mode 100644
index 0000000..c020561
--- /dev/null
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextHtmlHover.java
@@ -0,0 +1,472 @@
+/*******************************************************************************
+ * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ *******************************************************************************/
+package org.eclipse.xtext.ui.editor.hover.html;
+
+import java.io.BufferedReader;
+import java.io.IOException;
+import java.io.InputStreamReader;
+import java.net.URL;
+
+import org.eclipse.emf.common.util.URI;
+import org.eclipse.emf.ecore.EObject;
+import org.eclipse.emf.ecore.resource.ResourceSet;
+import org.eclipse.jface.action.Action;
+import org.eclipse.jface.action.ToolBarManager;
+import org.eclipse.jface.internal.text.html.BrowserInformationControl;
+import org.eclipse.jface.internal.text.html.BrowserInformationControlInput;
+import org.eclipse.jface.internal.text.html.BrowserInput;
+import org.eclipse.jface.internal.text.html.HTMLPrinter;
+import org.eclipse.jface.resource.JFaceResources;
+import org.eclipse.jface.text.AbstractReusableInformationControlCreator;
+import org.eclipse.jface.text.DefaultInformationControl;
+import org.eclipse.jface.text.IInformationControl;
+import org.eclipse.jface.text.IInformationControlCreator;
+import org.eclipse.jface.text.IInformationControlExtension4;
+import org.eclipse.jface.text.IInputChangedListener;
+import org.eclipse.jface.text.IRegion;
+import org.eclipse.jface.text.ITextViewer;
+import org.eclipse.jface.viewers.ILabelProvider;
+import org.eclipse.swt.SWT;
+import org.eclipse.swt.graphics.FontData;
+import org.eclipse.swt.widgets.Display;
+import org.eclipse.swt.widgets.Shell;
+import org.eclipse.ui.ISharedImages;
+import org.eclipse.ui.PlatformUI;
+import org.eclipse.ui.editors.text.EditorsUI;
+import org.eclipse.xtext.parsetree.AbstractNode;
+import org.eclipse.xtext.resource.XtextResource;
+import org.eclipse.xtext.ui.XtextUIMessages;
+import org.eclipse.xtext.ui.editor.IURIEditorOpener;
+import org.eclipse.xtext.ui.editor.hover.AbstractXtextEditorHover;
+import org.eclipse.xtext.ui.editor.model.IXtextDocument;
+import org.eclipse.xtext.ui.editor.model.XtextDocumentUtil;
+import org.eclipse.xtext.ui.internal.Activator;
+import org.eclipse.xtext.ui.internal.XtextPluginImages;
+import org.eclipse.xtext.util.Pair;
+import org.eclipse.xtext.util.concurrent.IUnitOfWork;
+
+import com.google.inject.Inject;
+import com.google.inject.name.Named;
+import com.ibm.icu.text.MessageFormat;
+
+/**
+ * This is a clone from JDT's JavadocHover class
+ * 
+ * @author Christoph Kulla - Initial contribution and API
+ */
+@SuppressWarnings({ "restriction"})
+public class XtextHtmlHover extends AbstractXtextEditorHover {
+
+	@Inject(optional=true)
+	private IHtmlHoverContentProvider hoverContentProvider;
+	
+	@Inject
+	private IURIEditorOpener uriEditorOpener;
+		
+	@Inject(optional = true)
+	@Named("org.eclipse.xtext.ui.editor.hover.XtextEditorHover.styleSheetFileName")
+	private String styleSheetFileName = "/XtextHoverStyleSheet.css"; //$NON-NLS-1$
+
+	@Inject(optional = true)
+	@Named("org.eclipse.xtext.ui.editor.hover.XtextEditorHover.font")
+	private String fontSymbolicName = "org.eclipse.jdt.ui.javadocfont"; //$NON-NLS-1$ 
+	
+	@Inject
+	private XtextElementLinks elementLinks;
+	
+	@Inject 
+	private ILabelProvider labelProvider;
+	
+	private static String fgStyleSheet;
+
+	private IInformationControlCreator hoverControlCreator;
+
+	private IInformationControlCreator presenterControlCreator;
+
+	private static final class BackAction extends Action {
+		private final BrowserInformationControl fInfoControl;
+
+		public BackAction(BrowserInformationControl infoControl) {
+			fInfoControl= infoControl;
+			setText(XtextUIMessages.XtextBrowserInformationControlInput_Back);
+			ISharedImages images= PlatformUI.getWorkbench().getSharedImages();
+			setImageDescriptor(images.getImageDescriptor(ISharedImages.IMG_TOOL_BACK));
+			setDisabledImageDescriptor(images.getImageDescriptor(ISharedImages.IMG_TOOL_BACK_DISABLED));
+
+			update();
+		}
+
+		@Override
+		public void run() {
+			BrowserInformationControlInput previous= (BrowserInformationControlInput) fInfoControl.getInput().getPrevious();
+			if (previous != null) {
+				fInfoControl.setInput(previous);
+			}
+		}
+
+		public void update() {
+			BrowserInformationControlInput current= fInfoControl.getInput();
+
+			if (current != null && current.getPrevious() != null) {
+				BrowserInput previous= current.getPrevious();
+				setToolTipText(MessageFormat.format(XtextUIMessages.XtextBrowserInformationControlInput_BackTo,  
+						new Object[] { previous.getInputName() }));
+				setEnabled(true);
+			} else {
+				setToolTipText(XtextUIMessages.XtextBrowserInformationControlInput_Back);
+				setEnabled(false);
+			}
+		}
+	}
+
+	private static final class ForwardAction extends Action {
+		private final BrowserInformationControl fInfoControl;
+
+		public ForwardAction(BrowserInformationControl infoControl) {
+			fInfoControl= infoControl;
+			setText(XtextUIMessages.XtextBrowserInformationControlInput_Forward);
+			ISharedImages images= PlatformUI.getWorkbench().getSharedImages();
+			setImageDescriptor(images.getImageDescriptor(ISharedImages.IMG_TOOL_FORWARD));
+			setDisabledImageDescriptor(images.getImageDescriptor(ISharedImages.IMG_TOOL_FORWARD_DISABLED));
+
+			update();
+		}
+
+		@Override
+		public void run() {
+			BrowserInformationControlInput next= (BrowserInformationControlInput) fInfoControl.getInput().getNext();
+			if (next != null) {
+				fInfoControl.setInput(next);
+			}
+		}
+
+		public void update() {
+			BrowserInformationControlInput current= fInfoControl.getInput();
+
+			if (current != null && current.getNext() != null) {
+				setToolTipText(MessageFormat.format(XtextUIMessages.XtextBrowserInformationControlInput_ForwardTo,  
+						new Object[] { current.getNext().getInputName()}));
+				setEnabled(true);
+			} else {
+				setToolTipText(XtextUIMessages.XtextBrowserInformationControlInput_Forward);
+				setEnabled(false);
+			}
+		}
+	}
+
+//	private static final class ShowInJavadocViewAction extends Action {
+//		private final BrowserInformationControl fInfoControl;
+//
+//		public ShowInJavadocViewAction(BrowserInformationControl infoControl) {
+//			fInfoControl= infoControl;
+//			setText(JavaHoverMessages.JavadocHover_showInJavadoc);
+//			setImageDescriptor(JavaPluginImages.DESC_OBJS_JAVADOCTAG); //TODO: better image
+//		}
+//
+//		/*
+//		 * @see org.eclipse.jface.action.Action#run()
+//		 */
+//		@Override
+//		public void run() {
+//			JavadocBrowserInformationControlInput infoInput= (JavadocBrowserInformationControlInput) fInfoControl.getInput(); //TODO: check cast
+//			fInfoControl.notifyDelayedInputChange(null);
+//			fInfoControl.dispose(); //FIXME: should have protocol to hide, rather than dispose
+//			try {
+//				JavadocView view= (JavadocView) JavaPlugin.getActivePage().showView(JavaUI.ID_JAVADOC_VIEW);
+//				view.setInput(infoInput);
+//			} catch (PartInitException e) {
+//				JavaPlugin.log(e);
+//			}
+//		}
+//	}
+
+	/**
+	 * Action that opens the current hover input element.
+	 */
+	private final class OpenDeclarationAction extends Action {
+		private final BrowserInformationControl fInfoControl;
+
+		public OpenDeclarationAction(BrowserInformationControl infoControl) {
+			fInfoControl= infoControl;
+			setText(XtextUIMessages.XtextBrowserInformationControlInput_OpenDeclaration);
+			setImageDescriptor(XtextPluginImages.DESC_OPEN_DECLARATION);
+			setDisabledImageDescriptor(XtextPluginImages.DESC_OPEN_DECLARATION_DISABLED);
+		}
+
+		/*
+		 * @see org.eclipse.jface.action.Action#run()
+		 */
+		@Override
+		public void run() {
+			if (fInfoControl.getInput() instanceof XtextBrowserInformationControlInput) {
+				XtextBrowserInformationControlInput infoInput = (XtextBrowserInformationControlInput) fInfoControl.getInput();
+				fInfoControl.notifyDelayedInputChange(null);
+				fInfoControl.dispose();
+				uriEditorOpener.open (createURI(infoInput.getElement()), true);
+			}
+		}		
+	}
+
+	private org.eclipse.emf.common.util.URI createURI(EObject o) {
+		return o.eResource().getURI().appendFragment(o.eResource().getURIFragment(o));
+	}
+	
+	private void addLinkListener(final BrowserInformationControl control) {
+		control.addLocationListener(elementLinks.createLocationListener(new XtextElementLinks.ILinkHandler() {
+
+			public void handleXtextdocViewLink(URI linkTarget) {
+				// TODO: enable when xtextdoc view available
+//				control.notifyDelayedInputChange(null);
+//				control.setVisible(false);
+//				control.dispose(); //FIXME: should have protocol to hide, rather than dispose
+//				try {
+//					JavadocView view= (JavadocView) JavaPlugin.getActivePage().showView(JavaUI.ID_JAVADOC_VIEW);
+//					view.setInput(linkTarget);
+//				} catch (PartInitException e) {
+//					JavaPlugin.log(e);
+//				}
+			}
+
+			public void handleInlineXtextdocLink(URI linkTarget) {
+				XtextBrowserInformationControlInput hoverInfo = getHoverInfo(getTarget(linkTarget), null, (XtextBrowserInformationControlInput) control.getInput());
+				if (control.hasDelayedInputChangeListener())
+					control.notifyDelayedInputChange(hoverInfo);
+				else
+					control.setInput(hoverInfo);
+			}
+
+			public void handleDeclarationLink(URI linkTarget) {
+				control.notifyDelayedInputChange(null);
+				control.dispose(); //FIXME: should have protocol to hide, rather than dispose
+				uriEditorOpener.open (linkTarget, true);
+
+			}
+
+			public boolean handleExternalLink(URL url, Display display) {
+				control.notifyDelayedInputChange(null);
+				control.dispose(); //FIXME: should have protocol to hide, rather than dispose
+				
+				// open external links in real browser:
+				OpenBrowserUtil.open(url, display, ""); //$NON-NLS-1$
+				return true;
+			}
+
+			public void handleTextSet() {
+			}
+			
+			EObject getTarget (URI uri) {
+				ResourceSet rs = ((XtextBrowserInformationControlInput) control.getInput()).getElement().eResource().getResourceSet();
+				return rs.getEObject(uri, true);
+			}
+		}));
+	}
+	
+	public final class PresenterControlCreator extends AbstractReusableInformationControlCreator {
+
+		/*
+		 * @see org.eclipse.jdt.internal.ui.text.java.hover.AbstractReusableInformationControlCreator#doCreateInformationControl(org.eclipse.swt.widgets.Shell)
+		 */
+		@Override
+		public IInformationControl doCreateInformationControl(Shell parent) {
+			if (BrowserInformationControl.isAvailable(parent)) {
+				ToolBarManager tbm= new ToolBarManager(SWT.FLAT);
+				String font = "org.eclipse.jdt.ui.javadocfont"; // FIXME: mPreferenceConstants.APPEARANCE_JAVADOC_FONT;
+				BrowserInformationControl iControl= new BrowserInformationControl(parent, font, tbm);
+
+				final BackAction backAction= new BackAction(iControl);
+				backAction.setEnabled(false);
+				tbm.add(backAction);
+				final ForwardAction forwardAction= new ForwardAction(iControl);
+				tbm.add(forwardAction);
+				forwardAction.setEnabled(false);
+
+//				final ShowInJavadocViewAction showInJavadocViewAction= new ShowInJavadocViewAction(iControl);
+//				tbm.add(showInJavadocViewAction);
+				final OpenDeclarationAction openDeclarationAction= new OpenDeclarationAction(iControl);
+				tbm.add(openDeclarationAction);
+
+//				final SimpleSelectionProvider selectionProvider= new SimpleSelectionProvider();
+
+				IInputChangedListener inputChangeListener= new IInputChangedListener() {
+					public void inputChanged(Object newInput) {
+						backAction.update();
+						forwardAction.update();
+						if (newInput == null) {
+//							selectionProvider.setSelection(new StructuredSelection());
+						} else if (newInput instanceof XtextBrowserInformationControlInput) {
+//							XtextBrowserInformationControlInput input= (XtextBrowserInformationControlInput) newInput;
+//							Object inputElement = input.getInputElement();
+//							selectionProvider.setSelection(new StructuredSelection(inputElement));
+//							boolean isJavaElementInput= inputElement instanceof IJavaElement;
+//							showInJavadocViewAction.setEnabled(isJavaElementInput);
+							openDeclarationAction.setEnabled(true);
+						}
+					}
+				};
+				iControl.addInputChangeListener(inputChangeListener);
+				tbm.update(true);
+				addLinkListener(iControl);
+				return iControl;
+
+			} else {
+				return new DefaultInformationControl(parent, true);
+			}
+		}
+	}
+
+	public final class HoverControlCreator extends AbstractReusableInformationControlCreator {
+
+		private final IInformationControlCreator fInformationPresenterControlCreator;
+
+		public HoverControlCreator(IInformationControlCreator informationPresenterControlCreator) {
+			fInformationPresenterControlCreator= informationPresenterControlCreator;
+		}
+
+		/*
+		 * @see org.eclipse.jdt.internal.ui.text.java.hover.AbstractReusableInformationControlCreator#doCreateInformationControl(org.eclipse.swt.widgets.Shell)
+		 */
+		@Override
+		public IInformationControl doCreateInformationControl(Shell parent) {
+			String tooltipAffordanceString = EditorsUI.getTooltipAffordanceString();
+			if (BrowserInformationControl.isAvailable(parent)) {
+				String font= "org.eclipse.jdt.ui.javadocfont"; // FIXME: PreferenceConstants.APPEARANCE_JAVADOC_FONT;
+				BrowserInformationControl iControl= new BrowserInformationControl(parent, font, tooltipAffordanceString) {
+					/*
+					 * @see org.eclipse.jface.text.IInformationControlExtension5#getInformationPresenterControlCreator()
+					 */
+					@Override
+					public IInformationControlCreator getInformationPresenterControlCreator() {
+						return fInformationPresenterControlCreator;
+					}
+				};
+				addLinkListener(iControl);
+				return iControl;
+			} else {
+				return new DefaultInformationControl(parent, tooltipAffordanceString);
+			}
+		}
+
+		/*
+		 * @see org.eclipse.jdt.internal.ui.text.java.hover.AbstractReusableInformationControlCreator#canReuse(org.eclipse.jface.text.IInformationControl)
+		 */
+		@Override
+		public boolean canReuse(IInformationControl control) {
+			if (!super.canReuse(control))
+				return false;
+
+			if (control instanceof IInformationControlExtension4) {
+				String tooltipAffordanceString = EditorsUI.getTooltipAffordanceString();
+				((IInformationControlExtension4)control).setStatusText(tooltipAffordanceString);
+			}
+
+			return true;
+		}
+	}
+	
+	public IInformationControlCreator getInformationPresenterControlCreator() {
+		if (presenterControlCreator == null)
+			presenterControlCreator= new PresenterControlCreator();
+		return presenterControlCreator;
+	}	
+	
+
+	@Override
+	public IInformationControlCreator getHoverControlCreator() {
+		if (hoverControlCreator == null)
+			hoverControlCreator= new HoverControlCreator(getInformationPresenterControlCreator());
+		return hoverControlCreator;
+	}
+	
+	/**
+	 * @deprecated see {@link org.eclipse.jface.text.ITextHover#getHoverInfo(ITextViewer, IRegion)}
+	 */
+	@Deprecated
+	public String getHoverInfo(ITextViewer textViewer, IRegion hoverRegion) {
+		XtextBrowserInformationControlInput info= (XtextBrowserInformationControlInput) getHoverInfo2(textViewer, hoverRegion);
+		return info != null ? info.getHtml() : null;
+	}
+
+	/*
+	 * @see org.eclipse.jface.text.ITextHoverExtension2#getHoverInfo2(org.eclipse.jface.text.ITextViewer, org.eclipse.jface.text.IRegion)
+	 */
+	public Object getHoverInfo2(ITextViewer textViewer, IRegion hoverRegion) {
+		return internalGetHoverInfo(textViewer, hoverRegion);
+	}
+
+	private XtextBrowserInformationControlInput internalGetHoverInfo(final ITextViewer textViewer, final IRegion hoverRegion) {
+		if (hoverContentProvider==null) 
+			return null;
+		
+		IXtextDocument xtextDocument = XtextDocumentUtil.get(textViewer);
+
+		return xtextDocument.readOnly(new IUnitOfWork<XtextBrowserInformationControlInput, XtextResource>() {
+			public XtextBrowserInformationControlInput exec(XtextResource state) throws Exception {
+				Pair<AbstractNode,EObject> element = getXtextElementAt(textViewer, hoverRegion);
+				if (element!=null && element.getSecond()!=null) {
+					return getHoverInfo (element.getSecond(), hoverRegion, null);
+				} 
+				return null;
+			}		
+		});
+	}
+
+	private XtextBrowserInformationControlInput getHoverInfo(EObject element, IRegion hoverRegion, XtextBrowserInformationControlInput previous) {
+		String html = hoverContentProvider.getHtml(element);
+		if (html!=null) {
+			StringBuffer buffer = new StringBuffer(html);
+			HTMLPrinter.insertPageProlog(buffer, 0, getStyleSheet());
+			HTMLPrinter.addPageEpilog(buffer);
+			html = buffer.toString();
+			return new XtextBrowserInformationControlInput(previous, element, html, labelProvider);
+		}
+		return null;
+	}
+	
+	protected String getStyleSheet() {
+		if (fgStyleSheet == null)
+			fgStyleSheet= loadStyleSheet();
+		String css= fgStyleSheet;
+		if (css != null) {
+			FontData fontData= JFaceResources.getFontRegistry().getFontData(fontSymbolicName)[0];
+			css= HTMLPrinter.convertTopLevelFont(css, fontData);
+		}
+		return css;
+	}
+	
+	/**
+	 * Loads and returns the hover style sheet.
+	 * @return the style sheet, or <code>null</code> if unable to load
+	 */
+	private String loadStyleSheet() {
+		URL styleSheetURL= Activator.getDefault().getBundle().getEntry(styleSheetFileName); //$NON-NLS-1$
+		if (styleSheetURL != null) {
+			BufferedReader reader= null;
+			try {
+				reader= new BufferedReader(new InputStreamReader(styleSheetURL.openStream()));
+				StringBuffer buffer= new StringBuffer(1500);
+				String line= reader.readLine();
+				while (line != null) {
+					buffer.append(line);
+					buffer.append('\n');
+					line= reader.readLine();
+				}
+				return buffer.toString();
+			} catch (IOException ex) {
+				return ""; //$NON-NLS-1$
+			} finally {
+				try {
+					if (reader != null)
+						reader.close();
+				} catch (IOException e) {
+				}
+			}
+		}
+		return null;
+	}
+
+}
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/internal/XtextPluginImages.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/internal/XtextPluginImages.java
index e593b44..58eb753 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/internal/XtextPluginImages.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/internal/XtextPluginImages.java
@@ -100,6 +100,9 @@ public class XtextPluginImages {
 	public static final ImageDescriptor DESC_EXPAND_ALL = create(PATH_LCL, "expandall.gif");
 	public static final ImageDescriptor DESC_COLLAPSE_ALL = create(PATH_LCL, "collapseall.gif");
 	
+	public static final ImageDescriptor DESC_OPEN_DECLARATION = create(PATH_LCL, "goto_input.gif");
+	public static final ImageDescriptor DESC_OPEN_DECLARATION_DISABLED = create(PATH_LCL_DISABLED, "goto_input.gif");
+	
 	/**
 	 * WIZ
 	 */
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/messages.properties b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/messages.properties
index 926cd4a..784030b 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/messages.properties
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/messages.properties
@@ -8,6 +8,16 @@ AbstractHover_MultipleMarkers=Multiple markers at this line\n
 
 Editor_FoldingMenu_name=F&olding
 
+XtextBrowserInformationControlInput_Back=Back
+XtextBrowserInformationControlInput_BackTo=Back to {0}
+XtextBrowserInformationControlInput_Forward=Forward
+XtextBrowserInformationControlInput_ForwardTo=Forward to {0}
+XtextBrowserInformationControlInput_OpenDeclaration=Open Declaration
+
+AnnotationWithQuickFixesHover_message_singleQuickFix= 1 quick fix available:
+AnnotationWithQuickFixesHover_message_multipleQuickFix= {0} quick fixes available:
+
+
 LexicalSortingAction_description=Sorts elements in the outline.
 LexicalSortingAction_label=Sort
 LexicalSortingAction_tooltip=Sort
-- 
1.6.6


From 21b1c3952025b421c2ce2303f1a089647108959b Mon Sep 17 00:00:00 2001
From: Christoph Kulla <christophkulla@googlemail.com>
Date: Tue, 19 Oct 2010 21:17:52 +0200
Subject: [PATCH 02/28] Removed DefaultUiModule.java.rej. File left from merge of the hover patch.

---
 .../org/eclipse/xtext/ui/DefaultUiModule.java.rej  |   19 -------------------
 1 files changed, 0 insertions(+), 19 deletions(-)
 delete mode 100644 plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java.rej

diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java.rej b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java.rej
deleted file mode 100644
index 4536f78..0000000
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java.rej
+++ /dev/null
@@ -1,19 +0,0 @@
-diff a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java	(rejected hunks)
-@@ -287,5 +297,17 @@ public class DefaultUiModule extends AbstractGenericModule {
- 		return XtextResourceSetProvider.class;
- 	}
- 
-+	public Class<? extends IAnnotationHover> bindAnnotationHover () {
-+		return ProblemHover.class;		
-+	}
- 	
-+	public void configureTextHover(com.google.inject.Binder binder) {
-+		binder.bind(ITextHover.class).to(DelegatingHover.class);
-+		binder.bind(ITextHover.class).annotatedWith(com.google.inject.name.Names.named(DelegatingHover.PRIORITY_HOVER)).to(AnnotationWithQuickFixesHover.class);
-+		binder.bind(ITextHover.class).annotatedWith(com.google.inject.name.Names.named(DelegatingHover.DEFAULT_HOVER)).to(XtextHtmlHover.class);
-+	}
-+	
-+	public Class<? extends IHtmlHoverContentProvider> bindHtmlHoverContentProvider () {
-+		return DefaultHtmlHoverContentProvider.class;
-+	}
- }
-- 
1.6.6


From f80e6f099d68da3c19a356a9243ae13a88d2622d Mon Sep 17 00:00:00 2001
From: Christoph Kulla <christophkulla@googlemail.com>
Date: Sat, 23 Oct 2010 16:50:02 +0200
Subject: [PATCH 03/28] Replaced guice multi binders with a createHovers() method in DelegatingHover. This method returns the list of hovers. To add hovers subclass from DelegatingHover and overrride createHovers(). See JdtDelegatingHover for reference.

---
 .../common/types/xtext/ui/JdtDelegatingHover.java  |   33 ++++++++++++
 .../generator/types/TypesGeneratorFragment.java    |    5 +--
 .../src/org/eclipse/xtext/ui/DefaultUiModule.java  |   14 ++---
 .../xtext/ui/editor/hover/DelegatingHover.java     |   56 ++++++++------------
 4 files changed, 61 insertions(+), 47 deletions(-)
 create mode 100644 plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JdtDelegatingHover.java

diff --git a/plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JdtDelegatingHover.java b/plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JdtDelegatingHover.java
new file mode 100644
index 0000000..316e713
--- /dev/null
+++ b/plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JdtDelegatingHover.java
@@ -0,0 +1,33 @@
+/*******************************************************************************
+ * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ *******************************************************************************/
+package org.eclipse.xtext.common.types.xtext.ui;
+
+import java.util.List;
+
+import org.eclipse.jface.text.ITextHover;
+import org.eclipse.xtext.ui.editor.hover.DelegatingHover;
+
+import com.google.inject.Inject;
+import com.google.inject.Injector;
+
+/**
+ * @author Christoph Kulla - Initial contribution and API
+ */
+public class JdtDelegatingHover extends DelegatingHover {
+
+	@Inject
+	JdtHover jdtHover;
+	
+	@Override
+	protected List<ITextHover> createHovers() {
+		List<ITextHover> list = super.createHovers();
+		list.add (1,jdtHover);
+		return list;
+	}
+
+}
diff --git a/plugins/org.eclipse.xtext.generator/src/org/eclipse/xtext/generator/types/TypesGeneratorFragment.java b/plugins/org.eclipse.xtext.generator/src/org/eclipse/xtext/generator/types/TypesGeneratorFragment.java
index 8cfd88b..98bc33a 100644
--- a/plugins/org.eclipse.xtext.generator/src/org/eclipse/xtext/generator/types/TypesGeneratorFragment.java
+++ b/plugins/org.eclipse.xtext.generator/src/org/eclipse/xtext/generator/types/TypesGeneratorFragment.java
@@ -55,10 +55,7 @@ public class TypesGeneratorFragment extends DefaultGeneratorFragment {
 					 	"org.eclipse.xtext.common.types.xtext.ui.TypeAwareHyperlinkHelper")
 			 .addTypeToType("org.eclipse.xtext.ui.editor.contentassist.PrefixMatcher", 
 					 	"org.eclipse.xtext.ui.editor.contentassist.FQNPrefixMatcher")
-			 .addConfiguredBinding("AdditionalHover", 
-					"binder.bind(org.eclipse.jface.text.ITextHover.class)"+
-					".annotatedWith(com.google.inject.name.Names.named(org.eclipse.xtext.ui.editor.hover.DelegatingHover.ADDITIONAL_HOVER" +
-					")).to(org.eclipse.xtext.common.types.xtext.ui.JDTHover.class);")
+			 .addTypeToType ("org.eclipse.jface.text.ITextHover", "org.eclipse.xtext.common.types.xtext.ui.JdtDelegatingHover")
 			 .addTypeToType("org.eclipse.xtext.ui.editor.contentassist.AbstractJavaBasedContentProposalProvider$ReferenceProposalCreator", 
 					 	"org.eclipse.xtext.common.types.xtext.ui.TypeAwareReferenceProposalCreator")
 			 .getBindings();
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java
index dca5548..f2a39e4 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java
@@ -58,10 +58,8 @@ import org.eclipse.xtext.ui.editor.formatting.IContentFormatterFactory;
 import org.eclipse.xtext.ui.editor.formatting.PreferenceStoreIndentationInformation;
 import org.eclipse.xtext.ui.editor.hover.ProblemHover;
 import org.eclipse.xtext.ui.editor.hover.DelegatingHover;
-import org.eclipse.xtext.ui.editor.hover.AnnotationWithQuickFixesHover;
 import org.eclipse.xtext.ui.editor.hover.html.DefaultHtmlHoverContentProvider;
 import org.eclipse.xtext.ui.editor.hover.html.IHtmlHoverContentProvider;
-import org.eclipse.xtext.ui.editor.hover.html.XtextHtmlHover;
 import org.eclipse.xtext.ui.editor.hyperlinking.DefaultHyperlinkDetector;
 import org.eclipse.xtext.ui.editor.model.IResourceForEditorInputFactory;
 import org.eclipse.xtext.ui.editor.model.JavaClassPathResourceForIEditorInputFactory;
@@ -302,17 +300,15 @@ public class DefaultUiModule extends AbstractGenericModule {
 		return XtextResourceSetProvider.class;
 	}
 
-	public Class<? extends IAnnotationHover> bindAnnotationHover () {
+	public Class<? extends IAnnotationHover> bindIAnnotationHover () {
 		return ProblemHover.class;		
 	}
-		 	
-	public void configureTextHover(com.google.inject.Binder binder) {
-		binder.bind(ITextHover.class).to(DelegatingHover.class);
-		binder.bind(ITextHover.class).annotatedWith(com.google.inject.name.Names.named(DelegatingHover.PRIORITY_HOVER)).to(AnnotationWithQuickFixesHover.class);
-		binder.bind(ITextHover.class).annotatedWith(com.google.inject.name.Names.named(DelegatingHover.DEFAULT_HOVER)).to(XtextHtmlHover.class);
+		 
+	public Class<? extends org.eclipse.jface.text.ITextHover> bindITextHover() {
+		return DelegatingHover.class;
 	}
 			
-	public Class<? extends IHtmlHoverContentProvider> bindHtmlHoverContentProvider () {
+	public Class<? extends IHtmlHoverContentProvider> bindIHtmlHoverContentProvider () {
 		return DefaultHtmlHoverContentProvider.class;
 	}
 }
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DelegatingHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DelegatingHover.java
index 6999042..456530d 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DelegatingHover.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DelegatingHover.java
@@ -20,57 +20,45 @@ import org.eclipse.jface.text.ITextHoverExtension2;
 import org.eclipse.jface.text.ITextViewer;
 import org.eclipse.jface.text.source.ISourceViewer;
 import org.eclipse.xtext.ui.editor.ISourceViewerAware;
+import org.eclipse.xtext.ui.editor.hover.html.XtextHtmlHover;
 
 import com.google.inject.Inject;
+import com.google.inject.Injector;
 import com.google.inject.name.Named;
 
 /**
- * This hover delegates calls to a list of hovers. By default the list consist of two hovers: the priority hover 
- * (usually the problem/annotation hover) and a default hover. The active hover is determined by iterating over 
- * the list of hovers. The first one which returns a valid region in getHoverRegion is selected.
- * 
- * <p>Additional hovers can be configured with a guice multi binder (those hovers will be inserted between the 
- * the priority and default hovers. Please note that the multi binder does not support any ordering of the hovers.
+ * This hover delegates calls to a list of hovers. By default the list consist of the annotation/problem
+ * hover and the XtextHtmlHover. To change the list of hovers override the method createHovers.
  * 
  * @author Christoph Kulla - Initial contribution and API
  */
 public class DelegatingHover implements ITextHover, ITextHoverExtension, ITextHoverExtension2, ISourceViewerAware {
 
-	public final static String PRIORITY_HOVER = "org.eclipse.xtext.ui.editor.hover.DelegatingHover.PriorityHover";
-	public final static String DEFAULT_HOVER = "org.eclipse.xtext.ui.editor.hover.DelegatingHover.DefaultHover";
+	@Inject 
+	AnnotationWithQuickFixesHover annotationHover;
 	
-	// FIXME: remove as soon as guice multibinder works
-	public final static String ADDITIONAL_HOVER = "org.eclipse.xtext.ui.editor.hover.DelegatingHover.AdditionalHover";
+	@Inject
+	XtextHtmlHover htmlHover;
 	
 	private List<ITextHover> hovers;
-
+	
 	private ITextHover currentHover;
-
-	@Inject
-	public DelegatingHover(@Named(PRIORITY_HOVER) ITextHover priorityHover, @Named(DEFAULT_HOVER) ITextHover defaultHover) {
-		hovers = new ArrayList<ITextHover>(2);
-		hovers.add(priorityHover);
-		hovers.add(defaultHover);
-	}
-
-	@Inject(optional=true)
-	public void setAdditionalHovers (Set<ITextHover> additionalHovers) {
-		int i=0;
-		for (ITextHover hover: additionalHovers) {
-			hovers.add(1+i, hover);
-			i++;
-		}
+	
+	public List<ITextHover> getHovers() {
+		if (hovers==null)
+			hovers = createHovers();
+		return hovers;
 	}
 	
-	@Inject(optional=true)
-	public void setAdditionalHover (@Named(ADDITIONAL_HOVER) ITextHover additionalHover) {
-		Set<ITextHover> set = new HashSet<ITextHover>();
-		set.add(additionalHover);
-		setAdditionalHovers(set);
-	}	
+	protected List<ITextHover> createHovers() {
+		List<ITextHover> list = new ArrayList<ITextHover>();
+		list.add (annotationHover);
+		list.add (htmlHover);
+		return list;
+	}
 	
 	public void setSourceViewer(ISourceViewer sourceViewer) {
-		for (ITextHover hover : hovers) {
+		for (ITextHover hover : getHovers()) {
 			if (hover instanceof ISourceViewerAware)
 				((ISourceViewerAware) hover).setSourceViewer(sourceViewer);
 		}
@@ -81,7 +69,7 @@ public class DelegatingHover implements ITextHover, ITextHoverExtension, ITextHo
 	 */
 	@SuppressWarnings("deprecation")
 	public IRegion getHoverRegion(ITextViewer textViewer, int offset) {
-		for (ITextHover hover : hovers) {
+		for (ITextHover hover : getHovers()) {
 			IRegion region = hover.getHoverRegion(textViewer, offset);
 			if (region != null) {
 
-- 
1.6.6


From d54501ff23f4a3a2e42bd8bba22bdb4097800b58 Mon Sep 17 00:00:00 2001
From: Christoph Kulla <christophkulla@googlemail.com>
Date: Sat, 23 Oct 2010 16:54:42 +0200
Subject: [PATCH 04/28] Renamed DelegatingHover to CompositeHover.

---
 .../common/types/xtext/ui/JdtCompositeHover.java   |   33 +++++
 .../common/types/xtext/ui/JdtDelegatingHover.java  |   33 -----
 .../generator/types/TypesGeneratorFragment.java    |    2 +-
 .../src/org/eclipse/xtext/ui/DefaultUiModule.java  |    4 +-
 .../xtext/ui/editor/hover/CompositeHover.java      |  130 ++++++++++++++++++++
 .../xtext/ui/editor/hover/DelegatingHover.java     |  130 --------------------
 6 files changed, 166 insertions(+), 166 deletions(-)
 create mode 100644 plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JdtCompositeHover.java
 delete mode 100644 plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JdtDelegatingHover.java
 create mode 100644 plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/CompositeHover.java
 delete mode 100644 plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DelegatingHover.java

diff --git a/plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JdtCompositeHover.java b/plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JdtCompositeHover.java
new file mode 100644
index 0000000..6c779a2
--- /dev/null
+++ b/plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JdtCompositeHover.java
@@ -0,0 +1,33 @@
+/*******************************************************************************
+ * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ *******************************************************************************/
+package org.eclipse.xtext.common.types.xtext.ui;
+
+import java.util.List;
+
+import org.eclipse.jface.text.ITextHover;
+import org.eclipse.xtext.ui.editor.hover.CompositeHover;
+
+import com.google.inject.Inject;
+import com.google.inject.Injector;
+
+/**
+ * @author Christoph Kulla - Initial contribution and API
+ */
+public class JdtCompositeHover extends CompositeHover {
+
+	@Inject
+	JdtHover jdtHover;
+	
+	@Override
+	protected List<ITextHover> createHovers() {
+		List<ITextHover> list = super.createHovers();
+		list.add (1,jdtHover);
+		return list;
+	}
+
+}
diff --git a/plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JdtDelegatingHover.java b/plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JdtDelegatingHover.java
deleted file mode 100644
index 316e713..0000000
--- a/plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JdtDelegatingHover.java
+++ /dev/null
@@ -1,33 +0,0 @@
-/*******************************************************************************
- * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
- * All rights reserved. This program and the accompanying materials
- * are made available under the terms of the Eclipse Public License v1.0
- * which accompanies this distribution, and is available at
- * http://www.eclipse.org/legal/epl-v10.html
- *******************************************************************************/
-package org.eclipse.xtext.common.types.xtext.ui;
-
-import java.util.List;
-
-import org.eclipse.jface.text.ITextHover;
-import org.eclipse.xtext.ui.editor.hover.DelegatingHover;
-
-import com.google.inject.Inject;
-import com.google.inject.Injector;
-
-/**
- * @author Christoph Kulla - Initial contribution and API
- */
-public class JdtDelegatingHover extends DelegatingHover {
-
-	@Inject
-	JdtHover jdtHover;
-	
-	@Override
-	protected List<ITextHover> createHovers() {
-		List<ITextHover> list = super.createHovers();
-		list.add (1,jdtHover);
-		return list;
-	}
-
-}
diff --git a/plugins/org.eclipse.xtext.generator/src/org/eclipse/xtext/generator/types/TypesGeneratorFragment.java b/plugins/org.eclipse.xtext.generator/src/org/eclipse/xtext/generator/types/TypesGeneratorFragment.java
index 98bc33a..21d8024 100644
--- a/plugins/org.eclipse.xtext.generator/src/org/eclipse/xtext/generator/types/TypesGeneratorFragment.java
+++ b/plugins/org.eclipse.xtext.generator/src/org/eclipse/xtext/generator/types/TypesGeneratorFragment.java
@@ -55,7 +55,7 @@ public class TypesGeneratorFragment extends DefaultGeneratorFragment {
 					 	"org.eclipse.xtext.common.types.xtext.ui.TypeAwareHyperlinkHelper")
 			 .addTypeToType("org.eclipse.xtext.ui.editor.contentassist.PrefixMatcher", 
 					 	"org.eclipse.xtext.ui.editor.contentassist.FQNPrefixMatcher")
-			 .addTypeToType ("org.eclipse.jface.text.ITextHover", "org.eclipse.xtext.common.types.xtext.ui.JdtDelegatingHover")
+			 .addTypeToType ("org.eclipse.jface.text.ITextHover", "org.eclipse.xtext.common.types.xtext.ui.JdtCompositeHover")
 			 .addTypeToType("org.eclipse.xtext.ui.editor.contentassist.AbstractJavaBasedContentProposalProvider$ReferenceProposalCreator", 
 					 	"org.eclipse.xtext.common.types.xtext.ui.TypeAwareReferenceProposalCreator")
 			 .getBindings();
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java
index f2a39e4..f5dd709 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java
@@ -57,7 +57,7 @@ import org.eclipse.xtext.ui.editor.formatting.ContentFormatterFactory;
 import org.eclipse.xtext.ui.editor.formatting.IContentFormatterFactory;
 import org.eclipse.xtext.ui.editor.formatting.PreferenceStoreIndentationInformation;
 import org.eclipse.xtext.ui.editor.hover.ProblemHover;
-import org.eclipse.xtext.ui.editor.hover.DelegatingHover;
+import org.eclipse.xtext.ui.editor.hover.CompositeHover;
 import org.eclipse.xtext.ui.editor.hover.html.DefaultHtmlHoverContentProvider;
 import org.eclipse.xtext.ui.editor.hover.html.IHtmlHoverContentProvider;
 import org.eclipse.xtext.ui.editor.hyperlinking.DefaultHyperlinkDetector;
@@ -305,7 +305,7 @@ public class DefaultUiModule extends AbstractGenericModule {
 	}
 		 
 	public Class<? extends org.eclipse.jface.text.ITextHover> bindITextHover() {
-		return DelegatingHover.class;
+		return CompositeHover.class;
 	}
 			
 	public Class<? extends IHtmlHoverContentProvider> bindIHtmlHoverContentProvider () {
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/CompositeHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/CompositeHover.java
new file mode 100644
index 0000000..f297b4b
--- /dev/null
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/CompositeHover.java
@@ -0,0 +1,130 @@
+/*******************************************************************************
+ * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ *******************************************************************************/
+package org.eclipse.xtext.ui.editor.hover;
+
+import java.util.ArrayList;
+import java.util.HashSet;
+import java.util.List;
+import java.util.Set;
+
+import org.eclipse.jface.text.IInformationControlCreator;
+import org.eclipse.jface.text.IRegion;
+import org.eclipse.jface.text.ITextHover;
+import org.eclipse.jface.text.ITextHoverExtension;
+import org.eclipse.jface.text.ITextHoverExtension2;
+import org.eclipse.jface.text.ITextViewer;
+import org.eclipse.jface.text.source.ISourceViewer;
+import org.eclipse.xtext.ui.editor.ISourceViewerAware;
+import org.eclipse.xtext.ui.editor.hover.html.XtextHtmlHover;
+
+import com.google.inject.Inject;
+import com.google.inject.Injector;
+import com.google.inject.name.Named;
+
+/**
+ * This hover delegates calls to a list of hovers. By default the list consist of the annotation/problem
+ * hover and the XtextHtmlHover. To change the list of hovers override the method createHovers.
+ * 
+ * @author Christoph Kulla - Initial contribution and API
+ */
+public class CompositeHover implements ITextHover, ITextHoverExtension, ITextHoverExtension2, ISourceViewerAware {
+
+	@Inject 
+	AnnotationWithQuickFixesHover annotationHover;
+	
+	@Inject
+	XtextHtmlHover htmlHover;
+	
+	private List<ITextHover> hovers;
+	
+	private ITextHover currentHover;
+	
+	public List<ITextHover> getHovers() {
+		if (hovers==null)
+			hovers = createHovers();
+		return hovers;
+	}
+	
+	protected List<ITextHover> createHovers() {
+		List<ITextHover> list = new ArrayList<ITextHover>();
+		list.add (annotationHover);
+		list.add (htmlHover);
+		return list;
+	}
+	
+	public void setSourceViewer(ISourceViewer sourceViewer) {
+		for (ITextHover hover : getHovers()) {
+			if (hover instanceof ISourceViewerAware)
+				((ISourceViewerAware) hover).setSourceViewer(sourceViewer);
+		}
+	}
+
+	/*
+	 * @see ITextHover#getHoverRegion(ITextViewer, int)
+	 */
+	@SuppressWarnings("deprecation")
+	public IRegion getHoverRegion(ITextViewer textViewer, int offset) {
+		for (ITextHover hover : getHovers()) {
+			IRegion region = hover.getHoverRegion(textViewer, offset);
+			if (region != null) {
+
+				Object hoverInfo = null;
+				if (hover instanceof ITextHoverExtension2)
+					hoverInfo = ((ITextHoverExtension2) hover).getHoverInfo2(textViewer, region);
+				else {
+					hoverInfo = hover.getHoverInfo(textViewer, region);
+				}
+				if (hoverInfo != null && !(hoverInfo instanceof String && ((String) hoverInfo).length() == 0)) {
+					currentHover = hover;
+					return region;
+				}
+			}
+		}
+		currentHover = null;
+		return null;
+	}
+
+	/*
+	 * @see ITextHover#getHoverInfo(ITextViewer, IRegion)
+	 */
+	@Deprecated
+	public String getHoverInfo(ITextViewer textViewer, IRegion hoverRegion) {
+		// should never be called
+		if (currentHover != null) {
+			return currentHover.getHoverInfo(textViewer, hoverRegion);
+		}
+		return null;
+	}
+
+	/*
+	 * @see org.eclipse.jface.text.ITextHoverExtension2#getHoverInfo2(org.eclipse.jface.text.ITextViewer, org.eclipse.jface.text.IRegion)
+	 * @since 3.4
+	 */
+	@SuppressWarnings("deprecation")
+	public Object getHoverInfo2(ITextViewer textViewer, IRegion hoverRegion) {
+		if (currentHover != null) {
+			if (currentHover instanceof ITextHoverExtension2)
+				return ((ITextHoverExtension2) currentHover).getHoverInfo2(textViewer, hoverRegion);
+			else {
+				return currentHover.getHoverInfo(textViewer, hoverRegion);
+			}
+		}
+		return null;
+	}
+
+	/*
+	 * @see org.eclipse.jface.text.ITextHoverExtension#getHoverControlCreator()
+	 * @since 3.4
+	 */
+	public IInformationControlCreator getHoverControlCreator() {
+		if (currentHover instanceof ITextHoverExtension)
+			return ((ITextHoverExtension) currentHover).getHoverControlCreator();
+		return null;
+	}
+
+}
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DelegatingHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DelegatingHover.java
deleted file mode 100644
index 456530d..0000000
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DelegatingHover.java
+++ /dev/null
@@ -1,130 +0,0 @@
-/*******************************************************************************
- * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
- * All rights reserved. This program and the accompanying materials
- * are made available under the terms of the Eclipse Public License v1.0
- * which accompanies this distribution, and is available at
- * http://www.eclipse.org/legal/epl-v10.html
- *******************************************************************************/
-package org.eclipse.xtext.ui.editor.hover;
-
-import java.util.ArrayList;
-import java.util.HashSet;
-import java.util.List;
-import java.util.Set;
-
-import org.eclipse.jface.text.IInformationControlCreator;
-import org.eclipse.jface.text.IRegion;
-import org.eclipse.jface.text.ITextHover;
-import org.eclipse.jface.text.ITextHoverExtension;
-import org.eclipse.jface.text.ITextHoverExtension2;
-import org.eclipse.jface.text.ITextViewer;
-import org.eclipse.jface.text.source.ISourceViewer;
-import org.eclipse.xtext.ui.editor.ISourceViewerAware;
-import org.eclipse.xtext.ui.editor.hover.html.XtextHtmlHover;
-
-import com.google.inject.Inject;
-import com.google.inject.Injector;
-import com.google.inject.name.Named;
-
-/**
- * This hover delegates calls to a list of hovers. By default the list consist of the annotation/problem
- * hover and the XtextHtmlHover. To change the list of hovers override the method createHovers.
- * 
- * @author Christoph Kulla - Initial contribution and API
- */
-public class DelegatingHover implements ITextHover, ITextHoverExtension, ITextHoverExtension2, ISourceViewerAware {
-
-	@Inject 
-	AnnotationWithQuickFixesHover annotationHover;
-	
-	@Inject
-	XtextHtmlHover htmlHover;
-	
-	private List<ITextHover> hovers;
-	
-	private ITextHover currentHover;
-	
-	public List<ITextHover> getHovers() {
-		if (hovers==null)
-			hovers = createHovers();
-		return hovers;
-	}
-	
-	protected List<ITextHover> createHovers() {
-		List<ITextHover> list = new ArrayList<ITextHover>();
-		list.add (annotationHover);
-		list.add (htmlHover);
-		return list;
-	}
-	
-	public void setSourceViewer(ISourceViewer sourceViewer) {
-		for (ITextHover hover : getHovers()) {
-			if (hover instanceof ISourceViewerAware)
-				((ISourceViewerAware) hover).setSourceViewer(sourceViewer);
-		}
-	}
-
-	/*
-	 * @see ITextHover#getHoverRegion(ITextViewer, int)
-	 */
-	@SuppressWarnings("deprecation")
-	public IRegion getHoverRegion(ITextViewer textViewer, int offset) {
-		for (ITextHover hover : getHovers()) {
-			IRegion region = hover.getHoverRegion(textViewer, offset);
-			if (region != null) {
-
-				Object hoverInfo = null;
-				if (hover instanceof ITextHoverExtension2)
-					hoverInfo = ((ITextHoverExtension2) hover).getHoverInfo2(textViewer, region);
-				else {
-					hoverInfo = hover.getHoverInfo(textViewer, region);
-				}
-				if (hoverInfo != null && !(hoverInfo instanceof String && ((String) hoverInfo).length() == 0)) {
-					currentHover = hover;
-					return region;
-				}
-			}
-		}
-		currentHover = null;
-		return null;
-	}
-
-	/*
-	 * @see ITextHover#getHoverInfo(ITextViewer, IRegion)
-	 */
-	@Deprecated
-	public String getHoverInfo(ITextViewer textViewer, IRegion hoverRegion) {
-		// should never be called
-		if (currentHover != null) {
-			return currentHover.getHoverInfo(textViewer, hoverRegion);
-		}
-		return null;
-	}
-
-	/*
-	 * @see org.eclipse.jface.text.ITextHoverExtension2#getHoverInfo2(org.eclipse.jface.text.ITextViewer, org.eclipse.jface.text.IRegion)
-	 * @since 3.4
-	 */
-	@SuppressWarnings("deprecation")
-	public Object getHoverInfo2(ITextViewer textViewer, IRegion hoverRegion) {
-		if (currentHover != null) {
-			if (currentHover instanceof ITextHoverExtension2)
-				return ((ITextHoverExtension2) currentHover).getHoverInfo2(textViewer, hoverRegion);
-			else {
-				return currentHover.getHoverInfo(textViewer, hoverRegion);
-			}
-		}
-		return null;
-	}
-
-	/*
-	 * @see org.eclipse.jface.text.ITextHoverExtension#getHoverControlCreator()
-	 * @since 3.4
-	 */
-	public IInformationControlCreator getHoverControlCreator() {
-		if (currentHover instanceof ITextHoverExtension)
-			return ((ITextHoverExtension) currentHover).getHoverControlCreator();
-		return null;
-	}
-
-}
-- 
1.6.6


From 7787e1e167ba75d9eaad8331cc79e8b3f79ebb93 Mon Sep 17 00:00:00 2001
From: Christoph Kulla <christophkulla@googlemail.com>
Date: Sat, 23 Oct 2010 17:09:54 +0200
Subject: [PATCH 05/28] Split CompositeHover into CompositeHover and DefaultCompositeHover. CompositeHover is an abstract class where the method createHovers() is abstract. The DefaultCompositeHover is configured with the problem and html hover and should serve as the default Xtext hover. If users want to create a complete different hover they can now subclass from CompositeHover.

---
 .../common/types/xtext/ui/JdtCompositeHover.java   |    4 +-
 .../src/org/eclipse/xtext/ui/DefaultUiModule.java  |    4 +-
 .../xtext/ui/editor/hover/CompositeHover.java      |   57 +++++---------------
 .../ui/editor/hover/DefaultCompositeHover.java     |   39 +++++++++++++
 4 files changed, 57 insertions(+), 47 deletions(-)
 create mode 100644 plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DefaultCompositeHover.java

diff --git a/plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JdtCompositeHover.java b/plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JdtCompositeHover.java
index 6c779a2..db6145d 100644
--- a/plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JdtCompositeHover.java
+++ b/plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JdtCompositeHover.java
@@ -10,7 +10,7 @@ package org.eclipse.xtext.common.types.xtext.ui;
 import java.util.List;
 
 import org.eclipse.jface.text.ITextHover;
-import org.eclipse.xtext.ui.editor.hover.CompositeHover;
+import org.eclipse.xtext.ui.editor.hover.DefaultCompositeHover;
 
 import com.google.inject.Inject;
 import com.google.inject.Injector;
@@ -18,7 +18,7 @@ import com.google.inject.Injector;
 /**
  * @author Christoph Kulla - Initial contribution and API
  */
-public class JdtCompositeHover extends CompositeHover {
+public class JdtCompositeHover extends DefaultCompositeHover {
 
 	@Inject
 	JdtHover jdtHover;
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java
index f5dd709..e85cc49 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java
@@ -57,7 +57,7 @@ import org.eclipse.xtext.ui.editor.formatting.ContentFormatterFactory;
 import org.eclipse.xtext.ui.editor.formatting.IContentFormatterFactory;
 import org.eclipse.xtext.ui.editor.formatting.PreferenceStoreIndentationInformation;
 import org.eclipse.xtext.ui.editor.hover.ProblemHover;
-import org.eclipse.xtext.ui.editor.hover.CompositeHover;
+import org.eclipse.xtext.ui.editor.hover.DefaultCompositeHover;
 import org.eclipse.xtext.ui.editor.hover.html.DefaultHtmlHoverContentProvider;
 import org.eclipse.xtext.ui.editor.hover.html.IHtmlHoverContentProvider;
 import org.eclipse.xtext.ui.editor.hyperlinking.DefaultHyperlinkDetector;
@@ -305,7 +305,7 @@ public class DefaultUiModule extends AbstractGenericModule {
 	}
 		 
 	public Class<? extends org.eclipse.jface.text.ITextHover> bindITextHover() {
-		return CompositeHover.class;
+		return DefaultCompositeHover.class;
 	}
 			
 	public Class<? extends IHtmlHoverContentProvider> bindIHtmlHoverContentProvider () {
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/CompositeHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/CompositeHover.java
index f297b4b..5326b30 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/CompositeHover.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/CompositeHover.java
@@ -7,10 +7,7 @@
  *******************************************************************************/
 package org.eclipse.xtext.ui.editor.hover;
 
-import java.util.ArrayList;
-import java.util.HashSet;
 import java.util.List;
-import java.util.Set;
 
 import org.eclipse.jface.text.IInformationControlCreator;
 import org.eclipse.jface.text.IRegion;
@@ -20,43 +17,31 @@ import org.eclipse.jface.text.ITextHoverExtension2;
 import org.eclipse.jface.text.ITextViewer;
 import org.eclipse.jface.text.source.ISourceViewer;
 import org.eclipse.xtext.ui.editor.ISourceViewerAware;
-import org.eclipse.xtext.ui.editor.hover.html.XtextHtmlHover;
-
-import com.google.inject.Inject;
-import com.google.inject.Injector;
-import com.google.inject.name.Named;
 
 /**
- * This hover delegates calls to a list of hovers. By default the list consist of the annotation/problem
- * hover and the XtextHtmlHover. To change the list of hovers override the method createHovers.
+ * The CompositeHover is a hover which delegates calls to a list of hovers. It iterates through this list of hovers 
+ * and chooses the first one which provides a region in getHoverRegion(). Override the method createHovers() to 
+ * configure the list of hovers.
  * 
  * @author Christoph Kulla - Initial contribution and API
  */
-public class CompositeHover implements ITextHover, ITextHoverExtension, ITextHoverExtension2, ISourceViewerAware {
+public abstract class CompositeHover implements ITextHover, ITextHoverExtension, ITextHoverExtension2, ISourceViewerAware {
 
-	@Inject 
-	AnnotationWithQuickFixesHover annotationHover;
-	
-	@Inject
-	XtextHtmlHover htmlHover;
-	
 	private List<ITextHover> hovers;
-	
 	private ITextHover currentHover;
-	
+
+	public CompositeHover() {
+		super();
+	}
+
 	public List<ITextHover> getHovers() {
 		if (hovers==null)
 			hovers = createHovers();
 		return hovers;
 	}
-	
-	protected List<ITextHover> createHovers() {
-		List<ITextHover> list = new ArrayList<ITextHover>();
-		list.add (annotationHover);
-		list.add (htmlHover);
-		return list;
-	}
-	
+
+	abstract protected List<ITextHover> createHovers();
+
 	public void setSourceViewer(ISourceViewer sourceViewer) {
 		for (ITextHover hover : getHovers()) {
 			if (hover instanceof ISourceViewerAware)
@@ -64,15 +49,12 @@ public class CompositeHover implements ITextHover, ITextHoverExtension, ITextHov
 		}
 	}
 
-	/*
-	 * @see ITextHover#getHoverRegion(ITextViewer, int)
-	 */
 	@SuppressWarnings("deprecation")
 	public IRegion getHoverRegion(ITextViewer textViewer, int offset) {
 		for (ITextHover hover : getHovers()) {
 			IRegion region = hover.getHoverRegion(textViewer, offset);
 			if (region != null) {
-
+	
 				Object hoverInfo = null;
 				if (hover instanceof ITextHoverExtension2)
 					hoverInfo = ((ITextHoverExtension2) hover).getHoverInfo2(textViewer, region);
@@ -89,9 +71,6 @@ public class CompositeHover implements ITextHover, ITextHoverExtension, ITextHov
 		return null;
 	}
 
-	/*
-	 * @see ITextHover#getHoverInfo(ITextViewer, IRegion)
-	 */
 	@Deprecated
 	public String getHoverInfo(ITextViewer textViewer, IRegion hoverRegion) {
 		// should never be called
@@ -101,10 +80,6 @@ public class CompositeHover implements ITextHover, ITextHoverExtension, ITextHov
 		return null;
 	}
 
-	/*
-	 * @see org.eclipse.jface.text.ITextHoverExtension2#getHoverInfo2(org.eclipse.jface.text.ITextViewer, org.eclipse.jface.text.IRegion)
-	 * @since 3.4
-	 */
 	@SuppressWarnings("deprecation")
 	public Object getHoverInfo2(ITextViewer textViewer, IRegion hoverRegion) {
 		if (currentHover != null) {
@@ -117,14 +92,10 @@ public class CompositeHover implements ITextHover, ITextHoverExtension, ITextHov
 		return null;
 	}
 
-	/*
-	 * @see org.eclipse.jface.text.ITextHoverExtension#getHoverControlCreator()
-	 * @since 3.4
-	 */
 	public IInformationControlCreator getHoverControlCreator() {
 		if (currentHover instanceof ITextHoverExtension)
 			return ((ITextHoverExtension) currentHover).getHoverControlCreator();
 		return null;
 	}
 
-}
+}
\ No newline at end of file
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DefaultCompositeHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DefaultCompositeHover.java
new file mode 100644
index 0000000..5edcf73
--- /dev/null
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DefaultCompositeHover.java
@@ -0,0 +1,39 @@
+/*******************************************************************************
+ * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ *******************************************************************************/
+package org.eclipse.xtext.ui.editor.hover;
+
+import java.util.ArrayList;
+import java.util.List;
+import org.eclipse.jface.text.ITextHover;
+import org.eclipse.xtext.ui.editor.hover.html.XtextHtmlHover;
+
+import com.google.inject.Inject;
+
+/**
+ * This hover delegates calls to a list of hovers. By default the list consist of the annotation/problem
+ * hover and the XtextHtmlHover. To change the list of hovers override the method createHovers.
+ * 
+ * @author Christoph Kulla - Initial contribution and API
+ */
+public class DefaultCompositeHover extends CompositeHover  {
+
+	@Inject 
+	AnnotationWithQuickFixesHover annotationHover;
+	
+	@Inject
+	XtextHtmlHover htmlHover;
+	
+	@Override
+	protected List<ITextHover> createHovers() {
+		List<ITextHover> list = new ArrayList<ITextHover>();
+		list.add (annotationHover);
+		list.add (htmlHover);
+		return list;
+	}
+
+}
-- 
1.6.6


From 8e525855c8ce01d28c0f18d4bb67be32be2fb76f Mon Sep 17 00:00:00 2001
From: Christoph Kulla <christophkulla@googlemail.com>
Date: Sat, 23 Oct 2010 17:14:23 +0200
Subject: [PATCH 06/28] Fixed javadoc comment.

---
 .../ui/editor/hover/DefaultCompositeHover.java     |    4 ++--
 1 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DefaultCompositeHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DefaultCompositeHover.java
index 5edcf73..10a41a8 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DefaultCompositeHover.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DefaultCompositeHover.java
@@ -15,8 +15,8 @@ import org.eclipse.xtext.ui.editor.hover.html.XtextHtmlHover;
 import com.google.inject.Inject;
 
 /**
- * This hover delegates calls to a list of hovers. By default the list consist of the annotation/problem
- * hover and the XtextHtmlHover. To change the list of hovers override the method createHovers.
+ * The default implementation of a composite hover. Configured with the 
+ * AnnotationWithQuickFixesHover and XtextHtmlHover.
  * 
  * @author Christoph Kulla - Initial contribution and API
  */
-- 
1.6.6


From 17de782de4af5335cbb1d6167180e1403817d6cf Mon Sep 17 00:00:00 2001
From: Christoph Kulla <christophkulla@googlemail.com>
Date: Sat, 23 Oct 2010 17:49:30 +0200
Subject: [PATCH 07/28] Fixed 2) You should not pass EObjects/AbstractNodes as a result of an IUnitOfWork,
 e.g. in AbstractXtextEditorHover.getXtextElementAt(ITextViewer, int) as these
 could change concurrently thus becoming invalid. You have to put all
 calculation on these inside the unit. If you just need offset and length,
 consider using a (Text)Region.

---
 .../xtext/common/types/xtext/ui/JdtHover.java      |   24 ++---
 .../ui/editor/hover/AbstractXtextEditorHover.java  |   96 +++++++++++---------
 .../xtext/ui/editor/hover/html/XtextHtmlHover.java |    2 +-
 3 files changed, 61 insertions(+), 61 deletions(-)

diff --git a/plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JdtHover.java b/plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JdtHover.java
index 9e87844..b1bc038 100644
--- a/plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JdtHover.java
+++ b/plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JdtHover.java
@@ -46,26 +46,20 @@ public class JdtHover extends AbstractXtextEditorHover {
 
 	public Object getHoverInfo2(final ITextViewer textViewer, final IRegion hoverRegion) {		
 		IXtextDocument xtextDocument = XtextDocumentUtil.get(textViewer);
-
-		JvmIdentifyableElement element = xtextDocument.readOnly(new IUnitOfWork<JvmIdentifyableElement, XtextResource>() {
-			public JvmIdentifyableElement exec(XtextResource state) throws Exception {
-				Pair<AbstractNode,EObject> element = getXtextElementAt(textViewer, hoverRegion);
+		return xtextDocument.readOnly(new IUnitOfWork<Object, XtextResource>() {
+			public Object exec(XtextResource state) throws Exception {
+				Pair<AbstractNode,EObject> element = getXtextElementAt(state, hoverRegion);
 				if (element!=null && element.getSecond() instanceof JvmIdentifyableElement) {
-					return (JvmIdentifyableElement) element.getSecond();
-
+					JvmIdentifyableElement jvmIdentifyableElement = (JvmIdentifyableElement) element.getSecond();
+					IJavaElement javaElement = javaElementFinder.findElementFor(jvmIdentifyableElement);
+					if (javaElement!=null) {
+						javadocHover.setJavaElement(javaElement);
+						return javadocHover.getHoverInfo2(textViewer, hoverRegion);
+					}
 				} 
 				return null;
 			}		
 		});
-		 
-		if (element!=null) {	
-			IJavaElement javaElement = javaElementFinder.findElementFor(element);
-			if (javaElement!=null) {
-				javadocHover.setJavaElement(javaElement);
-				return javadocHover.getHoverInfo2(textViewer, hoverRegion);
-			}
-		}
-		return null;
 	}
 
 	@Override
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractXtextEditorHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractXtextEditorHover.java
index 66842d7..15b96d7 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractXtextEditorHover.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractXtextEditorHover.java
@@ -44,13 +44,19 @@ public abstract class AbstractXtextEditorHover implements ITextHover, ITextHover
 	@Inject
 	private EObjectAtOffsetHelper eObjectAtOffsetHelper;
 	
-	public IRegion getHoverRegion(ITextViewer textViewer, int offset) {
-		Pair<AbstractNode, EObject> element = getXtextElementAt(textViewer, offset);
-		if (element != null) {
-			return new Region(element.getFirst().getOffset(), element.getFirst().getLength());
-		} else {
-			return null;
-		}
+	public IRegion getHoverRegion(final ITextViewer textViewer, final int offset) {
+		IXtextDocument xtextDocument = XtextDocumentUtil.get(textViewer);
+		return xtextDocument.readOnly(new IUnitOfWork<IRegion, XtextResource>() {
+
+			public IRegion exec(XtextResource state) throws Exception {
+				Pair<AbstractNode, EObject> element = getXtextElementAt(state, offset);
+				if (element != null) {
+					return new Region(element.getFirst().getOffset(), element.getFirst().getLength());
+				} else {
+					return null;
+				}
+			}
+		});
 	}
 
 	/*
@@ -65,50 +71,50 @@ public abstract class AbstractXtextEditorHover implements ITextHover, ITextHover
 		};
 	}
 
-	protected Pair<AbstractNode, EObject> getXtextElementAt(ITextViewer textViewer, final IRegion hoverRegion) {
-		return getXtextElementAt(textViewer, hoverRegion.getOffset());
+	/**
+	 * Call this method only from within an IUnitOfWork
+	 */
+	protected Pair<AbstractNode, EObject> getXtextElementAt(XtextResource resource, final IRegion hoverRegion) {
+		return getXtextElementAt(resource, hoverRegion.getOffset());
 	}
 
-	protected Pair<AbstractNode, EObject> getXtextElementAt(ITextViewer textViewer, final int offset) {
-		IXtextDocument xtextDocument = XtextDocumentUtil.get(textViewer);
-		return xtextDocument.readOnly(new IUnitOfWork<Pair<AbstractNode, EObject>, XtextResource>() {
+	/**
+	 * Call this method only from within an IUnitOfWork
+	 */
+	protected Pair<AbstractNode, EObject> getXtextElementAt(XtextResource resource, final int offset) {
+		AbstractNode an = ParseTreeUtil.getCurrentOrFollowingNodeByOffset(resource.getParseResult().getRootNode(),
+				offset);
 
-			public Pair<AbstractNode, EObject> exec(XtextResource state) throws Exception {
-				AbstractNode an = ParseTreeUtil.getCurrentOrFollowingNodeByOffset(state.getParseResult().getRootNode(), offset);
-				
-				{
-					// check assignment to name
-					EObject o = NodeUtil.findASTElement(an);
-					if (o!=null) {
-						EStructuralFeature nameFeature = o.eClass().getEStructuralFeature("name");
-						if (nameFeature!=null) {
-							List<AbstractNode> nodes = NodeUtil.findNodesForFeature (o, nameFeature);
-							if (contains(nodes, an))
-								return Tuples.create(an, o);
-						}
-					}
+		{
+			// check assignment to name
+			EObject o = NodeUtil.findASTElement(an);
+			if (o != null) {
+				EStructuralFeature nameFeature = o.eClass().getEStructuralFeature("name");
+				if (nameFeature != null) {
+					List<AbstractNode> nodes = NodeUtil.findNodesForFeature(o, nameFeature);
+					if (contains(nodes, an))
+						return Tuples.create(an, o);
 				}
-				
-				// check cross reference
-				EObject crossLinkedEObject = eObjectAtOffsetHelper.resolveCrossReferencedElementAt(state, offset);
-				if (crossLinkedEObject != null && !crossLinkedEObject.eIsProxy()) {
-					return Tuples.create(an, crossLinkedEObject);
-				}
-				return null;
 			}
+		}
 
-			private boolean contains(List<AbstractNode> nodes, AbstractNode an) {
-				for (AbstractNode n: nodes) {
-					if (n==an) 
-						return true;
-					if (n instanceof CompositeNode) {
-						if (contains (((CompositeNode) n).getChildren(), an))
-							return true;
-					}
-				}
-				return false;
+		// check cross reference
+		EObject crossLinkedEObject = eObjectAtOffsetHelper.resolveCrossReferencedElementAt(resource, offset);
+		if (crossLinkedEObject != null && !crossLinkedEObject.eIsProxy()) {
+			return Tuples.create(an, crossLinkedEObject);
+		}
+		return null;
+	}
+
+	private boolean contains(List<AbstractNode> nodes, AbstractNode an) {
+		for (AbstractNode n: nodes) {
+			if (n==an) 
+				return true;
+			if (n instanceof CompositeNode) {
+				if (contains (((CompositeNode) n).getChildren(), an))
+					return true;
 			}
-		});
+		}
+		return false;
 	}
-	
 }
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextHtmlHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextHtmlHover.java
index c020561..5a020f4 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextHtmlHover.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextHtmlHover.java
@@ -406,7 +406,7 @@ public class XtextHtmlHover extends AbstractXtextEditorHover {
 
 		return xtextDocument.readOnly(new IUnitOfWork<XtextBrowserInformationControlInput, XtextResource>() {
 			public XtextBrowserInformationControlInput exec(XtextResource state) throws Exception {
-				Pair<AbstractNode,EObject> element = getXtextElementAt(textViewer, hoverRegion);
+				Pair<AbstractNode,EObject> element = getXtextElementAt(state, hoverRegion);
 				if (element!=null && element.getSecond()!=null) {
 					return getHoverInfo (element.getSecond(), hoverRegion, null);
 				} 
-- 
1.6.6


From c17d0ef036156f2ee369df05a7a34009d4b2c5dc Mon Sep 17 00:00:00 2001
From: Christoph Kulla <christophkulla@googlemail.com>
Date: Sat, 23 Oct 2010 19:35:21 +0200
Subject: [PATCH 08/28] Removed blank line at end in problem hover when showing multiple messages.

---
 .../xtext/ui/editor/hover/AbstractHover.java       |    1 +
 1 files changed, 1 insertions(+), 0 deletions(-)

diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractHover.java
index b10bc9b..3a3f37d 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractHover.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractHover.java
@@ -75,6 +75,7 @@ public abstract class AbstractHover implements IAnnotationHover, ITextHover, ITe
 			while (e.hasNext()) {
 				splitInfo("- " + e.next() + "\n", buffer);
 			}
+			buffer.deleteCharAt(buffer.length()-1);
 		}
 		else if (messages.size() == 1) {
 			splitInfo(messages.iterator().next(), buffer);
-- 
1.6.6


From 82dbc66df47bfd2f35dec231923b64b746931965 Mon Sep 17 00:00:00 2001
From: Christoph Kulla <christophkulla@googlemail.com>
Date: Sat, 23 Oct 2010 20:41:02 +0200
Subject: [PATCH 09/28] Refactoring of hovers:
 - AbstractHover is now the common base classes for hovers.
 - Renamed AbstractXtextEditorHover to AbstractEObjectHover
 - AbstractEObjectHover is derived from AbstractHover and retrieves the EObject at the hover region.
 - AbstractHover is no longer implementing IAnnotationHover (not all hovers are annotation hovers).
 - ProblemHover is implementing IAnnotationHover directly.

---
 .../xtext/common/types/xtext/ui/JdtHover.java      |   20 +++-
 .../ui/editor/hover/AbstractEObjectHover.java      |  130 +++++++++++++++++++
 .../xtext/ui/editor/hover/AbstractHover.java       |  118 ++++++++++-------
 .../ui/editor/hover/AbstractXtextEditorHover.java  |  120 -----------------
 .../xtext/ui/editor/hover/ProblemHover.java        |  135 ++++++++++---------
 .../xtext/ui/editor/hover/html/XtextHtmlHover.java |   11 ++-
 6 files changed, 297 insertions(+), 237 deletions(-)
 create mode 100644 plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractEObjectHover.java
 delete mode 100644 plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractXtextEditorHover.java

diff --git a/plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JdtHover.java b/plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JdtHover.java
index b1bc038..ff143a9 100644
--- a/plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JdtHover.java
+++ b/plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JdtHover.java
@@ -12,11 +12,12 @@ import org.eclipse.jdt.core.IJavaElement;
 import org.eclipse.jface.text.IInformationControlCreator;
 import org.eclipse.jface.text.IRegion;
 import org.eclipse.jface.text.ITextViewer;
+import org.eclipse.jface.text.Region;
 import org.eclipse.xtext.common.types.JvmIdentifyableElement;
 import org.eclipse.xtext.common.types.util.jdt.IJavaElementFinder;
 import org.eclipse.xtext.parsetree.AbstractNode;
 import org.eclipse.xtext.resource.XtextResource;
-import org.eclipse.xtext.ui.editor.hover.AbstractXtextEditorHover;
+import org.eclipse.xtext.ui.editor.hover.AbstractEObjectHover;
 import org.eclipse.xtext.ui.editor.model.IXtextDocument;
 import org.eclipse.xtext.ui.editor.model.XtextDocumentUtil;
 import org.eclipse.xtext.util.Pair;
@@ -28,13 +29,14 @@ import com.google.inject.Inject;
  * @author Christoph Kulla - Initial contribution and API
  */
 @SuppressWarnings("restriction")
-public class JdtHover extends AbstractXtextEditorHover {
+public class JdtHover extends AbstractEObjectHover {
 
 	@Inject
 	private IJavaElementFinder javaElementFinder;
 	
 	private JavadocHoverWrapper javadocHover = new JavadocHoverWrapper ();
 	
+	@Override
 	@Deprecated
 	public String getHoverInfo(ITextViewer textViewer, IRegion hoverRegion) {
 		Object o = getHoverInfo2(textViewer, hoverRegion);
@@ -44,6 +46,7 @@ public class JdtHover extends AbstractXtextEditorHover {
 		return null;
 	}
 
+	@Override
 	public Object getHoverInfo2(final ITextViewer textViewer, final IRegion hoverRegion) {		
 		IXtextDocument xtextDocument = XtextDocumentUtil.get(textViewer);
 		return xtextDocument.readOnly(new IUnitOfWork<Object, XtextResource>() {
@@ -67,5 +70,18 @@ public class JdtHover extends AbstractXtextEditorHover {
 		return javadocHover.getHoverControlCreator();
 	}
 
+	@Override
+	protected Object getHoverInfo2(final EObject eObject, final ITextViewer textViewer, final IRegion hoverRegion) {
+		if (eObject instanceof JvmIdentifyableElement) {
+			JvmIdentifyableElement jvmIdentifyableElement = (JvmIdentifyableElement) eObject;
+			IJavaElement javaElement = javaElementFinder.findElementFor(jvmIdentifyableElement);
+			if (javaElement!=null) {
+				javadocHover.setJavaElement(javaElement);
+				return javadocHover.getHoverInfo2(textViewer, hoverRegion);
+			}
+		} 
+		return null;
+	}
+
 	
 }
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractEObjectHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractEObjectHover.java
new file mode 100644
index 0000000..aa34282
--- /dev/null
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractEObjectHover.java
@@ -0,0 +1,130 @@
+/*******************************************************************************
+ * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ *******************************************************************************/
+package org.eclipse.xtext.ui.editor.hover;
+
+import java.util.List;
+
+import org.eclipse.emf.ecore.EObject;
+import org.eclipse.emf.ecore.EStructuralFeature;
+import org.eclipse.jface.text.DefaultInformationControl;
+import org.eclipse.jface.text.IInformationControl;
+import org.eclipse.jface.text.IInformationControlCreator;
+import org.eclipse.jface.text.IRegion;
+import org.eclipse.jface.text.ITextHover;
+import org.eclipse.jface.text.ITextHoverExtension;
+import org.eclipse.jface.text.ITextHoverExtension2;
+import org.eclipse.jface.text.ITextViewer;
+import org.eclipse.jface.text.Region;
+import org.eclipse.swt.widgets.Shell;
+import org.eclipse.ui.editors.text.EditorsUI;
+import org.eclipse.xtext.parsetree.AbstractNode;
+import org.eclipse.xtext.parsetree.CompositeNode;
+import org.eclipse.xtext.parsetree.NodeUtil;
+import org.eclipse.xtext.parsetree.ParseTreeUtil;
+import org.eclipse.xtext.resource.EObjectAtOffsetHelper;
+import org.eclipse.xtext.resource.XtextResource;
+import org.eclipse.xtext.ui.editor.hover.html.XtextBrowserInformationControlInput;
+import org.eclipse.xtext.ui.editor.model.IXtextDocument;
+import org.eclipse.xtext.ui.editor.model.XtextDocumentUtil;
+import org.eclipse.xtext.util.Pair;
+import org.eclipse.xtext.util.Tuples;
+import org.eclipse.xtext.util.concurrent.IUnitOfWork;
+
+import com.google.inject.Inject;
+
+/**
+ * A hover which determines the EObject at the hover region. Subclasses have to implement 
+ * getHoverInfo2 (final EObject eObject, final ITextViewer textViewer, final IRegion hoverRegion).
+ * 
+ * @author Christoph Kulla - Initial contribution and API
+ */
+public abstract class AbstractEObjectHover extends AbstractHover {
+
+	@Inject
+	private EObjectAtOffsetHelper eObjectAtOffsetHelper;
+	
+	@Override
+	public IRegion getHoverRegion(final ITextViewer textViewer, final int offset) {
+		IXtextDocument xtextDocument = XtextDocumentUtil.get(textViewer);
+		return xtextDocument.readOnly(new IUnitOfWork<IRegion, XtextResource>() {
+
+			public IRegion exec(XtextResource state) throws Exception {
+				Pair<AbstractNode, EObject> element = getXtextElementAt(state, offset);
+				if (element != null) {
+					return new Region(element.getFirst().getOffset(), element.getFirst().getLength());
+				} else {
+					return null;
+				}
+			}
+		});
+	}
+
+	public Object getHoverInfo2(final ITextViewer textViewer, final IRegion hoverRegion) {
+		if (hoverRegion==null)
+			return null;
+		IXtextDocument xtextDocument = XtextDocumentUtil.get(textViewer);
+		return xtextDocument.readOnly(new IUnitOfWork<Object, XtextResource>() {
+			public Object exec(XtextResource state) throws Exception {
+				Pair<AbstractNode,EObject> element = getXtextElementAt(state, hoverRegion.getOffset());
+				if (element!=null && element.getSecond()!=null) {
+					return getHoverInfo2 (element.getSecond(), textViewer, hoverRegion);
+				} 
+				return null;
+			}		
+		});
+	}
+	
+	protected abstract Object getHoverInfo2 (final EObject eObject, final ITextViewer textViewer, final IRegion hoverRegion);
+	
+	/**
+	 * Call this method only from within an IUnitOfWork
+	 */
+	protected Pair<AbstractNode, EObject> getXtextElementAt(XtextResource resource, final IRegion hoverRegion) {
+		return getXtextElementAt(resource, hoverRegion.getOffset());
+	}
+
+	/**
+	 * Call this method only from within an IUnitOfWork
+	 */
+	protected Pair<AbstractNode, EObject> getXtextElementAt(XtextResource resource, final int offset) {
+		AbstractNode an = ParseTreeUtil.getCurrentOrFollowingNodeByOffset(resource.getParseResult().getRootNode(),
+				offset);
+
+		{
+			// check assignment to name
+			EObject o = NodeUtil.findASTElement(an);
+			if (o != null) {
+				EStructuralFeature nameFeature = o.eClass().getEStructuralFeature("name");
+				if (nameFeature != null) {
+					List<AbstractNode> nodes = NodeUtil.findNodesForFeature(o, nameFeature);
+					if (contains(nodes, an))
+						return Tuples.create(an, o);
+				}
+			}
+		}
+
+		// check cross reference
+		EObject crossLinkedEObject = eObjectAtOffsetHelper.resolveCrossReferencedElementAt(resource, offset);
+		if (crossLinkedEObject != null && !crossLinkedEObject.eIsProxy()) {
+			return Tuples.create(an, crossLinkedEObject);
+		}
+		return null;
+	}
+
+	private boolean contains(List<AbstractNode> nodes, AbstractNode an) {
+		for (AbstractNode n: nodes) {
+			if (n==an) 
+				return true;
+			if (n instanceof CompositeNode) {
+				if (contains (((CompositeNode) n).getChildren(), an))
+					return true;
+			}
+		}
+		return false;
+	}
+}
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractHover.java
index 3a3f37d..a1cabd7 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractHover.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractHover.java
@@ -8,26 +8,36 @@
  *******************************************************************************/
 package org.eclipse.xtext.ui.editor.hover;
 
-import java.util.Collection;
 import java.util.Iterator;
+import java.util.List;
 
 import org.eclipse.jface.text.BadLocationException;
+import org.eclipse.jface.text.DefaultInformationControl;
 import org.eclipse.jface.text.IDocument;
+import org.eclipse.jface.text.IInformationControl;
+import org.eclipse.jface.text.IInformationControlCreator;
 import org.eclipse.jface.text.IRegion;
 import org.eclipse.jface.text.ITextHover;
+import org.eclipse.jface.text.ITextHoverExtension;
 import org.eclipse.jface.text.ITextHoverExtension2;
 import org.eclipse.jface.text.ITextViewer;
+import org.eclipse.jface.text.Position;
 import org.eclipse.jface.text.Region;
-import org.eclipse.jface.text.source.IAnnotationHover;
+import org.eclipse.jface.text.source.Annotation;
+import org.eclipse.jface.text.source.IAnnotationModel;
+import org.eclipse.jface.text.source.ILineDiffInfo;
 import org.eclipse.jface.text.source.ISourceViewer;
 import org.eclipse.swt.graphics.Point;
-import org.eclipse.xtext.ui.XtextUIMessages;
+import org.eclipse.swt.widgets.Shell;
+import org.eclipse.ui.editors.text.EditorsUI;
 import org.eclipse.xtext.ui.editor.ISourceViewerAware;
 
+import com.google.inject.internal.Lists;
+
 /**
  * @author Patrick Schoenbach - Initial API and implementation
  */
-public abstract class AbstractHover implements IAnnotationHover, ITextHover, ITextHoverExtension2, ISourceViewerAware {
+public abstract class AbstractHover implements ITextHover, ITextHoverExtension, ITextHoverExtension2, ISourceViewerAware {
 
 	protected ISourceViewer sourceViewer;
 
@@ -39,67 +49,77 @@ public abstract class AbstractHover implements IAnnotationHover, ITextHover, ITe
 		return sourceViewer.getDocument();
 	}
 
-	public String getHoverInfo(final ISourceViewer sourceViewer, final int lineNumber) {
-		return getHoverInfoInternal(lineNumber, -1);
+	public IAnnotationModel getAnnotationModel() {
+		return sourceViewer.getAnnotationModel();
 	}
 
 	@Deprecated
 	public String getHoverInfo(final ITextViewer textViewer, final IRegion hoverRegion) {
-		return getHoverInfo2(textViewer, hoverRegion);
+		Object o = getHoverInfo2(textViewer, hoverRegion);
+		if (o!=null)
+			return o.toString();
+		return null;
 	}
 
-	// for TextHover
-	public String getHoverInfo2(final ITextViewer textViewer, final IRegion hoverRegion) {
-		int lineNumber;
-		try {
-			lineNumber = textViewer.getDocument().getLineOfOffset(hoverRegion.getOffset());
-		}
-		catch (final BadLocationException e) {
-			return null;
-		}
-		return getHoverInfoInternal(lineNumber, hoverRegion.getOffset());
+	public int getLineNumber (final ITextViewer textViewer, final IRegion hoverRegion) throws BadLocationException {
+		return textViewer.getDocument().getLineOfOffset(hoverRegion.getOffset());
 	}
 
+
 	public IRegion getHoverRegion(final ITextViewer textViewer, final int offset) {
 		final Point selection = textViewer.getSelectedRange();
 		if (selection.x <= offset && offset < selection.x + selection.y)
 			return new Region(selection.x, selection.y);
 		return new Region(offset, 0);
 	}
-
-	protected String formatInfo(final Collection<String> messages) {
-		final StringBuffer buffer = new StringBuffer();
-		if (messages.size() > 1) {
-			buffer.append(XtextUIMessages.AbstractHover_MultipleMarkers);
-			final Iterator<String> e = messages.iterator();
-			while (e.hasNext()) {
-				splitInfo("- " + e.next() + "\n", buffer);
+	
+	/*
+	 * @see ITextHoverExtension#getHoverControlCreator()
+	 * @since 3.0
+	 */
+	public IInformationControlCreator getHoverControlCreator() {
+		return new IInformationControlCreator() {
+			public IInformationControl createInformationControl(Shell parent) {
+				return new DefaultInformationControl(parent, EditorsUI.getTooltipAffordanceString());
 			}
-			buffer.deleteCharAt(buffer.length()-1);
-		}
-		else if (messages.size() == 1) {
-			splitInfo(messages.iterator().next(), buffer);
-		}
-		return buffer.toString();
+		};
 	}
-
-	protected abstract String getHoverInfoInternal(final int lineNumber, final int offset);
-
-	private String splitInfo(final String message, final StringBuffer buffer) {
-		String msg = message;
-		String prefix = "";
-		int pos;
-		do {
-			pos = msg.indexOf(" ", 60);
-			if (pos > -1) {
-				buffer.append(prefix + msg.substring(0, pos) + "\n");
-				msg = msg.substring(pos);
-				prefix = "  ";
-			}
-			else {
-				buffer.append(prefix + msg);
+	
+	protected List<Annotation> getAnnotations (final int lineNumber, final int offset) {
+		if(getAnnotationModel() == null) {
+			return null;
+		}
+		final Iterator<?> iterator = getAnnotationModel().getAnnotationIterator();
+		List<Annotation> result = Lists.newArrayList();
+		while (iterator.hasNext()) {
+			final Annotation annotation = (Annotation) iterator.next();
+			if (!annotation.isMarkedDeleted()) {
+				Position position = getAnnotationModel().getPosition(annotation);
+				if (position != null) {
+					final int start = position.getOffset();
+					final int end = start + position.getLength();
+		
+					if (offset > 0 && !(start <= offset && offset <= end)) {
+						continue;
+					}
+					try {
+						if (lineNumber != getDocument().getLineOfOffset(
+								start)) {
+							continue;
+						}
+					} catch (final Exception x) {
+						continue;
+					}
+					if (!isLineDiffInfo(annotation)) {
+						result .add (annotation);
+					}
+				}
 			}
-		} while (pos > -1);
-		return buffer.toString();
+		}	
+		return result;
+	}
+	
+	protected boolean isLineDiffInfo(Annotation annotation) {
+		return annotation instanceof ILineDiffInfo;
 	}
 }
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractXtextEditorHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractXtextEditorHover.java
deleted file mode 100644
index 15b96d7..0000000
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractXtextEditorHover.java
+++ /dev/null
@@ -1,120 +0,0 @@
-/*******************************************************************************
- * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
- * All rights reserved. This program and the accompanying materials
- * are made available under the terms of the Eclipse Public License v1.0
- * which accompanies this distribution, and is available at
- * http://www.eclipse.org/legal/epl-v10.html
- *******************************************************************************/
-package org.eclipse.xtext.ui.editor.hover;
-
-import java.util.List;
-
-import org.eclipse.emf.ecore.EObject;
-import org.eclipse.emf.ecore.EStructuralFeature;
-import org.eclipse.jface.text.DefaultInformationControl;
-import org.eclipse.jface.text.IInformationControl;
-import org.eclipse.jface.text.IInformationControlCreator;
-import org.eclipse.jface.text.IRegion;
-import org.eclipse.jface.text.ITextHover;
-import org.eclipse.jface.text.ITextHoverExtension;
-import org.eclipse.jface.text.ITextHoverExtension2;
-import org.eclipse.jface.text.ITextViewer;
-import org.eclipse.jface.text.Region;
-import org.eclipse.swt.widgets.Shell;
-import org.eclipse.ui.editors.text.EditorsUI;
-import org.eclipse.xtext.parsetree.AbstractNode;
-import org.eclipse.xtext.parsetree.CompositeNode;
-import org.eclipse.xtext.parsetree.NodeUtil;
-import org.eclipse.xtext.parsetree.ParseTreeUtil;
-import org.eclipse.xtext.resource.EObjectAtOffsetHelper;
-import org.eclipse.xtext.resource.XtextResource;
-import org.eclipse.xtext.ui.editor.model.IXtextDocument;
-import org.eclipse.xtext.ui.editor.model.XtextDocumentUtil;
-import org.eclipse.xtext.util.Pair;
-import org.eclipse.xtext.util.Tuples;
-import org.eclipse.xtext.util.concurrent.IUnitOfWork;
-
-import com.google.inject.Inject;
-
-/**
- * @author Christoph Kulla - Initial contribution and API
- */
-public abstract class AbstractXtextEditorHover implements ITextHover, ITextHoverExtension, ITextHoverExtension2 {
-
-	@Inject
-	private EObjectAtOffsetHelper eObjectAtOffsetHelper;
-	
-	public IRegion getHoverRegion(final ITextViewer textViewer, final int offset) {
-		IXtextDocument xtextDocument = XtextDocumentUtil.get(textViewer);
-		return xtextDocument.readOnly(new IUnitOfWork<IRegion, XtextResource>() {
-
-			public IRegion exec(XtextResource state) throws Exception {
-				Pair<AbstractNode, EObject> element = getXtextElementAt(state, offset);
-				if (element != null) {
-					return new Region(element.getFirst().getOffset(), element.getFirst().getLength());
-				} else {
-					return null;
-				}
-			}
-		});
-	}
-
-	/*
-	 * @see ITextHoverExtension#getHoverControlCreator()
-	 * @since 3.0
-	 */
-	public IInformationControlCreator getHoverControlCreator() {
-		return new IInformationControlCreator() {
-			public IInformationControl createInformationControl(Shell parent) {
-				return new DefaultInformationControl(parent, EditorsUI.getTooltipAffordanceString());
-			}
-		};
-	}
-
-	/**
-	 * Call this method only from within an IUnitOfWork
-	 */
-	protected Pair<AbstractNode, EObject> getXtextElementAt(XtextResource resource, final IRegion hoverRegion) {
-		return getXtextElementAt(resource, hoverRegion.getOffset());
-	}
-
-	/**
-	 * Call this method only from within an IUnitOfWork
-	 */
-	protected Pair<AbstractNode, EObject> getXtextElementAt(XtextResource resource, final int offset) {
-		AbstractNode an = ParseTreeUtil.getCurrentOrFollowingNodeByOffset(resource.getParseResult().getRootNode(),
-				offset);
-
-		{
-			// check assignment to name
-			EObject o = NodeUtil.findASTElement(an);
-			if (o != null) {
-				EStructuralFeature nameFeature = o.eClass().getEStructuralFeature("name");
-				if (nameFeature != null) {
-					List<AbstractNode> nodes = NodeUtil.findNodesForFeature(o, nameFeature);
-					if (contains(nodes, an))
-						return Tuples.create(an, o);
-				}
-			}
-		}
-
-		// check cross reference
-		EObject crossLinkedEObject = eObjectAtOffsetHelper.resolveCrossReferencedElementAt(resource, offset);
-		if (crossLinkedEObject != null && !crossLinkedEObject.eIsProxy()) {
-			return Tuples.create(an, crossLinkedEObject);
-		}
-		return null;
-	}
-
-	private boolean contains(List<AbstractNode> nodes, AbstractNode an) {
-		for (AbstractNode n: nodes) {
-			if (n==an) 
-				return true;
-			if (n instanceof CompositeNode) {
-				if (contains (((CompositeNode) n).getChildren(), an))
-					return true;
-			}
-		}
-		return false;
-	}
-}
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/ProblemHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/ProblemHover.java
index a7aa8f9..0fe1cce 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/ProblemHover.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/ProblemHover.java
@@ -10,7 +10,9 @@
  *******************************************************************************/
 package org.eclipse.xtext.ui.editor.hover;
 
+import java.util.Collection;
 import java.util.Iterator;
+import java.util.List;
 import java.util.Set;
 
 import org.eclipse.jface.text.BadLocationException;
@@ -19,14 +21,23 @@ import org.eclipse.jface.text.ITextViewer;
 import org.eclipse.jface.text.Position;
 import org.eclipse.jface.text.Region;
 import org.eclipse.jface.text.source.Annotation;
-import org.eclipse.jface.text.source.IAnnotationModel;
-import org.eclipse.jface.text.source.ILineDiffInfo;
+import org.eclipse.jface.text.source.IAnnotationHover;
+import org.eclipse.jface.text.source.ISourceViewer;
+import org.eclipse.xtext.ui.XtextUIMessages;
+
 import com.google.common.collect.Sets;
 
 /**
  * @author Sven Efftinge - Initial contribution and API
  */
-public class ProblemHover extends AbstractHover {
+public class ProblemHover extends AbstractHover implements IAnnotationHover {
+	
+	public String getHoverInfo(final ISourceViewer sourceViewer, final int lineNumber) {
+		Object o = getHoverInfoInternal(sourceViewer, lineNumber, -1);
+		if (o!=null)
+			return o.toString();
+		return null;
+	}
 	
 	@Override
 	public IRegion getHoverRegion(final ITextViewer textViewer, final int offset) {
@@ -38,79 +49,75 @@ public class ProblemHover extends AbstractHover {
 		}
 		return null;
 	}
-	
-	protected Region getHoverRegionInternal(final int lineNumber,
-			final int offset) {
-		final IAnnotationModel model = sourceViewer.getAnnotationModel();
-		if(model == null) {
-			return null;
-		}
-		final Iterator<?> iterator = model.getAnnotationIterator();
-		while (iterator.hasNext()) {
-			final Annotation annotation = (Annotation) iterator.next();
-			if (!annotation.isMarkedDeleted()) {
-				Position position = model.getPosition(annotation);
-				if (position != null) {
-					final int start = position.getOffset();
-					final int end = start + position.getLength();
 		
-					if (offset > 0 && !(start <= offset && offset <= end)) {
-						continue;
-					}
-					try {
-						if (lineNumber != sourceViewer.getDocument().getLineOfOffset(
-								start)) {
-							continue;
-						}
-					} catch (final Exception x) {
-						continue;
-					}
-					if (!isLineDiffInfo(annotation)) {
-						return new Region (start, position.getLength());
-					}
-				}
+	protected Region getHoverRegionInternal(final int lineNumber, final int offset) {
+		List<Annotation> annotations = getAnnotations(lineNumber, offset);
+		for (Annotation annotation : annotations) {
+			Position position = sourceViewer.getAnnotationModel().getPosition(annotation);
+			if (position != null) {
+				final int start = position.getOffset();
+				return new Region (start, position.getLength());	
 			}
 		}
 		return null;
 	}
 	
-	@Override
-	protected String getHoverInfoInternal(final int lineNumber,
-			final int offset) {
-		final IAnnotationModel model = sourceViewer.getAnnotationModel();
-		if(model == null) {
+	public Object getHoverInfo2(ITextViewer textViewer, IRegion hoverRegion) {
+		int lineNumber;
+		try {
+			lineNumber = getLineNumber(textViewer, hoverRegion);
+			return getHoverInfoInternal(textViewer, lineNumber, hoverRegion.getOffset());
+		}
+		catch (final BadLocationException e) {
 			return null;
 		}
+	}
+	
+	protected Object getHoverInfoInternal(final ITextViewer textViewer, final int lineNumber, final int offset) {
 		final Set<String> messages = Sets.newLinkedHashSet();
-		final Iterator<?> iterator = model.getAnnotationIterator();
-		while (iterator.hasNext()) {
-			final Annotation annotation = (Annotation) iterator.next();
-			if (!annotation.isMarkedDeleted()) {
-				Position position = model.getPosition(annotation);
-				if (position != null) {
-					final int start = position.getOffset();
-					final int end = start + position.getLength();
-		
-					if (offset > 0 && !(start <= offset && offset <= end)) {
-						continue;
-					}
-					try {
-						if (lineNumber != sourceViewer.getDocument().getLineOfOffset(start)) {
-							continue;
-						}
-					} catch (final Exception x) {
-						continue;
-					}
-					if (annotation.getText() != null && !isLineDiffInfo(annotation)) {
-						messages.add(annotation.getText().trim());
-					} 
-				}
+		List<Annotation> annotations = getAnnotations(lineNumber, offset);
+		for (Annotation annotation : annotations) {
+			if (annotation.getText() != null) {
+				messages.add(annotation.getText().trim());
 			}
 		}
-		return formatInfo(messages);
+		if (messages.size()>0)
+			return formatInfo(messages);
+		return null;
 	}
 	
-	public boolean isLineDiffInfo(Annotation annotation) {
-		return annotation instanceof ILineDiffInfo;
+	protected String formatInfo(final Collection<String> messages) {
+		final StringBuffer buffer = new StringBuffer();
+		if (messages.size() > 1) {
+			buffer.append(XtextUIMessages.AbstractHover_MultipleMarkers);
+			final Iterator<String> e = messages.iterator();
+			while (e.hasNext()) {
+				splitInfo("- " + e.next() + "\n", buffer);
+			}
+			buffer.deleteCharAt(buffer.length()-1);
+		}
+		else if (messages.size() == 1) {
+			splitInfo(messages.iterator().next(), buffer);
+		}
+		return buffer.toString();
 	}
+	
+	private String splitInfo(final String message, final StringBuffer buffer) {
+		String msg = message;
+		String prefix = "";
+		int pos;
+		do {
+			pos = msg.indexOf(" ", 60);
+			if (pos > -1) {
+				buffer.append(prefix + msg.substring(0, pos) + "\n");
+				msg = msg.substring(pos);
+				prefix = "  ";
+			}
+			else {
+				buffer.append(prefix + msg);
+			}
+		} while (pos > -1);
+		return buffer.toString();
+	}
+
 }
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextHtmlHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextHtmlHover.java
index 5a020f4..3d6836b 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextHtmlHover.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextHtmlHover.java
@@ -42,7 +42,7 @@ import org.eclipse.xtext.parsetree.AbstractNode;
 import org.eclipse.xtext.resource.XtextResource;
 import org.eclipse.xtext.ui.XtextUIMessages;
 import org.eclipse.xtext.ui.editor.IURIEditorOpener;
-import org.eclipse.xtext.ui.editor.hover.AbstractXtextEditorHover;
+import org.eclipse.xtext.ui.editor.hover.AbstractEObjectHover;
 import org.eclipse.xtext.ui.editor.model.IXtextDocument;
 import org.eclipse.xtext.ui.editor.model.XtextDocumentUtil;
 import org.eclipse.xtext.ui.internal.Activator;
@@ -60,7 +60,7 @@ import com.ibm.icu.text.MessageFormat;
  * @author Christoph Kulla - Initial contribution and API
  */
 @SuppressWarnings({ "restriction"})
-public class XtextHtmlHover extends AbstractXtextEditorHover {
+public class XtextHtmlHover extends AbstractEObjectHover {
 
 	@Inject(optional=true)
 	private IHtmlHoverContentProvider hoverContentProvider;
@@ -385,6 +385,7 @@ public class XtextHtmlHover extends AbstractXtextEditorHover {
 	/**
 	 * @deprecated see {@link org.eclipse.jface.text.ITextHover#getHoverInfo(ITextViewer, IRegion)}
 	 */
+	@Override
 	@Deprecated
 	public String getHoverInfo(ITextViewer textViewer, IRegion hoverRegion) {
 		XtextBrowserInformationControlInput info= (XtextBrowserInformationControlInput) getHoverInfo2(textViewer, hoverRegion);
@@ -394,6 +395,7 @@ public class XtextHtmlHover extends AbstractXtextEditorHover {
 	/*
 	 * @see org.eclipse.jface.text.ITextHoverExtension2#getHoverInfo2(org.eclipse.jface.text.ITextViewer, org.eclipse.jface.text.IRegion)
 	 */
+	@Override
 	public Object getHoverInfo2(ITextViewer textViewer, IRegion hoverRegion) {
 		return internalGetHoverInfo(textViewer, hoverRegion);
 	}
@@ -415,6 +417,11 @@ public class XtextHtmlHover extends AbstractXtextEditorHover {
 		});
 	}
 
+	@Override
+	protected Object getHoverInfo2 (final EObject eObject, final ITextViewer textViewer, final IRegion hoverRegion) {
+		return getHoverInfo(eObject, null, null);
+	}
+	
 	private XtextBrowserInformationControlInput getHoverInfo(EObject element, IRegion hoverRegion, XtextBrowserInformationControlInput previous) {
 		String html = hoverContentProvider.getHtml(element);
 		if (html!=null) {
-- 
1.6.6


From aff1fc37262213ed20c7c836c884f2cc02ab4dae Mon Sep 17 00:00:00 2001
From: Christoph Kulla <christophkulla@googlemail.com>
Date: Sat, 23 Oct 2010 20:42:02 +0200
Subject: [PATCH 10/28] Cleanup: Removed obsolete class XtextTextHover.

---
 .../xtext/ui/editor/hover/XtextTextHover.java      |   33 --------------------
 1 files changed, 0 insertions(+), 33 deletions(-)
 delete mode 100644 plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/XtextTextHover.java

diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/XtextTextHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/XtextTextHover.java
deleted file mode 100644
index 777ae09..0000000
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/XtextTextHover.java
+++ /dev/null
@@ -1,33 +0,0 @@
-/*******************************************************************************
- * Copyright (c) 2008 itemis AG (http://www.itemis.eu) and others.
- * All rights reserved. This program and the accompanying materials
- * are made available under the terms of the Eclipse Public License v1.0
- * which accompanies this distribution, and is available at
- * http://www.eclipse.org/legal/epl-v10.html
- *
- *******************************************************************************/
-package org.eclipse.xtext.ui.editor.hover;
-
-import org.eclipse.jface.text.IRegion;
-import org.eclipse.jface.text.ITextHover;
-import org.eclipse.jface.text.ITextViewer;
-
-/**
- * Displays the parser rule the current token was consumed by.
- * TODO: Delete me!
- */
-@Deprecated
-public class XtextTextHover implements ITextHover {
-
-	@Deprecated
-	public String getHoverInfo(ITextViewer textViewer, IRegion hoverRegion) {
-		// TODO Auto-generated method stub
-		return null;
-	}
-
-	public IRegion getHoverRegion(ITextViewer textViewer, int offset) {
-		// TODO Auto-generated method stub
-		return null;
-	}
-
-}
\ No newline at end of file
-- 
1.6.6


From 3deb464aed00671ce3e401c76f0a393f08283178 Mon Sep 17 00:00:00 2001
From: Christoph Kulla <christophkulla@googlemail.com>
Date: Sat, 23 Oct 2010 21:32:37 +0200
Subject: [PATCH 11/28] Introduced AbstractProblemHover as a common base class for ProblemHover and AnnotationWithQuickFixesHover. Both now share the same code for retrieving annotations.

---
 .../xtext/ui/editor/hover/AbstractHover.java       |   51 +--------
 .../ui/editor/hover/AbstractProblemHover.java      |   97 +++++++++++++++
 .../hover/AnnotationWithQuickFixesHover.java       |  128 ++++----------------
 .../xtext/ui/editor/hover/ProblemHover.java        |   33 ++----
 4 files changed, 131 insertions(+), 178 deletions(-)
 create mode 100644 plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractProblemHover.java

diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractHover.java
index a1cabd7..88c4ea9 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractHover.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractHover.java
@@ -8,9 +8,6 @@
  *******************************************************************************/
 package org.eclipse.xtext.ui.editor.hover;
 
-import java.util.Iterator;
-import java.util.List;
-
 import org.eclipse.jface.text.BadLocationException;
 import org.eclipse.jface.text.DefaultInformationControl;
 import org.eclipse.jface.text.IDocument;
@@ -21,19 +18,13 @@ import org.eclipse.jface.text.ITextHover;
 import org.eclipse.jface.text.ITextHoverExtension;
 import org.eclipse.jface.text.ITextHoverExtension2;
 import org.eclipse.jface.text.ITextViewer;
-import org.eclipse.jface.text.Position;
 import org.eclipse.jface.text.Region;
-import org.eclipse.jface.text.source.Annotation;
-import org.eclipse.jface.text.source.IAnnotationModel;
-import org.eclipse.jface.text.source.ILineDiffInfo;
 import org.eclipse.jface.text.source.ISourceViewer;
 import org.eclipse.swt.graphics.Point;
 import org.eclipse.swt.widgets.Shell;
 import org.eclipse.ui.editors.text.EditorsUI;
 import org.eclipse.xtext.ui.editor.ISourceViewerAware;
 
-import com.google.inject.internal.Lists;
-
 /**
  * @author Patrick Schoenbach - Initial API and implementation
  */
@@ -49,9 +40,6 @@ public abstract class AbstractHover implements ITextHover, ITextHoverExtension,
 		return sourceViewer.getDocument();
 	}
 
-	public IAnnotationModel getAnnotationModel() {
-		return sourceViewer.getAnnotationModel();
-	}
 
 	@Deprecated
 	public String getHoverInfo(final ITextViewer textViewer, final IRegion hoverRegion) {
@@ -84,42 +72,5 @@ public abstract class AbstractHover implements ITextHover, ITextHoverExtension,
 			}
 		};
 	}
-	
-	protected List<Annotation> getAnnotations (final int lineNumber, final int offset) {
-		if(getAnnotationModel() == null) {
-			return null;
-		}
-		final Iterator<?> iterator = getAnnotationModel().getAnnotationIterator();
-		List<Annotation> result = Lists.newArrayList();
-		while (iterator.hasNext()) {
-			final Annotation annotation = (Annotation) iterator.next();
-			if (!annotation.isMarkedDeleted()) {
-				Position position = getAnnotationModel().getPosition(annotation);
-				if (position != null) {
-					final int start = position.getOffset();
-					final int end = start + position.getLength();
-		
-					if (offset > 0 && !(start <= offset && offset <= end)) {
-						continue;
-					}
-					try {
-						if (lineNumber != getDocument().getLineOfOffset(
-								start)) {
-							continue;
-						}
-					} catch (final Exception x) {
-						continue;
-					}
-					if (!isLineDiffInfo(annotation)) {
-						result .add (annotation);
-					}
-				}
-			}
-		}	
-		return result;
-	}
-	
-	protected boolean isLineDiffInfo(Annotation annotation) {
-		return annotation instanceof ILineDiffInfo;
-	}
+
 }
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractProblemHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractProblemHover.java
new file mode 100644
index 0000000..755d10d
--- /dev/null
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractProblemHover.java
@@ -0,0 +1,97 @@
+/*******************************************************************************
+ * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ *******************************************************************************/
+package org.eclipse.xtext.ui.editor.hover;
+
+import java.util.Iterator;
+import java.util.List;
+
+import org.eclipse.jface.text.BadLocationException;
+import org.eclipse.jface.text.IRegion;
+import org.eclipse.jface.text.ITextViewer;
+import org.eclipse.jface.text.Position;
+import org.eclipse.jface.text.source.Annotation;
+import org.eclipse.jface.text.source.IAnnotationModel;
+import org.eclipse.jface.text.source.ILineDiffInfo;
+
+import com.google.inject.internal.Lists;
+
+/**
+ * Base class for all hovers showing annotations and problems. 
+ * 
+ * @author Christoph Kulla - Initial contribution and API
+ */
+public abstract class AbstractProblemHover extends AbstractHover {
+
+	@Override
+	public IRegion getHoverRegion(final ITextViewer textViewer, final int offset) {
+		int lineNumber;
+		try {
+			lineNumber = textViewer.getDocument().getLineOfOffset(offset);
+			return getHoverRegionInternal(lineNumber, offset);
+		} catch (BadLocationException e) {
+		}
+		return null;
+	}
+	
+	protected abstract IRegion getHoverRegionInternal(int lineNumber, int offset);
+
+	public Object getHoverInfo2(ITextViewer textViewer, IRegion hoverRegion) {
+		int lineNumber;
+		try {
+			lineNumber = getLineNumber(textViewer, hoverRegion);
+			return getHoverInfoInternal(textViewer, lineNumber, hoverRegion.getOffset());
+		}
+		catch (final BadLocationException e) {
+			return null;
+		}
+	}
+		
+	protected abstract Object getHoverInfoInternal(ITextViewer textViewer, int lineNumber, int offset);
+
+	protected IAnnotationModel getAnnotationModel() {
+		return sourceViewer.getAnnotationModel();
+	}
+	
+	protected List<Annotation> getAnnotations (final int lineNumber, final int offset) {
+		if(getAnnotationModel() == null) {
+			return null;
+		}
+		final Iterator<?> iterator = getAnnotationModel().getAnnotationIterator();
+		List<Annotation> result = Lists.newArrayList();
+		while (iterator.hasNext()) {
+			final Annotation annotation = (Annotation) iterator.next();
+			if (!annotation.isMarkedDeleted()) {
+				Position position = getAnnotationModel().getPosition(annotation);
+				if (position != null) {
+					final int start = position.getOffset();
+					final int end = start + position.getLength();
+		
+					if (offset > 0 && !(start <= offset && offset <= end)) {
+						continue;
+					}
+					try {
+						if (lineNumber != getDocument().getLineOfOffset(
+								start)) {
+							continue;
+						}
+					} catch (final Exception x) {
+						continue;
+					}
+					if (!isLineDiffInfo(annotation)) {
+						result .add (annotation);
+					}
+				}
+			}
+		}	
+		return result;
+	}
+	
+	protected boolean isLineDiffInfo(Annotation annotation) {
+		return annotation instanceof ILineDiffInfo;
+	}
+}
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AnnotationWithQuickFixesHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AnnotationWithQuickFixesHover.java
index b358cd1..a25b7c4 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AnnotationWithQuickFixesHover.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AnnotationWithQuickFixesHover.java
@@ -85,7 +85,7 @@ import com.google.inject.Inject;
  *
  * @author Christoph Kulla
  */
-public class AnnotationWithQuickFixesHover implements ITextHover, ITextHoverExtension, ITextHoverExtension2, ISourceViewerAware {
+public class AnnotationWithQuickFixesHover extends AbstractProblemHover {
 	
 	@Inject
 	private XtextQuickAssistProcessor quickAssistProcessor;
@@ -600,12 +600,7 @@ public class AnnotationWithQuickFixesHover implements ITextHover, ITextHoverExte
 
 	private IInformationControlCreator fPresenterControlCreator;
 
-	private ISourceViewer sourceViewer;
-
-
-	public AnnotationWithQuickFixesHover() {
-	}
-
+	@Override
 	public IRegion getHoverRegion(final ITextViewer textViewer, final int offset) {
 		int lineNumber;
 		try {
@@ -616,100 +611,38 @@ public class AnnotationWithQuickFixesHover implements ITextHover, ITextHoverExte
 		}
 	}
 	
-	protected Region getHoverRegionInternal(final int lineNumber,
-			final int offset) {
-		final IAnnotationModel model = getAnnotationModel();
-		if(model == null) {
-			return null;
-		}
-		final Iterator<?> iterator = model.getAnnotationIterator();
-		while (iterator.hasNext()) {
-			final Annotation annotation = (Annotation) iterator.next();
-			if (!annotation.isMarkedDeleted()) {
-				Position position = model.getPosition(annotation);
-				if (position != null) {
-					final int start = position.getOffset();
-					final int end = start + position.getLength();
-		
-					if (offset > 0 && !(start <= offset && offset <= end)) {
-						continue;
-					}
-					try {
-						if (lineNumber != sourceViewer.getDocument().getLineOfOffset(
-								start)) {
-							continue;
-						}
-					} catch (final Exception x) {
-						continue;
-					}
-					if (!isLineDiffInfo(annotation)) {
-						return new Region (start, position.getLength());
-					}
-				}
+	@Override
+	protected Region getHoverRegionInternal(final int lineNumber, final int offset) {
+		List<Annotation> annotations = getAnnotations(lineNumber, offset);
+		for (Annotation annotation : annotations) {
+			Position position = sourceViewer.getAnnotationModel().getPosition(annotation);
+			if (position != null) {
+				final int start = position.getOffset();
+				return new Region (start, position.getLength());	
 			}
 		}
 		return null;
 	}
-	
-	@Deprecated
-	public String getHoverInfo(ITextViewer textViewer, IRegion hoverRegion) {
-		Object o = getHoverInfo2(textViewer, hoverRegion);
-		if (o!=null)
-			return o.toString();
-		return null;
-	}
-
-	public Object getHoverInfo2(final ITextViewer textViewer, final IRegion hoverRegion) {
-		int lineNumber;
-		try {
-			lineNumber = textViewer.getDocument().getLineOfOffset(hoverRegion.getOffset());
-		}
-		catch (final BadLocationException e) {
-			return null;
-		}
-		return getHoverInfoInternal(lineNumber, hoverRegion.getOffset());
-	}
 
-	protected Object getHoverInfoInternal(final int lineNumber, final int offset) {
-		final IAnnotationModel model = getAnnotationModel();
-		if(model == null) {
-			return null;
-		}
-		final Iterator<?> iterator = model.getAnnotationIterator();
-		while (iterator.hasNext()) {
-			final Annotation annotation = (Annotation) iterator.next();
-			if (!annotation.isMarkedDeleted()) {
-				Position position = model.getPosition(annotation);
-				if (position != null) {
-					final int start = position.getOffset();
-					final int end = start + position.getLength();
-		
-					if (offset > 0 && !(start <= offset && offset <= end)) {
-						continue;
-					}
-					try {
-						if (lineNumber != sourceViewer.getDocument().getLineOfOffset(
-								start)) {
-							continue;
-						}
-					} catch (final Exception x) {
-						continue;
-					}
-					if (!isLineDiffInfo(annotation)) {
-						final IQuickAssistInvocationContext invocationContext = new TextInvocationContext(sourceViewer, position.getOffset(), position.getLength());
-						CompletionProposalRunnable runnable = new CompletionProposalRunnable(invocationContext);	
-						// Note: the resolutions have to be retrieved from the UI thread, otherwise
-						// workbench.getActiveWorkbenchWindow() will return null in LanguageSpecificURIEditorOpener and
-						// cause an exception
-						Display.getDefault().syncExec(runnable);
-						return new AnnotationInfo (annotation, position, sourceViewer, runnable.proposals);
-					} 
-				}
+	@Override
+	protected Object getHoverInfoInternal(ITextViewer textViewer, final int lineNumber, final int offset) {
+		List<Annotation> annotations = getAnnotations(lineNumber, offset);
+		for (Annotation annotation : annotations) {
+			if (annotation.getText() != null) {
+				Position position = getAnnotationModel().getPosition(annotation);
+				final IQuickAssistInvocationContext invocationContext = new TextInvocationContext(sourceViewer, position.getOffset(), position.getLength());
+				CompletionProposalRunnable runnable = new CompletionProposalRunnable(invocationContext);	
+				// Note: the resolutions have to be retrieved from the UI thread, otherwise
+				// workbench.getActiveWorkbenchWindow() will return null in LanguageSpecificURIEditorOpener and
+				// cause an exception
+				Display.getDefault().syncExec(runnable);
+				return new AnnotationInfo (annotation, position, sourceViewer, runnable.proposals);				
 			}
 		}
 		return null;
 	}
 
+	@Override
 	public IInformationControlCreator getHoverControlCreator() {
 		if (fHoverControlCreator == null)
 			fHoverControlCreator= new HoverControlCreator(getInformationPresenterControlCreator());
@@ -722,19 +655,6 @@ public class AnnotationWithQuickFixesHover implements ITextHover, ITextHoverExte
 		return fPresenterControlCreator;
 	}
 
-	private IAnnotationModel getAnnotationModel() {
-		return sourceViewer.getAnnotationModel();
-	}
-
-	public void setSourceViewer(ISourceViewer sourceViewer) {
-		this.sourceViewer = sourceViewer;
-	}
-	
-	public boolean isLineDiffInfo(Annotation annotation) {
-		return annotation instanceof ILineDiffInfo;
-	}
-	
-
 //	/**
 //	 * Returns the annotation preference for the given annotation.
 //	 *
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/ProblemHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/ProblemHover.java
index 0fe1cce..25957df 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/ProblemHover.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/ProblemHover.java
@@ -15,8 +15,6 @@ import java.util.Iterator;
 import java.util.List;
 import java.util.Set;
 
-import org.eclipse.jface.text.BadLocationException;
-import org.eclipse.jface.text.IRegion;
 import org.eclipse.jface.text.ITextViewer;
 import org.eclipse.jface.text.Position;
 import org.eclipse.jface.text.Region;
@@ -30,7 +28,9 @@ import com.google.common.collect.Sets;
 /**
  * @author Sven Efftinge - Initial contribution and API
  */
-public class ProblemHover extends AbstractHover implements IAnnotationHover {
+public class ProblemHover extends AbstractProblemHover implements IAnnotationHover {
+	
+	// IAnnotationHover
 	
 	public String getHoverInfo(final ISourceViewer sourceViewer, final int lineNumber) {
 		Object o = getHoverInfoInternal(sourceViewer, lineNumber, -1);
@@ -39,17 +39,10 @@ public class ProblemHover extends AbstractHover implements IAnnotationHover {
 		return null;
 	}
 	
-	@Override
-	public IRegion getHoverRegion(final ITextViewer textViewer, final int offset) {
-		int lineNumber;
-		try {
-			lineNumber = textViewer.getDocument().getLineOfOffset(offset);
-			return getHoverRegionInternal(lineNumber, offset);
-		} catch (BadLocationException e) {
-		}
-		return null;
-	}
 		
+	// AbstractProblemHover
+	
+	@Override
 	protected Region getHoverRegionInternal(final int lineNumber, final int offset) {
 		List<Annotation> annotations = getAnnotations(lineNumber, offset);
 		for (Annotation annotation : annotations) {
@@ -61,18 +54,10 @@ public class ProblemHover extends AbstractHover implements IAnnotationHover {
 		}
 		return null;
 	}
+		
+	// AbstractProblemHover
 	
-	public Object getHoverInfo2(ITextViewer textViewer, IRegion hoverRegion) {
-		int lineNumber;
-		try {
-			lineNumber = getLineNumber(textViewer, hoverRegion);
-			return getHoverInfoInternal(textViewer, lineNumber, hoverRegion.getOffset());
-		}
-		catch (final BadLocationException e) {
-			return null;
-		}
-	}
-	
+	@Override
 	protected Object getHoverInfoInternal(final ITextViewer textViewer, final int lineNumber, final int offset) {
 		final Set<String> messages = Sets.newLinkedHashSet();
 		List<Annotation> annotations = getAnnotations(lineNumber, offset);
-- 
1.6.6


From 67a8633e77368e6dc85f1e01c35cc4e810cb5d32 Mon Sep 17 00:00:00 2001
From: Christoph Kulla <christophkulla@googlemail.com>
Date: Sat, 23 Oct 2010 22:17:41 +0200
Subject: [PATCH 12/28] Added comments to mark differences to the JDT version.

Fixes 4) AnnotationWithQuickFixesHover
Please document what is copied and what is changed.
---
 .../hover/AnnotationWithQuickFixesHover.java       |  133 ++++++++++++++++----
 1 files changed, 110 insertions(+), 23 deletions(-)

diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AnnotationWithQuickFixesHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AnnotationWithQuickFixesHover.java
index a25b7c4..3697252 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AnnotationWithQuickFixesHover.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AnnotationWithQuickFixesHover.java
@@ -10,7 +10,6 @@ package org.eclipse.xtext.ui.editor.hover;
 
 import java.text.MessageFormat;
 import java.util.ArrayList;
-import java.util.Iterator;
 import java.util.List;
 
 import org.eclipse.core.runtime.Assert;
@@ -18,17 +17,12 @@ import org.eclipse.jface.action.ToolBarManager;
 import org.eclipse.jface.resource.JFaceResources;
 import org.eclipse.jface.text.AbstractInformationControl;
 import org.eclipse.jface.text.AbstractReusableInformationControlCreator;
-import org.eclipse.jface.text.BadLocationException;
 import org.eclipse.jface.text.IDocument;
 import org.eclipse.jface.text.IInformationControl;
 import org.eclipse.jface.text.IInformationControlCreator;
 import org.eclipse.jface.text.IInformationControlExtension2;
 import org.eclipse.jface.text.IInformationControlExtension4;
-import org.eclipse.jface.text.IRegion;
 import org.eclipse.jface.text.IRewriteTarget;
-import org.eclipse.jface.text.ITextHover;
-import org.eclipse.jface.text.ITextHoverExtension;
-import org.eclipse.jface.text.ITextHoverExtension2;
 import org.eclipse.jface.text.ITextViewer;
 import org.eclipse.jface.text.ITextViewerExtension;
 import org.eclipse.jface.text.Position;
@@ -38,9 +32,6 @@ import org.eclipse.jface.text.contentassist.ICompletionProposalExtension;
 import org.eclipse.jface.text.contentassist.ICompletionProposalExtension2;
 import org.eclipse.jface.text.quickassist.IQuickAssistInvocationContext;
 import org.eclipse.jface.text.source.Annotation;
-import org.eclipse.jface.text.source.IAnnotationModel;
-import org.eclipse.jface.text.source.ILineDiffInfo;
-import org.eclipse.jface.text.source.ISourceViewer;
 import org.eclipse.jface.text.source.TextInvocationContext;
 import org.eclipse.swt.SWT;
 import org.eclipse.swt.custom.ScrolledComposite;
@@ -73,7 +64,6 @@ import org.eclipse.swt.widgets.Shell;
 import org.eclipse.ui.editors.text.EditorsUI;
 import org.eclipse.ui.texteditor.DefaultMarkerAnnotationAccess;
 import org.eclipse.xtext.ui.XtextUIMessages;
-import org.eclipse.xtext.ui.editor.ISourceViewerAware;
 import org.eclipse.xtext.ui.editor.quickfix.XtextQuickAssistProcessor;
 
 import com.google.inject.Inject;
@@ -81,25 +71,47 @@ import com.google.inject.Inject;
 /**
  * Hover which shows annotation and quick fixes. 
  * 
- * Clone from JDTs {@link org.eclipse.jdt.internal.ui.text.java.hover.AbstractAnnotationHover}
+ * Clone from JDTs {@link org.eclipse.jdt.internal.ui.text.java.hover.AbstractAnnotationHover}. 
  *
  * @author Christoph Kulla
  */
+
+// Following differences exist between AbstractAnnotationHover and AnnotationWithQuickFixesHover:
+//
+// 1) AnnotationInfo provides proposals directly, no need of subclassing
+// 2) Configuration of the hover content via preferences in the ui is not supported yet
+// 3) List of Quickfixes is retrieved from an XtextQuickAssistProcessor
+// 4) Removed acccess to JavaHoverMessages and replaced with XtextUIMessages
+// 5) Dropped support of FixCorrectionProposal and ICleanUp (JDT concept)
+// 6) Removed field fAnnotationAccess, DefaultMarkerAnnotationAccesss is not supported as we have no preferences
+// 7) Removed field fAllAnnotations, no filtering of only Java Annotations required
+// 8) instead of being an abstract class this a non abstract class
+
+// All comments starting with DIFF describes differences between the two versions
+
+// If no comments appear the code does not differ from AbstractAnnotationHover.
+
+// DIFF: AnnotationWithQuickFixesHoveris is not abstract (8)
 public class AnnotationWithQuickFixesHover extends AbstractProblemHover {
 	
+	// DIFF: not part of AbstractAnnotationHover (3)
+	
 	@Inject
 	private XtextQuickAssistProcessor quickAssistProcessor;
 
+	
 	protected static class AnnotationInfo {
 		public final Annotation annotation;
 		public final Position position;
 		public final ITextViewer viewer;
+		// DIFF: not part of AbstractAnnotationHover (1)
 		public final ICompletionProposal[] proposals;
 		
 		public AnnotationInfo(Annotation annotation, Position position, ITextViewer textViewer, ICompletionProposal[] proposals) {
 			this.annotation= annotation;
 			this.position= position;
 			this.viewer= textViewer;
+			// DIFF: not part of AbstractAnnotationHover(1)
 			this.proposals = proposals;
 		}
 
@@ -110,6 +122,7 @@ public class AnnotationWithQuickFixesHover extends AbstractProblemHover {
 		 * @return the proposals or an empty array
 		 */
 		public ICompletionProposal[] getCompletionProposals() {
+			// DIFF: return proposals directly, no subclassing (1)
 			return proposals;
 		}
 
@@ -120,6 +133,7 @@ public class AnnotationWithQuickFixesHover extends AbstractProblemHover {
 		 * @param infoControl the information control
 		 */
 		public void fillToolBar(ToolBarManager manager, IInformationControl infoControl) {
+			// DIFF: disabled as configuration is not supported yet (2)
 //			ConfigureAnnotationsAction configureAnnotationsAction= new ConfigureAnnotationsAction(annotation, infoControl);
 //			manager.add(configureAnnotationsAction);
 		}
@@ -140,16 +154,26 @@ public class AnnotationWithQuickFixesHover extends AbstractProblemHover {
 
 		public AnnotationInformationControl(Shell parentShell, ToolBarManager toolBarManager) {
 			super(parentShell, toolBarManager);
+			
 			fMarkerAnnotationAccess= new DefaultMarkerAnnotationAccess();
 			create();
 		}
 		
 		public AnnotationInformationControl(Shell parentShell, boolean resizeable) {
 			super(parentShell, resizeable);
+			
 			fMarkerAnnotationAccess= new DefaultMarkerAnnotationAccess();
 			create();
 		}		
 
+		/*
+		 * @see org.eclipse.jface.text.IInformationControl#setInformation(java.lang.String)
+		 */
+		@Override
+		public void setInformation(String information) {
+			//replaced by IInformationControlExtension2#setInput
+		}
+		
 		public void setInput(Object input) {
 			Assert.isLegal(input instanceof AnnotationInfo);
 			fInput= (AnnotationInfo)input;
@@ -308,8 +332,10 @@ public class AnnotationWithQuickFixesHover extends AbstractProblemHover {
 			quickFixLabel.setLayoutData(layoutData);
 			String text;
 			if (proposals.length == 1) {
+				// DIFF: replaced JavaHoverMessages with XtextUIMessages (4)
 				text= XtextUIMessages.AnnotationWithQuickFixesHover_message_singleQuickFix;
 			} else {
+				// DIFF: replaced JavaHoverMessages with XtextUIMessages (4)
 				text= MessageFormat.format(XtextUIMessages.AnnotationWithQuickFixesHover_message_multipleQuickFix, new Object[] { String.valueOf(proposals.length) });
 			}
 			quickFixLabel.setText(text);
@@ -336,6 +362,7 @@ public class AnnotationWithQuickFixesHover extends AbstractProblemHover {
 			for (int i= 0; i < proposals.length; i++) {
 				list.add(createCompletionProposalLink(composite, proposals[i], 1));// Original link for single fix, hence pass 1 for count
 
+				// DIFF: outcommented, no support of FixCorrectionProposal and ICleanUp (5)
 //				if (proposals[i] instanceof FixCorrectionProposal) {
 //					FixCorrectionProposal proposal= (FixCorrectionProposal)proposals[i];
 //					int count= proposal.computeNumberOfFixesForCleanUp(proposal.getCleanUp());
@@ -452,6 +479,7 @@ public class AnnotationWithQuickFixesHover extends AbstractProblemHover {
 			GridData layoutData= new GridData(SWT.BEGINNING, SWT.CENTER, false, false);
 			String linkText;
 			if (isMultiFix) {
+				// DIFF: XtextUIMessages (4)
 				linkText= MessageFormat.format(XtextUIMessages.AnnotationWithQuickFixesHover_message_multipleQuickFix, new Object[] { String.valueOf(count) });
 			} else {
 				linkText= proposal.getDisplayString();
@@ -510,6 +538,8 @@ public class AnnotationWithQuickFixesHover extends AbstractProblemHover {
 
 		@Override
 		public IInformationControl doCreateInformationControl(Shell parent) {
+			// DIFF: do not show toolbar in hover, no configuration supported (2)
+			// return new AnnotationInformationControl(parent, new ToolBarManager(SWT.FLAT));
 			return new AnnotationInformationControl(parent, true);
 		}
 	}
@@ -544,6 +574,8 @@ public class AnnotationWithQuickFixesHover extends AbstractProblemHover {
 		}
 	}
 
+	// DIFF: added this Runnable to execute quickAssistProposals to retrieve proposal list (3)
+	
 	private final class CompletionProposalRunnable implements Runnable {
 		
 		public ICompletionProposal[] proposals = null;
@@ -558,6 +590,8 @@ public class AnnotationWithQuickFixesHover extends AbstractProblemHover {
 		}
 	}
 	
+	// DIFF: outcommented, no configuration supported (3)
+	
 //	/**
 //	 * Action to configure the annotation preferences.
 //	 *
@@ -595,21 +629,26 @@ public class AnnotationWithQuickFixesHover extends AbstractProblemHover {
 //	}
 
 //	private final IPreferenceStore fStore= JavaPlugin.getDefault().getCombinedPreferenceStore();
-
+	// DIFF: (6)
+//	private final DefaultMarkerAnnotationAccess fAnnotationAccess= new DefaultMarkerAnnotationAccess();
+	// DIFF: (7)
+//	private final boolean fAllAnnotations;
+	
+	/**
+	 * The hover control creator.
+	 *
+	 * @since 3.4
+	 */
 	private IInformationControlCreator fHoverControlCreator;
-
+	/**
+	 * The presentation control creator.
+	 *
+	 * @since 3.4
+	 */
 	private IInformationControlCreator fPresenterControlCreator;
 
-	@Override
-	public IRegion getHoverRegion(final ITextViewer textViewer, final int offset) {
-		int lineNumber;
-		try {
-			lineNumber = textViewer.getDocument().getLineOfOffset(offset);
-			return getHoverRegionInternal(lineNumber, offset);
-		} catch (BadLocationException e) {
-			return null;
-		}
-	}
+	// DIFF: this code is entirely different, as the hover subclasses from AbstractProblemHover and 
+	// hooks different methods
 	
 	@Override
 	protected Region getHoverRegionInternal(final int lineNumber, final int offset) {
@@ -624,6 +663,9 @@ public class AnnotationWithQuickFixesHover extends AbstractProblemHover {
 		return null;
 	}
 
+	// DIFF: this code is entirely different, as the hover subclasses from AbstractProblemHover and 
+	// hooks different methods
+	
 	@Override
 	protected Object getHoverInfoInternal(ITextViewer textViewer, final int lineNumber, final int offset) {
 		List<Annotation> annotations = getAnnotations(lineNumber, offset);
@@ -655,6 +697,51 @@ public class AnnotationWithQuickFixesHover extends AbstractProblemHover {
 		return fPresenterControlCreator;
 	}
 
+	// DIFF: not required, get AnnotationModel via getAnnotationModel and not from the 
+	// file buffer manager
+	
+//	private IPath getEditorInputPath() {
+//		if (getEditor() == null)
+//			return null;
+//
+//		IEditorInput input= getEditor().getEditorInput();
+//		if (input instanceof IStorageEditorInput) {
+//			try {
+//				return ((IStorageEditorInput)input).getStorage().getFullPath();
+//			} catch (CoreException ex) {
+//				JavaPlugin.log(ex.getStatus());
+//			}
+//		}
+//		return null;
+//	}
+//	private IAnnotationModel getAnnotationModel(IPath path) {
+//		if (path == null)
+//			return null;
+//
+//		ITextFileBufferManager manager= FileBuffers.getTextFileBufferManager();
+//		try {
+//			manager.connect(path, LocationKind.NORMALIZE, null);
+//		} catch (CoreException ex) {
+//			JavaPlugin.log(ex.getStatus());
+//			return null;
+//		}
+//
+//		IAnnotationModel model= null;
+//		try {
+//			model= manager.getTextFileBuffer(path, LocationKind.NORMALIZE).getAnnotationModel();
+//			return model;
+//		} finally {
+//			if (model == null) {
+//				try {
+//					manager.disconnect(path, LocationKind.NORMALIZE, null);
+//				} catch (CoreException ex) {
+//					JavaPlugin.log(ex.getStatus());
+//				}
+//			}
+//		}
+//	}
+	
+	// DIFF: not required, as preferences are not supported (2)
 //	/**
 //	 * Returns the annotation preference for the given annotation.
 //	 *
-- 
1.6.6


From a20e9e9143db44da6eee07a900154f5be575a2e3 Mon Sep 17 00:00:00 2001
From: Christoph Kulla <christophkulla@googlemail.com>
Date: Sun, 24 Oct 2010 12:59:01 +0200
Subject: [PATCH 13/28] Refactoring towards removing IHtmlHoverContentProvider:
 - Removed IHtmlHoverContentProvider, IEObjectDocumentationProvider is now the only interface
 - Removed AbstractHtmlHoverContentProvider
 - Renamed MultiLineDocumentationProvider to MultiLineCommentDocumentationProvider
 - Renamed DefaultHtmlEObjectDP to DelegatingHtmlEObjectDP. It now delegates to another documentation provider (e.g. the MultiLineCommentEObjectDP) and adds the objects type and label at the beginning.
 - Adopted DefaultUIModule

Fixes 5) AbstractHtmlHoverContentProvider
I don't understand the delegation mechanism. Do you use it? If not, skip it in
the first place.

6) IHtmlHoverContentProvider:
Can there be non-EObject's ? If not, this interface looks pretty much like the
IEObjectDocumentationProvider.
---
 .../src/org/eclipse/xtext/ui/DefaultUiModule.java  |   16 +++-
 .../DeclarativeEObjectDocumentationProvider.java   |   48 +++++++++++
 .../hover/IEObjectDocumentationProvider.java       |    3 +-
 .../MutiLineCommentDocumentationProvider.java      |   85 ++++++++++++++++++++
 .../hover/MutiLineDocumentationProvider.java       |   85 --------------------
 .../html/AbstractHtmlHoverContentProvider.java     |   44 ----------
 .../html/DeclarativeHtmlHoverConentProvider.java   |   45 ----------
 .../html/DefaultHtmlHoverContentProvider.java      |   67 ---------------
 ...elegatingtHtmlEObjectDocumentationProvider.java |   56 +++++++++++++
 .../hover/html/IHtmlHoverContentProvider.java      |   19 -----
 .../xtext/ui/editor/hover/html/XtextHtmlHover.java |    5 +-
 11 files changed, 206 insertions(+), 267 deletions(-)
 create mode 100644 plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DeclarativeEObjectDocumentationProvider.java
 create mode 100644 plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/MutiLineCommentDocumentationProvider.java
 delete mode 100644 plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/MutiLineDocumentationProvider.java
 delete mode 100644 plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/AbstractHtmlHoverContentProvider.java
 delete mode 100644 plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/DeclarativeHtmlHoverConentProvider.java
 delete mode 100644 plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/DefaultHtmlHoverContentProvider.java
 create mode 100644 plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/DelegatingtHtmlEObjectDocumentationProvider.java
 delete mode 100644 plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/IHtmlHoverContentProvider.java

diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java
index e85cc49..ec75b97 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java
@@ -56,10 +56,11 @@ import org.eclipse.xtext.ui.editor.contentassist.XtextContentAssistProcessor;
 import org.eclipse.xtext.ui.editor.formatting.ContentFormatterFactory;
 import org.eclipse.xtext.ui.editor.formatting.IContentFormatterFactory;
 import org.eclipse.xtext.ui.editor.formatting.PreferenceStoreIndentationInformation;
+import org.eclipse.xtext.ui.editor.hover.IEObjectDocumentationProvider;
+import org.eclipse.xtext.ui.editor.hover.MutiLineCommentDocumentationProvider;
 import org.eclipse.xtext.ui.editor.hover.ProblemHover;
 import org.eclipse.xtext.ui.editor.hover.DefaultCompositeHover;
-import org.eclipse.xtext.ui.editor.hover.html.DefaultHtmlHoverContentProvider;
-import org.eclipse.xtext.ui.editor.hover.html.IHtmlHoverContentProvider;
+import org.eclipse.xtext.ui.editor.hover.html.DelegatingtHtmlEObjectDocumentationProvider;
 import org.eclipse.xtext.ui.editor.hyperlinking.DefaultHyperlinkDetector;
 import org.eclipse.xtext.ui.editor.model.IResourceForEditorInputFactory;
 import org.eclipse.xtext.ui.editor.model.JavaClassPathResourceForIEditorInputFactory;
@@ -286,6 +287,12 @@ public class DefaultUiModule extends AbstractGenericModule {
 	public void configureUiEncodingProvider(Binder binder) {
 		binder.bind(IEncodingProvider.class).annotatedWith(DispatchingProvider.Ui.class)
 				.to(WorkspaceEncodingProvider.class);
+	}	
+	
+	public void configureDefaultHtmlEObjectDocumentationProvider(Binder binder) {
+		binder.bind(IEObjectDocumentationProvider.class).annotatedWith
+		(Names.named(DelegatingtHtmlEObjectDocumentationProvider.DELEGATE))
+		.to(MutiLineCommentDocumentationProvider.class);		
 	}
 
 	public Class<? extends IAllContainersState.Provider> bindIAllContainersState$Provider() {
@@ -308,7 +315,8 @@ public class DefaultUiModule extends AbstractGenericModule {
 		return DefaultCompositeHover.class;
 	}
 			
-	public Class<? extends IHtmlHoverContentProvider> bindIHtmlHoverContentProvider () {
-		return DefaultHtmlHoverContentProvider.class;
+	public Class<? extends IEObjectDocumentationProvider> bindIEObjectDocumentationProvider () {
+		return DelegatingtHtmlEObjectDocumentationProvider.class;
 	}
+
 }
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DeclarativeEObjectDocumentationProvider.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DeclarativeEObjectDocumentationProvider.java
new file mode 100644
index 0000000..f7773fd
--- /dev/null
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DeclarativeEObjectDocumentationProvider.java
@@ -0,0 +1,48 @@
+package org.eclipse.xtext.ui.editor.hover;
+
+import java.util.Collections;
+
+import org.eclipse.emf.ecore.EObject;
+import org.eclipse.xtext.util.Exceptions;
+import org.eclipse.xtext.util.PolymorphicDispatcher;
+import org.eclipse.xtext.util.PolymorphicDispatcher.ErrorHandler;
+
+/**
+ * @author Christoph Kulla - Initial contribution and API
+ */
+public class DeclarativeEObjectDocumentationProvider implements IEObjectDocumentationProvider {
+
+	public DeclarativeEObjectDocumentationProvider() {
+	}
+
+	private final PolymorphicDispatcher<String> dispatcher = 
+		new PolymorphicDispatcher<String>("documentation", 1, 1, Collections.singletonList(this), new ErrorHandler<String>() {
+			public String handle(Object[] params, Throwable e) {
+				return handleError(params, e);
+			}
+		});
+
+	public String getDocumentation(EObject o) {
+		String result = dispatcher.invoke(o);
+		if (result == null)
+			result = getDefaultDocumentation();
+		return result;
+	}
+
+	private String getDefaultDocumentation() {
+		return null;
+	}
+
+	protected String documentation(EObject element) {
+		return null;
+	}
+	
+	protected String handleError(Object[] params, Throwable e) {
+		if (e instanceof NullPointerException) {
+			return getDefaultDocumentation();
+		}
+		return Exceptions.throwUncheckedException(e);
+
+	}
+
+}
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/IEObjectDocumentationProvider.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/IEObjectDocumentationProvider.java
index 4135b00..fdb4b49 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/IEObjectDocumentationProvider.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/IEObjectDocumentationProvider.java
@@ -12,10 +12,11 @@ import org.eclipse.emf.ecore.EObject;
 import com.google.inject.ImplementedBy;
 
 /**
+ * Returns a documentation string for an EObject.
+ * 
  * @author Christoph Kulla - Initial contribution and API
  */
 // FIXME: not ui related, move to org.eclipse.xtext?
-@ImplementedBy(MutiLineDocumentationProvider.class)
 public interface IEObjectDocumentationProvider {
 
 	public String getDocumentation (EObject o);
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/MutiLineCommentDocumentationProvider.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/MutiLineCommentDocumentationProvider.java
new file mode 100644
index 0000000..52f3360
--- /dev/null
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/MutiLineCommentDocumentationProvider.java
@@ -0,0 +1,85 @@
+/*******************************************************************************
+ * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ *******************************************************************************/
+package org.eclipse.xtext.ui.editor.hover;
+
+import org.eclipse.emf.ecore.EObject;
+import org.eclipse.xtext.TerminalRule;
+import org.eclipse.xtext.parsetree.AbstractNode;
+import org.eclipse.xtext.parsetree.CompositeNode;
+import org.eclipse.xtext.parsetree.LeafNode;
+import org.eclipse.xtext.parsetree.NodeUtil;
+
+import com.google.inject.Inject;
+import com.google.inject.name.Named;
+
+/**
+ * @author Christoph Kulla - Initial contribution and API
+ */
+//FIXME: not ui related, move to org.eclipse.xtext?
+public class MutiLineCommentDocumentationProvider implements IEObjectDocumentationProvider {
+
+	public final static String RULE = "org.eclipse.xtext.ui.editor.hover.MultiLineDocumentationProvider.ruleName";
+	public final static String START_TAG = "org.eclipse.xtext.ui.editor.hover.MultiLineDocumentationProvider.xtartTag";
+	public final static String END_TAG = "org.eclipse.xtext.ui.editor.hover.MultiLineDocumentationProvider.endTag";
+	public final static String LINE_PREFIX = "org.eclipse.xtext.ui.editor.hover.MultiLineDocumentationProvider.linePrefix";
+	public final static String LINE_POSTFIX = "org.eclipse.xtext.ui.editor.hover.MultiLineDocumentationProvider.linePostfix";
+
+	@Inject(optional = true)
+	@Named(RULE)
+	String ruleName = "ML_COMMENT";
+
+	@Inject(optional = true)
+	@Named(START_TAG)
+	String startTag = "/\\*\\*"; // regular expression
+
+	@Inject(optional = true)
+	@Named(END_TAG)
+	String endTag = "\\*/"; // regular expression
+
+	@Inject(optional = true)
+	@Named(LINE_PREFIX)
+	String linePrefix = "\\*+"; // regular expression
+
+	@Inject(optional = true)
+	@Named(LINE_POSTFIX)
+	String linePostfix = "\\*+"; // regular expression
+
+	protected String findComment(EObject o) {
+		String returnValue = null;
+		CompositeNode node = NodeUtil.getNode(o);
+		if (node != null) {
+			Iterable<AbstractNode> contents = NodeUtil.getAllContents(node);
+
+			// get the last multi line comment before a non hidden leaf node
+			for (AbstractNode abstractNode : contents) {
+				if (abstractNode instanceof LeafNode && !((LeafNode) abstractNode).isHidden())
+					break;
+				if (abstractNode instanceof LeafNode && abstractNode.getGrammarElement() instanceof TerminalRule
+						&& ruleName.equalsIgnoreCase(((TerminalRule) abstractNode.getGrammarElement()).getName())) {
+					String comment = ((LeafNode) abstractNode).getText();
+					if (comment.matches("(?s)" + startTag + ".*")) {
+						returnValue = comment;
+					}
+				}
+			}
+		}
+		return returnValue;
+	}
+
+	public String getDocumentation(EObject o) {
+		String returnValue = findComment(o);
+		if (returnValue != null) {
+			returnValue = returnValue.replaceAll("\\A" + startTag, "");
+			returnValue = returnValue.replaceAll(endTag + "\\z", "");
+			returnValue = returnValue.replaceAll("(?m)^( |\\t)*" + linePrefix, "");
+			returnValue = returnValue.replaceAll("(?m)" + linePostfix + "( |\\t)*$", "");
+			return returnValue;
+		} else
+			return "";
+	}
+}
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/MutiLineDocumentationProvider.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/MutiLineDocumentationProvider.java
deleted file mode 100644
index 53096dc..0000000
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/MutiLineDocumentationProvider.java
+++ /dev/null
@@ -1,85 +0,0 @@
-/*******************************************************************************
- * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
- * All rights reserved. This program and the accompanying materials
- * are made available under the terms of the Eclipse Public License v1.0
- * which accompanies this distribution, and is available at
- * http://www.eclipse.org/legal/epl-v10.html
- *******************************************************************************/
-package org.eclipse.xtext.ui.editor.hover;
-
-import org.eclipse.emf.ecore.EObject;
-import org.eclipse.xtext.TerminalRule;
-import org.eclipse.xtext.parsetree.AbstractNode;
-import org.eclipse.xtext.parsetree.CompositeNode;
-import org.eclipse.xtext.parsetree.LeafNode;
-import org.eclipse.xtext.parsetree.NodeUtil;
-
-import com.google.inject.Inject;
-import com.google.inject.name.Named;
-
-/**
- * @author Christoph Kulla - Initial contribution and API
- */
-//FIXME: not ui related, move to org.eclipse.xtext?
-public class MutiLineDocumentationProvider implements IEObjectDocumentationProvider {
-
-	public final static String RULE = "org.eclipse.xtext.ui.editor.hover.MultiLineDocumentationProvider.ruleName";
-	public final static String START_TAG = "org.eclipse.xtext.ui.editor.hover.MultiLineDocumentationProvider.xtartTag";
-	public final static String END_TAG = "org.eclipse.xtext.ui.editor.hover.MultiLineDocumentationProvider.endTag";
-	public final static String LINE_PREFIX = "org.eclipse.xtext.ui.editor.hover.MultiLineDocumentationProvider.linePrefix";
-	public final static String LINE_POSTFIX = "org.eclipse.xtext.ui.editor.hover.MultiLineDocumentationProvider.linePostfix";
-
-	@Inject(optional = true)
-	@Named(RULE)
-	String ruleName = "ML_COMMENT";
-
-	@Inject(optional = true)
-	@Named(START_TAG)
-	String startTag = "/\\*\\*"; // regular expression
-
-	@Inject(optional = true)
-	@Named(END_TAG)
-	String endTag = "\\*/"; // regular expression
-
-	@Inject(optional = true)
-	@Named(LINE_PREFIX)
-	String linePrefix = "\\*+"; // regular expression
-
-	@Inject(optional = true)
-	@Named(LINE_POSTFIX)
-	String linePostfix = "\\*+"; // regular expression
-
-	protected String findComment(EObject o) {
-		String returnValue = null;
-		CompositeNode node = NodeUtil.getNode(o);
-		if (node != null) {
-			Iterable<AbstractNode> contents = NodeUtil.getAllContents(node);
-
-			// get the last multi line comment before a non hidden leaf node
-			for (AbstractNode abstractNode : contents) {
-				if (abstractNode instanceof LeafNode && !((LeafNode) abstractNode).isHidden())
-					break;
-				if (abstractNode instanceof LeafNode && abstractNode.getGrammarElement() instanceof TerminalRule
-						&& ruleName.equalsIgnoreCase(((TerminalRule) abstractNode.getGrammarElement()).getName())) {
-					String comment = ((LeafNode) abstractNode).getText();
-					if (comment.matches("(?s)" + startTag + ".*")) {
-						returnValue = comment;
-					}
-				}
-			}
-		}
-		return returnValue;
-	}
-
-	public String getDocumentation(EObject o) {
-		String returnValue = findComment(o);
-		if (returnValue != null) {
-			returnValue = returnValue.replaceAll("\\A" + startTag, "");
-			returnValue = returnValue.replaceAll(endTag + "\\z", "");
-			returnValue = returnValue.replaceAll("(?m)^( |\\t)*" + linePrefix, "");
-			returnValue = returnValue.replaceAll("(?m)" + linePostfix + "( |\\t)*$", "");
-			return returnValue;
-		} else
-			return "";
-	}
-}
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/AbstractHtmlHoverContentProvider.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/AbstractHtmlHoverContentProvider.java
deleted file mode 100644
index 23fcc0b..0000000
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/AbstractHtmlHoverContentProvider.java
+++ /dev/null
@@ -1,44 +0,0 @@
-/*******************************************************************************
- * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
- * All rights reserved. This program and the accompanying materials
- * are made available under the terms of the Eclipse Public License v1.0
- * which accompanies this distribution, and is available at
- * http://www.eclipse.org/legal/epl-v10.html
- *******************************************************************************/
-package org.eclipse.xtext.ui.editor.hover.html;
-
-/**
- * @author Christoph Kulla - Initial contribution and API
- */
-public abstract class AbstractHtmlHoverContentProvider implements IHtmlHoverContentProvider {
-
-	private IHtmlHoverContentProvider delegate;
-
-	protected AbstractHtmlHoverContentProvider() {
-	}
-
-	protected AbstractHtmlHoverContentProvider(IHtmlHoverContentProvider delegate) {
-		this.delegate = delegate;
-	}
-
-	public String getHtml(Object o) {
-		String html = doGetHtml(o);
-		if (o == null && html != null)
-			html = delegate.getHtml(o);
-		if (html == null)
-			html = getDefaultHtml();
-		return html;
-	}
-
-	/**
-	 * Expected to be overridden by clients.
-	 * 
-	 * @return a {@link String} containing html content.
-	 */
-	protected abstract String doGetHtml(Object o);
-
-	protected String getDefaultHtml() {
-		return null;
-	}
-
-}
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/DeclarativeHtmlHoverConentProvider.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/DeclarativeHtmlHoverConentProvider.java
deleted file mode 100644
index 2dcfaa5..0000000
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/DeclarativeHtmlHoverConentProvider.java
+++ /dev/null
@@ -1,45 +0,0 @@
-package org.eclipse.xtext.ui.editor.hover.html;
-
-import java.util.Collections;
-
-import org.eclipse.xtext.util.Exceptions;
-import org.eclipse.xtext.util.PolymorphicDispatcher;
-import org.eclipse.xtext.util.PolymorphicDispatcher.ErrorHandler;
-
-/**
- * @author Christoph Kulla - Initial contribution and API
- */
-public class DeclarativeHtmlHoverConentProvider extends AbstractHtmlHoverContentProvider {
-
-	public DeclarativeHtmlHoverConentProvider() {
-	}
-
-	public DeclarativeHtmlHoverConentProvider(IHtmlHoverContentProvider delegate) {
-		super(delegate);
-	}
-
-	private final PolymorphicDispatcher<String> dispatcher = 
-		new PolymorphicDispatcher<String>("html", 1, 1, Collections.singletonList(this), new ErrorHandler<String>() {
-			public String handle(Object[] params, Throwable e) {
-				return handleError(params, e);
-			}
-		});
-
-	@Override
-	protected String doGetHtml(Object element) {
-		return dispatcher.invoke(element);
-	}
-
-	public String html(Object element) {
-		return null;
-	}
-	
-	protected String handleError(Object[] params, Throwable e) {
-		if (e instanceof NullPointerException) {
-			return getDefaultHtml();
-		}
-		return Exceptions.throwUncheckedException(e);
-
-	}
-
-}
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/DefaultHtmlHoverContentProvider.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/DefaultHtmlHoverContentProvider.java
deleted file mode 100644
index fdd0c8d..0000000
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/DefaultHtmlHoverContentProvider.java
+++ /dev/null
@@ -1,67 +0,0 @@
-/*******************************************************************************
- * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
- * All rights reserved. This program and the accompanying materials
- * are made available under the terms of the Eclipse Public License v1.0
- * which accompanies this distribution, and is available at
- * http://www.eclipse.org/legal/epl-v10.html
- *******************************************************************************/
-package org.eclipse.xtext.ui.editor.hover.html;
-
-import org.eclipse.emf.ecore.EObject;
-import org.eclipse.jface.viewers.ILabelProvider;
-import org.eclipse.xtext.ui.editor.hover.IEObjectDocumentationProvider;
-
-import com.google.inject.Inject;
-
-/**
- * @author Christoph Kulla - Initial contribution and API
- */
-public class DefaultHtmlHoverContentProvider extends DeclarativeHtmlHoverConentProvider {
-
-	@Inject
-	private ILabelProvider labelProvider;
-
-	@Inject
-	private IEObjectDocumentationProvider documentationProvider;
-
-	@Override
-	protected String doGetHtml(Object element) {
-		String text = super.doGetHtml(element);
-		if (text != null) {
-			return text;
-		}
-		if (element instanceof EObject) {
-			return getDefaultHtml((EObject) element);
-		}
-		return null;
-	}
-
-	protected String getDefaultHtml (EObject o) {
-		StringBuffer buffer = new StringBuffer();
-		buffer.append (o.eClass().getName()+ " <b>"+getLabel(o)+"</b>");
-		String documentation = getDocumentation(o);
-		if (documentation!=null && documentation.length()>0) {
-			buffer.append ("<p>");
-			buffer.append (documentation);
-		}
-		return buffer.toString();
-	}
-	
-	protected String getDocumentation (EObject o) {
-		return getDocumentationProvider().getDocumentation(o);
-	}
-	
-	protected IEObjectDocumentationProvider getDocumentationProvider () {
-		return documentationProvider;
-	}
-		
-	protected String getLabel (EObject o) {
-		return getLabelProvider().getText(o);
-	}
-	
-	protected ILabelProvider getLabelProvider () {
-		return labelProvider;
-	}
-	
-}
-
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/DelegatingtHtmlEObjectDocumentationProvider.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/DelegatingtHtmlEObjectDocumentationProvider.java
new file mode 100644
index 0000000..5135af5
--- /dev/null
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/DelegatingtHtmlEObjectDocumentationProvider.java
@@ -0,0 +1,56 @@
+/*******************************************************************************
+ * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ *******************************************************************************/
+package org.eclipse.xtext.ui.editor.hover.html;
+
+import java.lang.annotation.Annotation;
+
+import org.eclipse.emf.ecore.EObject;
+import org.eclipse.jface.viewers.ILabelProvider;
+import org.eclipse.xtext.ui.editor.hover.IEObjectDocumentationProvider;
+
+import com.google.inject.Inject;
+import com.google.inject.name.Named;
+
+/**
+ * Returns a html string as documentation. Delegates to another IEObjectDocumentationProvider and adds
+ * the objects type and label at the beginning.
+ * 
+ * @author Christoph Kulla - Initial contribution and API
+ */
+public class DelegatingtHtmlEObjectDocumentationProvider implements IEObjectDocumentationProvider {
+
+	public static final String DELEGATE = "org.eclipse.xtext.ui.editor.hover.html.DelegatingtHtmlEObjectDocumentationProvider.delegate";
+
+	@Inject
+	private ILabelProvider labelProvider;
+
+	@Inject @Named(DELEGATE)
+	private IEObjectDocumentationProvider delegate;
+
+	public String getDocumentation(EObject o) {
+		StringBuffer buffer = new StringBuffer();
+		buffer.append (o.eClass().getName()+ " <b>"+getLabel(o)+"</b>");
+		String documentation = delegate.getDocumentation(o);
+		if (documentation!=null && documentation.length()>0) {
+			buffer.append ("<p>");
+			buffer.append (documentation);
+			buffer.append("</p>");
+		}
+		return buffer.toString();
+	}
+	
+	protected String getLabel (EObject o) {
+		return getLabelProvider().getText(o);
+	}
+	
+	protected ILabelProvider getLabelProvider () {
+		return labelProvider;
+	}
+	
+}
+
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/IHtmlHoverContentProvider.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/IHtmlHoverContentProvider.java
deleted file mode 100644
index 7c8570f..0000000
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/IHtmlHoverContentProvider.java
+++ /dev/null
@@ -1,19 +0,0 @@
-/*******************************************************************************
- * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
- * All rights reserved. This program and the accompanying materials
- * are made available under the terms of the Eclipse Public License v1.0
- * which accompanies this distribution, and is available at
- * http://www.eclipse.org/legal/epl-v10.html
- *******************************************************************************/
-package org.eclipse.xtext.ui.editor.hover.html;
-
-/**
- * @author Christoph Kulla - Initial contribution and API
- */
-public interface IHtmlHoverContentProvider {
-
-	/**
-	 * Returns a html string for the given object
-	 */
-	String getHtml (Object o);  
-}
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextHtmlHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextHtmlHover.java
index 3d6836b..8552df5 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextHtmlHover.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextHtmlHover.java
@@ -43,6 +43,7 @@ import org.eclipse.xtext.resource.XtextResource;
 import org.eclipse.xtext.ui.XtextUIMessages;
 import org.eclipse.xtext.ui.editor.IURIEditorOpener;
 import org.eclipse.xtext.ui.editor.hover.AbstractEObjectHover;
+import org.eclipse.xtext.ui.editor.hover.IEObjectDocumentationProvider;
 import org.eclipse.xtext.ui.editor.model.IXtextDocument;
 import org.eclipse.xtext.ui.editor.model.XtextDocumentUtil;
 import org.eclipse.xtext.ui.internal.Activator;
@@ -63,7 +64,7 @@ import com.ibm.icu.text.MessageFormat;
 public class XtextHtmlHover extends AbstractEObjectHover {
 
 	@Inject(optional=true)
-	private IHtmlHoverContentProvider hoverContentProvider;
+	private IEObjectDocumentationProvider hoverContentProvider;
 	
 	@Inject
 	private IURIEditorOpener uriEditorOpener;
@@ -423,7 +424,7 @@ public class XtextHtmlHover extends AbstractEObjectHover {
 	}
 	
 	private XtextBrowserInformationControlInput getHoverInfo(EObject element, IRegion hoverRegion, XtextBrowserInformationControlInput previous) {
-		String html = hoverContentProvider.getHtml(element);
+		String html = hoverContentProvider.getDocumentation(element);
 		if (html!=null) {
 			StringBuffer buffer = new StringBuffer(html);
 			HTMLPrinter.insertPageProlog(buffer, 0, getStyleSheet());
-- 
1.6.6


From e827e23d68a47eb24f4f244815093a35385cfe7d Mon Sep 17 00:00:00 2001
From: Christoph Kulla <christophkulla@googlemail.com>
Date: Sun, 24 Oct 2010 13:09:04 +0200
Subject: [PATCH 14/28] Added comment describes changes from JavadocBrowserInformationControlInput.

---
 .../html/XtextBrowserInformationControlInput.java  |    9 +++++++--
 1 files changed, 7 insertions(+), 2 deletions(-)

diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextBrowserInformationControlInput.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextBrowserInformationControlInput.java
index 2e20858..51535a0 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextBrowserInformationControlInput.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextBrowserInformationControlInput.java
@@ -17,10 +17,16 @@ import org.eclipse.jface.internal.text.html.BrowserInformationControlInput;
 import org.eclipse.jface.viewers.ILabelProvider;
 
 /**
- * Browser input for XtextEditorHover.
+ * Browser input for XtextHtmlHover.
  *
  * @since 3.4
  */
+
+// Clone from JavadocBrowserInformationControlInput. Following changes have been made:
+// - Changed type of fElement from IJavaElement to EObject.
+// - Removed fLeadingImageWidth, leading images are not yet supported by the XtextHtmlHover
+// - getInputName requires an labelProvider to retrieve the EObjects name. 
+
 @SuppressWarnings("restriction")
 public class XtextBrowserInformationControlInput extends BrowserInformationControlInput {
 
@@ -46,7 +52,6 @@ public class XtextBrowserInformationControlInput extends BrowserInformationContr
 		// fLeadingImageWidth= leadingImageWidth;
 	}
 
-	// FIXME
 //	/*
 //	 * @see org.eclipse.jface.internal.text.html.BrowserInformationControlInput#getLeadingImageWidth()
 //	 * @since 3.4
-- 
1.6.6


From bd2a126235f138fed0c537da59db7ad80564152a Mon Sep 17 00:00:00 2001
From: Christoph Kulla <christophkulla@googlemail.com>
Date: Sun, 31 Oct 2010 11:20:48 +0100
Subject: [PATCH 15/28] Moved non ui classes to org.eclipse.xtext project. Created package org.eclipse.xtext.documentation and .impl.

---
 .../src/org/eclipse/xtext/ui/DefaultUiModule.java  |    4 +-
 .../DeclarativeEObjectDocumentationProvider.java   |   48 -----------
 .../hover/IEObjectDocumentationProvider.java       |   24 -----
 .../MutiLineCommentDocumentationProvider.java      |   85 ------------------
 ...elegatingtHtmlEObjectDocumentationProvider.java |    4 +-
 .../xtext/ui/editor/hover/html/XtextHtmlHover.java |    2 +-
 plugins/org.eclipse.xtext/META-INF/MANIFEST.MF     |    2 +
 .../IEObjectDocumentationProvider.java             |   23 +++++
 .../DeclarativeEObjectDocumentationProvider.java   |   46 ++++++++++
 .../impl/MutiLineCommentDocumentationProvider.java |   90 ++++++++++++++++++++
 10 files changed, 165 insertions(+), 163 deletions(-)
 delete mode 100644 plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DeclarativeEObjectDocumentationProvider.java
 delete mode 100644 plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/IEObjectDocumentationProvider.java
 delete mode 100644 plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/MutiLineCommentDocumentationProvider.java
 create mode 100644 plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/IEObjectDocumentationProvider.java
 create mode 100644 plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/impl/DeclarativeEObjectDocumentationProvider.java
 create mode 100644 plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/impl/MutiLineCommentDocumentationProvider.java

diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java
index ec75b97..8e981d5 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java
@@ -30,6 +30,8 @@ import org.eclipse.jface.viewers.ILabelProvider;
 import org.eclipse.ui.PlatformUI;
 import org.eclipse.ui.plugin.AbstractUIPlugin;
 import org.eclipse.ui.views.contentoutline.IContentOutlinePage;
+import org.eclipse.xtext.documentation.IEObjectDocumentationProvider;
+import org.eclipse.xtext.documentation.impl.MutiLineCommentDocumentationProvider;
 import org.eclipse.xtext.formatting.IIndentationInformation;
 import org.eclipse.xtext.parser.IEncodingProvider;
 import org.eclipse.xtext.resource.IExternalContentSupport;
@@ -56,8 +58,6 @@ import org.eclipse.xtext.ui.editor.contentassist.XtextContentAssistProcessor;
 import org.eclipse.xtext.ui.editor.formatting.ContentFormatterFactory;
 import org.eclipse.xtext.ui.editor.formatting.IContentFormatterFactory;
 import org.eclipse.xtext.ui.editor.formatting.PreferenceStoreIndentationInformation;
-import org.eclipse.xtext.ui.editor.hover.IEObjectDocumentationProvider;
-import org.eclipse.xtext.ui.editor.hover.MutiLineCommentDocumentationProvider;
 import org.eclipse.xtext.ui.editor.hover.ProblemHover;
 import org.eclipse.xtext.ui.editor.hover.DefaultCompositeHover;
 import org.eclipse.xtext.ui.editor.hover.html.DelegatingtHtmlEObjectDocumentationProvider;
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DeclarativeEObjectDocumentationProvider.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DeclarativeEObjectDocumentationProvider.java
deleted file mode 100644
index f7773fd..0000000
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DeclarativeEObjectDocumentationProvider.java
+++ /dev/null
@@ -1,48 +0,0 @@
-package org.eclipse.xtext.ui.editor.hover;
-
-import java.util.Collections;
-
-import org.eclipse.emf.ecore.EObject;
-import org.eclipse.xtext.util.Exceptions;
-import org.eclipse.xtext.util.PolymorphicDispatcher;
-import org.eclipse.xtext.util.PolymorphicDispatcher.ErrorHandler;
-
-/**
- * @author Christoph Kulla - Initial contribution and API
- */
-public class DeclarativeEObjectDocumentationProvider implements IEObjectDocumentationProvider {
-
-	public DeclarativeEObjectDocumentationProvider() {
-	}
-
-	private final PolymorphicDispatcher<String> dispatcher = 
-		new PolymorphicDispatcher<String>("documentation", 1, 1, Collections.singletonList(this), new ErrorHandler<String>() {
-			public String handle(Object[] params, Throwable e) {
-				return handleError(params, e);
-			}
-		});
-
-	public String getDocumentation(EObject o) {
-		String result = dispatcher.invoke(o);
-		if (result == null)
-			result = getDefaultDocumentation();
-		return result;
-	}
-
-	private String getDefaultDocumentation() {
-		return null;
-	}
-
-	protected String documentation(EObject element) {
-		return null;
-	}
-	
-	protected String handleError(Object[] params, Throwable e) {
-		if (e instanceof NullPointerException) {
-			return getDefaultDocumentation();
-		}
-		return Exceptions.throwUncheckedException(e);
-
-	}
-
-}
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/IEObjectDocumentationProvider.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/IEObjectDocumentationProvider.java
deleted file mode 100644
index fdb4b49..0000000
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/IEObjectDocumentationProvider.java
+++ /dev/null
@@ -1,24 +0,0 @@
-/*******************************************************************************
- * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
- * All rights reserved. This program and the accompanying materials
- * are made available under the terms of the Eclipse Public License v1.0
- * which accompanies this distribution, and is available at
- * http://www.eclipse.org/legal/epl-v10.html
- *******************************************************************************/
-package org.eclipse.xtext.ui.editor.hover;
-
-import org.eclipse.emf.ecore.EObject;
-
-import com.google.inject.ImplementedBy;
-
-/**
- * Returns a documentation string for an EObject.
- * 
- * @author Christoph Kulla - Initial contribution and API
- */
-// FIXME: not ui related, move to org.eclipse.xtext?
-public interface IEObjectDocumentationProvider {
-
-	public String getDocumentation (EObject o);
-
-}
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/MutiLineCommentDocumentationProvider.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/MutiLineCommentDocumentationProvider.java
deleted file mode 100644
index 52f3360..0000000
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/MutiLineCommentDocumentationProvider.java
+++ /dev/null
@@ -1,85 +0,0 @@
-/*******************************************************************************
- * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
- * All rights reserved. This program and the accompanying materials
- * are made available under the terms of the Eclipse Public License v1.0
- * which accompanies this distribution, and is available at
- * http://www.eclipse.org/legal/epl-v10.html
- *******************************************************************************/
-package org.eclipse.xtext.ui.editor.hover;
-
-import org.eclipse.emf.ecore.EObject;
-import org.eclipse.xtext.TerminalRule;
-import org.eclipse.xtext.parsetree.AbstractNode;
-import org.eclipse.xtext.parsetree.CompositeNode;
-import org.eclipse.xtext.parsetree.LeafNode;
-import org.eclipse.xtext.parsetree.NodeUtil;
-
-import com.google.inject.Inject;
-import com.google.inject.name.Named;
-
-/**
- * @author Christoph Kulla - Initial contribution and API
- */
-//FIXME: not ui related, move to org.eclipse.xtext?
-public class MutiLineCommentDocumentationProvider implements IEObjectDocumentationProvider {
-
-	public final static String RULE = "org.eclipse.xtext.ui.editor.hover.MultiLineDocumentationProvider.ruleName";
-	public final static String START_TAG = "org.eclipse.xtext.ui.editor.hover.MultiLineDocumentationProvider.xtartTag";
-	public final static String END_TAG = "org.eclipse.xtext.ui.editor.hover.MultiLineDocumentationProvider.endTag";
-	public final static String LINE_PREFIX = "org.eclipse.xtext.ui.editor.hover.MultiLineDocumentationProvider.linePrefix";
-	public final static String LINE_POSTFIX = "org.eclipse.xtext.ui.editor.hover.MultiLineDocumentationProvider.linePostfix";
-
-	@Inject(optional = true)
-	@Named(RULE)
-	String ruleName = "ML_COMMENT";
-
-	@Inject(optional = true)
-	@Named(START_TAG)
-	String startTag = "/\\*\\*"; // regular expression
-
-	@Inject(optional = true)
-	@Named(END_TAG)
-	String endTag = "\\*/"; // regular expression
-
-	@Inject(optional = true)
-	@Named(LINE_PREFIX)
-	String linePrefix = "\\*+"; // regular expression
-
-	@Inject(optional = true)
-	@Named(LINE_POSTFIX)
-	String linePostfix = "\\*+"; // regular expression
-
-	protected String findComment(EObject o) {
-		String returnValue = null;
-		CompositeNode node = NodeUtil.getNode(o);
-		if (node != null) {
-			Iterable<AbstractNode> contents = NodeUtil.getAllContents(node);
-
-			// get the last multi line comment before a non hidden leaf node
-			for (AbstractNode abstractNode : contents) {
-				if (abstractNode instanceof LeafNode && !((LeafNode) abstractNode).isHidden())
-					break;
-				if (abstractNode instanceof LeafNode && abstractNode.getGrammarElement() instanceof TerminalRule
-						&& ruleName.equalsIgnoreCase(((TerminalRule) abstractNode.getGrammarElement()).getName())) {
-					String comment = ((LeafNode) abstractNode).getText();
-					if (comment.matches("(?s)" + startTag + ".*")) {
-						returnValue = comment;
-					}
-				}
-			}
-		}
-		return returnValue;
-	}
-
-	public String getDocumentation(EObject o) {
-		String returnValue = findComment(o);
-		if (returnValue != null) {
-			returnValue = returnValue.replaceAll("\\A" + startTag, "");
-			returnValue = returnValue.replaceAll(endTag + "\\z", "");
-			returnValue = returnValue.replaceAll("(?m)^( |\\t)*" + linePrefix, "");
-			returnValue = returnValue.replaceAll("(?m)" + linePostfix + "( |\\t)*$", "");
-			return returnValue;
-		} else
-			return "";
-	}
-}
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/DelegatingtHtmlEObjectDocumentationProvider.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/DelegatingtHtmlEObjectDocumentationProvider.java
index 5135af5..840da86 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/DelegatingtHtmlEObjectDocumentationProvider.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/DelegatingtHtmlEObjectDocumentationProvider.java
@@ -7,11 +7,9 @@
  *******************************************************************************/
 package org.eclipse.xtext.ui.editor.hover.html;
 
-import java.lang.annotation.Annotation;
-
 import org.eclipse.emf.ecore.EObject;
 import org.eclipse.jface.viewers.ILabelProvider;
-import org.eclipse.xtext.ui.editor.hover.IEObjectDocumentationProvider;
+import org.eclipse.xtext.documentation.IEObjectDocumentationProvider;
 
 import com.google.inject.Inject;
 import com.google.inject.name.Named;
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextHtmlHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextHtmlHover.java
index 8552df5..cfad973 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextHtmlHover.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextHtmlHover.java
@@ -38,12 +38,12 @@ import org.eclipse.swt.widgets.Shell;
 import org.eclipse.ui.ISharedImages;
 import org.eclipse.ui.PlatformUI;
 import org.eclipse.ui.editors.text.EditorsUI;
+import org.eclipse.xtext.documentation.IEObjectDocumentationProvider;
 import org.eclipse.xtext.parsetree.AbstractNode;
 import org.eclipse.xtext.resource.XtextResource;
 import org.eclipse.xtext.ui.XtextUIMessages;
 import org.eclipse.xtext.ui.editor.IURIEditorOpener;
 import org.eclipse.xtext.ui.editor.hover.AbstractEObjectHover;
-import org.eclipse.xtext.ui.editor.hover.IEObjectDocumentationProvider;
 import org.eclipse.xtext.ui.editor.model.IXtextDocument;
 import org.eclipse.xtext.ui.editor.model.XtextDocumentUtil;
 import org.eclipse.xtext.ui.internal.Activator;
diff --git a/plugins/org.eclipse.xtext/META-INF/MANIFEST.MF b/plugins/org.eclipse.xtext/META-INF/MANIFEST.MF
index b31a06b..2b7e390 100644
--- a/plugins/org.eclipse.xtext/META-INF/MANIFEST.MF
+++ b/plugins/org.eclipse.xtext/META-INF/MANIFEST.MF
@@ -16,6 +16,8 @@ Export-Package: org.eclipse.xtext,
  org.eclipse.xtext.conversion,
  org.eclipse.xtext.conversion.impl,
  org.eclipse.xtext.diagnostics,
+ org.eclipse.xtext.documentation,
+ org.eclipse.xtext.documentation.impl,
  org.eclipse.xtext.formatting,
  org.eclipse.xtext.formatting.impl,
  org.eclipse.xtext.grammaranalysis,
diff --git a/plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/IEObjectDocumentationProvider.java b/plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/IEObjectDocumentationProvider.java
new file mode 100644
index 0000000..4e04d5a
--- /dev/null
+++ b/plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/IEObjectDocumentationProvider.java
@@ -0,0 +1,23 @@
+/*******************************************************************************
+ * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ *******************************************************************************/
+package org.eclipse.xtext.documentation;
+
+import org.eclipse.emf.ecore.EObject;
+
+import com.google.inject.ImplementedBy;
+
+/**
+ * Returns a documentation string for an EObject.
+ * 
+ * @author Christoph Kulla - Initial contribution and API
+ */
+public interface IEObjectDocumentationProvider {
+
+	public String getDocumentation (EObject o);
+
+}
diff --git a/plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/impl/DeclarativeEObjectDocumentationProvider.java b/plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/impl/DeclarativeEObjectDocumentationProvider.java
new file mode 100644
index 0000000..f58121d
--- /dev/null
+++ b/plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/impl/DeclarativeEObjectDocumentationProvider.java
@@ -0,0 +1,46 @@
+package org.eclipse.xtext.documentation.impl;
+
+import java.util.Collections;
+
+import org.eclipse.emf.ecore.EObject;
+import org.eclipse.xtext.documentation.IEObjectDocumentationProvider;
+import org.eclipse.xtext.util.Exceptions;
+import org.eclipse.xtext.util.PolymorphicDispatcher;
+import org.eclipse.xtext.util.PolymorphicDispatcher.ErrorHandler;
+
+/**
+ * @author Christoph Kulla - Initial contribution and API
+ */
+public class DeclarativeEObjectDocumentationProvider implements IEObjectDocumentationProvider {
+
+	private final PolymorphicDispatcher<String> dispatcher = 
+		new PolymorphicDispatcher<String>("documentation", 1, 1, Collections.singletonList(this), new ErrorHandler<String>() {
+			public String handle(Object[] params, Throwable e) {
+				return handleError(params, e);
+			}
+		});
+
+	public String getDocumentation(EObject o) {
+		String result = dispatcher.invoke(o);
+		if (result == null)
+			result = getDefaultDocumentation();
+		return result;
+	}
+
+	protected String getDefaultDocumentation() {
+		return null;
+	}
+
+	protected String documentation(EObject element) {
+		return null;
+	}
+	
+	protected String handleError(Object[] params, Throwable e) {
+		if (e instanceof NullPointerException) {
+			return getDefaultDocumentation();
+		}
+		return Exceptions.throwUncheckedException(e);
+
+	}
+
+}
diff --git a/plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/impl/MutiLineCommentDocumentationProvider.java b/plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/impl/MutiLineCommentDocumentationProvider.java
new file mode 100644
index 0000000..7885d7f
--- /dev/null
+++ b/plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/impl/MutiLineCommentDocumentationProvider.java
@@ -0,0 +1,90 @@
+/*******************************************************************************
+ * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ *******************************************************************************/
+package org.eclipse.xtext.documentation.impl;
+
+import org.eclipse.emf.ecore.EObject;
+import org.eclipse.xtext.TerminalRule;
+import org.eclipse.xtext.documentation.IEObjectDocumentationProvider;
+import org.eclipse.xtext.parsetree.AbstractNode;
+import org.eclipse.xtext.parsetree.CompositeNode;
+import org.eclipse.xtext.parsetree.LeafNode;
+import org.eclipse.xtext.parsetree.NodeUtil;
+
+import com.google.inject.Inject;
+import com.google.inject.name.Named;
+
+/**
+ * @author Christoph Kulla - Initial contribution and API
+ */
+public class MutiLineCommentDocumentationProvider implements IEObjectDocumentationProvider {
+
+	public final static String RULE = "org.eclipse.xtext.ui.editor.hover.MultiLineDocumentationProvider.ruleName";
+	public final static String START_TAG = "org.eclipse.xtext.ui.editor.hover.MultiLineDocumentationProvider.startTag";
+	public final static String END_TAG = "org.eclipse.xtext.ui.editor.hover.MultiLineDocumentationProvider.endTag";
+	public final static String LINE_PREFIX = "org.eclipse.xtext.ui.editor.hover.MultiLineDocumentationProvider.linePrefix";
+	public final static String LINE_POSTFIX = "org.eclipse.xtext.ui.editor.hover.MultiLineDocumentationProvider.linePostfix";
+	public final static String WHITESPACE = "org.eclipse.xtext.ui.editor.hover.MultiLineDocumentationProvider.whitespace";
+
+	@Inject(optional = true)
+	@Named(RULE)
+	String ruleName = "ML_COMMENT";
+
+	@Inject(optional = true)
+	@Named(START_TAG)
+	String startTag = "/\\*\\*"; // regular expression
+
+	@Inject(optional = true)
+	@Named(END_TAG)
+	String endTag = "\\*/"; // regular expression
+
+	@Inject(optional = true)
+	@Named(LINE_PREFIX)
+	String linePrefix = "\\** ?"; // regular expression
+
+	@Inject(optional = true)
+	@Named(LINE_POSTFIX)
+	String linePostfix = "\\**"; // regular expression
+
+	@Inject(optional = true)
+	@Named(WHITESPACE)
+	String whitespace = "( |\\t)*"; // regular expression
+	
+	protected String findComment(EObject o) {
+		String returnValue = null;
+		CompositeNode node = NodeUtil.getNode(o);
+		if (node != null) {
+			Iterable<AbstractNode> contents = NodeUtil.getAllContents(node);
+
+			// get the last multi line comment before a non hidden leaf node
+			for (AbstractNode abstractNode : contents) {
+				if (abstractNode instanceof LeafNode && !((LeafNode) abstractNode).isHidden())
+					break;
+				if (abstractNode instanceof LeafNode && abstractNode.getGrammarElement() instanceof TerminalRule
+						&& ruleName.equalsIgnoreCase(((TerminalRule) abstractNode.getGrammarElement()).getName())) {
+					String comment = ((LeafNode) abstractNode).getText();
+					if (comment.matches("(?s)" + startTag + ".*")) {
+						returnValue = comment;
+					}
+				}
+			}
+		}
+		return returnValue;
+	}
+
+	public String getDocumentation(EObject o) {
+		String returnValue = findComment(o);
+		if (returnValue != null) {
+			returnValue = returnValue.replaceAll("\\A" + startTag, "");
+			returnValue = returnValue.replaceAll(endTag + "\\z", "");
+			returnValue = returnValue.replaceAll("(?m)^"+ whitespace + linePrefix, "");
+			returnValue = returnValue.replaceAll("(?m)" + whitespace + linePostfix + whitespace + "$", "");
+			return returnValue.trim();
+		} else
+			return "";
+	}
+}
-- 
1.6.6


From ba58f4231ba72f38476078a57a131ed3b6aa7af1 Mon Sep 17 00:00:00 2001
From: Christoph Kulla <christophkulla@googlemail.com>
Date: Sun, 31 Oct 2010 11:21:37 +0100
Subject: [PATCH 16/28] Created tests for documentation classes.

---
 ...eclarativeEObjectDocumentationProviderTest.java |   60 +++++++++
 .../MultiLineCommentDocumentationProviderTest.java |  130 ++++++++++++++++++++
 2 files changed, 190 insertions(+), 0 deletions(-)
 create mode 100644 tests/org.eclipse.xtext.tests/src/org/eclipse/xtext/documentation/impl/DeclarativeEObjectDocumentationProviderTest.java
 create mode 100644 tests/org.eclipse.xtext.tests/src/org/eclipse/xtext/documentation/impl/MultiLineCommentDocumentationProviderTest.java

diff --git a/tests/org.eclipse.xtext.tests/src/org/eclipse/xtext/documentation/impl/DeclarativeEObjectDocumentationProviderTest.java b/tests/org.eclipse.xtext.tests/src/org/eclipse/xtext/documentation/impl/DeclarativeEObjectDocumentationProviderTest.java
new file mode 100644
index 0000000..ef87363
--- /dev/null
+++ b/tests/org.eclipse.xtext.tests/src/org/eclipse/xtext/documentation/impl/DeclarativeEObjectDocumentationProviderTest.java
@@ -0,0 +1,60 @@
+/*******************************************************************************
+ * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ *******************************************************************************/
+package org.eclipse.xtext.documentation.impl;
+
+import org.eclipse.xtext.dummy.DummyTestLanguageStandaloneSetup;
+import org.eclipse.xtext.dummy.dummyLang.Element;
+import org.eclipse.xtext.dummy.dummyLang.Model;
+import org.eclipse.xtext.junit.AbstractXtextTests;
+
+/**
+ * @author Christoph Kulla - Initial contribution and API
+ */
+public class DeclarativeEObjectDocumentationProviderTest extends AbstractXtextTests {
+
+	@Override
+	protected void setUp() throws Exception {
+		super.setUp();
+		with(DummyTestLanguageStandaloneSetup.class);
+	}
+	
+	public void test () throws Exception {
+		Model model = (Model) getModel ("element A;");
+		model.getElements().get(0);
+		DeclarativeEObjectDocumentationProvider provider = new DeclarativeEObjectDocumentationProvider() {
+			@SuppressWarnings("unused")
+			protected String documentation(Element element) {
+				return element.getName();
+			}			
+		};
+		assertEquals("A", provider.getDocumentation(model.getElements().get(0)));
+	}
+
+	public void testNull () throws Exception {
+		Model model = (Model) getModel ("element A;");
+		model.getElements().get(0);
+		DeclarativeEObjectDocumentationProvider provider = new DeclarativeEObjectDocumentationProvider();
+		assertEquals(null, provider.getDocumentation(model.getElements().get(0)));
+	}
+
+	public void testDefaultDocumentation () throws Exception {
+		final String expected = "getDefaultDocumentation() called";
+		Model model = (Model) getModel ("element A;");
+		model.getElements().get(0);
+		DeclarativeEObjectDocumentationProvider provider = new DeclarativeEObjectDocumentationProvider() {
+
+			@Override
+			protected String getDefaultDocumentation() {
+				return expected;
+			}
+			
+		};
+		assertEquals(expected, provider.getDocumentation(model.getElements().get(0)));
+	}
+
+}
diff --git a/tests/org.eclipse.xtext.tests/src/org/eclipse/xtext/documentation/impl/MultiLineCommentDocumentationProviderTest.java b/tests/org.eclipse.xtext.tests/src/org/eclipse/xtext/documentation/impl/MultiLineCommentDocumentationProviderTest.java
new file mode 100644
index 0000000..24d3a6b
--- /dev/null
+++ b/tests/org.eclipse.xtext.tests/src/org/eclipse/xtext/documentation/impl/MultiLineCommentDocumentationProviderTest.java
@@ -0,0 +1,130 @@
+/*******************************************************************************
+ * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ *******************************************************************************/
+package org.eclipse.xtext.documentation.impl;
+
+import org.eclipse.xtext.dummy.DummyTestLanguageStandaloneSetup;
+import org.eclipse.xtext.dummy.dummyLang.Element;
+import org.eclipse.xtext.dummy.dummyLang.Model;
+import org.eclipse.xtext.junit.AbstractXtextTests;
+
+/**
+ * @author Christoph Kulla - Initial contribution and API
+ */
+public class MultiLineCommentDocumentationProviderTest extends AbstractXtextTests {
+
+	final String expectedDocumentation = "A is an element.";	
+	
+	final String document = "element A;";
+
+	@Override
+	protected void setUp() throws Exception {
+		super.setUp();
+		with(DummyTestLanguageStandaloneSetup.class);
+	}
+
+	public String getComment (String modelString) throws Exception {
+		return getComment (modelString, 0);
+	}
+	
+	public String getComment (String modelString, int index) throws Exception {
+		Model model = (Model) getModel(modelString);
+		assertNotNull (model);
+		assertNotNull (model.getElements());
+		assertTrue (index<model.getElements().size());
+		
+		Element element = model.getElements().get(index);
+		assertNotNull (element);
+		
+		MutiLineCommentDocumentationProvider mlcdp = getInjector().getInstance(MutiLineCommentDocumentationProvider.class);
+		return mlcdp.getDocumentation(element);
+	}
+	
+	public void testSimple() throws Exception {
+		String documentation = getComment (
+				"/**\n" +
+				"* " + expectedDocumentation + "\n" +
+				"*/\n" +
+				"element A;");
+		assertEquals (expectedDocumentation, documentation);
+	}
+
+	public void testMissingStartTag() throws Exception {
+		String documentation = getComment (
+				"/*\n" +
+				"* " + expectedDocumentation + "\n" +
+				"*/\n" +
+				"element A;");
+		assertEquals ("", documentation);
+	}
+	
+	public void testRect() throws Exception {
+		String documentation = getComment (
+				"/********************************************\n" +
+				" **                               **\n" +
+				" ** " + expectedDocumentation + " **\n" +
+				" **                               **\n" +
+				" ********************************************/\n" +
+				document);
+		assertEquals (expectedDocumentation, documentation);
+	}	
+	
+	public void testWhitespace() throws Exception {
+		String documentation = getComment (
+				" \t \t /***\n" +
+				"** " + expectedDocumentation + " \t \t ** \t \t \n" +
+				" \t \t ***/ \t \t \n" +
+				document);
+		assertEquals (expectedDocumentation, documentation);
+	}	
+	
+	public void testWithSingleLineComment() throws Exception {
+		String documentation = getComment (
+				"/**\n" +
+				"* " + expectedDocumentation + "\n" +
+				"*/\n" +
+				"// single line comment\n" +
+				document);
+		assertEquals (expectedDocumentation, documentation);
+	}
+
+	public void testMultipleCommentsForOneObject() throws Exception {
+		String documentation = getComment (
+				"/**\n" +
+				"* " + expectedDocumentation + "2\n" +
+				"*/\n" +
+				"/**\n" +
+				"* " + expectedDocumentation + "\n" +
+				"*/\n" +
+				document);
+		assertEquals (expectedDocumentation, documentation);
+	}
+	
+	public void testMultipleComments() throws Exception {
+		String s = 	"/**\n" +
+			"* " + expectedDocumentation + "\n" +
+			"*/\n" +
+			document;
+		s.replaceAll ("A", "B");
+		String documentation = getComment (s.replaceAll ("A", "B") + s, 1);
+		assertEquals (expectedDocumentation, documentation);
+	}
+
+	public void testMultipleMultiLineComments() throws Exception {
+		String documentation = getComment ("/**\n" +
+			"* " + expectedDocumentation + "\n" +
+			"*/\n" +
+			"/* */" +
+			document);
+		assertEquals (expectedDocumentation, documentation);
+	}
+	
+	public void testNoComment() throws Exception {
+		String documentation = getComment (document);
+		assertEquals ("", documentation);		
+	}
+}
\ No newline at end of file
-- 
1.6.6


From 6bc55c69ce421fbf6816cc666d13f87eab5a3deb Mon Sep 17 00:00:00 2001
From: Christoph Kulla <christophkulla@googlemail.com>
Date: Sun, 31 Oct 2010 12:57:35 +0100
Subject: [PATCH 17/28] Factored out the document content into a field.

---
 ...eclarativeEObjectDocumentationProviderTest.java |    8 +++++---
 1 files changed, 5 insertions(+), 3 deletions(-)

diff --git a/tests/org.eclipse.xtext.tests/src/org/eclipse/xtext/documentation/impl/DeclarativeEObjectDocumentationProviderTest.java b/tests/org.eclipse.xtext.tests/src/org/eclipse/xtext/documentation/impl/DeclarativeEObjectDocumentationProviderTest.java
index ef87363..00dbb56 100644
--- a/tests/org.eclipse.xtext.tests/src/org/eclipse/xtext/documentation/impl/DeclarativeEObjectDocumentationProviderTest.java
+++ b/tests/org.eclipse.xtext.tests/src/org/eclipse/xtext/documentation/impl/DeclarativeEObjectDocumentationProviderTest.java
@@ -17,6 +17,8 @@ import org.eclipse.xtext.junit.AbstractXtextTests;
  */
 public class DeclarativeEObjectDocumentationProviderTest extends AbstractXtextTests {
 
+	final String document = "element A;";
+
 	@Override
 	protected void setUp() throws Exception {
 		super.setUp();
@@ -24,7 +26,7 @@ public class DeclarativeEObjectDocumentationProviderTest extends AbstractXtextTe
 	}
 	
 	public void test () throws Exception {
-		Model model = (Model) getModel ("element A;");
+		Model model = (Model) getModel (document);
 		model.getElements().get(0);
 		DeclarativeEObjectDocumentationProvider provider = new DeclarativeEObjectDocumentationProvider() {
 			@SuppressWarnings("unused")
@@ -36,7 +38,7 @@ public class DeclarativeEObjectDocumentationProviderTest extends AbstractXtextTe
 	}
 
 	public void testNull () throws Exception {
-		Model model = (Model) getModel ("element A;");
+		Model model = (Model) getModel (document);
 		model.getElements().get(0);
 		DeclarativeEObjectDocumentationProvider provider = new DeclarativeEObjectDocumentationProvider();
 		assertEquals(null, provider.getDocumentation(model.getElements().get(0)));
@@ -44,7 +46,7 @@ public class DeclarativeEObjectDocumentationProviderTest extends AbstractXtextTe
 
 	public void testDefaultDocumentation () throws Exception {
 		final String expected = "getDefaultDocumentation() called";
-		Model model = (Model) getModel ("element A;");
+		Model model = (Model) getModel (document);
 		model.getElements().get(0);
 		DeclarativeEObjectDocumentationProvider provider = new DeclarativeEObjectDocumentationProvider() {
 
-- 
1.6.6


From 6c812858fd168568939c97c47c690ab354b85062 Mon Sep 17 00:00:00 2001
From: Christoph Kulla <christophkulla@googlemail.com>
Date: Sun, 31 Oct 2010 19:41:52 +0100
Subject: [PATCH 18/28] First shot on ui tests for the hover.

---
 ...atingtHtmlEObjectDocumentationProviderTest.java |   84 ++++++++++++++++++++
 1 files changed, 84 insertions(+), 0 deletions(-)
 create mode 100644 tests/org.eclipse.xtext.ui.tests/src/org/eclipse/xtext/ui/tests/hover/html/DelegatingtHtmlEObjectDocumentationProviderTest.java

diff --git a/tests/org.eclipse.xtext.ui.tests/src/org/eclipse/xtext/ui/tests/hover/html/DelegatingtHtmlEObjectDocumentationProviderTest.java b/tests/org.eclipse.xtext.ui.tests/src/org/eclipse/xtext/ui/tests/hover/html/DelegatingtHtmlEObjectDocumentationProviderTest.java
new file mode 100644
index 0000000..3220a62
--- /dev/null
+++ b/tests/org.eclipse.xtext.ui.tests/src/org/eclipse/xtext/ui/tests/hover/html/DelegatingtHtmlEObjectDocumentationProviderTest.java
@@ -0,0 +1,84 @@
+/*******************************************************************************
+ * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ *******************************************************************************/
+package org.eclipse.xtext.ui.tests.hover.html;
+
+import org.eclipse.emf.ecore.EObject;
+import org.eclipse.xtext.ISetup;
+import org.eclipse.xtext.documentation.IEObjectDocumentationProvider;
+import org.eclipse.xtext.junit.AbstractXtextTests;
+import org.eclipse.xtext.ui.editor.hover.html.DelegatingtHtmlEObjectDocumentationProvider;
+import org.eclipse.xtext.ui.shared.SharedStateModule;
+import org.eclipse.xtext.ui.tests.Activator;
+import org.eclipse.xtext.ui.tests.TestLanguageRuntimeModule;
+import org.eclipse.xtext.ui.tests.foo.File;
+import org.eclipse.xtext.ui.tests.parser.keywords.KeywordsUiTestLanguageStandaloneSetup;
+import org.eclipse.xtext.ui.tests.ui.TestLanguageUiModule;
+import org.eclipse.xtext.util.Modules2;
+
+import com.google.inject.Binder;
+import com.google.inject.Guice;
+import com.google.inject.Injector;
+import com.google.inject.name.Names;
+
+/**
+ * @author Christoph Kulla - Initial contribution and API
+ */
+public class DelegatingtHtmlEObjectDocumentationProviderTest extends AbstractXtextTests {
+
+	public ISetup getTestLanguageSetup(final IEObjectDocumentationProvider ieObjectDocumentationProvider) {
+		return new KeywordsUiTestLanguageStandaloneSetup() {
+			@Override
+			public Injector createInjector() {
+				return Guice.createInjector(Modules2.mixin(
+						new TestLanguageRuntimeModule(),
+						new TestLanguageUiModule(Activator.getInstance()) {
+							@Override
+							public void configureDefaultHtmlEObjectDocumentationProvider(Binder binder) {
+								binder.bind(IEObjectDocumentationProvider.class).annotatedWith
+								(Names.named(DelegatingtHtmlEObjectDocumentationProvider.DELEGATE))
+								.toInstance(ieObjectDocumentationProvider);		
+							}							
+						},
+						new SharedStateModule()));
+			}
+		};
+	}
+	
+	@Override
+	protected void setUp() throws Exception {
+		super.setUp();
+		with(getTestLanguageSetup(new IEObjectDocumentationProvider() {
+			public String getDocumentation(EObject o) {
+				return null;
+			}
+		}));
+	}
+	
+	public void test () throws Exception {
+		with(getTestLanguageSetup(new IEObjectDocumentationProvider() {			
+			public String getDocumentation(EObject o) {
+				return null;
+			}
+		}));
+		File f = (File) getModel ("stuff test");
+		DelegatingtHtmlEObjectDocumentationProvider cut = getInjector().getInstance(DelegatingtHtmlEObjectDocumentationProvider.class);
+		assertEquals ("Stuff <b>test</b>", cut.getDocumentation(f.getStuff().get(0)));
+	}
+	
+	public void test2 () throws Exception {
+		with(getTestLanguageSetup(new IEObjectDocumentationProvider() {			
+			public String getDocumentation(EObject o) {
+				return "Test";
+			}
+		}));
+		File f = (File) getModel ("stuff test");
+		DelegatingtHtmlEObjectDocumentationProvider cut = getInjector().getInstance(DelegatingtHtmlEObjectDocumentationProvider.class);
+		assertEquals ("Stuff <b>test</b><p>Test</p>", cut.getDocumentation(f.getStuff().get(0)));
+	}
+	
+}
-- 
1.6.6


From c5481f75b6c052c63eb7b64c5a666494ee5dbd62 Mon Sep 17 00:00:00 2001
From: Christoph Kulla <christophkulla@googlemail.com>
Date: Sun, 31 Oct 2010 19:50:11 +0100
Subject: [PATCH 19/28] Minor cleanup on test.

---
 ...atingtHtmlEObjectDocumentationProviderTest.java |   18 ++++--------------
 1 files changed, 4 insertions(+), 14 deletions(-)

diff --git a/tests/org.eclipse.xtext.ui.tests/src/org/eclipse/xtext/ui/tests/hover/html/DelegatingtHtmlEObjectDocumentationProviderTest.java b/tests/org.eclipse.xtext.ui.tests/src/org/eclipse/xtext/ui/tests/hover/html/DelegatingtHtmlEObjectDocumentationProviderTest.java
index 3220a62..97cd50d 100644
--- a/tests/org.eclipse.xtext.ui.tests/src/org/eclipse/xtext/ui/tests/hover/html/DelegatingtHtmlEObjectDocumentationProviderTest.java
+++ b/tests/org.eclipse.xtext.ui.tests/src/org/eclipse/xtext/ui/tests/hover/html/DelegatingtHtmlEObjectDocumentationProviderTest.java
@@ -49,35 +49,25 @@ public class DelegatingtHtmlEObjectDocumentationProviderTest extends AbstractXte
 		};
 	}
 	
-	@Override
-	protected void setUp() throws Exception {
-		super.setUp();
-		with(getTestLanguageSetup(new IEObjectDocumentationProvider() {
-			public String getDocumentation(EObject o) {
-				return null;
-			}
-		}));
-	}
-	
-	public void test () throws Exception {
+	public void testElementHasNoDocumentation () throws Exception {
 		with(getTestLanguageSetup(new IEObjectDocumentationProvider() {			
 			public String getDocumentation(EObject o) {
 				return null;
 			}
 		}));
 		File f = (File) getModel ("stuff test");
-		DelegatingtHtmlEObjectDocumentationProvider cut = getInjector().getInstance(DelegatingtHtmlEObjectDocumentationProvider.class);
+		DelegatingtHtmlEObjectDocumentationProvider cut = get(DelegatingtHtmlEObjectDocumentationProvider.class);
 		assertEquals ("Stuff <b>test</b>", cut.getDocumentation(f.getStuff().get(0)));
 	}
 	
-	public void test2 () throws Exception {
+	public void testElementHasDocumentation () throws Exception {
 		with(getTestLanguageSetup(new IEObjectDocumentationProvider() {			
 			public String getDocumentation(EObject o) {
 				return "Test";
 			}
 		}));
 		File f = (File) getModel ("stuff test");
-		DelegatingtHtmlEObjectDocumentationProvider cut = getInjector().getInstance(DelegatingtHtmlEObjectDocumentationProvider.class);
+		DelegatingtHtmlEObjectDocumentationProvider cut = get(DelegatingtHtmlEObjectDocumentationProvider.class);
 		assertEquals ("Stuff <b>test</b><p>Test</p>", cut.getDocumentation(f.getStuff().get(0)));
 	}
 	
-- 
1.6.6


From d28c05ab43b19f7785b4508ec52f8aedaf1862f2 Mon Sep 17 00:00:00 2001
From: Christoph Kulla <christophkulla@googlemail.com>
Date: Sun, 7 Nov 2010 14:36:29 +0100
Subject: [PATCH 20/28] Added CompositeHoverTest.

---
 .../ui/tests/editor/hover/CompositeHoverTest.java  |  174 ++++++++++++++++++++
 1 files changed, 174 insertions(+), 0 deletions(-)
 create mode 100644 tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/CompositeHoverTest.java

diff --git a/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/CompositeHoverTest.java b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/CompositeHoverTest.java
new file mode 100644
index 0000000..f094c33
--- /dev/null
+++ b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/CompositeHoverTest.java
@@ -0,0 +1,174 @@
+/*******************************************************************************
+ * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ *******************************************************************************/
+package org.eclipse.xtext.ui.tests.editor.hover;
+
+import java.util.List;
+import org.eclipse.core.resources.IFile;
+import org.eclipse.jface.text.IRegion;
+import org.eclipse.jface.text.ITextHover;
+import org.eclipse.jface.text.ITextViewer;
+import org.eclipse.jface.text.Region;
+import org.eclipse.ui.IWorkbenchPart;
+import org.eclipse.xtext.resource.XtextResource;
+import org.eclipse.xtext.ui.editor.XtextEditor;
+import org.eclipse.xtext.ui.editor.hover.CompositeHover;
+import org.eclipse.xtext.ui.editor.model.IXtextDocument;
+import org.eclipse.xtext.ui.junit.util.IResourcesSetupUtil;
+import org.eclipse.xtext.ui.tests.editor.AbstractEditorTest;
+import org.eclipse.xtext.util.concurrent.IUnitOfWork;
+
+import com.google.inject.internal.Lists;
+
+/**
+ * @author Christoph Kulla - Initial contribution and API
+ */
+public class CompositeHoverTest extends AbstractEditorTest {
+	
+	protected XtextEditor editor;
+	protected IXtextDocument document;
+
+	protected String modelAsText;
+
+	@Override
+	protected void setUp() throws Exception {
+		super.setUp();
+		modelAsText = "stuff foo\nstuff roo refs foo";
+		IFile file = IResourcesSetupUtil.createFile("test/test.testlanguage", modelAsText);
+		editor = openEditor(file);
+		document = editor.getDocument();
+		document.readOnly(new IUnitOfWork<Void, XtextResource>() {
+			public java.lang.Void exec(XtextResource state) throws Exception {
+				return null;
+			}});
+	}
+
+	@Override
+	protected void tearDown() throws Exception {
+		super.tearDown();
+		editor.close(false);
+	}
+
+	@Override
+	protected String getEditorId() {
+		return "org.eclipse.xtext.ui.tests.TestLanguage";
+	}
+
+	public void testNullHoverList () {
+		CompositeHover hover = new CompositeHover() {
+
+			@Override
+			protected List<ITextHover> createHovers() {
+				return null;
+			}
+		};
+	
+		assertEquals (null, hover.getHovers());
+		assertNull (null, hover.getHoverRegion(editor.getInternalSourceViewer(), 0));
+		assertNull (null, hover.getHoverControlCreator());
+		assertNull (null, hover.getHoverInfo(editor.getInternalSourceViewer(), new Region(0,0)));
+		assertNull (null, hover.getHoverInfo2(editor.getInternalSourceViewer(), new Region(0,0)));
+	}
+	
+	public void testEmptyHoverList () {
+		CompositeHover hover = new CompositeHover() {
+
+			@Override
+			protected List<ITextHover> createHovers() {
+				List<ITextHover> hovers = Lists.newArrayList();
+				return hovers;
+			}
+		};
+	
+		assertEquals (0, hover.getHovers().size());
+		assertNull (null, hover.getHoverRegion(editor.getInternalSourceViewer(), 0));
+		assertNull (null, hover.getHoverControlCreator());
+		assertNull (null, hover.getHoverInfo(editor.getInternalSourceViewer(), new Region(0,0)));
+		assertNull (null, hover.getHoverInfo2(editor.getInternalSourceViewer(), new Region(0,0)));
+	}
+	
+	public void testSingleHover () {
+		CompositeHover hover = new CompositeHover() {
+
+			@Override
+			protected List<ITextHover> createHovers() {
+				List<ITextHover> hovers = Lists.newArrayList();
+				hovers.add (new ITextHover() {
+					
+					public IRegion getHoverRegion(ITextViewer textViewer, int offset) {
+						// TODO Auto-generated method stub
+						if (offset==0)
+							return new Region (offset, 0);
+						return null;
+					}
+					
+					public String getHoverInfo(ITextViewer textViewer, IRegion hoverRegion) {
+						return "test";
+					}
+				});
+				return hovers;
+			}
+		};
+	
+		assertEquals (1, hover.getHovers().size());
+		assertNotNull (null, hover.getHoverRegion(editor.getInternalSourceViewer(), 0));
+		assertEquals ("test", hover.getHoverInfo(editor.getInternalSourceViewer(), new Region(0,0)));
+		assertNull (null, hover.getHoverRegion(editor.getInternalSourceViewer(), 5));
+		assertEquals (null, hover.getHoverInfo(editor.getInternalSourceViewer(), new Region(0,0)));
+	}
+	
+	public void testMultipleHovers () {
+		final ITextHover hover1 = new ITextHover() {
+			
+			public IRegion getHoverRegion(ITextViewer textViewer, int offset) {
+				// TODO Auto-generated method stub
+				if (offset==0)
+					return new Region (offset, 0);
+				return null;
+			}
+			
+			public String getHoverInfo(ITextViewer textViewer, IRegion hoverRegion) {
+				return "hover1";
+			}
+		};
+		final ITextHover hover2 = new ITextHover() {
+			
+			public IRegion getHoverRegion(ITextViewer textViewer, int offset) {
+				// TODO Auto-generated method stub
+				if (offset==1)
+					return new Region (offset, 0);
+				return null;
+			}
+			
+			public String getHoverInfo(ITextViewer textViewer, IRegion hoverRegion) {
+				return "hover2";
+			}
+		};
+			
+		CompositeHover hover = new CompositeHover() {
+			@Override
+			protected List<ITextHover> createHovers() {
+				List<ITextHover> hovers = Lists.newArrayList();
+				hovers.add (hover1);
+				hovers.add (hover2);
+				return hovers;
+			}
+		};
+	
+		assertEquals (2, hover.getHovers().size());
+		assertNotNull (hover.getHoverRegion(editor.getInternalSourceViewer(), 0));
+		assertEquals ("hover1", hover.getHoverInfo(editor.getInternalSourceViewer(), new Region(0,0)));
+		assertNotNull (hover.getHoverRegion(editor.getInternalSourceViewer(), 1));
+		assertEquals ("hover2", hover.getHoverInfo(editor.getInternalSourceViewer(), new Region(1,0)));
+	}
+	
+	protected void activate(IWorkbenchPart part) {
+		editor.getSite().getPage().activate(part);
+	}
+
+
+}
-- 
1.6.6


From 9b0c810b00ce6057fb2a76fffe18fbb0c3a91f36 Mon Sep 17 00:00:00 2001
From: Christoph Kulla <christophkulla@googlemail.com>
Date: Sun, 7 Nov 2010 14:36:50 +0100
Subject: [PATCH 21/28] Moved to appropiate place.

---
 ...atingtHtmlEObjectDocumentationProviderTest.java |   74 --------------------
 ...atingtHtmlEObjectDocumentationProviderTest.java |   74 ++++++++++++++++++++
 2 files changed, 74 insertions(+), 74 deletions(-)
 delete mode 100644 tests/org.eclipse.xtext.ui.tests/src/org/eclipse/xtext/ui/tests/hover/html/DelegatingtHtmlEObjectDocumentationProviderTest.java
 create mode 100644 tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/hover/html/DelegatingtHtmlEObjectDocumentationProviderTest.java

diff --git a/tests/org.eclipse.xtext.ui.tests/src/org/eclipse/xtext/ui/tests/hover/html/DelegatingtHtmlEObjectDocumentationProviderTest.java b/tests/org.eclipse.xtext.ui.tests/src/org/eclipse/xtext/ui/tests/hover/html/DelegatingtHtmlEObjectDocumentationProviderTest.java
deleted file mode 100644
index 97cd50d..0000000
--- a/tests/org.eclipse.xtext.ui.tests/src/org/eclipse/xtext/ui/tests/hover/html/DelegatingtHtmlEObjectDocumentationProviderTest.java
+++ /dev/null
@@ -1,74 +0,0 @@
-/*******************************************************************************
- * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
- * All rights reserved. This program and the accompanying materials
- * are made available under the terms of the Eclipse Public License v1.0
- * which accompanies this distribution, and is available at
- * http://www.eclipse.org/legal/epl-v10.html
- *******************************************************************************/
-package org.eclipse.xtext.ui.tests.hover.html;
-
-import org.eclipse.emf.ecore.EObject;
-import org.eclipse.xtext.ISetup;
-import org.eclipse.xtext.documentation.IEObjectDocumentationProvider;
-import org.eclipse.xtext.junit.AbstractXtextTests;
-import org.eclipse.xtext.ui.editor.hover.html.DelegatingtHtmlEObjectDocumentationProvider;
-import org.eclipse.xtext.ui.shared.SharedStateModule;
-import org.eclipse.xtext.ui.tests.Activator;
-import org.eclipse.xtext.ui.tests.TestLanguageRuntimeModule;
-import org.eclipse.xtext.ui.tests.foo.File;
-import org.eclipse.xtext.ui.tests.parser.keywords.KeywordsUiTestLanguageStandaloneSetup;
-import org.eclipse.xtext.ui.tests.ui.TestLanguageUiModule;
-import org.eclipse.xtext.util.Modules2;
-
-import com.google.inject.Binder;
-import com.google.inject.Guice;
-import com.google.inject.Injector;
-import com.google.inject.name.Names;
-
-/**
- * @author Christoph Kulla - Initial contribution and API
- */
-public class DelegatingtHtmlEObjectDocumentationProviderTest extends AbstractXtextTests {
-
-	public ISetup getTestLanguageSetup(final IEObjectDocumentationProvider ieObjectDocumentationProvider) {
-		return new KeywordsUiTestLanguageStandaloneSetup() {
-			@Override
-			public Injector createInjector() {
-				return Guice.createInjector(Modules2.mixin(
-						new TestLanguageRuntimeModule(),
-						new TestLanguageUiModule(Activator.getInstance()) {
-							@Override
-							public void configureDefaultHtmlEObjectDocumentationProvider(Binder binder) {
-								binder.bind(IEObjectDocumentationProvider.class).annotatedWith
-								(Names.named(DelegatingtHtmlEObjectDocumentationProvider.DELEGATE))
-								.toInstance(ieObjectDocumentationProvider);		
-							}							
-						},
-						new SharedStateModule()));
-			}
-		};
-	}
-	
-	public void testElementHasNoDocumentation () throws Exception {
-		with(getTestLanguageSetup(new IEObjectDocumentationProvider() {			
-			public String getDocumentation(EObject o) {
-				return null;
-			}
-		}));
-		File f = (File) getModel ("stuff test");
-		DelegatingtHtmlEObjectDocumentationProvider cut = get(DelegatingtHtmlEObjectDocumentationProvider.class);
-		assertEquals ("Stuff <b>test</b>", cut.getDocumentation(f.getStuff().get(0)));
-	}
-	
-	public void testElementHasDocumentation () throws Exception {
-		with(getTestLanguageSetup(new IEObjectDocumentationProvider() {			
-			public String getDocumentation(EObject o) {
-				return "Test";
-			}
-		}));
-		File f = (File) getModel ("stuff test");
-		DelegatingtHtmlEObjectDocumentationProvider cut = get(DelegatingtHtmlEObjectDocumentationProvider.class);
-		assertEquals ("Stuff <b>test</b><p>Test</p>", cut.getDocumentation(f.getStuff().get(0)));
-	}
-	
-}
diff --git a/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/hover/html/DelegatingtHtmlEObjectDocumentationProviderTest.java b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/hover/html/DelegatingtHtmlEObjectDocumentationProviderTest.java
new file mode 100644
index 0000000..97cd50d
--- /dev/null
+++ b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/hover/html/DelegatingtHtmlEObjectDocumentationProviderTest.java
@@ -0,0 +1,74 @@
+/*******************************************************************************
+ * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ *******************************************************************************/
+package org.eclipse.xtext.ui.tests.hover.html;
+
+import org.eclipse.emf.ecore.EObject;
+import org.eclipse.xtext.ISetup;
+import org.eclipse.xtext.documentation.IEObjectDocumentationProvider;
+import org.eclipse.xtext.junit.AbstractXtextTests;
+import org.eclipse.xtext.ui.editor.hover.html.DelegatingtHtmlEObjectDocumentationProvider;
+import org.eclipse.xtext.ui.shared.SharedStateModule;
+import org.eclipse.xtext.ui.tests.Activator;
+import org.eclipse.xtext.ui.tests.TestLanguageRuntimeModule;
+import org.eclipse.xtext.ui.tests.foo.File;
+import org.eclipse.xtext.ui.tests.parser.keywords.KeywordsUiTestLanguageStandaloneSetup;
+import org.eclipse.xtext.ui.tests.ui.TestLanguageUiModule;
+import org.eclipse.xtext.util.Modules2;
+
+import com.google.inject.Binder;
+import com.google.inject.Guice;
+import com.google.inject.Injector;
+import com.google.inject.name.Names;
+
+/**
+ * @author Christoph Kulla - Initial contribution and API
+ */
+public class DelegatingtHtmlEObjectDocumentationProviderTest extends AbstractXtextTests {
+
+	public ISetup getTestLanguageSetup(final IEObjectDocumentationProvider ieObjectDocumentationProvider) {
+		return new KeywordsUiTestLanguageStandaloneSetup() {
+			@Override
+			public Injector createInjector() {
+				return Guice.createInjector(Modules2.mixin(
+						new TestLanguageRuntimeModule(),
+						new TestLanguageUiModule(Activator.getInstance()) {
+							@Override
+							public void configureDefaultHtmlEObjectDocumentationProvider(Binder binder) {
+								binder.bind(IEObjectDocumentationProvider.class).annotatedWith
+								(Names.named(DelegatingtHtmlEObjectDocumentationProvider.DELEGATE))
+								.toInstance(ieObjectDocumentationProvider);		
+							}							
+						},
+						new SharedStateModule()));
+			}
+		};
+	}
+	
+	public void testElementHasNoDocumentation () throws Exception {
+		with(getTestLanguageSetup(new IEObjectDocumentationProvider() {			
+			public String getDocumentation(EObject o) {
+				return null;
+			}
+		}));
+		File f = (File) getModel ("stuff test");
+		DelegatingtHtmlEObjectDocumentationProvider cut = get(DelegatingtHtmlEObjectDocumentationProvider.class);
+		assertEquals ("Stuff <b>test</b>", cut.getDocumentation(f.getStuff().get(0)));
+	}
+	
+	public void testElementHasDocumentation () throws Exception {
+		with(getTestLanguageSetup(new IEObjectDocumentationProvider() {			
+			public String getDocumentation(EObject o) {
+				return "Test";
+			}
+		}));
+		File f = (File) getModel ("stuff test");
+		DelegatingtHtmlEObjectDocumentationProvider cut = get(DelegatingtHtmlEObjectDocumentationProvider.class);
+		assertEquals ("Stuff <b>test</b><p>Test</p>", cut.getDocumentation(f.getStuff().get(0)));
+	}
+	
+}
-- 
1.6.6


From 6a5f93e2ee1b99154e1cfc5d1a13de22d5191b14 Mon Sep 17 00:00:00 2001
From: Christoph Kulla <christophkulla@googlemail.com>
Date: Sun, 7 Nov 2010 14:41:58 +0100
Subject: [PATCH 22/28] Moved to correct place.

---
 .../ui/tests/editor/hover/CompositeHoverTest.java  |    6 +-----
 1 files changed, 1 insertions(+), 5 deletions(-)

diff --git a/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/CompositeHoverTest.java b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/CompositeHoverTest.java
index f094c33..a01343b 100644
--- a/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/CompositeHoverTest.java
+++ b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/CompositeHoverTest.java
@@ -37,14 +37,10 @@ public class CompositeHoverTest extends AbstractEditorTest {
 	@Override
 	protected void setUp() throws Exception {
 		super.setUp();
-		modelAsText = "stuff foo\nstuff roo refs foo";
+		modelAsText = "// file content doesn't mater";
 		IFile file = IResourcesSetupUtil.createFile("test/test.testlanguage", modelAsText);
 		editor = openEditor(file);
 		document = editor.getDocument();
-		document.readOnly(new IUnitOfWork<Void, XtextResource>() {
-			public java.lang.Void exec(XtextResource state) throws Exception {
-				return null;
-			}});
 	}
 
 	@Override
-- 
1.6.6


From 2ec428f9cd93e520fd487be86a88e29331ba1233 Mon Sep 17 00:00:00 2001
From: Christoph Kulla <christophkulla@googlemail.com>
Date: Sun, 7 Nov 2010 14:42:58 +0100
Subject: [PATCH 23/28] Add null checks for getHovers()

---
 .../xtext/ui/editor/hover/CompositeHover.java      |   47 +++++++++++---------
 1 files changed, 26 insertions(+), 21 deletions(-)

diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/CompositeHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/CompositeHover.java
index 5326b30..7afdde0 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/CompositeHover.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/CompositeHover.java
@@ -19,13 +19,14 @@ import org.eclipse.jface.text.source.ISourceViewer;
 import org.eclipse.xtext.ui.editor.ISourceViewerAware;
 
 /**
- * The CompositeHover is a hover which delegates calls to a list of hovers. It iterates through this list of hovers 
- * and chooses the first one which provides a region in getHoverRegion(). Override the method createHovers() to 
- * configure the list of hovers.
+ * The CompositeHover is a hover which delegates calls to a list of hovers. It iterates through this list of hovers and
+ * chooses the first one which provides a region in getHoverRegion(). Override the method createHovers() to configure
+ * the list of hovers.
  * 
  * @author Christoph Kulla - Initial contribution and API
  */
-public abstract class CompositeHover implements ITextHover, ITextHoverExtension, ITextHoverExtension2, ISourceViewerAware {
+public abstract class CompositeHover implements ITextHover, ITextHoverExtension, ITextHoverExtension2,
+		ISourceViewerAware {
 
 	private List<ITextHover> hovers;
 	private ITextHover currentHover;
@@ -35,7 +36,7 @@ public abstract class CompositeHover implements ITextHover, ITextHoverExtension,
 	}
 
 	public List<ITextHover> getHovers() {
-		if (hovers==null)
+		if (hovers == null)
 			hovers = createHovers();
 		return hovers;
 	}
@@ -43,27 +44,31 @@ public abstract class CompositeHover implements ITextHover, ITextHoverExtension,
 	abstract protected List<ITextHover> createHovers();
 
 	public void setSourceViewer(ISourceViewer sourceViewer) {
-		for (ITextHover hover : getHovers()) {
-			if (hover instanceof ISourceViewerAware)
-				((ISourceViewerAware) hover).setSourceViewer(sourceViewer);
+		if (getHovers() != null) {
+			for (ITextHover hover : getHovers()) {
+				if (hover instanceof ISourceViewerAware)
+					((ISourceViewerAware) hover).setSourceViewer(sourceViewer);
+			}
 		}
 	}
 
 	@SuppressWarnings("deprecation")
 	public IRegion getHoverRegion(ITextViewer textViewer, int offset) {
-		for (ITextHover hover : getHovers()) {
-			IRegion region = hover.getHoverRegion(textViewer, offset);
-			if (region != null) {
-	
-				Object hoverInfo = null;
-				if (hover instanceof ITextHoverExtension2)
-					hoverInfo = ((ITextHoverExtension2) hover).getHoverInfo2(textViewer, region);
-				else {
-					hoverInfo = hover.getHoverInfo(textViewer, region);
-				}
-				if (hoverInfo != null && !(hoverInfo instanceof String && ((String) hoverInfo).length() == 0)) {
-					currentHover = hover;
-					return region;
+		if (getHovers() != null) {
+			for (ITextHover hover : getHovers()) {
+				IRegion region = hover.getHoverRegion(textViewer, offset);
+				if (region != null) {
+
+					Object hoverInfo = null;
+					if (hover instanceof ITextHoverExtension2)
+						hoverInfo = ((ITextHoverExtension2) hover).getHoverInfo2(textViewer, region);
+					else {
+						hoverInfo = hover.getHoverInfo(textViewer, region);
+					}
+					if (hoverInfo != null && !(hoverInfo instanceof String && ((String) hoverInfo).length() == 0)) {
+						currentHover = hover;
+						return region;
+					}
 				}
 			}
 		}
-- 
1.6.6


From 2a95aad5f753b3c67593f3ad9abe10a3ecf6ec3c Mon Sep 17 00:00:00 2001
From: Christoph Kulla <christophkulla@googlemail.com>
Date: Sun, 7 Nov 2010 14:43:58 +0100
Subject: [PATCH 24/28] Made fields protected.

---
 .../ui/editor/hover/DefaultCompositeHover.java     |    4 ++--
 1 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DefaultCompositeHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DefaultCompositeHover.java
index 10a41a8..9b89e43 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DefaultCompositeHover.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DefaultCompositeHover.java
@@ -23,10 +23,10 @@ import com.google.inject.Inject;
 public class DefaultCompositeHover extends CompositeHover  {
 
 	@Inject 
-	AnnotationWithQuickFixesHover annotationHover;
+	protected AnnotationWithQuickFixesHover annotationHover;
 	
 	@Inject
-	XtextHtmlHover htmlHover;
+	protected XtextHtmlHover htmlHover;
 	
 	@Override
 	protected List<ITextHover> createHovers() {
-- 
1.6.6


From 227723d90ef93bc4fcfd13333fc0e3a3ce6a7512 Mon Sep 17 00:00:00 2001
From: Christoph Kulla <christophkulla@googlemail.com>
Date: Sun, 7 Nov 2010 14:46:53 +0100
Subject: [PATCH 25/28] Renamed the dispatcher method from documentation() to _documentation().

---
 .../DeclarativeEObjectDocumentationProvider.java   |    4 ++--
 ...eclarativeEObjectDocumentationProviderTest.java |    2 +-
 2 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/impl/DeclarativeEObjectDocumentationProvider.java b/plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/impl/DeclarativeEObjectDocumentationProvider.java
index f58121d..0e7282d 100644
--- a/plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/impl/DeclarativeEObjectDocumentationProvider.java
+++ b/plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/impl/DeclarativeEObjectDocumentationProvider.java
@@ -14,7 +14,7 @@ import org.eclipse.xtext.util.PolymorphicDispatcher.ErrorHandler;
 public class DeclarativeEObjectDocumentationProvider implements IEObjectDocumentationProvider {
 
 	private final PolymorphicDispatcher<String> dispatcher = 
-		new PolymorphicDispatcher<String>("documentation", 1, 1, Collections.singletonList(this), new ErrorHandler<String>() {
+		new PolymorphicDispatcher<String>("_documentation", 1, 1, Collections.singletonList(this), new ErrorHandler<String>() {
 			public String handle(Object[] params, Throwable e) {
 				return handleError(params, e);
 			}
@@ -31,7 +31,7 @@ public class DeclarativeEObjectDocumentationProvider implements IEObjectDocument
 		return null;
 	}
 
-	protected String documentation(EObject element) {
+	protected String _documentation(EObject element) {
 		return null;
 	}
 	
diff --git a/tests/org.eclipse.xtext.tests/src/org/eclipse/xtext/documentation/impl/DeclarativeEObjectDocumentationProviderTest.java b/tests/org.eclipse.xtext.tests/src/org/eclipse/xtext/documentation/impl/DeclarativeEObjectDocumentationProviderTest.java
index 00dbb56..2750bd3 100644
--- a/tests/org.eclipse.xtext.tests/src/org/eclipse/xtext/documentation/impl/DeclarativeEObjectDocumentationProviderTest.java
+++ b/tests/org.eclipse.xtext.tests/src/org/eclipse/xtext/documentation/impl/DeclarativeEObjectDocumentationProviderTest.java
@@ -30,7 +30,7 @@ public class DeclarativeEObjectDocumentationProviderTest extends AbstractXtextTe
 		model.getElements().get(0);
 		DeclarativeEObjectDocumentationProvider provider = new DeclarativeEObjectDocumentationProvider() {
 			@SuppressWarnings("unused")
-			protected String documentation(Element element) {
+			protected String _documentation(Element element) {
 				return element.getName();
 			}			
 		};
-- 
1.6.6


From ee34091e34c5cbad11ee29a74c2087e18727edbe Mon Sep 17 00:00:00 2001
From: Christoph Kulla <christophkulla@googlemail.com>
Date: Sat, 20 Nov 2010 16:39:22 +0100
Subject: [PATCH 26/28] Give existing hover tests more love. Add more tests.
 Update file headers.
 Cleanup of API of AbsractEObjectHover (uses IRegion now).
 Fixed MarkerCreator to create correct quickfix info on marker creation.

---
 .../xtext/common/types/xtext/ui/JdtHover.java      |   11 +-
 .../src/org/eclipse/xtext/ui/DefaultUiModule.java  |    6 +-
 .../ui/editor/hover/AbstractEObjectHover.java      |   73 +++++-------
 .../ui/editor/hover/AbstractProblemHover.java      |    5 +-
 .../hover/AnnotationWithQuickFixesHover.java       |   13 +-
 .../xtext/ui/editor/hover/CompositeHover.java      |    3 +-
 .../ui/editor/hover/DefaultCompositeHover.java     |    3 +-
 .../xtext/ui/editor/hover/ProblemHover.java        |    2 -
 ...elegatingtHtmlEObjectDocumentationProvider.java |   54 ---------
 .../HtmlEObjectDocumentationProviderDecorator.java |   55 +++++++++
 .../ui/editor/hover/html/OpenBrowserUtil.java      |   42 ++++++-
 .../html/XtextBrowserInformationControlInput.java  |   15 +---
 .../ui/editor/hover/html/XtextElementLinks.java    |   40 ++++---
 .../xtext/ui/editor/hover/html/XtextHtmlHover.java |   33 ++++--
 .../xtext/ui/editor/validation/MarkerCreator.java  |    5 +-
 .../IEObjectDocumentationProvider.java             |    5 +-
 .../DeclarativeEObjectDocumentationProvider.java   |    8 ++
 .../impl/MutiLineCommentDocumentationProvider.java |    3 +-
 ...eclarativeEObjectDocumentationProviderTest.java |    3 +-
 .../MultiLineCommentDocumentationProviderTest.java |    3 +-
 .../editor/hover/AbstractEObjectHoverTest.java     |   88 +++++++++++++++
 .../editor/hover/AbstractProblemHoverTest.java     |  100 +++++++++++++++++
 .../hover/AnnotationWithQuickFixesHoverTest.java   |   91 +++++++++++++++
 .../ui/tests/editor/hover/CompositeHoverTest.java  |   36 +++---
 .../ui/tests/editor/hover/ProblemHoverTest.java    |   86 ++++++++++++++
 ...lEObjectDocumentationProviderDecoratorTest.java |   75 +++++++++++++
 .../editor/hover/html/XtextElementLinksTest.java   |  118 ++++++++++++++++++++
 .../editor/hover/html/XtextHtmlHoverTest.java      |   77 +++++++++++++
 ...atingtHtmlEObjectDocumentationProviderTest.java |   74 ------------
 29 files changed, 860 insertions(+), 267 deletions(-)
 delete mode 100644 plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/DelegatingtHtmlEObjectDocumentationProvider.java
 create mode 100644 plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/HtmlEObjectDocumentationProviderDecorator.java
 create mode 100644 tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/AbstractEObjectHoverTest.java
 create mode 100644 tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/AbstractProblemHoverTest.java
 create mode 100644 tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/AnnotationWithQuickFixesHoverTest.java
 create mode 100644 tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/ProblemHoverTest.java
 create mode 100644 tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/html/HtmlEObjectDocumentationProviderDecoratorTest.java
 create mode 100644 tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/html/XtextElementLinksTest.java
 create mode 100644 tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/html/XtextHtmlHoverTest.java
 delete mode 100644 tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/hover/html/DelegatingtHtmlEObjectDocumentationProviderTest.java

diff --git a/plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JdtHover.java b/plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JdtHover.java
index ff143a9..62bd853 100644
--- a/plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JdtHover.java
+++ b/plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JdtHover.java
@@ -4,6 +4,8 @@
  * are made available under the terms of the Eclipse Public License v1.0
  * which accompanies this distribution, and is available at
  * http://www.eclipse.org/legal/epl-v10.html
+ * Contributors:
+ *  Christoph Kulla - Initial API and implementation
  *******************************************************************************/
 package org.eclipse.xtext.common.types.xtext.ui;
 
@@ -12,10 +14,8 @@ import org.eclipse.jdt.core.IJavaElement;
 import org.eclipse.jface.text.IInformationControlCreator;
 import org.eclipse.jface.text.IRegion;
 import org.eclipse.jface.text.ITextViewer;
-import org.eclipse.jface.text.Region;
 import org.eclipse.xtext.common.types.JvmIdentifyableElement;
 import org.eclipse.xtext.common.types.util.jdt.IJavaElementFinder;
-import org.eclipse.xtext.parsetree.AbstractNode;
 import org.eclipse.xtext.resource.XtextResource;
 import org.eclipse.xtext.ui.editor.hover.AbstractEObjectHover;
 import org.eclipse.xtext.ui.editor.model.IXtextDocument;
@@ -51,9 +51,9 @@ public class JdtHover extends AbstractEObjectHover {
 		IXtextDocument xtextDocument = XtextDocumentUtil.get(textViewer);
 		return xtextDocument.readOnly(new IUnitOfWork<Object, XtextResource>() {
 			public Object exec(XtextResource state) throws Exception {
-				Pair<AbstractNode,EObject> element = getXtextElementAt(state, hoverRegion);
-				if (element!=null && element.getSecond() instanceof JvmIdentifyableElement) {
-					JvmIdentifyableElement jvmIdentifyableElement = (JvmIdentifyableElement) element.getSecond();
+				Pair<EObject,IRegion> element = getXtextElementAt(state, hoverRegion);
+				if (element!=null && element.getFirst() instanceof JvmIdentifyableElement) {
+					JvmIdentifyableElement jvmIdentifyableElement = (JvmIdentifyableElement) element.getFirst();
 					IJavaElement javaElement = javaElementFinder.findElementFor(jvmIdentifyableElement);
 					if (javaElement!=null) {
 						javadocHover.setJavaElement(javaElement);
@@ -82,6 +82,5 @@ public class JdtHover extends AbstractEObjectHover {
 		} 
 		return null;
 	}
-
 	
 }
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java
index 8e981d5..b4fc13c 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/DefaultUiModule.java
@@ -60,7 +60,7 @@ import org.eclipse.xtext.ui.editor.formatting.IContentFormatterFactory;
 import org.eclipse.xtext.ui.editor.formatting.PreferenceStoreIndentationInformation;
 import org.eclipse.xtext.ui.editor.hover.ProblemHover;
 import org.eclipse.xtext.ui.editor.hover.DefaultCompositeHover;
-import org.eclipse.xtext.ui.editor.hover.html.DelegatingtHtmlEObjectDocumentationProvider;
+import org.eclipse.xtext.ui.editor.hover.html.HtmlEObjectDocumentationProviderDecorator;
 import org.eclipse.xtext.ui.editor.hyperlinking.DefaultHyperlinkDetector;
 import org.eclipse.xtext.ui.editor.model.IResourceForEditorInputFactory;
 import org.eclipse.xtext.ui.editor.model.JavaClassPathResourceForIEditorInputFactory;
@@ -291,7 +291,7 @@ public class DefaultUiModule extends AbstractGenericModule {
 	
 	public void configureDefaultHtmlEObjectDocumentationProvider(Binder binder) {
 		binder.bind(IEObjectDocumentationProvider.class).annotatedWith
-		(Names.named(DelegatingtHtmlEObjectDocumentationProvider.DELEGATE))
+		(Names.named(HtmlEObjectDocumentationProviderDecorator.DELEGATE))
 		.to(MutiLineCommentDocumentationProvider.class);		
 	}
 
@@ -316,7 +316,7 @@ public class DefaultUiModule extends AbstractGenericModule {
 	}
 			
 	public Class<? extends IEObjectDocumentationProvider> bindIEObjectDocumentationProvider () {
-		return DelegatingtHtmlEObjectDocumentationProvider.class;
+		return HtmlEObjectDocumentationProviderDecorator.class;
 	}
 
 }
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractEObjectHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractEObjectHover.java
index aa34282..368d62f 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractEObjectHover.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractEObjectHover.java
@@ -1,9 +1,10 @@
 /*******************************************************************************
- * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
  * All rights reserved. This program and the accompanying materials
  * are made available under the terms of the Eclipse Public License v1.0
  * which accompanies this distribution, and is available at
  * http://www.eclipse.org/legal/epl-v10.html
+ * Contributors:
+ *  Christoph Kulla - Initial API and implementation
  *******************************************************************************/
 package org.eclipse.xtext.ui.editor.hover;
 
@@ -11,24 +12,14 @@ import java.util.List;
 
 import org.eclipse.emf.ecore.EObject;
 import org.eclipse.emf.ecore.EStructuralFeature;
-import org.eclipse.jface.text.DefaultInformationControl;
-import org.eclipse.jface.text.IInformationControl;
-import org.eclipse.jface.text.IInformationControlCreator;
 import org.eclipse.jface.text.IRegion;
-import org.eclipse.jface.text.ITextHover;
-import org.eclipse.jface.text.ITextHoverExtension;
-import org.eclipse.jface.text.ITextHoverExtension2;
 import org.eclipse.jface.text.ITextViewer;
 import org.eclipse.jface.text.Region;
-import org.eclipse.swt.widgets.Shell;
-import org.eclipse.ui.editors.text.EditorsUI;
 import org.eclipse.xtext.parsetree.AbstractNode;
-import org.eclipse.xtext.parsetree.CompositeNode;
 import org.eclipse.xtext.parsetree.NodeUtil;
 import org.eclipse.xtext.parsetree.ParseTreeUtil;
 import org.eclipse.xtext.resource.EObjectAtOffsetHelper;
 import org.eclipse.xtext.resource.XtextResource;
-import org.eclipse.xtext.ui.editor.hover.html.XtextBrowserInformationControlInput;
 import org.eclipse.xtext.ui.editor.model.IXtextDocument;
 import org.eclipse.xtext.ui.editor.model.XtextDocumentUtil;
 import org.eclipse.xtext.util.Pair;
@@ -52,11 +43,10 @@ public abstract class AbstractEObjectHover extends AbstractHover {
 	public IRegion getHoverRegion(final ITextViewer textViewer, final int offset) {
 		IXtextDocument xtextDocument = XtextDocumentUtil.get(textViewer);
 		return xtextDocument.readOnly(new IUnitOfWork<IRegion, XtextResource>() {
-
 			public IRegion exec(XtextResource state) throws Exception {
-				Pair<AbstractNode, EObject> element = getXtextElementAt(state, offset);
+				Pair<EObject,IRegion> element = getXtextElementAt(state, offset);
 				if (element != null) {
-					return new Region(element.getFirst().getOffset(), element.getFirst().getLength());
+					return element.getSecond();
 				} else {
 					return null;
 				}
@@ -70,9 +60,9 @@ public abstract class AbstractEObjectHover extends AbstractHover {
 		IXtextDocument xtextDocument = XtextDocumentUtil.get(textViewer);
 		return xtextDocument.readOnly(new IUnitOfWork<Object, XtextResource>() {
 			public Object exec(XtextResource state) throws Exception {
-				Pair<AbstractNode,EObject> element = getXtextElementAt(state, hoverRegion.getOffset());
+				Pair<EObject,IRegion> element = getXtextElementAt(state, hoverRegion.getOffset());
 				if (element!=null && element.getSecond()!=null) {
-					return getHoverInfo2 (element.getSecond(), textViewer, hoverRegion);
+					return getHoverInfo2 (element.getFirst(), textViewer, hoverRegion);
 				} 
 				return null;
 			}		
@@ -84,46 +74,43 @@ public abstract class AbstractEObjectHover extends AbstractHover {
 	/**
 	 * Call this method only from within an IUnitOfWork
 	 */
-	protected Pair<AbstractNode, EObject> getXtextElementAt(XtextResource resource, final IRegion hoverRegion) {
+	protected Pair<EObject, IRegion> getXtextElementAt(XtextResource resource, final IRegion hoverRegion) {
 		return getXtextElementAt(resource, hoverRegion.getOffset());
 	}
 
 	/**
 	 * Call this method only from within an IUnitOfWork
 	 */
-	protected Pair<AbstractNode, EObject> getXtextElementAt(XtextResource resource, final int offset) {
-		AbstractNode an = ParseTreeUtil.getCurrentOrFollowingNodeByOffset(resource.getParseResult().getRootNode(),
-				offset);
-
-		{
-			// check assignment to name
-			EObject o = NodeUtil.findASTElement(an);
-			if (o != null) {
-				EStructuralFeature nameFeature = o.eClass().getEStructuralFeature("name");
-				if (nameFeature != null) {
-					List<AbstractNode> nodes = NodeUtil.findNodesForFeature(o, nameFeature);
-					if (contains(nodes, an))
-						return Tuples.create(an, o);
+	protected Pair<EObject, IRegion> getXtextElementAt(XtextResource resource, final int offset) {
+		// check for cross reference
+		EObject crossLinkedEObject = eObjectAtOffsetHelper.resolveCrossReferencedElementAt(resource, offset);
+		if (crossLinkedEObject != null) {
+			if (!crossLinkedEObject.eIsProxy()) {
+				AbstractNode an = ParseTreeUtil.getCurrentOrFollowingNodeByOffset(resource.getParseResult().getRootNode(), offset);
+				return Tuples.create (crossLinkedEObject, (IRegion) new Region (an.getOffset(), an.getLength()));
+			}
+		} else {		
+			// check for name
+			EObject o = eObjectAtOffsetHelper.resolveElementAt(resource, offset);
+			EStructuralFeature nameFeature = o.eClass().getEStructuralFeature("name");
+			if (nameFeature != null) {
+				List<AbstractNode> nodes = NodeUtil.findNodesForFeature(o, nameFeature);
+				if (contains(nodes, offset)) {
+					int length = 0;
+					for (AbstractNode n: nodes) {
+						length += n.getLength();
+					}
+					return Tuples.create (o, (IRegion) new Region (nodes.get(0).getOffset(), length));
 				}
 			}
-		}
-
-		// check cross reference
-		EObject crossLinkedEObject = eObjectAtOffsetHelper.resolveCrossReferencedElementAt(resource, offset);
-		if (crossLinkedEObject != null && !crossLinkedEObject.eIsProxy()) {
-			return Tuples.create(an, crossLinkedEObject);
-		}
+		}		
 		return null;
 	}
 
-	private boolean contains(List<AbstractNode> nodes, AbstractNode an) {
+	private boolean contains(List<AbstractNode> nodes, int offset) {
 		for (AbstractNode n: nodes) {
-			if (n==an) 
+			if (n.getOffset()<=offset && offset<n.getOffset()+n.getLength())
 				return true;
-			if (n instanceof CompositeNode) {
-				if (contains (((CompositeNode) n).getChildren(), an))
-					return true;
-			}
 		}
 		return false;
 	}
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractProblemHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractProblemHover.java
index 755d10d..4ab43c7 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractProblemHover.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractProblemHover.java
@@ -1,9 +1,10 @@
 /*******************************************************************************
- * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
  * All rights reserved. This program and the accompanying materials
  * are made available under the terms of the Eclipse Public License v1.0
  * which accompanies this distribution, and is available at
  * http://www.eclipse.org/legal/epl-v10.html
+ * Contributors:
+ *  Christoph Kulla - Initial API and implementation
  *******************************************************************************/
 package org.eclipse.xtext.ui.editor.hover;
 
@@ -57,7 +58,7 @@ public abstract class AbstractProblemHover extends AbstractHover {
 		return sourceViewer.getAnnotationModel();
 	}
 	
-	protected List<Annotation> getAnnotations (final int lineNumber, final int offset) {
+	public List<Annotation> getAnnotations (final int lineNumber, final int offset) {
 		if(getAnnotationModel() == null) {
 			return null;
 		}
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AnnotationWithQuickFixesHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AnnotationWithQuickFixesHover.java
index 3697252..51a5212 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AnnotationWithQuickFixesHover.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AnnotationWithQuickFixesHover.java
@@ -1,11 +1,11 @@
 /*******************************************************************************
- * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
  * All rights reserved. This program and the accompanying materials
  * are made available under the terms of the Eclipse Public License v1.0
  * which accompanies this distribution, and is available at
  * http://www.eclipse.org/legal/epl-v10.html
+ * Contributors:
+ *  Christoph Kulla - Initial API and implementation
  *******************************************************************************/
-
 package org.eclipse.xtext.ui.editor.hover;
 
 import java.text.MessageFormat;
@@ -81,7 +81,7 @@ import com.google.inject.Inject;
 // 1) AnnotationInfo provides proposals directly, no need of subclassing
 // 2) Configuration of the hover content via preferences in the ui is not supported yet
 // 3) List of Quickfixes is retrieved from an XtextQuickAssistProcessor
-// 4) Removed acccess to JavaHoverMessages and replaced with XtextUIMessages
+// 4) Removed access to JavaHoverMessages and replaced with XtextUIMessages
 // 5) Dropped support of FixCorrectionProposal and ICleanUp (JDT concept)
 // 6) Removed field fAnnotationAccess, DefaultMarkerAnnotationAccesss is not supported as we have no preferences
 // 7) Removed field fAllAnnotations, no filtering of only Java Annotations required
@@ -91,7 +91,8 @@ import com.google.inject.Inject;
 
 // If no comments appear the code does not differ from AbstractAnnotationHover.
 
-// DIFF: AnnotationWithQuickFixesHoveris is not abstract (8)
+// DIFF: AnnotationWithQuickFixesHover is is not abstract (8)
+
 public class AnnotationWithQuickFixesHover extends AbstractProblemHover {
 	
 	// DIFF: not part of AbstractAnnotationHover (3)
@@ -99,8 +100,8 @@ public class AnnotationWithQuickFixesHover extends AbstractProblemHover {
 	@Inject
 	private XtextQuickAssistProcessor quickAssistProcessor;
 
-	
-	protected static class AnnotationInfo {
+	// public to give access in tests
+	public static class AnnotationInfo {
 		public final Annotation annotation;
 		public final Position position;
 		public final ITextViewer viewer;
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/CompositeHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/CompositeHover.java
index 7afdde0..9f3bfe1 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/CompositeHover.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/CompositeHover.java
@@ -1,9 +1,10 @@
 /*******************************************************************************
- * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
  * All rights reserved. This program and the accompanying materials
  * are made available under the terms of the Eclipse Public License v1.0
  * which accompanies this distribution, and is available at
  * http://www.eclipse.org/legal/epl-v10.html
+ * Contributors:
+ *  Christoph Kulla - Initial API and implementation
  *******************************************************************************/
 package org.eclipse.xtext.ui.editor.hover;
 
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DefaultCompositeHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DefaultCompositeHover.java
index 9b89e43..a95db4f 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DefaultCompositeHover.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DefaultCompositeHover.java
@@ -1,9 +1,10 @@
 /*******************************************************************************
- * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
  * All rights reserved. This program and the accompanying materials
  * are made available under the terms of the Eclipse Public License v1.0
  * which accompanies this distribution, and is available at
  * http://www.eclipse.org/legal/epl-v10.html
+ * Contributors:
+ *  Christoph Kulla - Initial API and implementation
  *******************************************************************************/
 package org.eclipse.xtext.ui.editor.hover;
 
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/ProblemHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/ProblemHover.java
index 25957df..8a05f71 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/ProblemHover.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/ProblemHover.java
@@ -55,8 +55,6 @@ public class ProblemHover extends AbstractProblemHover implements IAnnotationHov
 		return null;
 	}
 		
-	// AbstractProblemHover
-	
 	@Override
 	protected Object getHoverInfoInternal(final ITextViewer textViewer, final int lineNumber, final int offset) {
 		final Set<String> messages = Sets.newLinkedHashSet();
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/DelegatingtHtmlEObjectDocumentationProvider.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/DelegatingtHtmlEObjectDocumentationProvider.java
deleted file mode 100644
index 840da86..0000000
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/DelegatingtHtmlEObjectDocumentationProvider.java
+++ /dev/null
@@ -1,54 +0,0 @@
-/*******************************************************************************
- * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
- * All rights reserved. This program and the accompanying materials
- * are made available under the terms of the Eclipse Public License v1.0
- * which accompanies this distribution, and is available at
- * http://www.eclipse.org/legal/epl-v10.html
- *******************************************************************************/
-package org.eclipse.xtext.ui.editor.hover.html;
-
-import org.eclipse.emf.ecore.EObject;
-import org.eclipse.jface.viewers.ILabelProvider;
-import org.eclipse.xtext.documentation.IEObjectDocumentationProvider;
-
-import com.google.inject.Inject;
-import com.google.inject.name.Named;
-
-/**
- * Returns a html string as documentation. Delegates to another IEObjectDocumentationProvider and adds
- * the objects type and label at the beginning.
- * 
- * @author Christoph Kulla - Initial contribution and API
- */
-public class DelegatingtHtmlEObjectDocumentationProvider implements IEObjectDocumentationProvider {
-
-	public static final String DELEGATE = "org.eclipse.xtext.ui.editor.hover.html.DelegatingtHtmlEObjectDocumentationProvider.delegate";
-
-	@Inject
-	private ILabelProvider labelProvider;
-
-	@Inject @Named(DELEGATE)
-	private IEObjectDocumentationProvider delegate;
-
-	public String getDocumentation(EObject o) {
-		StringBuffer buffer = new StringBuffer();
-		buffer.append (o.eClass().getName()+ " <b>"+getLabel(o)+"</b>");
-		String documentation = delegate.getDocumentation(o);
-		if (documentation!=null && documentation.length()>0) {
-			buffer.append ("<p>");
-			buffer.append (documentation);
-			buffer.append("</p>");
-		}
-		return buffer.toString();
-	}
-	
-	protected String getLabel (EObject o) {
-		return getLabelProvider().getText(o);
-	}
-	
-	protected ILabelProvider getLabelProvider () {
-		return labelProvider;
-	}
-	
-}
-
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/HtmlEObjectDocumentationProviderDecorator.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/HtmlEObjectDocumentationProviderDecorator.java
new file mode 100644
index 0000000..40795de
--- /dev/null
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/HtmlEObjectDocumentationProviderDecorator.java
@@ -0,0 +1,55 @@
+/*******************************************************************************
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ * Contributors:
+ *  Christoph Kulla - Initial API and implementation
+ *******************************************************************************/
+package org.eclipse.xtext.ui.editor.hover.html;
+
+import org.eclipse.emf.ecore.EObject;
+import org.eclipse.jface.viewers.ILabelProvider;
+import org.eclipse.xtext.documentation.IEObjectDocumentationProvider;
+
+import com.google.inject.Inject;
+import com.google.inject.name.Named;
+
+/**
+ * Returns a html string as documentation. Delegates to another IEObjectDocumentationProvider and adds
+ * the objects type and label at the beginning.
+ * 
+ * @author Christoph Kulla - Initial contribution and API
+ */
+public class HtmlEObjectDocumentationProviderDecorator implements IEObjectDocumentationProvider {
+
+	public static final String DELEGATE = "org.eclipse.xtext.ui.editor.hover.html.DelegatingtHtmlEObjectDocumentationProvider.delegate";
+
+	@Inject
+	private ILabelProvider labelProvider;
+
+	@Inject @Named(DELEGATE)
+	private IEObjectDocumentationProvider decoratedProvider;
+
+	public String getDocumentation(EObject o) {
+		StringBuffer buffer = new StringBuffer();
+		buffer.append (o.eClass().getName()+ " <b>"+getLabel(o)+"</b>");
+		String documentation = decoratedProvider.getDocumentation(o);
+		if (documentation!=null && documentation.length()>0) {
+			buffer.append ("<p>");
+			buffer.append (documentation);
+			buffer.append("</p>");
+		}
+		return buffer.toString();
+	}
+	
+	protected String getLabel (EObject o) {
+		return getLabelProvider().getText(o);
+	}
+	
+	protected ILabelProvider getLabelProvider () {
+		return labelProvider;
+	}
+	
+}
+
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/OpenBrowserUtil.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/OpenBrowserUtil.java
index 5c64ce8..6e6a17a 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/OpenBrowserUtil.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/OpenBrowserUtil.java
@@ -1,11 +1,11 @@
 /*******************************************************************************
- * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
  * All rights reserved. This program and the accompanying materials
  * are made available under the terms of the Eclipse Public License v1.0
  * which accompanies this distribution, and is available at
  * http://www.eclipse.org/legal/epl-v10.html
+ * Contributors:
+ *  Christoph Kulla - Initial API and implementation
  *******************************************************************************/
-
 package org.eclipse.xtext.ui.editor.hover.html;
 
 import java.net.URL;
@@ -13,25 +13,53 @@ import java.net.URL;
 import org.eclipse.swt.custom.BusyIndicator;
 import org.eclipse.swt.widgets.Display;
 
+import org.eclipse.ui.PartInitException;
 import org.eclipse.ui.PlatformUI;
+import org.eclipse.ui.browser.IWebBrowser;
+import org.eclipse.ui.browser.IWorkbenchBrowserSupport;
 
-// coppied from JDT
+// cloned from org.eclipse.jdt.internal.ui.actions.OpenBrowserUtil,
+// does not differ from the original class
 
+/**
+ * This is a clone from JDT's JavadocHover class
+ * 
+ * @author Christoph Kulla - Initial contribution and API
+ */
 public class OpenBrowserUtil {
 
-	public static void open(final URL url, Display display, final String dialogTitle) {
+	public static void open(final URL url, Display display) {
+		display.syncExec(new Runnable() {
+			public void run() {
+				internalOpen(url, false);
+			}
+		});
+	}
+
+	public static void openExternal(final URL url, Display display) {
 		display.syncExec(new Runnable() {
 			public void run() {
-				internalOpen(url, dialogTitle);
+				internalOpen(url, true);
 			}
 		});
 	}
 
-	private static void internalOpen(final URL url, String title) {
+	private static void internalOpen(final URL url, final boolean useExternalBrowser) {
 		BusyIndicator.showWhile(null, new Runnable() {
 			public void run() {
-				PlatformUI.getWorkbench().getHelpSystem().displayHelpResource(url.toExternalForm() + "?noframes=true"); //$NON-NLS-1$
+				URL helpSystemUrl= PlatformUI.getWorkbench().getHelpSystem().resolve(url.toExternalForm(), true);
+				try {
+					IWorkbenchBrowserSupport browserSupport = PlatformUI.getWorkbench().getBrowserSupport();
+					IWebBrowser browser;
+					if (useExternalBrowser)
+						browser= browserSupport.getExternalBrowser();
+					else
+						browser= browserSupport.createBrowser(null);
+					browser.openURL(helpSystemUrl);
+				} catch (PartInitException ex) {
+				}
 			}
 		});
 	}
+
 }
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextBrowserInformationControlInput.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextBrowserInformationControlInput.java
index 51535a0..6bd88ab 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextBrowserInformationControlInput.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextBrowserInformationControlInput.java
@@ -1,12 +1,10 @@
 /*******************************************************************************
- * Copyright (c) 2008 IBM Corporation and others.
  * All rights reserved. This program and the accompanying materials
  * are made available under the terms of the Eclipse Public License v1.0
  * which accompanies this distribution, and is available at
  * http://www.eclipse.org/legal/epl-v10.html
- *
  * Contributors:
- *     IBM Corporation - initial API and implementation
+ *  Christoph Kulla - Initial API and implementation
  *******************************************************************************/
 package org.eclipse.xtext.ui.editor.hover.html;
 
@@ -34,7 +32,6 @@ public class XtextBrowserInformationControlInput extends BrowserInformationContr
 	private final String fHtml;
 	private final ILabelProvider fLabelProvider;
 	
-	//private final int fLeadingImageWidth;
 	/**
 	 * Creates a new browser information control input.
 	 *
@@ -49,18 +46,8 @@ public class XtextBrowserInformationControlInput extends BrowserInformationContr
 		fElement= element;
 		fHtml= html;
 		fLabelProvider = labelProvider;
-		// fLeadingImageWidth= leadingImageWidth;
 	}
 
-//	/*
-//	 * @see org.eclipse.jface.internal.text.html.BrowserInformationControlInput#getLeadingImageWidth()
-//	 * @since 3.4
-//	 */
-//	@Override
-//	public int getLeadingImageWidth() {
-//		return fLeadingImageWidth;
-//	}
-
 	public EObject getElement() {
 		return fElement;
 	}
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextElementLinks.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextElementLinks.java
index 8760173..47610bf 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextElementLinks.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextElementLinks.java
@@ -1,9 +1,10 @@
 /*******************************************************************************
- * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
  * All rights reserved. This program and the accompanying materials
  * are made available under the terms of the Eclipse Public License v1.0
  * which accompanies this distribution, and is available at
  * http://www.eclipse.org/legal/epl-v10.html
+ * Contributors:
+ *  Christoph Kulla - Initial API and implementation
  *******************************************************************************/
 package org.eclipse.xtext.ui.editor.hover.html;
 
@@ -23,21 +24,19 @@ import org.eclipse.swt.widgets.Display;
 
 import com.google.inject.Inject;
 
+// Clone of org.eclipse.jdt.internal.ui.viewsupport.JavaElementLinks
+// Removed all java specific parts
+
 /**
  * @author Christoph Kulla - Initial contribution and API
  */
 public class XtextElementLinks {
-	
-	@Inject
-	ILabelProvider labelProvider;
-	
-	private static final Logger log = Logger.getLogger(XtextElementLinks.class);
-	
-	// should be all lower case (IE issue)
-	public static final String OPEN_LINK_SCHEME= "xtext-open"; //$NON-NLS-1$
-	public static final String XTEXTDOC_SCHEME= "xtext-doc"; //$NON-NLS-1$
-	public static final String XTEXTDOC_VIEW_SCHEME= "xtext-doc-view"; //$NON-NLS-1$
-	
+
+	/**
+	 * A handler is asked to handle links to targets.
+	 *
+	 * @see XtextElementLinks#createLocationListener(XtextElementLinks.ILinkHandler)
+	 */
 	public interface ILinkHandler {
 
 		/**
@@ -77,6 +76,16 @@ public class XtextElementLinks {
 		void handleTextSet();
 	}	
 	
+	@Inject
+	ILabelProvider labelProvider;
+	
+	private static final Logger log = Logger.getLogger(XtextElementLinks.class);
+	
+	// should be all lower case (Internet Explorer issue)
+	public static final String OPEN_LINK_SCHEME= "eclipse-xtext-open"; //$NON-NLS-1$
+	public static final String XTEXTDOC_SCHEME= "eclipse-xtext-doc"; //$NON-NLS-1$
+	public static final String XTEXTDOC_VIEW_SCHEME= "eclipse-xtext-doc-view"; //$NON-NLS-1$
+	
 	public LocationListener createLocationListener(final ILinkHandler handler) {
 		return new LocationAdapter() {
 			@Override
@@ -169,10 +178,6 @@ public class XtextElementLinks {
 		return "<a class='header' href='" + uri + ("'>" + elementName + "</a>"); //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$
 	}
 	
-	private org.eclipse.emf.common.util.URI createURI(EObject o) {
-		return o.eResource().getURI().appendFragment(o.eResource().getURIFragment(o));
-	}
-	
 	public String createURI(String scheme, EObject o) throws URISyntaxException {
 		return new URI (scheme, createURI(o).toString(), null).toASCIIString();
 	}
@@ -181,5 +186,8 @@ public class XtextElementLinks {
 		return org.eclipse.emf.common.util.URI.createURI(uri.getSchemeSpecificPart());
 	}
 
+	private org.eclipse.emf.common.util.URI createURI(EObject o) {
+		return o.eResource().getURI().appendFragment(o.eResource().getURIFragment(o));
+	}
 	
 }
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextHtmlHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextHtmlHover.java
index cfad973..7acb09a 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextHtmlHover.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextHtmlHover.java
@@ -1,9 +1,10 @@
 /*******************************************************************************
- * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
  * All rights reserved. This program and the accompanying materials
  * are made available under the terms of the Eclipse Public License v1.0
  * which accompanies this distribution, and is available at
  * http://www.eclipse.org/legal/epl-v10.html
+ * Contributors:
+ *  Christoph Kulla - Initial API and implementation
  *******************************************************************************/
 package org.eclipse.xtext.ui.editor.hover.html;
 
@@ -39,7 +40,6 @@ import org.eclipse.ui.ISharedImages;
 import org.eclipse.ui.PlatformUI;
 import org.eclipse.ui.editors.text.EditorsUI;
 import org.eclipse.xtext.documentation.IEObjectDocumentationProvider;
-import org.eclipse.xtext.parsetree.AbstractNode;
 import org.eclipse.xtext.resource.XtextResource;
 import org.eclipse.xtext.ui.XtextUIMessages;
 import org.eclipse.xtext.ui.editor.IURIEditorOpener;
@@ -55,16 +55,21 @@ import com.google.inject.Inject;
 import com.google.inject.name.Named;
 import com.ibm.icu.text.MessageFormat;
 
+// clone of org.eclipse.jdt.internal.ui.text.java.hover.JavadocHover
+// Removed all reference to java elements, content is provided by an
+// IEObjectDocumentationProvider.
+
 /**
- * This is a clone from JDT's JavadocHover class
+ * Provides Xtext documentation as hover info for model elements
+ * (clone from JDT's JavadocHover).
  * 
  * @author Christoph Kulla - Initial contribution and API
  */
-@SuppressWarnings({ "restriction"})
+@SuppressWarnings("restriction")
 public class XtextHtmlHover extends AbstractEObjectHover {
 
-	@Inject(optional=true)
-	private IEObjectDocumentationProvider hoverContentProvider;
+	@Inject
+	private IEObjectDocumentationProvider documentationProvider;
 	
 	@Inject
 	private IURIEditorOpener uriEditorOpener;
@@ -160,6 +165,10 @@ public class XtextHtmlHover extends AbstractEObjectHover {
 		}
 	}
 
+	// This part is responsible for display the hover content in the 
+	// JavaDoc view. A corresponding XtextDoc view is not available yet.
+	// Therefore this code is disabled for later use.
+	
 //	private static final class ShowInJavadocViewAction extends Action {
 //		private final BrowserInformationControl fInfoControl;
 //
@@ -221,7 +230,7 @@ public class XtextHtmlHover extends AbstractEObjectHover {
 		control.addLocationListener(elementLinks.createLocationListener(new XtextElementLinks.ILinkHandler() {
 
 			public void handleXtextdocViewLink(URI linkTarget) {
-				// TODO: enable when xtextdoc view available
+				// TODO: enable when XtextDoc view available
 //				control.notifyDelayedInputChange(null);
 //				control.setVisible(false);
 //				control.dispose(); //FIXME: should have protocol to hide, rather than dispose
@@ -253,7 +262,7 @@ public class XtextHtmlHover extends AbstractEObjectHover {
 				control.dispose(); //FIXME: should have protocol to hide, rather than dispose
 				
 				// open external links in real browser:
-				OpenBrowserUtil.open(url, display, ""); //$NON-NLS-1$
+				OpenBrowserUtil.openExternal(url, display);
 				return true;
 			}
 
@@ -402,16 +411,16 @@ public class XtextHtmlHover extends AbstractEObjectHover {
 	}
 
 	private XtextBrowserInformationControlInput internalGetHoverInfo(final ITextViewer textViewer, final IRegion hoverRegion) {
-		if (hoverContentProvider==null) 
+		if (documentationProvider==null) 
 			return null;
 		
 		IXtextDocument xtextDocument = XtextDocumentUtil.get(textViewer);
 
 		return xtextDocument.readOnly(new IUnitOfWork<XtextBrowserInformationControlInput, XtextResource>() {
 			public XtextBrowserInformationControlInput exec(XtextResource state) throws Exception {
-				Pair<AbstractNode,EObject> element = getXtextElementAt(state, hoverRegion);
+				Pair<EObject,IRegion> element = getXtextElementAt(state, hoverRegion);
 				if (element!=null && element.getSecond()!=null) {
-					return getHoverInfo (element.getSecond(), hoverRegion, null);
+					return getHoverInfo (element.getFirst(), hoverRegion, null);
 				} 
 				return null;
 			}		
@@ -424,7 +433,7 @@ public class XtextHtmlHover extends AbstractEObjectHover {
 	}
 	
 	private XtextBrowserInformationControlInput getHoverInfo(EObject element, IRegion hoverRegion, XtextBrowserInformationControlInput previous) {
-		String html = hoverContentProvider.getDocumentation(element);
+		String html = documentationProvider.getDocumentation(element);
 		if (html!=null) {
 			StringBuffer buffer = new StringBuffer(html);
 			HTMLPrinter.insertPageProlog(buffer, 0, getStyleSheet());
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/validation/MarkerCreator.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/validation/MarkerCreator.java
index 789b45b..df2e834 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/validation/MarkerCreator.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/validation/MarkerCreator.java
@@ -25,13 +25,14 @@ public class MarkerCreator {
 			lineNR = "line: " + issue.getLineNumber() + " ";
 		}
 		marker.setAttribute(IMarker.LOCATION, lineNR + resource.getFullPath().toString());
+		marker.setAttribute(Issue.CODE_KEY, issue.getCode());		
+		marker.setAttribute(IMarker.SEVERITY, getSeverity(issue));
 		marker.setAttribute(IMarker.CHAR_START, issue.getOffset());
 		if(issue.getOffset() != null && issue.getLength() != null)
 			marker.setAttribute(IMarker.CHAR_END, issue.getOffset()+issue.getLength());
 		marker.setAttribute(IMarker.LINE_NUMBER, issue.getLineNumber());
 		marker.setAttribute(IMarker.MESSAGE, issue.getMessage());
-		marker.setAttribute(IMarker.SEVERITY, getSeverity(issue));
-		marker.setAttribute(Issue.CODE_KEY, issue.getCode());
+
 		if (issue.getUriToProblem()!=null) 
 			marker.setAttribute(Issue.URI_KEY, issue.getUriToProblem().toString());
 		if(issue.getData() != null && issue.getData().length > 0) {
diff --git a/plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/IEObjectDocumentationProvider.java b/plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/IEObjectDocumentationProvider.java
index 4e04d5a..07e7e05 100644
--- a/plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/IEObjectDocumentationProvider.java
+++ b/plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/IEObjectDocumentationProvider.java
@@ -1,16 +1,15 @@
 /*******************************************************************************
- * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
  * All rights reserved. This program and the accompanying materials
  * are made available under the terms of the Eclipse Public License v1.0
  * which accompanies this distribution, and is available at
  * http://www.eclipse.org/legal/epl-v10.html
+ * Contributors:
+ *  Christoph Kulla - Initial API and implementation
  *******************************************************************************/
 package org.eclipse.xtext.documentation;
 
 import org.eclipse.emf.ecore.EObject;
 
-import com.google.inject.ImplementedBy;
-
 /**
  * Returns a documentation string for an EObject.
  * 
diff --git a/plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/impl/DeclarativeEObjectDocumentationProvider.java b/plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/impl/DeclarativeEObjectDocumentationProvider.java
index 0e7282d..6c1f6c9 100644
--- a/plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/impl/DeclarativeEObjectDocumentationProvider.java
+++ b/plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/impl/DeclarativeEObjectDocumentationProvider.java
@@ -1,3 +1,11 @@
+/*******************************************************************************
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ * Contributors:
+ *  Christoph Kulla - Initial API and implementation
+ *******************************************************************************/
 package org.eclipse.xtext.documentation.impl;
 
 import java.util.Collections;
diff --git a/plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/impl/MutiLineCommentDocumentationProvider.java b/plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/impl/MutiLineCommentDocumentationProvider.java
index 7885d7f..0aa6332 100644
--- a/plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/impl/MutiLineCommentDocumentationProvider.java
+++ b/plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/impl/MutiLineCommentDocumentationProvider.java
@@ -1,9 +1,10 @@
 /*******************************************************************************
- * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
  * All rights reserved. This program and the accompanying materials
  * are made available under the terms of the Eclipse Public License v1.0
  * which accompanies this distribution, and is available at
  * http://www.eclipse.org/legal/epl-v10.html
+ * Contributors:
+ *  Christoph Kulla - Initial API and implementation
  *******************************************************************************/
 package org.eclipse.xtext.documentation.impl;
 
diff --git a/tests/org.eclipse.xtext.tests/src/org/eclipse/xtext/documentation/impl/DeclarativeEObjectDocumentationProviderTest.java b/tests/org.eclipse.xtext.tests/src/org/eclipse/xtext/documentation/impl/DeclarativeEObjectDocumentationProviderTest.java
index 2750bd3..4159276 100644
--- a/tests/org.eclipse.xtext.tests/src/org/eclipse/xtext/documentation/impl/DeclarativeEObjectDocumentationProviderTest.java
+++ b/tests/org.eclipse.xtext.tests/src/org/eclipse/xtext/documentation/impl/DeclarativeEObjectDocumentationProviderTest.java
@@ -1,9 +1,10 @@
 /*******************************************************************************
- * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
  * All rights reserved. This program and the accompanying materials
  * are made available under the terms of the Eclipse Public License v1.0
  * which accompanies this distribution, and is available at
  * http://www.eclipse.org/legal/epl-v10.html
+ * Contributors:
+ *  Christoph Kulla - Initial API and implementation
  *******************************************************************************/
 package org.eclipse.xtext.documentation.impl;
 
diff --git a/tests/org.eclipse.xtext.tests/src/org/eclipse/xtext/documentation/impl/MultiLineCommentDocumentationProviderTest.java b/tests/org.eclipse.xtext.tests/src/org/eclipse/xtext/documentation/impl/MultiLineCommentDocumentationProviderTest.java
index 24d3a6b..3cf7cb5 100644
--- a/tests/org.eclipse.xtext.tests/src/org/eclipse/xtext/documentation/impl/MultiLineCommentDocumentationProviderTest.java
+++ b/tests/org.eclipse.xtext.tests/src/org/eclipse/xtext/documentation/impl/MultiLineCommentDocumentationProviderTest.java
@@ -1,9 +1,10 @@
 /*******************************************************************************
- * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
  * All rights reserved. This program and the accompanying materials
  * are made available under the terms of the Eclipse Public License v1.0
  * which accompanies this distribution, and is available at
  * http://www.eclipse.org/legal/epl-v10.html
+ * Contributors:
+ *  Christoph Kulla - Initial API and implementation
  *******************************************************************************/
 package org.eclipse.xtext.documentation.impl;
 
diff --git a/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/AbstractEObjectHoverTest.java b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/AbstractEObjectHoverTest.java
new file mode 100644
index 0000000..538e37b
--- /dev/null
+++ b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/AbstractEObjectHoverTest.java
@@ -0,0 +1,88 @@
+/*******************************************************************************
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ * Contributors:
+ *  Christoph Kulla - Initial API and implementation
+ *******************************************************************************/
+package org.eclipse.xtext.ui.tests.editor.hover;
+
+import org.eclipse.core.resources.IFile;
+import org.eclipse.emf.ecore.EObject;
+import org.eclipse.jface.text.IRegion;
+import org.eclipse.jface.text.ITextViewer;
+import org.eclipse.jface.text.Region;
+import org.eclipse.ui.IWorkbenchPart;
+import org.eclipse.xtext.ui.editor.XtextEditor;
+import org.eclipse.xtext.ui.editor.hover.AbstractEObjectHover;
+import org.eclipse.xtext.ui.editor.model.IXtextDocument;
+import org.eclipse.xtext.ui.junit.util.IResourcesSetupUtil;
+import org.eclipse.xtext.ui.tests.Activator;
+import org.eclipse.xtext.ui.tests.editor.AbstractEditorTest;
+
+/**
+ * @author Christoph Kulla - Initial contribution and API
+ */
+public class AbstractEObjectHoverTest extends AbstractEditorTest {
+	
+	protected XtextEditor editor;
+	
+	protected IXtextDocument document;
+
+	protected String modelAsText;
+	
+	private MockHover hover;
+
+	@Override
+	protected void setUp() throws Exception {
+		super.setUp();
+		modelAsText = "stuff mystuff stuff yourstuff refs mystuff // Comment";
+		IFile file = IResourcesSetupUtil.createFile("test/test.testlanguage", modelAsText);
+		editor = openEditor(file);
+		document = editor.getDocument();
+		hover = Activator.getInstance().getInjector(getEditorId()).getInstance(MockHover.class);
+	}
+
+	@Override
+	protected void tearDown() throws Exception {
+		super.tearDown();
+		editor.close(false);
+	}
+
+	@Override
+	protected String getEditorId() {
+		return "org.eclipse.xtext.ui.tests.TestLanguage";
+	}
+
+	public void testNames () {	
+		assertNull (hover.getHoverRegion(editor.getInternalSourceViewer(), 5));
+		assertNull (hover.getHoverRegion(editor.getInternalSourceViewer(), 5));
+		assertEquals(new Region (6,7), hover.getHoverRegion(editor.getInternalSourceViewer(), 6));
+		assertEquals(new Region (6,7), hover.getHoverRegion(editor.getInternalSourceViewer(), 12));
+		assertNull (hover.getHoverRegion(editor.getInternalSourceViewer(), 13));
+	}
+
+	public void testCrossReferences () {
+		assertNull (hover.getHoverRegion(editor.getInternalSourceViewer(), 34));
+		assertEquals(new Region (35,7), hover.getHoverRegion(editor.getInternalSourceViewer(), 35));
+		assertEquals(new Region (35,7), hover.getHoverRegion(editor.getInternalSourceViewer(), 42));
+		assertNull (hover.getHoverRegion(editor.getInternalSourceViewer(), 43));
+	}
+
+	protected void activate(IWorkbenchPart part) {
+		editor.getSite().getPage().activate(part);
+	}
+	
+	static class MockHover extends AbstractEObjectHover {
+		
+		EObject hoverObject;
+
+		@Override
+		protected Object getHoverInfo2(EObject eObject, ITextViewer textViewer, IRegion hoverRegion) {
+			hoverObject = eObject;
+			return "test";
+		}
+	}
+		
+}
diff --git a/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/AbstractProblemHoverTest.java b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/AbstractProblemHoverTest.java
new file mode 100644
index 0000000..2bdcbe3
--- /dev/null
+++ b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/AbstractProblemHoverTest.java
@@ -0,0 +1,100 @@
+/*******************************************************************************
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ * Contributors:
+ *  Christoph Kulla - Initial API and implementation
+ *******************************************************************************/
+package org.eclipse.xtext.ui.tests.editor.hover;
+
+import java.util.List;
+
+import org.eclipse.core.resources.IFile;
+import org.eclipse.jface.text.IRegion;
+import org.eclipse.jface.text.ITextViewer;
+import org.eclipse.ui.IWorkbenchPart;
+import org.eclipse.xtext.resource.XtextResource;
+import org.eclipse.xtext.ui.MarkerTypes;
+import org.eclipse.xtext.ui.editor.XtextEditor;
+import org.eclipse.xtext.ui.editor.hover.AbstractProblemHover;
+import org.eclipse.xtext.ui.editor.model.IXtextDocument;
+import org.eclipse.xtext.ui.editor.validation.MarkerCreator;
+import org.eclipse.xtext.ui.junit.util.IResourcesSetupUtil;
+import org.eclipse.xtext.ui.tests.Activator;
+import org.eclipse.xtext.ui.tests.editor.AbstractEditorTest;
+import org.eclipse.xtext.util.concurrent.IUnitOfWork;
+import org.eclipse.xtext.validation.CheckMode;
+import org.eclipse.xtext.validation.Issue;
+
+/**
+ * @author Christoph Kulla - Initial contribution and API
+ */
+public class AbstractProblemHoverTest extends AbstractEditorTest {
+
+	protected XtextEditor editor;
+	
+	protected IXtextDocument document;
+
+	protected String modelAsText;
+	
+	private MockHover hover;
+
+	@Override
+	protected void setUp() throws Exception {
+		super.setUp();
+		modelAsText = "stuff mystuff\nstuff yourstuff refs _mystuff// Comment";
+		IFile file = IResourcesSetupUtil.createFile("test/test.testlanguage", modelAsText);
+		editor = openEditor(file);
+		document = editor.getDocument();
+		hover = Activator.getInstance().getInjector(getEditorId()).getInstance(MockHover.class);
+		hover.setSourceViewer(editor.getInternalSourceViewer());
+		List<Issue> issues = document.readOnly(new IUnitOfWork<List<Issue>, XtextResource>() {
+			public List<Issue> exec(XtextResource state) throws Exception {
+				return state.getResourceServiceProvider().getResourceValidator().validate(state, CheckMode.ALL, null);
+			}	
+		});
+		MarkerCreator markerCreator =  Activator.getInstance().getInjector(getEditorId()).getInstance(MarkerCreator.class);
+		for (Issue issue : issues) {
+			markerCreator.createMarker(issue, file, MarkerTypes.forCheckType(issue.getType()));
+		}
+	}
+
+	@Override
+	protected void tearDown() throws Exception {
+		super.tearDown();
+		editor.close(false);
+	}
+
+	@Override
+	protected String getEditorId() {
+		return "org.eclipse.xtext.ui.tests.TestLanguage";
+	}
+
+	public void testAnnotations () {	
+		assertEquals (0, hover.getAnnotations(0,0).size());
+		assertEquals (0, hover.getAnnotations(1,34).size());
+		assertEquals (1, hover.getAnnotations(1,35).size());
+		assertEquals (1, hover.getAnnotations(1,43).size());
+		assertEquals (0, hover.getAnnotations(1,44).size());
+	}
+
+	protected void activate(IWorkbenchPart part) {
+		editor.getSite().getPage().activate(part);
+	}
+	
+	static class MockHover extends AbstractProblemHover {
+		
+		@Override
+		protected IRegion getHoverRegionInternal(int lineNumber, int offset) {
+			return null;
+		}
+
+		@Override
+		protected Object getHoverInfoInternal(ITextViewer textViewer, int lineNumber, int offset) {
+			return null;
+		}
+
+	}
+	
+}
diff --git a/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/AnnotationWithQuickFixesHoverTest.java b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/AnnotationWithQuickFixesHoverTest.java
new file mode 100644
index 0000000..6a52c8a
--- /dev/null
+++ b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/AnnotationWithQuickFixesHoverTest.java
@@ -0,0 +1,91 @@
+/*******************************************************************************
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ * Contributors:
+ *  Christoph Kulla - Initial API and implementation
+ *******************************************************************************/
+package org.eclipse.xtext.ui.tests.editor.hover;
+
+import java.util.List;
+
+import org.eclipse.core.resources.IFile;
+import org.eclipse.jface.text.Region;
+import org.eclipse.ui.IWorkbenchPart;
+import org.eclipse.xtext.resource.XtextResource;
+import org.eclipse.xtext.ui.MarkerTypes;
+import org.eclipse.xtext.ui.editor.XtextEditor;
+import org.eclipse.xtext.ui.editor.hover.AnnotationWithQuickFixesHover;
+import org.eclipse.xtext.ui.editor.hover.AnnotationWithQuickFixesHover.AnnotationInfo;
+import org.eclipse.xtext.ui.editor.model.IXtextDocument;
+import org.eclipse.xtext.ui.editor.validation.MarkerCreator;
+import org.eclipse.xtext.ui.junit.util.IResourcesSetupUtil;
+import org.eclipse.xtext.ui.tests.Activator;
+import org.eclipse.xtext.ui.tests.editor.AbstractEditorTest;
+import org.eclipse.xtext.util.concurrent.IUnitOfWork;
+import org.eclipse.xtext.validation.CheckMode;
+import org.eclipse.xtext.validation.Issue;
+
+/**
+ * @author Christoph Kulla - Initial contribution and API
+ */
+public class AnnotationWithQuickFixesHoverTest extends AbstractEditorTest {
+
+	protected XtextEditor editor;
+	
+	protected IXtextDocument document;
+
+	protected String modelAsText;
+	
+	private AnnotationWithQuickFixesHover hover;
+
+	@Override
+	protected void setUp() throws Exception {
+		super.setUp();
+		modelAsText = "stuff mystuff stuff yourstuff refs _mystuff stuff hisstuff refs _yourstuff";
+		IFile file = IResourcesSetupUtil.createFile("test/test.testlanguage", modelAsText);
+		editor = openEditor(file);
+		document = editor.getDocument();
+		hover = Activator.getInstance().getInjector(getEditorId()).getInstance(AnnotationWithQuickFixesHover.class);
+		hover.setSourceViewer(editor.getInternalSourceViewer());
+		List<Issue> issues = document.readOnly(new IUnitOfWork<List<Issue>, XtextResource>() {
+			public List<Issue> exec(XtextResource state) throws Exception {
+				return state.getResourceServiceProvider().getResourceValidator().validate(state, CheckMode.ALL, null);
+			}	
+		});
+		assertEquals (2, issues.size());
+		MarkerCreator markerCreator =  Activator.getInstance().getInjector(getEditorId()).getInstance(MarkerCreator.class);
+		for (Issue issue : issues) {
+			markerCreator.createMarker(issue, file, MarkerTypes.forCheckType(issue.getType()));
+		}
+	}
+
+	@Override
+	protected void tearDown() throws Exception {
+		super.tearDown();
+		editor.close(false);
+	}
+
+	@Override
+	protected String getEditorId() {
+		return "org.eclipse.xtext.ui.tests.TestLanguage";
+	}
+
+	public void testNoAnnotations () {	
+		AnnotationWithQuickFixesHover.AnnotationInfo info = (AnnotationInfo) hover.getHoverInfo2(editor.getInternalSourceViewer(), new Region (1, 1));
+		assertNull(info);
+	}
+	
+	public void testAnnotations () {	
+		AnnotationWithQuickFixesHover.AnnotationInfo info = (AnnotationInfo) hover.getHoverInfo2(editor.getInternalSourceViewer(), new Region(modelAsText.indexOf("_mystuff"), 1));
+		assertNotNull(info);
+		assertNotNull(info.annotation);
+		assertEquals (3, info.getCompletionProposals().length);
+	}
+
+	protected void activate(IWorkbenchPart part) {
+		editor.getSite().getPage().activate(part);
+	}
+		
+}
diff --git a/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/CompositeHoverTest.java b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/CompositeHoverTest.java
index a01343b..7752aec 100644
--- a/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/CompositeHoverTest.java
+++ b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/CompositeHoverTest.java
@@ -1,9 +1,10 @@
 /*******************************************************************************
- * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
  * All rights reserved. This program and the accompanying materials
  * are made available under the terms of the Eclipse Public License v1.0
  * which accompanies this distribution, and is available at
  * http://www.eclipse.org/legal/epl-v10.html
+ * Contributors:
+ *  Christoph Kulla - Initial API and implementation
  *******************************************************************************/
 package org.eclipse.xtext.ui.tests.editor.hover;
 
@@ -14,14 +15,11 @@ import org.eclipse.jface.text.ITextHover;
 import org.eclipse.jface.text.ITextViewer;
 import org.eclipse.jface.text.Region;
 import org.eclipse.ui.IWorkbenchPart;
-import org.eclipse.xtext.resource.XtextResource;
 import org.eclipse.xtext.ui.editor.XtextEditor;
 import org.eclipse.xtext.ui.editor.hover.CompositeHover;
 import org.eclipse.xtext.ui.editor.model.IXtextDocument;
 import org.eclipse.xtext.ui.junit.util.IResourcesSetupUtil;
 import org.eclipse.xtext.ui.tests.editor.AbstractEditorTest;
-import org.eclipse.xtext.util.concurrent.IUnitOfWork;
-
 import com.google.inject.internal.Lists;
 
 /**
@@ -32,12 +30,10 @@ public class CompositeHoverTest extends AbstractEditorTest {
 	protected XtextEditor editor;
 	protected IXtextDocument document;
 
-	protected String modelAsText;
-
 	@Override
 	protected void setUp() throws Exception {
 		super.setUp();
-		modelAsText = "// file content doesn't mater";
+		String modelAsText = "// file content doesn't mater";
 		IFile file = IResourcesSetupUtil.createFile("test/test.testlanguage", modelAsText);
 		editor = openEditor(file);
 		document = editor.getDocument();
@@ -54,6 +50,7 @@ public class CompositeHoverTest extends AbstractEditorTest {
 		return "org.eclipse.xtext.ui.tests.TestLanguage";
 	}
 
+	@SuppressWarnings("deprecation")
 	public void testNullHoverList () {
 		CompositeHover hover = new CompositeHover() {
 
@@ -64,12 +61,13 @@ public class CompositeHoverTest extends AbstractEditorTest {
 		};
 	
 		assertEquals (null, hover.getHovers());
-		assertNull (null, hover.getHoverRegion(editor.getInternalSourceViewer(), 0));
-		assertNull (null, hover.getHoverControlCreator());
-		assertNull (null, hover.getHoverInfo(editor.getInternalSourceViewer(), new Region(0,0)));
-		assertNull (null, hover.getHoverInfo2(editor.getInternalSourceViewer(), new Region(0,0)));
+		assertNull (hover.getHoverRegion(editor.getInternalSourceViewer(), 0));
+		assertNull (hover.getHoverControlCreator());
+		assertNull (hover.getHoverInfo(editor.getInternalSourceViewer(), new Region(0,0)));
+		assertNull (hover.getHoverInfo2(editor.getInternalSourceViewer(), new Region(0,0)));
 	}
 	
+	@SuppressWarnings("deprecation")
 	public void testEmptyHoverList () {
 		CompositeHover hover = new CompositeHover() {
 
@@ -81,12 +79,13 @@ public class CompositeHoverTest extends AbstractEditorTest {
 		};
 	
 		assertEquals (0, hover.getHovers().size());
-		assertNull (null, hover.getHoverRegion(editor.getInternalSourceViewer(), 0));
-		assertNull (null, hover.getHoverControlCreator());
-		assertNull (null, hover.getHoverInfo(editor.getInternalSourceViewer(), new Region(0,0)));
-		assertNull (null, hover.getHoverInfo2(editor.getInternalSourceViewer(), new Region(0,0)));
+		assertNull (hover.getHoverRegion(editor.getInternalSourceViewer(), 0));
+		assertNull (hover.getHoverControlCreator());
+		assertNull (hover.getHoverInfo(editor.getInternalSourceViewer(), new Region(0,0)));
+		assertNull (hover.getHoverInfo2(editor.getInternalSourceViewer(), new Region(0,0)));
 	}
 	
+	@SuppressWarnings("deprecation")
 	public void testSingleHover () {
 		CompositeHover hover = new CompositeHover() {
 
@@ -111,12 +110,13 @@ public class CompositeHoverTest extends AbstractEditorTest {
 		};
 	
 		assertEquals (1, hover.getHovers().size());
-		assertNotNull (null, hover.getHoverRegion(editor.getInternalSourceViewer(), 0));
+		assertNotNull (hover.getHoverRegion(editor.getInternalSourceViewer(), 0));
 		assertEquals ("test", hover.getHoverInfo(editor.getInternalSourceViewer(), new Region(0,0)));
-		assertNull (null, hover.getHoverRegion(editor.getInternalSourceViewer(), 5));
-		assertEquals (null, hover.getHoverInfo(editor.getInternalSourceViewer(), new Region(0,0)));
+		assertNull (hover.getHoverRegion(editor.getInternalSourceViewer(), 5));
+		assertNull (hover.getHoverInfo(editor.getInternalSourceViewer(), new Region(0,0)));
 	}
 	
+	@SuppressWarnings("deprecation")
 	public void testMultipleHovers () {
 		final ITextHover hover1 = new ITextHover() {
 			
diff --git a/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/ProblemHoverTest.java b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/ProblemHoverTest.java
new file mode 100644
index 0000000..9d39fa1
--- /dev/null
+++ b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/ProblemHoverTest.java
@@ -0,0 +1,86 @@
+/*******************************************************************************
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ * Contributors:
+ *  Christoph Kulla - Initial API and implementation
+ *******************************************************************************/
+package org.eclipse.xtext.ui.tests.editor.hover;
+
+import java.util.List;
+
+import org.eclipse.core.resources.IFile;
+import org.eclipse.jface.text.Region;
+import org.eclipse.ui.IWorkbenchPart;
+import org.eclipse.xtext.resource.XtextResource;
+import org.eclipse.xtext.ui.MarkerTypes;
+import org.eclipse.xtext.ui.editor.XtextEditor;
+import org.eclipse.xtext.ui.editor.hover.ProblemHover;
+import org.eclipse.xtext.ui.editor.model.IXtextDocument;
+import org.eclipse.xtext.ui.editor.validation.MarkerCreator;
+import org.eclipse.xtext.ui.junit.util.IResourcesSetupUtil;
+import org.eclipse.xtext.ui.tests.Activator;
+import org.eclipse.xtext.ui.tests.editor.AbstractEditorTest;
+import org.eclipse.xtext.util.concurrent.IUnitOfWork;
+import org.eclipse.xtext.validation.CheckMode;
+import org.eclipse.xtext.validation.Issue;
+
+/**
+ * @author Christoph Kulla - Initial contribution and API
+ */
+public class ProblemHoverTest extends AbstractEditorTest {
+
+	protected XtextEditor editor;
+	
+	protected IXtextDocument document;
+
+	protected String modelAsText;
+	
+	private ProblemHover hover;
+
+	@Override
+	protected void setUp() throws Exception {
+		super.setUp();
+		modelAsText = "stuff mystuff\nstuff yourstuff refs _mystuff stuff hisstuff refs _yourstuff// Comment";
+		IFile file = IResourcesSetupUtil.createFile("test/test.testlanguage", modelAsText);
+		editor = openEditor(file);
+		document = editor.getDocument();
+		hover = Activator.getInstance().getInjector(getEditorId()).getInstance(ProblemHover.class);
+		hover.setSourceViewer(editor.getInternalSourceViewer());
+		List<Issue> issues = document.readOnly(new IUnitOfWork<List<Issue>, XtextResource>() {
+			public List<Issue> exec(XtextResource state) throws Exception {
+				return state.getResourceServiceProvider().getResourceValidator().validate(state, CheckMode.ALL, null);
+			}	
+		});
+		MarkerCreator markerCreator =  Activator.getInstance().getInjector(getEditorId()).getInstance(MarkerCreator.class);
+		for (Issue issue : issues) {
+			markerCreator.createMarker(issue, file, MarkerTypes.forCheckType(issue.getType()));
+		}
+	}
+
+	@Override
+	protected void tearDown() throws Exception {
+		super.tearDown();
+		editor.close(false);
+	}
+
+	@Override
+	protected String getEditorId() {
+		return "org.eclipse.xtext.ui.tests.TestLanguage";
+	}
+
+	@SuppressWarnings("deprecation")
+	public void testAnnotations () {	
+		assertNull(hover.getHoverInfo(editor.getInternalSourceViewer(), new Region(34, 1)));
+		assertEquals("Couldn't resolve reference to Stuff '_mystuff'.", hover.getHoverInfo(editor.getInternalSourceViewer(), new Region(35, 7)));
+		assertEquals ("Multiple markers at this line\n"+
+				"- Couldn't resolve reference to Stuff '_mystuff'.\n"+
+				"- Couldn't resolve reference to Stuff '_yourstuff'.", hover.getHoverInfo(editor.getInternalSourceViewer(), 1));
+	}
+
+	protected void activate(IWorkbenchPart part) {
+		editor.getSite().getPage().activate(part);
+	}
+		
+}
diff --git a/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/html/HtmlEObjectDocumentationProviderDecoratorTest.java b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/html/HtmlEObjectDocumentationProviderDecoratorTest.java
new file mode 100644
index 0000000..fec42bb
--- /dev/null
+++ b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/html/HtmlEObjectDocumentationProviderDecoratorTest.java
@@ -0,0 +1,75 @@
+/*******************************************************************************
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ * Contributors:
+ *  Christoph Kulla - Initial API and implementation
+ *******************************************************************************/
+package org.eclipse.xtext.ui.tests.editor.hover.html;
+
+import org.eclipse.emf.ecore.EObject;
+import org.eclipse.xtext.ISetup;
+import org.eclipse.xtext.documentation.IEObjectDocumentationProvider;
+import org.eclipse.xtext.junit.AbstractXtextTests;
+import org.eclipse.xtext.ui.editor.hover.html.HtmlEObjectDocumentationProviderDecorator;
+import org.eclipse.xtext.ui.shared.SharedStateModule;
+import org.eclipse.xtext.ui.tests.Activator;
+import org.eclipse.xtext.ui.tests.TestLanguageRuntimeModule;
+import org.eclipse.xtext.ui.tests.foo.File;
+import org.eclipse.xtext.ui.tests.parser.keywords.KeywordsUiTestLanguageStandaloneSetup;
+import org.eclipse.xtext.ui.tests.ui.TestLanguageUiModule;
+import org.eclipse.xtext.util.Modules2;
+
+import com.google.inject.Binder;
+import com.google.inject.Guice;
+import com.google.inject.Injector;
+import com.google.inject.name.Names;
+
+/**
+ * @author Christoph Kulla - Initial contribution and API
+ */
+public class HtmlEObjectDocumentationProviderDecoratorTest extends AbstractXtextTests {
+
+	public ISetup getTestLanguageSetup(final IEObjectDocumentationProvider ieObjectDocumentationProvider) {
+		return new KeywordsUiTestLanguageStandaloneSetup() {
+			@Override
+			public Injector createInjector() {
+				return Guice.createInjector(Modules2.mixin(
+						new TestLanguageRuntimeModule(),
+						new TestLanguageUiModule(Activator.getInstance()) {
+							@Override
+							public void configureDefaultHtmlEObjectDocumentationProvider(Binder binder) {
+								binder.bind(IEObjectDocumentationProvider.class).annotatedWith
+								(Names.named(HtmlEObjectDocumentationProviderDecorator.DELEGATE))
+								.toInstance(ieObjectDocumentationProvider);		
+							}							
+						},
+						new SharedStateModule()));
+			}
+		};
+	}
+	
+	public void testElementHasNoDocumentation () throws Exception {
+		with(getTestLanguageSetup(new IEObjectDocumentationProvider() {			
+			public String getDocumentation(EObject o) {
+				return null;
+			}
+		}));
+		File f = (File) getModel ("stuff test");
+		HtmlEObjectDocumentationProviderDecorator cut = get(HtmlEObjectDocumentationProviderDecorator.class);
+		assertEquals ("Stuff <b>test</b>", cut.getDocumentation(f.getStuff().get(0)));
+	}
+	
+	public void testElementHasDocumentation () throws Exception {
+		with(getTestLanguageSetup(new IEObjectDocumentationProvider() {			
+			public String getDocumentation(EObject o) {
+				return "Test";
+			}
+		}));
+		File f = (File) getModel ("stuff test");
+		HtmlEObjectDocumentationProviderDecorator cut = get(HtmlEObjectDocumentationProviderDecorator.class);
+		assertEquals ("Stuff <b>test</b><p>Test</p>", cut.getDocumentation(f.getStuff().get(0)));
+	}
+	
+}
diff --git a/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/html/XtextElementLinksTest.java b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/html/XtextElementLinksTest.java
new file mode 100644
index 0000000..1bb382f
--- /dev/null
+++ b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/html/XtextElementLinksTest.java
@@ -0,0 +1,118 @@
+/*******************************************************************************
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ * Contributors:
+ *  Christoph Kulla - Initial API and implementation
+ *******************************************************************************/
+package org.eclipse.xtext.ui.tests.editor.hover.html;
+
+import java.net.URISyntaxException;
+import java.util.regex.Matcher;
+import java.util.regex.Pattern;
+
+import org.eclipse.core.resources.IFile;
+import org.eclipse.emf.common.util.URI;
+import org.eclipse.emf.ecore.EObject;
+import org.eclipse.emf.ecore.resource.ResourceSet;
+import org.eclipse.xtext.resource.XtextResource;
+import org.eclipse.xtext.ui.editor.XtextEditor;
+import org.eclipse.xtext.ui.editor.hover.html.XtextElementLinks;
+import org.eclipse.xtext.ui.editor.model.IXtextDocument;
+import org.eclipse.xtext.ui.junit.util.IResourcesSetupUtil;
+import org.eclipse.xtext.ui.tests.Activator;
+import org.eclipse.xtext.ui.tests.editor.AbstractEditorTest;
+import org.eclipse.xtext.ui.tests.foo.File;
+import org.eclipse.xtext.util.concurrent.IUnitOfWork;
+
+/**
+ * @author Christoph Kulla - Initial contribution and API
+ */
+public class XtextElementLinksTest extends AbstractEditorTest {
+	
+	protected XtextEditor editor;
+	
+	protected IXtextDocument document;
+
+	protected String modelAsText;
+
+	private XtextElementLinks elementLinks;
+
+	private File f;
+	
+	@Override
+	protected void setUp() throws Exception {
+		super.setUp();
+		modelAsText = "stuff mystuff\nstuff yourstuff";
+		IFile file = IResourcesSetupUtil.createFile("test/test.testlanguage", modelAsText);
+		editor = openEditor(file);
+		document = editor.getDocument();
+		elementLinks = Activator.getInstance().getInjector(getEditorId()).getInstance (XtextElementLinks.class);
+		f = document.readOnly(new IUnitOfWork<File, XtextResource>() {
+			public File exec(XtextResource state) throws Exception {
+				return (File) state.getContents().get(0);
+			}	
+		});	
+	}
+	
+	@Override
+	protected void tearDown() throws Exception {
+		super.tearDown();
+		editor.close(false);
+	}
+	
+	public void testDefaultScheme () throws Exception {
+		String link = elementLinks.createLink (f.getStuff().get(0));
+		assertTrue (isLinkOfType (link, XtextElementLinks.XTEXTDOC_SCHEME));
+		assertEquals (f.getStuff().get(0), getEObject(link));
+	}
+	
+	public void testXTEXTDOC_SCHEME () throws Exception {
+		String link = elementLinks.createLink (XtextElementLinks.XTEXTDOC_SCHEME, f.getStuff().get(0));
+		assertTrue (isLinkOfType (link, XtextElementLinks.XTEXTDOC_SCHEME));
+		assertEquals (f.getStuff().get(0), getEObject(link));
+	}
+	
+	public void testOPEN_LINK_SCHEME () throws Exception {
+		String link = elementLinks.createLink (XtextElementLinks.OPEN_LINK_SCHEME, f.getStuff().get(0));
+		assertTrue (isLinkOfType (link, XtextElementLinks.OPEN_LINK_SCHEME));
+		assertEquals (f.getStuff().get(0), getEObject(link));
+	}
+	
+	public void testXTEXTDOC_VIEW_SCHEME () throws Exception {
+		String link = elementLinks.createLink (XtextElementLinks.XTEXTDOC_VIEW_SCHEME ,f.getStuff().get(0));
+		assertTrue (isLinkOfType (link, XtextElementLinks.XTEXTDOC_VIEW_SCHEME));
+		assertEquals (f.getStuff().get(0), getEObject(link));
+	}
+	
+	protected boolean isLinkOfType (String link, String type) {
+		return link.matches("<a.* href='" + type + ":.*'.*</a>");
+	}
+	
+	@Override
+	protected String getEditorId() {
+		return "org.eclipse.xtext.ui.tests.TestLanguage";
+	}
+	
+	protected String getLocation (String link) {
+		// parse the href=link
+		Pattern pattern = Pattern.compile("href='(.*)'");
+		Matcher matcher = pattern.matcher(link);
+		if (matcher.find()) {
+			return matcher.group(1);
+		}
+		return null;
+	}
+
+	protected EObject getEObject (String link) throws URISyntaxException {
+		URI uri = elementLinks.parseURI(new java.net.URI(getLocation(link)));
+		ResourceSet rs = document.readOnly(new IUnitOfWork<ResourceSet, XtextResource>() {
+			public ResourceSet exec(XtextResource state) throws Exception {
+				return state.getResourceSet();
+			}
+		});
+		return rs.getEObject(uri, true);	
+	}
+	
+}
diff --git a/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/html/XtextHtmlHoverTest.java b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/html/XtextHtmlHoverTest.java
new file mode 100644
index 0000000..ff7bb89
--- /dev/null
+++ b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/html/XtextHtmlHoverTest.java
@@ -0,0 +1,77 @@
+/*******************************************************************************
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ * Contributors:
+ *  Christoph Kulla - Initial API and implementation
+ *******************************************************************************/
+package org.eclipse.xtext.ui.tests.editor.hover.html;
+
+import org.eclipse.core.resources.IFile;
+import org.eclipse.jface.text.Region;
+import org.eclipse.ui.IWorkbenchPart;
+import org.eclipse.xtext.ui.editor.XtextEditor;
+import org.eclipse.xtext.ui.editor.hover.html.XtextBrowserInformationControlInput;
+import org.eclipse.xtext.ui.editor.hover.html.XtextHtmlHover;
+import org.eclipse.xtext.ui.editor.model.IXtextDocument;
+import org.eclipse.xtext.ui.junit.util.IResourcesSetupUtil;
+import org.eclipse.xtext.ui.tests.Activator;
+import org.eclipse.xtext.ui.tests.editor.AbstractEditorTest;
+
+/**
+ * @author Christoph Kulla - Initial contribution and API
+ */
+public class XtextHtmlHoverTest extends AbstractEditorTest {
+
+	protected XtextEditor editor;
+	
+	protected IXtextDocument document;
+
+	protected String modelAsText;
+	
+	private XtextHtmlHover hover;
+
+	@Override
+	protected void setUp() throws Exception {
+		super.setUp();
+		modelAsText = "stuff mystuff\nstuff yourstuff";
+		IFile file = IResourcesSetupUtil.createFile("test/test.testlanguage", modelAsText);
+		editor = openEditor(file);
+		document = editor.getDocument();
+		hover = Activator.getInstance().getInjector(getEditorId()).getInstance(XtextHtmlHover.class);
+		hover.setSourceViewer(editor.getInternalSourceViewer());
+	}
+
+	@Override
+	protected void tearDown() throws Exception {
+		super.tearDown();
+		editor.close(false);
+	}
+
+	@Override
+	protected String getEditorId() {
+		return "org.eclipse.xtext.ui.tests.TestLanguage";
+	}
+
+	@SuppressWarnings("deprecation")
+	public void testNoHover () {	
+		assertNull(hover.getHoverInfo(editor.getInternalSourceViewer(), new Region(0, 1)));
+		assertNull(hover.getHoverInfo2(editor.getInternalSourceViewer(), new Region(0, 1)));
+	}
+	
+	@SuppressWarnings("deprecation")
+	public void testHover () {	
+		assertNotNull(hover.getHoverInfo(editor.getInternalSourceViewer(), new Region(modelAsText.indexOf("mystuff"), 1)));
+		XtextBrowserInformationControlInput ici = (XtextBrowserInformationControlInput) hover.getHoverInfo2(editor.getInternalSourceViewer(), new Region(modelAsText.indexOf("mystuff"), 1));
+		assertNotNull(ici); 
+		assertNotNull (ici.getInputElement());
+		assertEquals ("mystuff", ici.getInputName());
+		assertEquals(1887, ici.getHtml().length());
+	}
+
+	protected void activate(IWorkbenchPart part) {
+		editor.getSite().getPage().activate(part);
+	}
+		
+}
diff --git a/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/hover/html/DelegatingtHtmlEObjectDocumentationProviderTest.java b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/hover/html/DelegatingtHtmlEObjectDocumentationProviderTest.java
deleted file mode 100644
index 97cd50d..0000000
--- a/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/hover/html/DelegatingtHtmlEObjectDocumentationProviderTest.java
+++ /dev/null
@@ -1,74 +0,0 @@
-/*******************************************************************************
- * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
- * All rights reserved. This program and the accompanying materials
- * are made available under the terms of the Eclipse Public License v1.0
- * which accompanies this distribution, and is available at
- * http://www.eclipse.org/legal/epl-v10.html
- *******************************************************************************/
-package org.eclipse.xtext.ui.tests.hover.html;
-
-import org.eclipse.emf.ecore.EObject;
-import org.eclipse.xtext.ISetup;
-import org.eclipse.xtext.documentation.IEObjectDocumentationProvider;
-import org.eclipse.xtext.junit.AbstractXtextTests;
-import org.eclipse.xtext.ui.editor.hover.html.DelegatingtHtmlEObjectDocumentationProvider;
-import org.eclipse.xtext.ui.shared.SharedStateModule;
-import org.eclipse.xtext.ui.tests.Activator;
-import org.eclipse.xtext.ui.tests.TestLanguageRuntimeModule;
-import org.eclipse.xtext.ui.tests.foo.File;
-import org.eclipse.xtext.ui.tests.parser.keywords.KeywordsUiTestLanguageStandaloneSetup;
-import org.eclipse.xtext.ui.tests.ui.TestLanguageUiModule;
-import org.eclipse.xtext.util.Modules2;
-
-import com.google.inject.Binder;
-import com.google.inject.Guice;
-import com.google.inject.Injector;
-import com.google.inject.name.Names;
-
-/**
- * @author Christoph Kulla - Initial contribution and API
- */
-public class DelegatingtHtmlEObjectDocumentationProviderTest extends AbstractXtextTests {
-
-	public ISetup getTestLanguageSetup(final IEObjectDocumentationProvider ieObjectDocumentationProvider) {
-		return new KeywordsUiTestLanguageStandaloneSetup() {
-			@Override
-			public Injector createInjector() {
-				return Guice.createInjector(Modules2.mixin(
-						new TestLanguageRuntimeModule(),
-						new TestLanguageUiModule(Activator.getInstance()) {
-							@Override
-							public void configureDefaultHtmlEObjectDocumentationProvider(Binder binder) {
-								binder.bind(IEObjectDocumentationProvider.class).annotatedWith
-								(Names.named(DelegatingtHtmlEObjectDocumentationProvider.DELEGATE))
-								.toInstance(ieObjectDocumentationProvider);		
-							}							
-						},
-						new SharedStateModule()));
-			}
-		};
-	}
-	
-	public void testElementHasNoDocumentation () throws Exception {
-		with(getTestLanguageSetup(new IEObjectDocumentationProvider() {			
-			public String getDocumentation(EObject o) {
-				return null;
-			}
-		}));
-		File f = (File) getModel ("stuff test");
-		DelegatingtHtmlEObjectDocumentationProvider cut = get(DelegatingtHtmlEObjectDocumentationProvider.class);
-		assertEquals ("Stuff <b>test</b>", cut.getDocumentation(f.getStuff().get(0)));
-	}
-	
-	public void testElementHasDocumentation () throws Exception {
-		with(getTestLanguageSetup(new IEObjectDocumentationProvider() {			
-			public String getDocumentation(EObject o) {
-				return "Test";
-			}
-		}));
-		File f = (File) getModel ("stuff test");
-		DelegatingtHtmlEObjectDocumentationProvider cut = get(DelegatingtHtmlEObjectDocumentationProvider.class);
-		assertEquals ("Stuff <b>test</b><p>Test</p>", cut.getDocumentation(f.getStuff().get(0)));
-	}
-	
-}
-- 
1.6.6


From 82081035503b25e663cdf4ad01d34af514d4e5de Mon Sep 17 00:00:00 2001
From: Christoph Kulla <christophkulla@googlemail.com>
Date: Sat, 20 Nov 2010 17:11:01 +0100
Subject: [PATCH 27/28] Updated copyright header.

---
 .../xtext/common/types/xtext/ui/JdtHover.java      |    5 +++--
 .../ui/editor/hover/AbstractEObjectHover.java      |    4 +++-
 .../ui/editor/hover/AbstractProblemHover.java      |    4 +++-
 .../hover/AnnotationWithQuickFixesHover.java       |    4 +++-
 .../xtext/ui/editor/hover/CompositeHover.java      |    4 +++-
 .../ui/editor/hover/DefaultCompositeHover.java     |    4 +++-
 .../xtext/ui/editor/hover/ProblemHover.java        |    1 +
 .../HtmlEObjectDocumentationProviderDecorator.java |    4 +++-
 .../ui/editor/hover/html/OpenBrowserUtil.java      |    4 +++-
 .../html/XtextBrowserInformationControlInput.java  |    4 +++-
 .../ui/editor/hover/html/XtextElementLinks.java    |    4 +++-
 .../xtext/ui/editor/hover/html/XtextHtmlHover.java |    4 +++-
 .../IEObjectDocumentationProvider.java             |    4 +++-
 .../DeclarativeEObjectDocumentationProvider.java   |    4 +++-
 .../impl/MutiLineCommentDocumentationProvider.java |    4 +++-
 ...eclarativeEObjectDocumentationProviderTest.java |    4 +++-
 .../MultiLineCommentDocumentationProviderTest.java |    4 +++-
 .../editor/hover/AbstractEObjectHoverTest.java     |    4 +++-
 .../editor/hover/AbstractProblemHoverTest.java     |    4 +++-
 .../hover/AnnotationWithQuickFixesHoverTest.java   |    4 +++-
 .../ui/tests/editor/hover/CompositeHoverTest.java  |    4 +++-
 .../ui/tests/editor/hover/ProblemHoverTest.java    |    4 +++-
 ...lEObjectDocumentationProviderDecoratorTest.java |    4 +++-
 .../editor/hover/html/XtextElementLinksTest.java   |    4 +++-
 .../editor/hover/html/XtextHtmlHoverTest.java      |    4 +++-
 25 files changed, 73 insertions(+), 25 deletions(-)

diff --git a/plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JdtHover.java b/plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JdtHover.java
index 62bd853..9644783 100644
--- a/plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JdtHover.java
+++ b/plugins/org.eclipse.xtext.common.types.ui/src/org/eclipse/xtext/common/types/xtext/ui/JdtHover.java
@@ -1,11 +1,12 @@
 /*******************************************************************************
- * Copyright (c) 2010 itemis AG (http://www.itemis.eu) and others.
+ * Copyright (c) 2010 Christoph Kulla
  * All rights reserved. This program and the accompanying materials
  * are made available under the terms of the Eclipse Public License v1.0
  * which accompanies this distribution, and is available at
  * http://www.eclipse.org/legal/epl-v10.html
+ * 
  * Contributors:
- *  Christoph Kulla - Initial API and implementation
+ *   Christoph Kulla - Initial API and implementation
  *******************************************************************************/
 package org.eclipse.xtext.common.types.xtext.ui;
 
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractEObjectHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractEObjectHover.java
index 368d62f..5393895 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractEObjectHover.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractEObjectHover.java
@@ -1,10 +1,12 @@
 /*******************************************************************************
+ * Copyright (c) 2010 Christoph Kulla
  * All rights reserved. This program and the accompanying materials
  * are made available under the terms of the Eclipse Public License v1.0
  * which accompanies this distribution, and is available at
  * http://www.eclipse.org/legal/epl-v10.html
+ * 
  * Contributors:
- *  Christoph Kulla - Initial API and implementation
+ *   Christoph Kulla - Initial API and implementation
  *******************************************************************************/
 package org.eclipse.xtext.ui.editor.hover;
 
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractProblemHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractProblemHover.java
index 4ab43c7..1196d5d 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractProblemHover.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractProblemHover.java
@@ -1,10 +1,12 @@
 /*******************************************************************************
+ * Copyright (c) 2010 Christoph Kulla
  * All rights reserved. This program and the accompanying materials
  * are made available under the terms of the Eclipse Public License v1.0
  * which accompanies this distribution, and is available at
  * http://www.eclipse.org/legal/epl-v10.html
+ * 
  * Contributors:
- *  Christoph Kulla - Initial API and implementation
+ *   Christoph Kulla - Initial API and implementation
  *******************************************************************************/
 package org.eclipse.xtext.ui.editor.hover;
 
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AnnotationWithQuickFixesHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AnnotationWithQuickFixesHover.java
index 51a5212..c13591c 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AnnotationWithQuickFixesHover.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AnnotationWithQuickFixesHover.java
@@ -1,10 +1,12 @@
 /*******************************************************************************
+ * Copyright (c) 2010 Christoph Kulla
  * All rights reserved. This program and the accompanying materials
  * are made available under the terms of the Eclipse Public License v1.0
  * which accompanies this distribution, and is available at
  * http://www.eclipse.org/legal/epl-v10.html
+ * 
  * Contributors:
- *  Christoph Kulla - Initial API and implementation
+ *   Christoph Kulla - Initial API and implementation
  *******************************************************************************/
 package org.eclipse.xtext.ui.editor.hover;
 
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/CompositeHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/CompositeHover.java
index 9f3bfe1..3957335 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/CompositeHover.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/CompositeHover.java
@@ -1,10 +1,12 @@
 /*******************************************************************************
+ * Copyright (c) 2010 Christoph Kulla
  * All rights reserved. This program and the accompanying materials
  * are made available under the terms of the Eclipse Public License v1.0
  * which accompanies this distribution, and is available at
  * http://www.eclipse.org/legal/epl-v10.html
+ * 
  * Contributors:
- *  Christoph Kulla - Initial API and implementation
+ *   Christoph Kulla - Initial API and implementation
  *******************************************************************************/
 package org.eclipse.xtext.ui.editor.hover;
 
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DefaultCompositeHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DefaultCompositeHover.java
index a95db4f..8c831e4 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DefaultCompositeHover.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DefaultCompositeHover.java
@@ -1,10 +1,12 @@
 /*******************************************************************************
+ * Copyright (c) 2010 Christoph Kulla
  * All rights reserved. This program and the accompanying materials
  * are made available under the terms of the Eclipse Public License v1.0
  * which accompanies this distribution, and is available at
  * http://www.eclipse.org/legal/epl-v10.html
+ * 
  * Contributors:
- *  Christoph Kulla - Initial API and implementation
+ *   Christoph Kulla - Initial API and implementation
  *******************************************************************************/
 package org.eclipse.xtext.ui.editor.hover;
 
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/ProblemHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/ProblemHover.java
index 8a05f71..64e47e3 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/ProblemHover.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/ProblemHover.java
@@ -27,6 +27,7 @@ import com.google.common.collect.Sets;
 
 /**
  * @author Sven Efftinge - Initial contribution and API
+ * @author Christoph Kulla - Adaptation to AbstractProblemHover
  */
 public class ProblemHover extends AbstractProblemHover implements IAnnotationHover {
 	
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/HtmlEObjectDocumentationProviderDecorator.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/HtmlEObjectDocumentationProviderDecorator.java
index 40795de..530f3a9 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/HtmlEObjectDocumentationProviderDecorator.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/HtmlEObjectDocumentationProviderDecorator.java
@@ -1,10 +1,12 @@
 /*******************************************************************************
+ * Copyright (c) 2010 Christoph Kulla
  * All rights reserved. This program and the accompanying materials
  * are made available under the terms of the Eclipse Public License v1.0
  * which accompanies this distribution, and is available at
  * http://www.eclipse.org/legal/epl-v10.html
+ * 
  * Contributors:
- *  Christoph Kulla - Initial API and implementation
+ *   Christoph Kulla - Initial API and implementation
  *******************************************************************************/
 package org.eclipse.xtext.ui.editor.hover.html;
 
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/OpenBrowserUtil.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/OpenBrowserUtil.java
index 6e6a17a..881c8c2 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/OpenBrowserUtil.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/OpenBrowserUtil.java
@@ -1,10 +1,12 @@
 /*******************************************************************************
+ * Copyright (c) 2010 Christoph Kulla
  * All rights reserved. This program and the accompanying materials
  * are made available under the terms of the Eclipse Public License v1.0
  * which accompanies this distribution, and is available at
  * http://www.eclipse.org/legal/epl-v10.html
+ * 
  * Contributors:
- *  Christoph Kulla - Initial API and implementation
+ *   Christoph Kulla - Initial API and implementation
  *******************************************************************************/
 package org.eclipse.xtext.ui.editor.hover.html;
 
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextBrowserInformationControlInput.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextBrowserInformationControlInput.java
index 6bd88ab..d949a0a 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextBrowserInformationControlInput.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextBrowserInformationControlInput.java
@@ -1,10 +1,12 @@
 /*******************************************************************************
+ * Copyright (c) 2010 Christoph Kulla
  * All rights reserved. This program and the accompanying materials
  * are made available under the terms of the Eclipse Public License v1.0
  * which accompanies this distribution, and is available at
  * http://www.eclipse.org/legal/epl-v10.html
+ * 
  * Contributors:
- *  Christoph Kulla - Initial API and implementation
+ *   Christoph Kulla - Initial API and implementation
  *******************************************************************************/
 package org.eclipse.xtext.ui.editor.hover.html;
 
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextElementLinks.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextElementLinks.java
index 47610bf..d4169d7 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextElementLinks.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextElementLinks.java
@@ -1,10 +1,12 @@
 /*******************************************************************************
+ * Copyright (c) 2010 Christoph Kulla
  * All rights reserved. This program and the accompanying materials
  * are made available under the terms of the Eclipse Public License v1.0
  * which accompanies this distribution, and is available at
  * http://www.eclipse.org/legal/epl-v10.html
+ * 
  * Contributors:
- *  Christoph Kulla - Initial API and implementation
+ *   Christoph Kulla - Initial API and implementation
  *******************************************************************************/
 package org.eclipse.xtext.ui.editor.hover.html;
 
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextHtmlHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextHtmlHover.java
index 7acb09a..16f6ead 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextHtmlHover.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/html/XtextHtmlHover.java
@@ -1,10 +1,12 @@
 /*******************************************************************************
+ * Copyright (c) 2010 Christoph Kulla
  * All rights reserved. This program and the accompanying materials
  * are made available under the terms of the Eclipse Public License v1.0
  * which accompanies this distribution, and is available at
  * http://www.eclipse.org/legal/epl-v10.html
+ * 
  * Contributors:
- *  Christoph Kulla - Initial API and implementation
+ *   Christoph Kulla - Initial API and implementation
  *******************************************************************************/
 package org.eclipse.xtext.ui.editor.hover.html;
 
diff --git a/plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/IEObjectDocumentationProvider.java b/plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/IEObjectDocumentationProvider.java
index 07e7e05..b12fed4 100644
--- a/plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/IEObjectDocumentationProvider.java
+++ b/plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/IEObjectDocumentationProvider.java
@@ -1,10 +1,12 @@
 /*******************************************************************************
+ * Copyright (c) 2010 Christoph Kulla
  * All rights reserved. This program and the accompanying materials
  * are made available under the terms of the Eclipse Public License v1.0
  * which accompanies this distribution, and is available at
  * http://www.eclipse.org/legal/epl-v10.html
+ * 
  * Contributors:
- *  Christoph Kulla - Initial API and implementation
+ *   Christoph Kulla - Initial API and implementation
  *******************************************************************************/
 package org.eclipse.xtext.documentation;
 
diff --git a/plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/impl/DeclarativeEObjectDocumentationProvider.java b/plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/impl/DeclarativeEObjectDocumentationProvider.java
index 6c1f6c9..955866c 100644
--- a/plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/impl/DeclarativeEObjectDocumentationProvider.java
+++ b/plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/impl/DeclarativeEObjectDocumentationProvider.java
@@ -1,10 +1,12 @@
 /*******************************************************************************
+ * Copyright (c) 2010 Christoph Kulla
  * All rights reserved. This program and the accompanying materials
  * are made available under the terms of the Eclipse Public License v1.0
  * which accompanies this distribution, and is available at
  * http://www.eclipse.org/legal/epl-v10.html
+ * 
  * Contributors:
- *  Christoph Kulla - Initial API and implementation
+ *   Christoph Kulla - Initial API and implementation
  *******************************************************************************/
 package org.eclipse.xtext.documentation.impl;
 
diff --git a/plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/impl/MutiLineCommentDocumentationProvider.java b/plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/impl/MutiLineCommentDocumentationProvider.java
index 0aa6332..d74089f 100644
--- a/plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/impl/MutiLineCommentDocumentationProvider.java
+++ b/plugins/org.eclipse.xtext/src/org/eclipse/xtext/documentation/impl/MutiLineCommentDocumentationProvider.java
@@ -1,10 +1,12 @@
 /*******************************************************************************
+ * Copyright (c) 2010 Christoph Kulla
  * All rights reserved. This program and the accompanying materials
  * are made available under the terms of the Eclipse Public License v1.0
  * which accompanies this distribution, and is available at
  * http://www.eclipse.org/legal/epl-v10.html
+ * 
  * Contributors:
- *  Christoph Kulla - Initial API and implementation
+ *   Christoph Kulla - Initial API and implementation
  *******************************************************************************/
 package org.eclipse.xtext.documentation.impl;
 
diff --git a/tests/org.eclipse.xtext.tests/src/org/eclipse/xtext/documentation/impl/DeclarativeEObjectDocumentationProviderTest.java b/tests/org.eclipse.xtext.tests/src/org/eclipse/xtext/documentation/impl/DeclarativeEObjectDocumentationProviderTest.java
index 4159276..bae1c68 100644
--- a/tests/org.eclipse.xtext.tests/src/org/eclipse/xtext/documentation/impl/DeclarativeEObjectDocumentationProviderTest.java
+++ b/tests/org.eclipse.xtext.tests/src/org/eclipse/xtext/documentation/impl/DeclarativeEObjectDocumentationProviderTest.java
@@ -1,10 +1,12 @@
 /*******************************************************************************
+ * Copyright (c) 2010 Christoph Kulla
  * All rights reserved. This program and the accompanying materials
  * are made available under the terms of the Eclipse Public License v1.0
  * which accompanies this distribution, and is available at
  * http://www.eclipse.org/legal/epl-v10.html
+ * 
  * Contributors:
- *  Christoph Kulla - Initial API and implementation
+ *   Christoph Kulla - Initial API and implementation
  *******************************************************************************/
 package org.eclipse.xtext.documentation.impl;
 
diff --git a/tests/org.eclipse.xtext.tests/src/org/eclipse/xtext/documentation/impl/MultiLineCommentDocumentationProviderTest.java b/tests/org.eclipse.xtext.tests/src/org/eclipse/xtext/documentation/impl/MultiLineCommentDocumentationProviderTest.java
index 3cf7cb5..35cd30f 100644
--- a/tests/org.eclipse.xtext.tests/src/org/eclipse/xtext/documentation/impl/MultiLineCommentDocumentationProviderTest.java
+++ b/tests/org.eclipse.xtext.tests/src/org/eclipse/xtext/documentation/impl/MultiLineCommentDocumentationProviderTest.java
@@ -1,10 +1,12 @@
 /*******************************************************************************
+ * Copyright (c) 2010 Christoph Kulla
  * All rights reserved. This program and the accompanying materials
  * are made available under the terms of the Eclipse Public License v1.0
  * which accompanies this distribution, and is available at
  * http://www.eclipse.org/legal/epl-v10.html
+ * 
  * Contributors:
- *  Christoph Kulla - Initial API and implementation
+ *   Christoph Kulla - Initial API and implementation
  *******************************************************************************/
 package org.eclipse.xtext.documentation.impl;
 
diff --git a/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/AbstractEObjectHoverTest.java b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/AbstractEObjectHoverTest.java
index 538e37b..971e414 100644
--- a/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/AbstractEObjectHoverTest.java
+++ b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/AbstractEObjectHoverTest.java
@@ -1,10 +1,12 @@
 /*******************************************************************************
+ * Copyright (c) 2010 Christoph Kulla
  * All rights reserved. This program and the accompanying materials
  * are made available under the terms of the Eclipse Public License v1.0
  * which accompanies this distribution, and is available at
  * http://www.eclipse.org/legal/epl-v10.html
+ * 
  * Contributors:
- *  Christoph Kulla - Initial API and implementation
+ *   Christoph Kulla - Initial API and implementation
  *******************************************************************************/
 package org.eclipse.xtext.ui.tests.editor.hover;
 
diff --git a/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/AbstractProblemHoverTest.java b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/AbstractProblemHoverTest.java
index 2bdcbe3..302312a 100644
--- a/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/AbstractProblemHoverTest.java
+++ b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/AbstractProblemHoverTest.java
@@ -1,10 +1,12 @@
 /*******************************************************************************
+ * Copyright (c) 2010 Christoph Kulla
  * All rights reserved. This program and the accompanying materials
  * are made available under the terms of the Eclipse Public License v1.0
  * which accompanies this distribution, and is available at
  * http://www.eclipse.org/legal/epl-v10.html
+ * 
  * Contributors:
- *  Christoph Kulla - Initial API and implementation
+ *   Christoph Kulla - Initial API and implementation
  *******************************************************************************/
 package org.eclipse.xtext.ui.tests.editor.hover;
 
diff --git a/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/AnnotationWithQuickFixesHoverTest.java b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/AnnotationWithQuickFixesHoverTest.java
index 6a52c8a..6d285d6 100644
--- a/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/AnnotationWithQuickFixesHoverTest.java
+++ b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/AnnotationWithQuickFixesHoverTest.java
@@ -1,10 +1,12 @@
 /*******************************************************************************
+ * Copyright (c) 2010 Christoph Kulla
  * All rights reserved. This program and the accompanying materials
  * are made available under the terms of the Eclipse Public License v1.0
  * which accompanies this distribution, and is available at
  * http://www.eclipse.org/legal/epl-v10.html
+ * 
  * Contributors:
- *  Christoph Kulla - Initial API and implementation
+ *   Christoph Kulla - Initial API and implementation
  *******************************************************************************/
 package org.eclipse.xtext.ui.tests.editor.hover;
 
diff --git a/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/CompositeHoverTest.java b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/CompositeHoverTest.java
index 7752aec..4c7623b 100644
--- a/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/CompositeHoverTest.java
+++ b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/CompositeHoverTest.java
@@ -1,10 +1,12 @@
 /*******************************************************************************
+ * Copyright (c) 2010 Christoph Kulla
  * All rights reserved. This program and the accompanying materials
  * are made available under the terms of the Eclipse Public License v1.0
  * which accompanies this distribution, and is available at
  * http://www.eclipse.org/legal/epl-v10.html
+ * 
  * Contributors:
- *  Christoph Kulla - Initial API and implementation
+ *   Christoph Kulla - Initial API and implementation
  *******************************************************************************/
 package org.eclipse.xtext.ui.tests.editor.hover;
 
diff --git a/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/ProblemHoverTest.java b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/ProblemHoverTest.java
index 9d39fa1..2002571 100644
--- a/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/ProblemHoverTest.java
+++ b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/ProblemHoverTest.java
@@ -1,10 +1,12 @@
 /*******************************************************************************
+ * Copyright (c) 2010 Christoph Kulla
  * All rights reserved. This program and the accompanying materials
  * are made available under the terms of the Eclipse Public License v1.0
  * which accompanies this distribution, and is available at
  * http://www.eclipse.org/legal/epl-v10.html
+ * 
  * Contributors:
- *  Christoph Kulla - Initial API and implementation
+ *   Christoph Kulla - Initial API and implementation
  *******************************************************************************/
 package org.eclipse.xtext.ui.tests.editor.hover;
 
diff --git a/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/html/HtmlEObjectDocumentationProviderDecoratorTest.java b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/html/HtmlEObjectDocumentationProviderDecoratorTest.java
index fec42bb..defb1c5 100644
--- a/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/html/HtmlEObjectDocumentationProviderDecoratorTest.java
+++ b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/html/HtmlEObjectDocumentationProviderDecoratorTest.java
@@ -1,10 +1,12 @@
 /*******************************************************************************
+ * Copyright (c) 2010 Christoph Kulla
  * All rights reserved. This program and the accompanying materials
  * are made available under the terms of the Eclipse Public License v1.0
  * which accompanies this distribution, and is available at
  * http://www.eclipse.org/legal/epl-v10.html
+ * 
  * Contributors:
- *  Christoph Kulla - Initial API and implementation
+ *   Christoph Kulla - Initial API and implementation
  *******************************************************************************/
 package org.eclipse.xtext.ui.tests.editor.hover.html;
 
diff --git a/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/html/XtextElementLinksTest.java b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/html/XtextElementLinksTest.java
index 1bb382f..69c0cd6 100644
--- a/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/html/XtextElementLinksTest.java
+++ b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/html/XtextElementLinksTest.java
@@ -1,10 +1,12 @@
 /*******************************************************************************
+ * Copyright (c) 2010 Christoph Kulla
  * All rights reserved. This program and the accompanying materials
  * are made available under the terms of the Eclipse Public License v1.0
  * which accompanies this distribution, and is available at
  * http://www.eclipse.org/legal/epl-v10.html
+ * 
  * Contributors:
- *  Christoph Kulla - Initial API and implementation
+ *   Christoph Kulla - Initial API and implementation
  *******************************************************************************/
 package org.eclipse.xtext.ui.tests.editor.hover.html;
 
diff --git a/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/html/XtextHtmlHoverTest.java b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/html/XtextHtmlHoverTest.java
index ff7bb89..5db4caf 100644
--- a/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/html/XtextHtmlHoverTest.java
+++ b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/html/XtextHtmlHoverTest.java
@@ -1,10 +1,12 @@
 /*******************************************************************************
+ * Copyright (c) 2010 Christoph Kulla
  * All rights reserved. This program and the accompanying materials
  * are made available under the terms of the Eclipse Public License v1.0
  * which accompanies this distribution, and is available at
  * http://www.eclipse.org/legal/epl-v10.html
+ * 
  * Contributors:
- *  Christoph Kulla - Initial API and implementation
+ *   Christoph Kulla - Initial API and implementation
  *******************************************************************************/
 package org.eclipse.xtext.ui.tests.editor.hover.html;
 
-- 
1.6.6


From be353f14ef1a0248f1adb117497ea647d269adf8 Mon Sep 17 00:00:00 2001
From: Christoph Kulla <christophkulla@googlemail.com>
Date: Sat, 20 Nov 2010 17:26:32 +0100
Subject: [PATCH 28/28] Renamed CompositeHover to AbstractCompositeHover as it is abstract.

---
 .../ui/editor/hover/AbstractCompositeHover.java    |  109 +++++++++++++
 .../xtext/ui/editor/hover/CompositeHover.java      |  109 -------------
 .../ui/editor/hover/DefaultCompositeHover.java     |    2 +-
 .../editor/hover/AbstractCompositeHoverTest.java   |  172 ++++++++++++++++++++
 .../ui/tests/editor/hover/CompositeHoverTest.java  |  172 --------------------
 5 files changed, 282 insertions(+), 282 deletions(-)
 create mode 100644 plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractCompositeHover.java
 delete mode 100644 plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/CompositeHover.java
 create mode 100644 tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/AbstractCompositeHoverTest.java
 delete mode 100644 tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/CompositeHoverTest.java

diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractCompositeHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractCompositeHover.java
new file mode 100644
index 0000000..13d766b
--- /dev/null
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/AbstractCompositeHover.java
@@ -0,0 +1,109 @@
+/*******************************************************************************
+ * Copyright (c) 2010 Christoph Kulla
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ * 
+ * Contributors:
+ *   Christoph Kulla - Initial API and implementation
+ *******************************************************************************/
+package org.eclipse.xtext.ui.editor.hover;
+
+import java.util.List;
+
+import org.eclipse.jface.text.IInformationControlCreator;
+import org.eclipse.jface.text.IRegion;
+import org.eclipse.jface.text.ITextHover;
+import org.eclipse.jface.text.ITextHoverExtension;
+import org.eclipse.jface.text.ITextHoverExtension2;
+import org.eclipse.jface.text.ITextViewer;
+import org.eclipse.jface.text.source.ISourceViewer;
+import org.eclipse.xtext.ui.editor.ISourceViewerAware;
+
+/**
+ * The CompositeHover is a hover which delegates calls to a list of hovers. It iterates through this list of hovers and
+ * chooses the first one which provides a region in getHoverRegion(). Override the method createHovers() to configure
+ * the list of hovers.
+ * 
+ * @author Christoph Kulla - Initial contribution and API
+ */
+public abstract class AbstractCompositeHover implements ITextHover, ITextHoverExtension, ITextHoverExtension2,
+		ISourceViewerAware {
+
+	private List<ITextHover> hovers;
+	private ITextHover currentHover;
+
+	public AbstractCompositeHover() {
+		super();
+	}
+
+	public List<ITextHover> getHovers() {
+		if (hovers == null)
+			hovers = createHovers();
+		return hovers;
+	}
+
+	abstract protected List<ITextHover> createHovers();
+
+	public void setSourceViewer(ISourceViewer sourceViewer) {
+		if (getHovers() != null) {
+			for (ITextHover hover : getHovers()) {
+				if (hover instanceof ISourceViewerAware)
+					((ISourceViewerAware) hover).setSourceViewer(sourceViewer);
+			}
+		}
+	}
+
+	@SuppressWarnings("deprecation")
+	public IRegion getHoverRegion(ITextViewer textViewer, int offset) {
+		if (getHovers() != null) {
+			for (ITextHover hover : getHovers()) {
+				IRegion region = hover.getHoverRegion(textViewer, offset);
+				if (region != null) {
+
+					Object hoverInfo = null;
+					if (hover instanceof ITextHoverExtension2)
+						hoverInfo = ((ITextHoverExtension2) hover).getHoverInfo2(textViewer, region);
+					else {
+						hoverInfo = hover.getHoverInfo(textViewer, region);
+					}
+					if (hoverInfo != null && !(hoverInfo instanceof String && ((String) hoverInfo).length() == 0)) {
+						currentHover = hover;
+						return region;
+					}
+				}
+			}
+		}
+		currentHover = null;
+		return null;
+	}
+
+	@Deprecated
+	public String getHoverInfo(ITextViewer textViewer, IRegion hoverRegion) {
+		// should never be called
+		if (currentHover != null) {
+			return currentHover.getHoverInfo(textViewer, hoverRegion);
+		}
+		return null;
+	}
+
+	@SuppressWarnings("deprecation")
+	public Object getHoverInfo2(ITextViewer textViewer, IRegion hoverRegion) {
+		if (currentHover != null) {
+			if (currentHover instanceof ITextHoverExtension2)
+				return ((ITextHoverExtension2) currentHover).getHoverInfo2(textViewer, hoverRegion);
+			else {
+				return currentHover.getHoverInfo(textViewer, hoverRegion);
+			}
+		}
+		return null;
+	}
+
+	public IInformationControlCreator getHoverControlCreator() {
+		if (currentHover instanceof ITextHoverExtension)
+			return ((ITextHoverExtension) currentHover).getHoverControlCreator();
+		return null;
+	}
+
+}
\ No newline at end of file
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/CompositeHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/CompositeHover.java
deleted file mode 100644
index 3957335..0000000
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/CompositeHover.java
+++ /dev/null
@@ -1,109 +0,0 @@
-/*******************************************************************************
- * Copyright (c) 2010 Christoph Kulla
- * All rights reserved. This program and the accompanying materials
- * are made available under the terms of the Eclipse Public License v1.0
- * which accompanies this distribution, and is available at
- * http://www.eclipse.org/legal/epl-v10.html
- * 
- * Contributors:
- *   Christoph Kulla - Initial API and implementation
- *******************************************************************************/
-package org.eclipse.xtext.ui.editor.hover;
-
-import java.util.List;
-
-import org.eclipse.jface.text.IInformationControlCreator;
-import org.eclipse.jface.text.IRegion;
-import org.eclipse.jface.text.ITextHover;
-import org.eclipse.jface.text.ITextHoverExtension;
-import org.eclipse.jface.text.ITextHoverExtension2;
-import org.eclipse.jface.text.ITextViewer;
-import org.eclipse.jface.text.source.ISourceViewer;
-import org.eclipse.xtext.ui.editor.ISourceViewerAware;
-
-/**
- * The CompositeHover is a hover which delegates calls to a list of hovers. It iterates through this list of hovers and
- * chooses the first one which provides a region in getHoverRegion(). Override the method createHovers() to configure
- * the list of hovers.
- * 
- * @author Christoph Kulla - Initial contribution and API
- */
-public abstract class CompositeHover implements ITextHover, ITextHoverExtension, ITextHoverExtension2,
-		ISourceViewerAware {
-
-	private List<ITextHover> hovers;
-	private ITextHover currentHover;
-
-	public CompositeHover() {
-		super();
-	}
-
-	public List<ITextHover> getHovers() {
-		if (hovers == null)
-			hovers = createHovers();
-		return hovers;
-	}
-
-	abstract protected List<ITextHover> createHovers();
-
-	public void setSourceViewer(ISourceViewer sourceViewer) {
-		if (getHovers() != null) {
-			for (ITextHover hover : getHovers()) {
-				if (hover instanceof ISourceViewerAware)
-					((ISourceViewerAware) hover).setSourceViewer(sourceViewer);
-			}
-		}
-	}
-
-	@SuppressWarnings("deprecation")
-	public IRegion getHoverRegion(ITextViewer textViewer, int offset) {
-		if (getHovers() != null) {
-			for (ITextHover hover : getHovers()) {
-				IRegion region = hover.getHoverRegion(textViewer, offset);
-				if (region != null) {
-
-					Object hoverInfo = null;
-					if (hover instanceof ITextHoverExtension2)
-						hoverInfo = ((ITextHoverExtension2) hover).getHoverInfo2(textViewer, region);
-					else {
-						hoverInfo = hover.getHoverInfo(textViewer, region);
-					}
-					if (hoverInfo != null && !(hoverInfo instanceof String && ((String) hoverInfo).length() == 0)) {
-						currentHover = hover;
-						return region;
-					}
-				}
-			}
-		}
-		currentHover = null;
-		return null;
-	}
-
-	@Deprecated
-	public String getHoverInfo(ITextViewer textViewer, IRegion hoverRegion) {
-		// should never be called
-		if (currentHover != null) {
-			return currentHover.getHoverInfo(textViewer, hoverRegion);
-		}
-		return null;
-	}
-
-	@SuppressWarnings("deprecation")
-	public Object getHoverInfo2(ITextViewer textViewer, IRegion hoverRegion) {
-		if (currentHover != null) {
-			if (currentHover instanceof ITextHoverExtension2)
-				return ((ITextHoverExtension2) currentHover).getHoverInfo2(textViewer, hoverRegion);
-			else {
-				return currentHover.getHoverInfo(textViewer, hoverRegion);
-			}
-		}
-		return null;
-	}
-
-	public IInformationControlCreator getHoverControlCreator() {
-		if (currentHover instanceof ITextHoverExtension)
-			return ((ITextHoverExtension) currentHover).getHoverControlCreator();
-		return null;
-	}
-
-}
\ No newline at end of file
diff --git a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DefaultCompositeHover.java b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DefaultCompositeHover.java
index 8c831e4..e4b0cc6 100644
--- a/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DefaultCompositeHover.java
+++ b/plugins/org.eclipse.xtext.ui/src/org/eclipse/xtext/ui/editor/hover/DefaultCompositeHover.java
@@ -23,7 +23,7 @@ import com.google.inject.Inject;
  * 
  * @author Christoph Kulla - Initial contribution and API
  */
-public class DefaultCompositeHover extends CompositeHover  {
+public class DefaultCompositeHover extends AbstractCompositeHover  {
 
 	@Inject 
 	protected AnnotationWithQuickFixesHover annotationHover;
diff --git a/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/AbstractCompositeHoverTest.java b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/AbstractCompositeHoverTest.java
new file mode 100644
index 0000000..24a4d5f
--- /dev/null
+++ b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/AbstractCompositeHoverTest.java
@@ -0,0 +1,172 @@
+/*******************************************************************************
+ * Copyright (c) 2010 Christoph Kulla
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ * 
+ * Contributors:
+ *   Christoph Kulla - Initial API and implementation
+ *******************************************************************************/
+package org.eclipse.xtext.ui.tests.editor.hover;
+
+import java.util.List;
+import org.eclipse.core.resources.IFile;
+import org.eclipse.jface.text.IRegion;
+import org.eclipse.jface.text.ITextHover;
+import org.eclipse.jface.text.ITextViewer;
+import org.eclipse.jface.text.Region;
+import org.eclipse.ui.IWorkbenchPart;
+import org.eclipse.xtext.ui.editor.XtextEditor;
+import org.eclipse.xtext.ui.editor.hover.AbstractCompositeHover;
+import org.eclipse.xtext.ui.editor.model.IXtextDocument;
+import org.eclipse.xtext.ui.junit.util.IResourcesSetupUtil;
+import org.eclipse.xtext.ui.tests.editor.AbstractEditorTest;
+import com.google.inject.internal.Lists;
+
+/**
+ * @author Christoph Kulla - Initial contribution and API
+ */
+public class AbstractCompositeHoverTest extends AbstractEditorTest {
+	
+	protected XtextEditor editor;
+	protected IXtextDocument document;
+
+	@Override
+	protected void setUp() throws Exception {
+		super.setUp();
+		String modelAsText = "// file content doesn't mater";
+		IFile file = IResourcesSetupUtil.createFile("test/test.testlanguage", modelAsText);
+		editor = openEditor(file);
+		document = editor.getDocument();
+	}
+
+	@Override
+	protected void tearDown() throws Exception {
+		super.tearDown();
+		editor.close(false);
+	}
+
+	@Override
+	protected String getEditorId() {
+		return "org.eclipse.xtext.ui.tests.TestLanguage";
+	}
+
+	@SuppressWarnings("deprecation")
+	public void testNullHoverList () {
+		AbstractCompositeHover hover = new AbstractCompositeHover() {
+
+			@Override
+			protected List<ITextHover> createHovers() {
+				return null;
+			}
+		};
+	
+		assertEquals (null, hover.getHovers());
+		assertNull (hover.getHoverRegion(editor.getInternalSourceViewer(), 0));
+		assertNull (hover.getHoverControlCreator());
+		assertNull (hover.getHoverInfo(editor.getInternalSourceViewer(), new Region(0,0)));
+		assertNull (hover.getHoverInfo2(editor.getInternalSourceViewer(), new Region(0,0)));
+	}
+	
+	@SuppressWarnings("deprecation")
+	public void testEmptyHoverList () {
+		AbstractCompositeHover hover = new AbstractCompositeHover() {
+
+			@Override
+			protected List<ITextHover> createHovers() {
+				List<ITextHover> hovers = Lists.newArrayList();
+				return hovers;
+			}
+		};
+	
+		assertEquals (0, hover.getHovers().size());
+		assertNull (hover.getHoverRegion(editor.getInternalSourceViewer(), 0));
+		assertNull (hover.getHoverControlCreator());
+		assertNull (hover.getHoverInfo(editor.getInternalSourceViewer(), new Region(0,0)));
+		assertNull (hover.getHoverInfo2(editor.getInternalSourceViewer(), new Region(0,0)));
+	}
+	
+	@SuppressWarnings("deprecation")
+	public void testSingleHover () {
+		AbstractCompositeHover hover = new AbstractCompositeHover() {
+
+			@Override
+			protected List<ITextHover> createHovers() {
+				List<ITextHover> hovers = Lists.newArrayList();
+				hovers.add (new ITextHover() {
+					
+					public IRegion getHoverRegion(ITextViewer textViewer, int offset) {
+						// TODO Auto-generated method stub
+						if (offset==0)
+							return new Region (offset, 0);
+						return null;
+					}
+					
+					public String getHoverInfo(ITextViewer textViewer, IRegion hoverRegion) {
+						return "test";
+					}
+				});
+				return hovers;
+			}
+		};
+	
+		assertEquals (1, hover.getHovers().size());
+		assertNotNull (hover.getHoverRegion(editor.getInternalSourceViewer(), 0));
+		assertEquals ("test", hover.getHoverInfo(editor.getInternalSourceViewer(), new Region(0,0)));
+		assertNull (hover.getHoverRegion(editor.getInternalSourceViewer(), 5));
+		assertNull (hover.getHoverInfo(editor.getInternalSourceViewer(), new Region(0,0)));
+	}
+	
+	@SuppressWarnings("deprecation")
+	public void testMultipleHovers () {
+		final ITextHover hover1 = new ITextHover() {
+			
+			public IRegion getHoverRegion(ITextViewer textViewer, int offset) {
+				// TODO Auto-generated method stub
+				if (offset==0)
+					return new Region (offset, 0);
+				return null;
+			}
+			
+			public String getHoverInfo(ITextViewer textViewer, IRegion hoverRegion) {
+				return "hover1";
+			}
+		};
+		final ITextHover hover2 = new ITextHover() {
+			
+			public IRegion getHoverRegion(ITextViewer textViewer, int offset) {
+				// TODO Auto-generated method stub
+				if (offset==1)
+					return new Region (offset, 0);
+				return null;
+			}
+			
+			public String getHoverInfo(ITextViewer textViewer, IRegion hoverRegion) {
+				return "hover2";
+			}
+		};
+			
+		AbstractCompositeHover hover = new AbstractCompositeHover() {
+			@Override
+			protected List<ITextHover> createHovers() {
+				List<ITextHover> hovers = Lists.newArrayList();
+				hovers.add (hover1);
+				hovers.add (hover2);
+				return hovers;
+			}
+		};
+	
+		assertEquals (2, hover.getHovers().size());
+		assertNotNull (hover.getHoverRegion(editor.getInternalSourceViewer(), 0));
+		assertEquals ("hover1", hover.getHoverInfo(editor.getInternalSourceViewer(), new Region(0,0)));
+		assertNotNull (hover.getHoverRegion(editor.getInternalSourceViewer(), 1));
+		assertEquals ("hover2", hover.getHoverInfo(editor.getInternalSourceViewer(), new Region(1,0)));
+	}
+	
+	protected void activate(IWorkbenchPart part) {
+		editor.getSite().getPage().activate(part);
+	}
+
+
+}
diff --git a/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/CompositeHoverTest.java b/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/CompositeHoverTest.java
deleted file mode 100644
index 4c7623b..0000000
--- a/tests/org.eclipse.xtext.ui.tests/tests/org/eclipse/xtext/ui/tests/editor/hover/CompositeHoverTest.java
+++ /dev/null
@@ -1,172 +0,0 @@
-/*******************************************************************************
- * Copyright (c) 2010 Christoph Kulla
- * All rights reserved. This program and the accompanying materials
- * are made available under the terms of the Eclipse Public License v1.0
- * which accompanies this distribution, and is available at
- * http://www.eclipse.org/legal/epl-v10.html
- * 
- * Contributors:
- *   Christoph Kulla - Initial API and implementation
- *******************************************************************************/
-package org.eclipse.xtext.ui.tests.editor.hover;
-
-import java.util.List;
-import org.eclipse.core.resources.IFile;
-import org.eclipse.jface.text.IRegion;
-import org.eclipse.jface.text.ITextHover;
-import org.eclipse.jface.text.ITextViewer;
-import org.eclipse.jface.text.Region;
-import org.eclipse.ui.IWorkbenchPart;
-import org.eclipse.xtext.ui.editor.XtextEditor;
-import org.eclipse.xtext.ui.editor.hover.CompositeHover;
-import org.eclipse.xtext.ui.editor.model.IXtextDocument;
-import org.eclipse.xtext.ui.junit.util.IResourcesSetupUtil;
-import org.eclipse.xtext.ui.tests.editor.AbstractEditorTest;
-import com.google.inject.internal.Lists;
-
-/**
- * @author Christoph Kulla - Initial contribution and API
- */
-public class CompositeHoverTest extends AbstractEditorTest {
-	
-	protected XtextEditor editor;
-	protected IXtextDocument document;
-
-	@Override
-	protected void setUp() throws Exception {
-		super.setUp();
-		String modelAsText = "// file content doesn't mater";
-		IFile file = IResourcesSetupUtil.createFile("test/test.testlanguage", modelAsText);
-		editor = openEditor(file);
-		document = editor.getDocument();
-	}
-
-	@Override
-	protected void tearDown() throws Exception {
-		super.tearDown();
-		editor.close(false);
-	}
-
-	@Override
-	protected String getEditorId() {
-		return "org.eclipse.xtext.ui.tests.TestLanguage";
-	}
-
-	@SuppressWarnings("deprecation")
-	public void testNullHoverList () {
-		CompositeHover hover = new CompositeHover() {
-
-			@Override
-			protected List<ITextHover> createHovers() {
-				return null;
-			}
-		};
-	
-		assertEquals (null, hover.getHovers());
-		assertNull (hover.getHoverRegion(editor.getInternalSourceViewer(), 0));
-		assertNull (hover.getHoverControlCreator());
-		assertNull (hover.getHoverInfo(editor.getInternalSourceViewer(), new Region(0,0)));
-		assertNull (hover.getHoverInfo2(editor.getInternalSourceViewer(), new Region(0,0)));
-	}
-	
-	@SuppressWarnings("deprecation")
-	public void testEmptyHoverList () {
-		CompositeHover hover = new CompositeHover() {
-
-			@Override
-			protected List<ITextHover> createHovers() {
-				List<ITextHover> hovers = Lists.newArrayList();
-				return hovers;
-			}
-		};
-	
-		assertEquals (0, hover.getHovers().size());
-		assertNull (hover.getHoverRegion(editor.getInternalSourceViewer(), 0));
-		assertNull (hover.getHoverControlCreator());
-		assertNull (hover.getHoverInfo(editor.getInternalSourceViewer(), new Region(0,0)));
-		assertNull (hover.getHoverInfo2(editor.getInternalSourceViewer(), new Region(0,0)));
-	}
-	
-	@SuppressWarnings("deprecation")
-	public void testSingleHover () {
-		CompositeHover hover = new CompositeHover() {
-
-			@Override
-			protected List<ITextHover> createHovers() {
-				List<ITextHover> hovers = Lists.newArrayList();
-				hovers.add (new ITextHover() {
-					
-					public IRegion getHoverRegion(ITextViewer textViewer, int offset) {
-						// TODO Auto-generated method stub
-						if (offset==0)
-							return new Region (offset, 0);
-						return null;
-					}
-					
-					public String getHoverInfo(ITextViewer textViewer, IRegion hoverRegion) {
-						return "test";
-					}
-				});
-				return hovers;
-			}
-		};
-	
-		assertEquals (1, hover.getHovers().size());
-		assertNotNull (hover.getHoverRegion(editor.getInternalSourceViewer(), 0));
-		assertEquals ("test", hover.getHoverInfo(editor.getInternalSourceViewer(), new Region(0,0)));
-		assertNull (hover.getHoverRegion(editor.getInternalSourceViewer(), 5));
-		assertNull (hover.getHoverInfo(editor.getInternalSourceViewer(), new Region(0,0)));
-	}
-	
-	@SuppressWarnings("deprecation")
-	public void testMultipleHovers () {
-		final ITextHover hover1 = new ITextHover() {
-			
-			public IRegion getHoverRegion(ITextViewer textViewer, int offset) {
-				// TODO Auto-generated method stub
-				if (offset==0)
-					return new Region (offset, 0);
-				return null;
-			}
-			
-			public String getHoverInfo(ITextViewer textViewer, IRegion hoverRegion) {
-				return "hover1";
-			}
-		};
-		final ITextHover hover2 = new ITextHover() {
-			
-			public IRegion getHoverRegion(ITextViewer textViewer, int offset) {
-				// TODO Auto-generated method stub
-				if (offset==1)
-					return new Region (offset, 0);
-				return null;
-			}
-			
-			public String getHoverInfo(ITextViewer textViewer, IRegion hoverRegion) {
-				return "hover2";
-			}
-		};
-			
-		CompositeHover hover = new CompositeHover() {
-			@Override
-			protected List<ITextHover> createHovers() {
-				List<ITextHover> hovers = Lists.newArrayList();
-				hovers.add (hover1);
-				hovers.add (hover2);
-				return hovers;
-			}
-		};
-	
-		assertEquals (2, hover.getHovers().size());
-		assertNotNull (hover.getHoverRegion(editor.getInternalSourceViewer(), 0));
-		assertEquals ("hover1", hover.getHoverInfo(editor.getInternalSourceViewer(), new Region(0,0)));
-		assertNotNull (hover.getHoverRegion(editor.getInternalSourceViewer(), 1));
-		assertEquals ("hover2", hover.getHoverInfo(editor.getInternalSourceViewer(), new Region(1,0)));
-	}
-	
-	protected void activate(IWorkbenchPart part) {
-		editor.getSite().getPage().activate(part);
-	}
-
-
-}
-- 
1.6.6

